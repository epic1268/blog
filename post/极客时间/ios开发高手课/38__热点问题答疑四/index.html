<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>38__热点问题答疑（四） - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是戴铭。今天这篇答疑文章，我要针对近期留言中的热点问题，进行一次集中解答。
目前，我们专栏已经更新完了基础篇、应用开发篇和原理篇 3 大模块的内容。其中，原理篇的内容，因为涉及到的都是底层原理，比如系统内核 XNU、AOP、内存管理和编译等，学习起来会很辛苦。但所谓良药苦口，你只有搞明白了这些最最底层的原理，才可以帮你抓住开发知识的规律，达到融会贯通的效果，进而提升自己造轮子、解决问题的能力。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/ios%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/38__%E7%83%AD%E7%82%B9%E9%97%AE%E9%A2%98%E7%AD%94%E7%96%91%E5%9B%9B/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/ios%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/38__%E7%83%AD%E7%82%B9%E9%97%AE%E9%A2%98%E7%AD%94%E7%96%91%E5%9B%9B/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="38__热点问题答疑（四）">
  <meta property="og:description" content="你好，我是戴铭。今天这篇答疑文章，我要针对近期留言中的热点问题，进行一次集中解答。
目前，我们专栏已经更新完了基础篇、应用开发篇和原理篇 3 大模块的内容。其中，原理篇的内容，因为涉及到的都是底层原理，比如系统内核 XNU、AOP、内存管理和编译等，学习起来会很辛苦。但所谓良药苦口，你只有搞明白了这些最最底层的原理，才可以帮你抓住开发知识的规律，达到融会贯通的效果，进而提升自己造轮子、解决问题的能力。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="IOS开发高手课">

  <meta itemprop="name" content="38__热点问题答疑（四）">
  <meta itemprop="description" content="你好，我是戴铭。今天这篇答疑文章，我要针对近期留言中的热点问题，进行一次集中解答。
目前，我们专栏已经更新完了基础篇、应用开发篇和原理篇 3 大模块的内容。其中，原理篇的内容，因为涉及到的都是底层原理，比如系统内核 XNU、AOP、内存管理和编译等，学习起来会很辛苦。但所谓良药苦口，你只有搞明白了这些最最底层的原理，才可以帮你抓住开发知识的规律，达到融会贯通的效果，进而提升自己造轮子、解决问题的能力。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="3019">
  <meta itemprop="keywords" content="IOS开发高手课">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="38__热点问题答疑（四）">
  <meta name="twitter:description" content="你好，我是戴铭。今天这篇答疑文章，我要针对近期留言中的热点问题，进行一次集中解答。
目前，我们专栏已经更新完了基础篇、应用开发篇和原理篇 3 大模块的内容。其中，原理篇的内容，因为涉及到的都是底层原理，比如系统内核 XNU、AOP、内存管理和编译等，学习起来会很辛苦。但所谓良药苦口，你只有搞明白了这些最最底层的原理，才可以帮你抓住开发知识的规律，达到融会贯通的效果，进而提升自己造轮子、解决问题的能力。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">38__热点问题答疑（四）</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 3019 字 </span>
          <span class="more-meta"> 预计阅读 7 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#关于监控卡顿">关于监控卡顿</a></li>
        <li><a href="#关于-smlogger-的实现">关于 SMLogger 的实现</a></li>
        <li><a href="#nsurlprotocol-相关">NSURLProtocol 相关</a></li>
        <li><a href="#关于-json-解析的问题">关于 JSON 解析的问题</a></li>
        <li><a href="#json-案例相关">JSON 案例相关</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是戴铭。今天这篇答疑文章，我要针对近期留言中的热点问题，进行一次集中解答。</p>
<p>目前，我们专栏已经更新完了基础篇、应用开发篇和原理篇 3 大模块的内容。其中，原理篇的内容，因为涉及到的都是底层原理，比如系统内核 XNU、AOP、内存管理和编译等，学习起来会很辛苦。但所谓良药苦口，你只有搞明白了这些最最底层的原理，才可以帮你抓住开发知识的规律，达到融会贯通的效果，进而提升自己造轮子、解决问题的能力。</p>
<p>也正因为这些底层知识比较难啃，需要细细琢磨，所以在这期答疑文章中，我并没有展开这个模块的内容。如果你对这个模块的文章有哪里不理解，或者觉得哪里有问题的话，可以在评论区留下你的观点，我会挑选合适的时机，给你答复。</p>
<p>接下来，我们就看看今天这篇文章要展开讨论的问题吧。</p>
<h2 id="关于监控卡顿">关于监控卡顿</h2>
<p>@凡在第 13 篇文章<a href="./89494.md">《如何利用 RunLoop 原理去监控卡顿？》</a>后问道：</p>
<blockquote>
<p>大多数的卡顿监控，都是在主线程上做的。音视频播放以及直播的卡顿，能否使用这种方式来监控呢？另外，我们公司对接的直播都是第三方的库和知识平台，我应该如何把这种监控放到客户端来做呢？</p>
</blockquote>
<p>针对这个同学的问题，我想说的是，只有在主线程上卡了，用户才会感知到，而监控卡顿主要就是要监控什么时候会卡。只要我们在发生卡顿的时刻，想办法去收集卡顿信息，就能够定位到问题，找出具体是由谁引起的卡顿。</p>
<p>比如，@凡同学提到的音视频播放卡顿问题，监控到发生卡顿的时刻，通过获取当时方法调用堆栈的方式，就能够确定出具体是哪个方法在调用，从而找到发生卡顿问题的原因。</p>
<p>当然，有些时候只通过各个线程中的方法调用栈来分析问题，可能信息还不太够，这时你还可以捕获各线程卡顿时的 CPU 使用率，进而发现哪个方法占用资源过高。同时，你还能够通过业务场景和环境数据埋点信息，综合分析发生卡顿时，业务场景以及数据是否出现了异常。</p>
<h2 id="关于-smlogger-的实现">关于 SMLogger 的实现</h2>
<p>@梁华建在第 9 篇文章<a href="./87925.md">《无侵入的埋点方案如何实现？》</a>后留言，想要知道 SMLogger 是如何实现的。</p>
<p>SMLogger，是我对日志记录的一个封装。我在第 9 篇文章中使用 SMLogger 的方式，是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[[[SMLogger create]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   message:[NSString stringWithFormat:@&#34;%@ Appear&#34;,NSStringFromClass([self class])]]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  classify:ProjectClassifyOperation]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> save];
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，我把 SMLogger 的接口设计成了链式调用的方式。这样的接口接收外部数据后，能够更加灵活地进行组合。</p>
<p>对于日志记录来说，可以设置默认的日志分类和日志级别，简单记录日志描述就只需要一个日志描述数据。</p>
<p>当使用者需要日志库记录一个对象时，就需要增加一个新的接口来支持记录对象。接下来，就会面对外部输入会进行不同组合的情况，比如日志记录对象、日志描述、日志分类、日志级别这四个数据的不同组合。为了满足这些不同的组合，你设置的接口数量也会增加很多。如果都放到一个统一接口中当作不同参数，那么参数的个数就会非常多，导致接口使用起来非常不方便。比如，你每次只需要设置日志描述这个参数，但是使用了多参数的统一接口后，需要手动去设置其他参数值。</p>
<p>使用链式调用的好处就是可以随意组合。而且，当有新的输入类型加入，要和以前接口组合时，也不需要额外工作。我定义的 SMLogger 的链式接口，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 初始化
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">+ (SMLogger *)create;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 可选设置
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- (SMLogger *)object:(id)obj;                        //object 对象记录
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- (SMLogger *)message:(NSString *)msg;               // 描述
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- (SMLogger *)classify:(SMProjectClassify)classify;  // 分类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- (SMLogger *)level:(SMLoggerLevel)level;            // 级别
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 场景记录
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- (SMLogger *)scene:(SceneType)scene;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> // 最后需要执行这个方法进行保存，什么都不设置也会记录文件名，函数名，行数等信息
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- (void)save;
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，日志记录对象、日志描述、日志分类、日志级别分别为 object、message、classity、level。当需要在日志记录中增加业务场景数据时，只需要简单增加一个 scene 链式接口，就能够达到组合使用业务场景数据和其他链式接口的目的。</p>
<p>在 SMLogger 中，我还在链式基础上实现了宏的方式，来简化一些常用的日志记录接口调用方式。宏的定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">宏接口</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FOUNDATION_EXPORT</span> <span class="n">void</span> <span class="n">SMLoggerDebugFunc</span><span class="p">(</span><span class="n">NSUInteger</span> <span class="n">lineNumber</span><span class="p">,</span> <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">functionName</span><span class="p">,</span> <span class="n">SMProjectClassify</span> <span class="n">classify</span><span class="p">,</span> <span class="n">SMLoggerLevel</span> <span class="n">level</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="n">NS_FORMAT_FUNCTION</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">debug</span> <span class="err">方式打印日志，不会上报</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef DEBUG</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#define SMLoggerDebug(frmt, ...) SMLoggerCustom(SMProjectClassifyNormal,SMLoggerLevelDebug,frmt, ##__VA_ARGS__)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#else</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#define SMLoggerDebug(frmt, ...) do {} while (0)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">简单的上报日志</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define SMLoggerSimple(classify,frmt, ...) SMLoggerCustom(classify,SMLoggerLevelInfo,frmt, ##__VA_ARGS__)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">自定义</span> <span class="n">classify</span> <span class="err">和</span> <span class="n">level</span> <span class="err">的日志，可上报</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define SMLoggerCustom(classify,level,frmt, ...) \</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">do</span> <span class="p">{</span> <span class="n">SMLoggerDebugFunc</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">classify</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">frmt</span><span class="p">,</span> <span class="c1">##__VA_ARGS__);} while(0)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，宏定义最终调用的是 SMLoggerDebugFunc 函数，这个函数的实现如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">SMLoggerDebugFunc</span><span class="p">(</span><span class="n">NSUInteger</span> <span class="n">lineNumber</span><span class="p">,</span> <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">functionName</span><span class="p">,</span> <span class="n">SMProjectClassify</span> <span class="n">classify</span><span class="p">,</span> <span class="n">SMLoggerLevel</span> <span class="n">level</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">输出方法名和行号</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">NSString</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithFormat</span><span class="p">:</span><span class="n">format</span> <span class="n">arguments</span><span class="p">:</span><span class="n">args</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="p">:</span><span class="err">@</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">:</span><span class="si">%lu</span><span class="s2">]%@&#34;</span><span class="p">,</span><span class="n">functionName</span><span class="p">,(</span><span class="n">unsigned</span> <span class="n">long</span><span class="p">)</span><span class="n">lineNumber</span><span class="p">,</span><span class="n">msg</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">SMLogger</span> <span class="err">链式调用</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">[[[[[</span><span class="n">SMLogger</span> <span class="n">create</span><span class="p">]</span> <span class="n">message</span><span class="p">:</span><span class="n">msg</span><span class="p">]</span> <span class="n">classify</span><span class="p">:</span><span class="n">classify</span><span class="p">]</span> <span class="n">level</span><span class="p">:</span><span class="n">level</span><span class="p">]</span> <span class="n">save</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过上面代码可以看到，SMLoggerDebugFunc 在处理完方法名和行号后，最终使用的就是 SMLogger 链式调用。</p>
<p>通过宏的定义，日志记录接口调用起来也会简化很多，使用效果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 宏方式使用，会记录具体调用地方的函数名和行数
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SMLoggerDebug(@&#34; 此处必改：%@ 此处也必改： %@&#34;,arr,dict); // 仅调试，不上报
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SMLoggerSimple(SMProjectClassifyNormal,@&#34; 此处必改：%@ 此处也必改： %@&#34;,arr,dict); // 会上报
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SMLoggerCustom(SMProjectClassifyNormal,SMLoggerLevelDebug, @&#34; 这两个需要上报 %@%@&#34;,arr,dict); //level 为 debug 不上报
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="nsurlprotocol-相关">NSURLProtocol 相关</h2>
<p>@熊在第 28 篇文章<a href="./95023.md">《怎么应对各种富文本表现需求？》</a>后留言到：</p>
<blockquote>
<p>WKWebView 对 NSURLProtocol 的支持不太好，我在网上找到的方法都不适用，连 Ajax 请求都不好去拦截。</p>
</blockquote>
<p>其实，WKWebView 处理资源缓存的思路和 UIWebView 类似，需要创建一个 WKURLSchemeHandler，然后使用 -[WKWebViewConfiguration setURLSchemeHandler:forURLScheme:] 方法注册到 WKWebView 配置里。</p>
<p>WKURLSchemeHandler 实例可以用来处理对应的 URLScheme 加载的资源，使用它的 webView:startURLSchemeTask 方法可以加载特定资源的数据。这样就能够起到和 NSURLProtocol 同样的效果。</p>
<h2 id="关于-json-解析的问题">关于 JSON 解析的问题</h2>
<p>@大太阳在第 26 篇文章<a href="./93819.md">《如何提高 JSON 解析的性能？》</a>中留言到：</p>
<blockquote>
<p>我现在项目是用 Swift 语言开发的，绝大部分的 JSON 解析用的是 SwiftyJSON，很少一部分用到了 KVC。我想问下，SwiftyJSON 的效率怎么样？我怎么才能评测这个效率？市面上比较出名的第三方库，它们的效率排名是什么样的？</p>
</blockquote>
<p>其实，市面上的大多数第三方库，在解析 JSON 时用的都是系统自带的 JSONSerialization。因此，从本质上来看，它们的解析效率并无差别，只是在易用性、容错率、缓存效率上有些许差异。</p>
<p>比如，@大太阳提到的 SwiftyJSON 库，初始化方法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">public init(data: Data, options opt: JSONSerialization.ReadingOptions = []) throws {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    let object: Any = try JSONSerialization.jsonObject(with: data, options: opt)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    self.init(jsonObject: object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，SwiftyJSON 库在解析 JSON 时，使用的是 JSONSerialization。你可以点击<a href="./SwiftyJSON.swift.md">这个链接</a>，查看 SwiftJSON 的完整代码。</p>
<p>既然 SwiftyJSON 也是使用 JSONSerialization 来解析 JSON 的，那么解析效率就和其他使用 JSONSerialization 解析的第三方库相比，没有本质上的差别。</p>
<h2 id="json-案例相关">JSON 案例相关</h2>
<p>@徐秀滨在第 23 篇文章<a href="./93090.md">《如何构造酷炫的物理效果和过场动画效果？》</a>后留言反馈，对通过 JSON 来控制代码逻辑的能力这块内容，感觉理解起来有些困难。接下来，针对这个问题，我再多说两句，希望能够对你有多帮助。</p>
<p>我在第 26 篇文章<a href="./93819.md">《如何提高 JSON 解析的性能？》</a>中，举了个更加具体的例子，使用 JSON 描述了一段 JavaScript 代码逻辑，你可以先看一下这篇文章的相关内容。</p>
<p>对于开发者来说，App 中的任何逻辑都可以通过代码来描述，而代码又能够转换成抽象语法树结构。JSON 作为一种数据结构的表示，同样可以表示代码的抽象语法树，自然也能够具有控制代码逻辑的能力。</p>
<h2 id="总结">总结</h2>
<p>今天这篇答疑文章，我和你分享了监控卡顿、SMLogger、NSURLProtocol、JSON 相关的问题。</p>
<p>监控卡顿的方案实际上是通用的，和具体的场景没有关系。卡只是表现在主线程上，根本原因还是需要分析每个线程。</p>
<p>通过 NSURLProtocol 对 WKWebView 支持不好的问题，我们可以看出，苹果公司为了更好地管控 WKWebView 而增加了一层，将资源的加载处理单独提供出来供开发者使用，以满足开发者自定义提速的需求。</p>
<p>最后，JSON 解析效率的提高，还是需要从根本上去解决，封装层解决的是易用性问题，所加缓存也只能解决重复解析的问题。</p>
<p>感谢你的收听，欢迎你在评论区给我留言分享你的观点，也欢迎把它分享给更多的朋友一起阅读。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/iOS%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/00f2c9fdb9510db65ff1c5aab85991c1.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ios%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/">iOS开发高手课</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A140%E9%97%AE/38__%E8%AE%A1%E6%95%B0%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%BA%8C50%E4%B8%87qps%E4%B8%8B%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E6%9C%AA%E8%AF%BB%E6%95%B0%E7%B3%BB%E7%BB%9F/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">38__计数系统设计（二）：50万QPS下如何设计未读数系统？</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E4%B9%8B%E7%BE%8E/38__%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E5%A6%82%E4%BD%95%E5%80%9F%E5%8A%A9%E5%B7%A5%E5%85%B7%E5%BF%AB%E9%80%9F%E5%8F%91%E7%8E%B0%E5%92%8C%E5%AE%9A%E4%BD%8D%E4%BA%A7%E5%93%81%E9%97%AE%E9%A2%98_/">
            <span class="next-text nav-default">38__日志管理：如何借助工具快速发现和定位产品问题_？</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
