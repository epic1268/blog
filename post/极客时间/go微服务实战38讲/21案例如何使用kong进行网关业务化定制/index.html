<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>21案例：如何使用Kong进行网关业务化定制？ - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="在上一课时中，我们对比了几款市面上流行的微服务网关，那么本课时我们就基于其中一款，也就是 Kong 来重点介绍微服务网关是如何搭建和实现的。
为什么使用 Kong
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/go%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%9838%E8%AE%B2/21%E6%A1%88%E4%BE%8B%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8kong%E8%BF%9B%E8%A1%8C%E7%BD%91%E5%85%B3%E4%B8%9A%E5%8A%A1%E5%8C%96%E5%AE%9A%E5%88%B6/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/go%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%9838%E8%AE%B2/21%E6%A1%88%E4%BE%8B%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8kong%E8%BF%9B%E8%A1%8C%E7%BD%91%E5%85%B3%E4%B8%9A%E5%8A%A1%E5%8C%96%E5%AE%9A%E5%88%B6/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="21案例：如何使用Kong进行网关业务化定制？">
  <meta property="og:description" content="在上一课时中，我们对比了几款市面上流行的微服务网关，那么本课时我们就基于其中一款，也就是 Kong 来重点介绍微服务网关是如何搭建和实现的。
为什么使用 Kong">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="Go微服务实战38讲">

  <meta itemprop="name" content="21案例：如何使用Kong进行网关业务化定制？">
  <meta itemprop="description" content="在上一课时中，我们对比了几款市面上流行的微服务网关，那么本课时我们就基于其中一款，也就是 Kong 来重点介绍微服务网关是如何搭建和实现的。
为什么使用 Kong">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="4872">
  <meta itemprop="keywords" content="Go微服务实战38讲">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="21案例：如何使用Kong进行网关业务化定制？">
  <meta name="twitter:description" content="在上一课时中，我们对比了几款市面上流行的微服务网关，那么本课时我们就基于其中一款，也就是 Kong 来重点介绍微服务网关是如何搭建和实现的。
为什么使用 Kong">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">21案例：如何使用Kong进行网关业务化定制？</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 4872 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>在上一课时中，我们对比了几款市面上流行的微服务网关，那么本课时我们就基于其中一款，也就是 Kong 来重点介绍微服务网关是如何搭建和实现的。</p>
<p>为什么使用 Kong</p>
<p>当我们对原有业务系统进行微服务改造时，客户端（包括移动端和 Web 端等）如何与各个微服务进行交互这个问题需要我们认真考虑，服务数量的增加会导致一些基础功能的实现变得困难，如认证授权、负载均衡和服务间通信管理。</p>
<p>但微服务网关所提供的访问限制、安全、流量控制、分析监控、日志、请求转发、合成和协议转换功能，可以使得开发者更加集中精力在各个业务服务的实现上，从而避免将大量时间花在考虑如何解决这些问题上。</p>
<p>在业内流行的微服务网关组件中，基于 Nginx 的Kong表现突出。Kong 是 Mashape 开源的高性能、高可用 API 网关，也可以认为是 API 服务管理层。它可以通过插件扩展已有功能，这些插件（使用 Lua 编写）在 API 请求响应循环的生命周期中被执行。除此之外，Kong 本身还提供了包括 HTTP 基本认证、密钥认证、CORS、TCP、UDP、文件日志、API 请求限流、请求转发及 Nginx 监控等基本功能。</p>
<p>在用 Kong 进行实践之前，我们得先介绍一些 Kong 中常用的术语，因为这些术语在实践中会经常用得到。</p>
<p>Route：请求的转发规则，按照 Hostname 和 PATH，将请求转发给 Service。</p>
<p>Services：多个 Upstream 的集合，是 Route 的转发目标。</p>
<p>Consumer：API 的用户，记录用户信息。</p>
<p>Plugin：插件，可以是全局的，也可以绑定到 Service、Router 或者 Consumer。</p>
<p>Certificate：HTTPS 配置的证书。</p>
<p>SNI：域名与 Certificate 的绑定，指定了一个域名对应的 HTTPS 证书。</p>
<p>Upstream：上游对象用来表示虚拟主机名，拥有多个服务（目标）时，会对请求进行负载均衡。</p>
<p>Target：最终处理请求的 Backend 服务。</p>
<p>安装实践</p>
<p>Kong 支持多种安装方式，目前最新版本是 Kong 2.1，官方支持包括 Docker、K8s 等方式的安装：</p>
<p>Kong 的多种安装方式</p>
<p>除了官方提供的安装方式，还有社区提供的安装方式：Microsoft Azure、Kongverge 等，详细情况你可参见该网址：https://konghq.com/install/ 。</p>
<p>为了方便，这里我们就选择基于 Docker 的方式安装，选择的 Kong 版本为 1.1.2。docker-compose.yml 中定义的镜像、依赖和参数如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">version</span><span class="p">:</span> <span class="s2">&#34;3.7&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">services</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">image</span><span class="p">:</span> <span class="n">kong</span><span class="p">:</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="n">environment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;KONG_DATABASE=postgres&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;KONG_PG_HOST=kong-database&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;KONG_CASSANDRA_CONTACT_POINTS=kong-database&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;KONG_PROXY_ACCESS_LOG=/dev/stdout&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;KONG_ADMIN_ACCESS_LOG=/dev/stdout&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;KONG_PROXY_ERROR_LOG=/dev/stderr&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;KONG_ADMIN_ERROR_LOG=/dev/stderr&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ports</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">8000</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="mi">8443</span><span class="p">:</span><span class="mi">8443</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="mi">8001</span><span class="p">:</span><span class="mi">8001</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="mi">8444</span><span class="p">:</span><span class="mi">8444</span>
</span></span><span class="line"><span class="cl">    <span class="n">networks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="n">kong</span><span class="o">-</span><span class="n">net</span>
</span></span><span class="line"><span class="cl">    <span class="n">depends_on</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">kong</span><span class="o">-</span><span class="n">database</span>
</span></span><span class="line"><span class="cl">  <span class="n">konga</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">image</span><span class="p">:</span> <span class="n">pantsel</span><span class="o">/</span><span class="n">konga</span>
</span></span><span class="line"><span class="cl">    <span class="n">environment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;TOKEN_SECRET=blueskykong.com&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="s2">&#34;NODE_ENV=production&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ports</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="mi">8080</span><span class="p">:</span><span class="mi">1337</span>
</span></span><span class="line"><span class="cl">    <span class="n">networks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="o">-</span> <span class="n">kong</span><span class="o">-</span><span class="n">net</span>
</span></span><span class="line"><span class="cl">    <span class="n">depends_on</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">kong</span><span class="o">-</span><span class="n">database</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong</span><span class="o">-</span><span class="n">database</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">image</span><span class="p">:</span> <span class="n">postgres</span><span class="p">:</span><span class="mf">9.6</span>
</span></span><span class="line"><span class="cl">    <span class="n">ports</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="s2">&#34;5432:5432&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">environment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">POSTGRES_USER</span><span class="o">=</span><span class="n">kong</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">POSTGRES_DB</span><span class="o">=</span><span class="n">kong</span>
</span></span><span class="line"><span class="cl">    <span class="n">networks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">kong</span><span class="o">-</span><span class="n">net</span>
</span></span><span class="line"><span class="cl">    <span class="n">volumes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span><span class="p">:</span><span class="n">ro</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">postgresql</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="n">data</span>
</span></span><span class="line"><span class="cl"><span class="n">networks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">kong</span><span class="o">-</span><span class="n">net</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">external</span><span class="p">:</span> <span class="bp">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上的 docker-compose.yml 会启动三个容器服务：Kong、Konga 和 Kong-database。这三个容器之间的通信需要增加 network 段，把容器放在同一个网段内，相关链接修改为容器名称来访问：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker network create kong-net
</span></span></code></pre></td></tr></table>
</div>
</div><p>所启动的三个容器服务，除了 Kong 之外的另两个服务：Konga是 Kong 的 Dashboard，它是基于 JavaScript 的客户端管理工具，对外暴露的端口为 8080；Kong-database是 Kong 的数据库服务，它用于存储配置信息，此处使用的是 Postgres。</p>
<p>这里要注意的是，在启动 Kong 容器之前，需要保持数据库的 Docker 容器在运行状态，并执行如下初始化数据库的操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker run --rm \
</span></span><span class="line"><span class="cl">     --network=kong-net \
</span></span><span class="line"><span class="cl">     -e &#34;KONG_DATABASE=postgres&#34; \
</span></span><span class="line"><span class="cl">     -e &#34;KONG_PG_HOST=kong-database&#34; \
</span></span><span class="line"><span class="cl">     kong:latest kong migrations bootstrap
</span></span></code></pre></td></tr></table>
</div>
</div><p>数据库初始化成功后，再次启动 docker-compose.yml 服务就可以了。我们看到 Kong 映射出多个端口，默认情况下，Kong 监听的端口为：</p>
<p>8000。此端口是 Kong 用来监听来自客户端传入的 HTTP 请求，并将此请求转发到上游服务器；Kong 根据配置的路由规则转发到真实的后台服务地址。</p>
<p>8443。此端口是 Kong 用来监听来自客户端传入的 HTTPS 请求，跟 8000 端口的功能类似，还会转发 HTTPS 请求。我们可以通过修改配置文件来禁用 HTTPS 的功能。</p>
<p>8001。Kong 提供的管理 API 端口，通过此端口，管理者可以对 Kong 的监听服务进行配置，插件设置、API 的增删改查以及负载均衡等一系列的配置都是通过 8001 端口进行管理的。</p>
<p>8444。通过此端口，管理者可以对 HTTPS 请求进行监控。</p>
<p>容器都启动好之后，下面我们来验证一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ curl -i http://localhost:8001/
</span></span><span class="line"><span class="cl">HTTP/1.1 200 OK
</span></span><span class="line"><span class="cl">Date: Sat, 20 Jul 2019 08:39:08 GMT
</span></span><span class="line"><span class="cl">Content-Type: application/json; charset=utf-8
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">Access-Control-Allow-Origin: *
</span></span><span class="line"><span class="cl">Server: kong/1.1.2
</span></span><span class="line"><span class="cl">Content-Length: 5785
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>本地访问 8001 端口，返回如上的结果，表示安装正确，可以正常使用 Kong。在浏览器中输入 http://localhost:8080 即可访问 Konga 的管理界面（如下图），如果你第一次登录使用，则需要创建管理员账号和密码。</p>
<p>Konga 的管理界面</p>
<p>至此，Kong 以及管理工具都已安装完成。下面我们将会通过创建服务、创建路由、安装插件等过程的讲解，进入 API Gateway 的具体实践。</p>
<p>1. 创建服务</p>
<p>正如我们在前面术语部分的介绍，服务 Services 是上游服务的抽象，可以是一个应用，或者具体某个接口。Kong 提供了管理接口，我们可以通过请求 8001 管理接口直接创建，也可以通过安装的管理界面，这二者的实现效果是一样的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -i -X POST \
</span></span><span class="line"><span class="cl">--url http://localhost:8001/services/ \
</span></span><span class="line"><span class="cl">--data &#39;name=aoho-blog&#39; \
</span></span><span class="line"><span class="cl">--data &#39;url=http://blueskykong.com/&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里我们创建了一个服务名为 aoho-blog 的后端服务，指定转发的地址为 <a href="http://blueskykong.com">http://blueskykong.com</a>。可以在管理界面中看到如下的记录：</p>
<p>Kong 服务列表</p>
<p>在创建服务的同时，我们还可以设置其中的一些参数，如 Retries（重试次数）、Connect timeout（连接的超时时间）、Write/Read timeout（写/读超时时间）等。</p>
<p>2. 创建路由</p>
<p>创建好服务之后，我们需要创建具体的 API 路由。路由是请求的转发规则，根据 Hostname 和 PATH，将请求转发。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -i -X POST \
</span></span><span class="line"><span class="cl">--url http://localhost:8001/services/aoho-blog/routes \
</span></span><span class="line"><span class="cl">--data &#39;hosts[]=blueskykong.com&#39; \
</span></span><span class="line"><span class="cl">--data &#39;paths[]=/api/blog&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上所示，我们在 aoho-blog 中创建了一个访问 /api/blog 的路由，在管理界面可以看到相应的记录：</p>
<p>Kong 路由记录</p>
<p>创建好路由之后，我们就可以访问 /api/blog，如下图：</p>
<p>访问 /api/blog</p>
<p>Kong 默认通过 8000 端口处理代理的请求。成功的响应意味着 Kong 会将 http://localhost:8000 的请求转发到配置的 URL，并将响应转发给我们。需要注意的是，如果 API 暴露的地址与前面 Host 定义的地址（blueskykong.com）不一致，就需要在请求的 Headers 里面加入 Header，Kong 根据上面请求中定义的
Header:Host
，执行此操作。</p>
<p>创建了服务和路由之后，我们已经能够将客户端的请求转发到对应的服务，但微服务网关还承担了很多基础的功能，如安全认证、限流、分析监控等功能，因此还需要应用 Kong 的插件来实现这些功能。</p>
<p>安装 Kong 插件</p>
<p>请求到达 Kong 网关，我们可以在请求转发给服务端应用之前，应用 Kong 自带的插件对请求进行处理，如身份认证、API 限流、黑白名单校验和日志切面等。同时，我们也可以按照 Kong 的教程文档，定制属于自己的插件。这部分我们主要选择其中的三个插件示例应用，至于其余的插件应用，你可以参考这个网址：https://docs.konghq.com/hub/。</p>
<p>1. JWT 认证插件</p>
<p>JWT（JSON Web Token）是一种流行的跨域身份验证解决方案。作为一个开放的标准（RFC 7519），JWT 定义了一种简洁的、自包含的方法用于通信双方之间以 JSON 对象的形式安全地传递信息。因为数字签名的存在，这些信息是可信的。</p>
<p>JWT 最大的优点就是能让业务无状态化，让 Token 作为业务请求的必须信息随着请求一并传输过来，服务端不用再去存储 session 信息，尤其是在分布式系统中。Kong 提供了 JWT 认证插件，用以验证包含 HS256 或 RS256 签名的 JWT 请求。每个消费者都将拥有 JWT 凭证（公钥和密钥），这些凭证必须用于签署其 JWT。JWT 令牌可以通过请求字符串、Cookie 或者认证头部传递，Kong 将会验证令牌的签名，通过则转发，否则直接丢弃请求。</p>
<p>我们在前面配置的路由基础上，增加 JWT 认证插件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -X POST http://localhost:8001/routes/e33d6aeb-4f35-4219-86c2- a41e879eda36/plugins \
</span></span><span class="line"><span class="cl">--data &#34;name=jwt&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，在插件列表增加了相应的记录：</p>
<p>Kong 插件列表</p>
<p>在增加了 JWT 插件之后，就没法直接访问 /api/blog 接口了，接口返回 &ldquo;message&rdquo;: &ldquo;Unauthorized&rdquo;，提示客户端要访问的话则需要提供 JWT 的认证信息。因此，我们需要创建用户：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -i -X POST \
</span></span><span class="line"><span class="cl">--url http://localhost:8001/consumers/  \
</span></span><span class="line"><span class="cl">--data &#34;username=aoho&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上我们就创建了一个名为 aoho 的用户。</p>
<p>Kong 创建用户</p>
<p>创建好用户之后，需要获取用户 JWT 凭证，执行如下的调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ curl -i -X POST \
</span></span><span class="line"><span class="cl">--url http://localhost:8001/consumers/aoho/jwt \
</span></span><span class="line"><span class="cl">--header &#34;Content-Type: application/x-www-form-urlencoded&#34;
</span></span><span class="line"><span class="cl"># 响应
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    &#34;rsa_public_key&#34;: null,
</span></span><span class="line"><span class="cl">    &#34;created_at&#34;: 1563566125,
</span></span><span class="line"><span class="cl">    &#34;consumer&#34;: {
</span></span><span class="line"><span class="cl">        &#34;id&#34;: &#34;8c0e1ab4-8411-42fc-ab80-5eccf472d2fd&#34;
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    &#34;id&#34;: &#34;1d69281d-5083-4db0-b42f-37b74e6d20ad&#34;,
</span></span><span class="line"><span class="cl">    &#34;algorithm&#34;: &#34;HS256&#34;,
</span></span><span class="line"><span class="cl">    &#34;secret&#34;: &#34;olsIeVjfVSF4RuQuylTMX4x53NDAOQyO&#34;,
</span></span><span class="line"><span class="cl">    &#34;key&#34;: &#34;TOjHFM4m1qQuPPReb8BTWAYCdM38xi3C&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 key 和 secret 在 <a href="https://jwt.io">https://jwt.io</a> 可以生成 JWT 凭证信息。在实际的使用过程中，我们通过编码实现，此处为了演示使用网页工具生成 Token。</p>
<p>生成 JWT Token</p>
<p>上图中画线部分即为 JWT 凭证的 key 和 secret。然后我们将生成的 Token，配置到请求的认证头部，再次执行请求：</p>
<p>带有 JWT 令牌的合法请求</p>
<p>可以看到，我们能够正常请求相应的 API 接口，JWT 认证插件应用成功。Kong 的 JWT 认证插件使用比较简单，但在实践过程中，我们还需要考虑如何跟自身的用户认证系统进行结合。</p>
<p>2. Prometheus 可视化监控</p>
<p>Prometheus 是一套开源的系统监控报警框架。它启发于 Google 的 BorgMon 监控系统，由工作在 SoundCloud 的员工在 2012 年作为社区开源项目进行开发，并于 2015 年正式发布。</p>
<p>作为新一代的监控框架，Prometheus 适用于记录时间序列数据，并且它还具有强大的多维度数据模型、灵活而强大的查询语句、易于管理和伸缩等特点。</p>
<p>Kong 官方提供的 Prometheus 插件，可用的 metric（指标）有如下：</p>
<p>状态码。上游服务返回的 HTTP 状态码。</p>
<p>时延柱状图。Kong 中的时延都将被记录，包括请求（完整请求的时延）、Kong（Kong 用来路由、验证和运行其他插件所花费的时间）和上游（上游服务所花费时间来响应请求）。</p>
<p>Bandwidth。流经 Kong 的总带宽（出口/入口）。</p>
<p>DB 可达性。Kong 节点是否能访问其 DB。</p>
<p>Connections。各种 Nginx 连接指标，如 Active、读取、写入和接收连接。</p>
<p>我们在 Service 为 aoho-blog 安装 Prometheus 插件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -X POST http://localhost:8001/services/aoho-blog/plugins \
</span></span><span class="line"><span class="cl">--data &#34;name=prometheus&#34; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>从管理界面可以看到，我们已经成功将 Prometheus 插件绑定到 aoho-blog 服务上。</p>
<p>Prometheus 插件</p>
<p>通过访问
/metrics
接口返回收集度量数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ curl -i http://localhost:8001/metrics
</span></span><span class="line"><span class="cl">HTTP/1.1 200 OK
</span></span><span class="line"><span class="cl">Server: openresty/1.13.6.2
</span></span><span class="line"><span class="cl">Date: Sun, 21 Jul 2019 09:48:42 GMT
</span></span><span class="line"><span class="cl">Content-Type: text/plain; charset=UTF-8
</span></span><span class="line"><span class="cl">Transfer-Encoding: chunked
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">Access-Control-Allow-Origin: *
</span></span><span class="line"><span class="cl">kong_bandwidth{type=&#34;egress&#34;,service=&#34;aoho-blog&#34;} 178718
</span></span><span class="line"><span class="cl">kong_bandwidth{type=&#34;ingress&#34;,service=&#34;aoho-blog&#34;} 1799
</span></span><span class="line"><span class="cl">kong_datastore_reachable 1
</span></span><span class="line"><span class="cl">kong_http_status{code=&#34;200&#34;,service=&#34;aoho-blog&#34;} 4
</span></span><span class="line"><span class="cl">kong_http_status{code=&#34;401&#34;,service=&#34;aoho-blog&#34;} 1
</span></span><span class="line"><span class="cl">kong_latency_bucket{type=&#34;kong&#34;,service=&#34;aoho-blog&#34;,le=&#34;00005.0&#34;} 1
</span></span><span class="line"><span class="cl">kong_latency_bucket{type=&#34;kong&#34;,service=&#34;aoho-blog&#34;,le=&#34;00007.0&#34;} 1
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">kong_latency_bucket{type=&#34;upstream&#34;,service=&#34;aoho-blog&#34;,le=&#34;00300.0&#34;} 4
</span></span><span class="line"><span class="cl">kong_latency_bucket{type=&#34;upstream&#34;,service=&#34;aoho-blog&#34;,le=&#34;00400.0&#34;} 4
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">kong_latency_count{type=&#34;kong&#34;,service=&#34;aoho-blog&#34;} 5
</span></span><span class="line"><span class="cl">kong_latency_count{type=&#34;request&#34;,service=&#34;aoho-blog&#34;} 5
</span></span><span class="line"><span class="cl">kong_latency_count{type=&#34;upstream&#34;,service=&#34;aoho-blog&#34;} 4
</span></span><span class="line"><span class="cl">kong_latency_sum{type=&#34;kong&#34;,service=&#34;aoho-blog&#34;} 409
</span></span><span class="line"><span class="cl">kong_latency_sum{type=&#34;request&#34;,service=&#34;aoho-blog&#34;} 1497
</span></span><span class="line"><span class="cl">kong_latency_sum{type=&#34;upstream&#34;,service=&#34;aoho-blog&#34;} 1047
</span></span><span class="line"><span class="cl">kong_nginx_http_current_connections{state=&#34;accepted&#34;} 2691
</span></span><span class="line"><span class="cl">kong_nginx_http_current_connections{state=&#34;active&#34;} 2
</span></span><span class="line"><span class="cl">kong_nginx_http_current_connections{state=&#34;handled&#34;} 2691
</span></span><span class="line"><span class="cl">kong_nginx_http_current_connections{state=&#34;reading&#34;} 0
</span></span><span class="line"><span class="cl">kong_nginx_http_current_connections{state=&#34;total&#34;} 2637
</span></span><span class="line"><span class="cl">kong_nginx_http_current_connections{state=&#34;waiting&#34;} 1
</span></span><span class="line"><span class="cl">kong_nginx_http_current_connections{state=&#34;writing&#34;} 1
</span></span><span class="line"><span class="cl">kong_nginx_metric_errors_total 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>返回的响应太长，有省略，从响应可以看到 Prometheus 插件提供的 metric 都有体现。Prometheus 插件导出的度量标准，可以在 Grafana（一个跨平台的开源的度量分析和可视化工具）中绘制，“Prometheus + Grafana” 的组合是目前较为流行的监控系统。</p>
<p>3. 链路追踪 Zipkin 插件</p>
<p>Zipkin 是由 Twitter 开源的分布式实时链路追踪组件。 Zipkin 收集来自各个异构系统的实时监控数据，用来追踪与分析微服务架构下的请求，应用系统则需要向 Zipkin 报告链路信息。Kong 的 Zipkin 插件将 Kong 作为 zipkin-client，zipkin-client 组装好 Zipkin 需要的数据包发送到 zipkin-server。Zipkin 插件会将请求打上如下标签，并推送到 Zipkin 服务端：</p>
<p>span.kind (sent to Zipkin as “kind”)</p>
<p>http.method</p>
<p>http.status_code</p>
<p>http.url</p>
<p>peer.ipv4</p>
<p>peer.ipv6</p>
<p>peer.port</p>
<p>peer.hostname</p>
<p>peer.service</p>
<p>关于链路追踪和 Zipkin 的具体信息，到后面的链路追踪课时我们会详细讲解，本课时我们就旨在介绍如何在 Kong 中使用 Zipkin 插件追踪所有请求的链路。</p>
<p>首先开启 Zipkin 插件，将插件绑定到路由上（这里可以绑定为全局的插件）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -X POST http://kong:8001/routes/e33d6aeb-4f35-4219- 86c2-a41e879eda36/plugins \
</span></span><span class="line"><span class="cl">    --data &#34;name=zipkin&#34;  \
</span></span><span class="line"><span class="cl">    --data &#34;config.http_endpoint=http://localhost:9411/api/v2/spans&#34; \
</span></span><span class="line"><span class="cl">    --data &#34;config.sample_ratio=1&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上配置了 Zipkin Collector 的地址和采样率，为了测试效果明显，设置采样率为 100%，但在实际生产环境中还是要谨慎使用 100% 的采样率配置，采样率对系统吞吐量会有影响。</p>
<p>Zipkin 插件</p>
<p>可以看到，Zipkin 插件已经应用到指定的路由上。下面我们将会执行请求 /api/blog 接口，打开 http://localhost:9411 界面如下：</p>
<p>Zipkin 链路追踪</p>
<p>这时 Zipkin 已经将请求记录，我们可以点开查看其链路详情：</p>
<p>链路详情</p>
<p>从链路调用可以知道，请求到达 Kong 之后，都经历了哪些服务和 Span，以及每个 Span 所花费的时间等信息。</p>
<p>小结</p>
<p>本课时我们重点介绍了微服务网关 Kong 的相关概念和安装实践，并在此基础上安装实践了其中具有代表性的三个 Kong 插件：JWT 认证插件、Prometheus 可视化监控和链路追踪 Zipkin 插件。Kong 官方对自身的定位也是适用于混合云平台的下一代 API 管理平台，其在功能方面很强大。因此，基于 Kong 的丰富生态和配套的工具，我们可以快速构建一个微服务网关，作为服务端的统一入口。</p>
<p>学习完本课时，你觉得还需要自定义哪些 Kong 网关的插件，欢迎你在留言区和我分享。</p>
<p>-&ndash; ### 精选评论 ##### 13213： &gt; yml文件中需要指定-e &ldquo;KONG_PG_PASSWORD=kong_test&rdquo; ######     讲师回复： &gt;     这个与你的pg设置有关了，笔者这个版本不需要加。 ##### **1609： &gt; 老师，Traefik和Kong有什么区别呢？</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/go%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%9838%E8%AE%B2/">Go微服务实战38讲</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3tomcat_jetty/21%E6%80%BB%E7%BB%93tomcat%E5%92%8Cjetty%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%B1%A0%E6%8A%80%E6%9C%AF/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">21总结Tomcat和Jetty中的对象池技术</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/spring%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/21%E6%B5%8B%E8%AF%95%E6%96%B9%E6%A1%88%E5%A6%82%E4%BD%95%E9%AA%8C%E8%AF%81%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E7%BB%84%E4%BB%B6%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%80%A7/">
            <span class="next-text nav-default">21测试方案：如何验证响应式编程组件的正确性？</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
