<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>18对比Koa和Redux：分析前端中的中间件理念 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="上一讲，我们通过分析 axios 源码，延伸了“如何设计一个请求公共库”，其中提到了不同层次级别的分层理念。这一讲，我们继续讨论代码设计这一话题，聚焦中间件化和插件化理念。并通过实现一个中间件化的请求库和上一节内容融会贯通。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80%E5%BB%BA%E8%AE%BE%E4%B8%8E%E6%9E%B6%E6%9E%8430%E8%AE%B2/18%E5%AF%B9%E6%AF%94koa%E5%92%8Credux%E5%88%86%E6%9E%90%E5%89%8D%E7%AB%AF%E4%B8%AD%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%90%86%E5%BF%B5/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80%E5%BB%BA%E8%AE%BE%E4%B8%8E%E6%9E%B6%E6%9E%8430%E8%AE%B2/18%E5%AF%B9%E6%AF%94koa%E5%92%8Credux%E5%88%86%E6%9E%90%E5%89%8D%E7%AB%AF%E4%B8%AD%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%90%86%E5%BF%B5/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="18对比Koa和Redux：分析前端中的中间件理念">
  <meta property="og:description" content="上一讲，我们通过分析 axios 源码，延伸了“如何设计一个请求公共库”，其中提到了不同层次级别的分层理念。这一讲，我们继续讨论代码设计这一话题，聚焦中间件化和插件化理念。并通过实现一个中间件化的请求库和上一节内容融会贯通。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="前端基础建设与架构30讲">

  <meta itemprop="name" content="18对比Koa和Redux：分析前端中的中间件理念">
  <meta itemprop="description" content="上一讲，我们通过分析 axios 源码，延伸了“如何设计一个请求公共库”，其中提到了不同层次级别的分层理念。这一讲，我们继续讨论代码设计这一话题，聚焦中间件化和插件化理念。并通过实现一个中间件化的请求库和上一节内容融会贯通。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="5054">
  <meta itemprop="keywords" content="前端基础建设与架构30讲">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="18对比Koa和Redux：分析前端中的中间件理念">
  <meta name="twitter:description" content="上一讲，我们通过分析 axios 源码，延伸了“如何设计一个请求公共库”，其中提到了不同层次级别的分层理念。这一讲，我们继续讨论代码设计这一话题，聚焦中间件化和插件化理念。并通过实现一个中间件化的请求库和上一节内容融会贯通。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">18对比Koa和Redux：分析前端中的中间件理念</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 5054 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>上一讲，我们通过分析 axios 源码，延伸了“如何设计一个请求公共库”，其中提到了不同层次级别的分层理念。这一讲，我们继续讨论代码设计这一话题，聚焦中间件化和插件化理念。并通过实现一个中间件化的请求库和上一节内容融会贯通。</p>
<p>以 Koa 为代表的 Node.js 中间件化设计</p>
<p>说到中间件，很多开发者都会想到 Koa.js，其中间件设计无疑是前端中间件思想的典型代表之一。我们先来剖析 Koa.js 的设计和实现。</p>
<p>先来看一下 Koa.js 中间件的实现和应用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="err">最外层中间件，可以用于兜底</span> <span class="n">Koa</span> <span class="err">全局错误</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">async</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;中间件 1 开始执行&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">执行下一个中间件</span>
</span></span><span class="line"><span class="cl">    <span class="n">await</span> <span class="n">next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;中间件 1 执行结束&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="p">[</span><span class="n">koa</span> <span class="n">error</span><span class="p">]:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">第二层中间件，可以用于日志记录</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">async</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;中间件 2 开始执行&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="p">{</span> <span class="n">req</span> <span class="p">}</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">req</span> <span class="n">is</span> <span class="o">$</span><span class="p">{</span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">req</span><span class="p">)}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">await</span> <span class="n">next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">res</span> <span class="n">is</span> <span class="o">$</span><span class="p">{</span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">res</span><span class="p">)}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;中间件 2 执行结束&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上代码，我们看 Koa 实例，通过
use
方法注册和串联中间件，其源码实现部分精简表述为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">use(fn) {
</span></span><span class="line"><span class="cl">    this.middleware.push(fn);
</span></span><span class="line"><span class="cl">    return this;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上代码，我们的中间件被存储进
this.middleware
数组中，那么中间件是如何被执行的呢？参考下面源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="err">通过</span> <span class="n">createServer</span> <span class="err">方法启动一个</span> <span class="ne">Node</span><span class="o">.</span><span class="n">js</span> <span class="err">服务</span>
</span></span><span class="line"><span class="cl"><span class="n">listen</span><span class="p">(</span><span class="o">...</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">server</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">createServer</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">callback</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="o">...</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Koa 框架通过
http
模块的
createServer
方法创建一个 Node.js 服务，并传入 this.callback() 方法， this.callback() 方法源码精简实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="nf">callback</span><span class="p">()</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">从</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">middleware</span><span class="w"> </span><span class="err">数组中，组合中间件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">compose</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">middleware</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">handleRequest</span><span class="w"> </span><span class="err">方法作为</span><span class="w"> </span><span class="o">`</span><span class="n">http</span><span class="o">`</span><span class="w"> </span><span class="err">模块的</span><span class="w"> </span><span class="o">`</span><span class="n">createServer</span><span class="o">`</span><span class="w"> </span><span class="err">方法参数，该方法通过</span><span class="w"> </span><span class="o">`</span><span class="n">createContext</span><span class="o">`</span><span class="w"> </span><span class="err">封装了</span><span class="w"> </span><span class="o">`</span><span class="n">http</span><span class="p">.</span><span class="n">createServer</span><span class="o">`</span><span class="w"> </span><span class="err">中的</span><span class="w"> </span><span class="o">`</span><span class="n">request</span><span class="o">`</span><span class="w"> </span><span class="err">和</span><span class="w"> </span><span class="o">`</span><span class="n">response</span><span class="o">`</span><span class="err">对象，并将这两个对象放到</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="err">中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">handleRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">const</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="nf">createContext</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="err">将</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="err">和组合后的中间件函数</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="err">传递给</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">handleRequest</span><span class="w"> </span><span class="err">方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="nf">handleRequest</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="err">}</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handleRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nf">handleRequest</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">fnMiddleware</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">res</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">res</span><span class="p">.</span><span class="n">statusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="nf">onerror</span><span class="p">(</span><span class="n">err</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">handleResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nf">respond</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">on</span><span class="o">-</span><span class="n">finished</span><span class="w"> </span><span class="n">npm</span><span class="w"> </span><span class="err">包提供的方法，该方法在一个</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="err">请求</span><span class="w"> </span><span class="n">closes</span><span class="err">，</span><span class="n">finishes</span><span class="w"> </span><span class="err">或者</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="err">时执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">onFinished</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">onerror</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">将</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="err">对象传递给中间件函数</span><span class="w"> </span><span class="n">fnMiddleware</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nf">fnMiddleware</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="n">handleResponse</span><span class="p">).</span><span class="nf">catch</span><span class="p">(</span><span class="n">onerror</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如上代码，我们将 Koa 一个中间件组合和执行流程梳理为以下步骤。</p>
<p>通过
compose
方法组合各种中间件，返回一个中间件组合函数
fnMiddleware</p>
<p>请求过来时，会先调用
handleRequest
方法，该方法完成：</p>
<p>调用
createContext
方法，对该次请求封装出一个
ctx
对象；</p>
<p>接着调用
this.handleRequest(ctx, fnMiddleware)
处理该次请求。</p>
<p>通过
fnMiddleware(ctx).then(handleResponse).catch(onerror)
执行中间件。</p>
<p>其中，一个核心过程就是使用
compose
方法组合各种中间件，其源码实现精简为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">function compose(middleware) {
</span></span><span class="line"><span class="cl">    // 这里返回的函数，就是上文中的 fnMiddleware
</span></span><span class="line"><span class="cl">    return function (context, next) {
</span></span><span class="line"><span class="cl">        let index = -1
</span></span><span class="line"><span class="cl">        return dispatch(0)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        function dispatch(i) {
</span></span><span class="line"><span class="cl">        	  // 
</span></span><span class="line"><span class="cl">            if (i &lt;= index) return Promise.reject(new Error(&#39;next() called multiple times&#39;))
</span></span><span class="line"><span class="cl">            index = i
</span></span><span class="line"><span class="cl">            // 取出第 i 个中间件为 fn
</span></span><span class="line"><span class="cl">            let fn = middleware[i]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            if (i === middleware.length) fn = next
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            // 已经取到了最后一个中间件，直接返回一个 Promise 实例，进行串联
</span></span><span class="line"><span class="cl">            // 这一步的意义是保证最后一个中间件调用 next 方法时，也不会报错
</span></span><span class="line"><span class="cl">            if (!fn) return Promise.resolve()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            try {
</span></span><span class="line"><span class="cl">                // 把 ctx 和 next 方法传入到中间件 fn 中，并将执行结果使用 Promise.resolve 包装
</span></span><span class="line"><span class="cl">                // 这里可以发现，我们在一个中间件中调用的 next 方法，其实就是dispatch.bind(null, i + 1)，即调用下一个中间件
</span></span><span class="line"><span class="cl">                return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
</span></span><span class="line"><span class="cl">            } catch (err) {
</span></span><span class="line"><span class="cl">                return Promise.reject(err)
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>源码实现中我已加入了相关注释，如果对于你来说还是晦涩难懂，不妨看一下下面这个 hard coding 的例子，通过下面代码，表示三个 Koa 中间件的执行情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">async function middleware1() {
</span></span><span class="line"><span class="cl">  ...
</span></span><span class="line"><span class="cl">  await (async function middleware2() {
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    await (async function middleware3() {
</span></span><span class="line"><span class="cl">      ...
</span></span><span class="line"><span class="cl">    });
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">  });
</span></span><span class="line"><span class="cl">  ...
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里我们来做一个简单的总结：</p>
<p>Koa 的中间件机制被社区形象地总结为洋葱模型；</p>
<p>所谓洋葱模型，就是指每一个 Koa 中间件都是一层洋葱圈，它即可以掌管请求进入，也可以掌管响应返回。换句话说：外层的中间件可以影响内层的请求和响应阶段，内层的中间件只能影响外层的响应阶段。</p>
<p>dispatch(n)
对应第 n 个中间件的执行，第 n 个中间件可以通过
await next()
来执行下一个中间件，同时在最后一个中间件执行完成后，依然有恢复执行的能力。即，通过洋葱模型，
await next()
控制调用 “下游”中间件，直到 “下游”没有中间件且堆栈执行完毕，最终流回“上游”中间件。这种方式有个优点，特别是对于日志记录以及错误处理等需要非常友好。</p>
<p>这里我们稍微做一下扩展，引申出 Koa v1 版本中中间件的实现，Koa1 的中间件实现利用了 Generator 函数 + co 库（一种基于 Promise 的 Generator 函数流程管理工具），来实现协程运行。本质上，Koa v1 版本中间件和 Koa v2 版本中间件思想是类似的，只不过 Koa v2 主要是用了 Async/Await 来替换 Generator 函数 + co 库，整体实现更加巧妙，代码更加优雅、简易。</p>
<p>对比 Express，再谈 Koa 中间件</p>
<p>说起 Node.js 框架，我们自然忘不了 Express.js。它的中间件机制同样值得我们学习、比对。Express 不同于 Koa，它继承了路由、静态服务器和模板引擎等功能，因此看上去比 Koa 更像是一个框架。通过学习 Express 源码，我们可以总结出它的工作机制。</p>
<p>通过
app.use
方法注册中间件。</p>
<p>一个中间件可以理解为一个 Layer 对象，其中包含了当前路由匹配的正则信息以及 handle 方法。</p>
<p>所有中间件（Layer 对象）使用
stack
数组存储起来。</p>
<p>因此，每个 Router 对象都是通过一个
stack
数组，存储了相关中间件函数。</p>
<p>当一个请求过来时，会从 REQ 中获取请求 path，根据 path 从
stack
中找到匹配的 Layer，具体匹配过程由
router.handle
函数实现。</p>
<p>router.handle
函数通过
next()
方法遍历每一个 layer 进行比对：</p>
<p>next()
方法通过闭包维持了对于 Stack Index 游标的引用，当调用
next()
方法时，就会从下一个中间件开始查找；</p>
<p>如果比对结果为 true，则调用
layer.handle_request
方法，
layer.handle_request
方法中会调用
next()
方法 ，实现中间件的执行。</p>
<p>我们将上述过程总结为下图，帮助你理解：</p>
<p>Express 工作机制</p>
<p>通过上述内容，我们可以看到，Express 的
next()
方法维护了遍历中间件列表的 Index 游标，中间件每次调用
next()
方法时，会通过增加 Index 游标的方式找到下一个中间件并执行。我们采用类似的 hard coding 形式帮助大家理解 Express 插件作用机制：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">((req, res) =&gt; {
</span></span><span class="line"><span class="cl">  console.log(&#39;第一个中间件&#39;);
</span></span><span class="line"><span class="cl">  ((req, res) =&gt; {
</span></span><span class="line"><span class="cl">    console.log(&#39;第二个中间件&#39;);
</span></span><span class="line"><span class="cl">    (async(req, res) =&gt; {
</span></span><span class="line"><span class="cl">      console.log(&#39;第三个中间件 =&gt; 是一个 route 中间件，处理 /api/test1&#39;);
</span></span><span class="line"><span class="cl">      await sleep(2000)
</span></span><span class="line"><span class="cl">      res.status(200).send(&#39;hello&#39;)
</span></span><span class="line"><span class="cl">    })(req, res)
</span></span><span class="line"><span class="cl">    console.log(&#39;第二个中间件调用结束&#39;);
</span></span><span class="line"><span class="cl">  })(req, res)
</span></span><span class="line"><span class="cl">  console.log(&#39;第一个中间件调用结束&#39;)
</span></span><span class="line"><span class="cl">})(req, res)
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上代码，Express 中间件设计并不是一个洋葱模型，它是基于回调实现的线形模型，不利于组合，不利于互操，在设计上并不像 Koa 一样简单。如果想实现一个记录请求响应的中间件，就需要：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">var</span> <span class="n">express</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">var</span> <span class="n">app</span> <span class="o">=</span> <span class="n">express</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">var</span> <span class="n">requestTime</span> <span class="o">=</span> <span class="n">function</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">req</span><span class="o">.</span><span class="n">requestTime</span> <span class="o">=</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="n">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">requestTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">function</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="n">responseText</span> <span class="o">=</span> <span class="s1">&#39;Hello World!&lt;br&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="n">responseText</span> <span class="o">+=</span> <span class="s1">&#39;&lt;small&gt;Requested at: &#39;</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="n">requestTime</span> <span class="o">+</span> <span class="s1">&#39;&lt;/small&gt;&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">responseText</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到，上述实现就对业务代码有一定程度的侵扰，甚至会造成不同中间件间的耦合。</p>
<p>我们回退到“上帝视角”发现，毫无疑问 Koa 的洋葱模型更加先进，而Express 的线形机制不容易实现拦截处理逻辑：比如异常处理和统计响应时间——这在 Koa 里，一般只需要一个中间件就能全部搞定。</p>
<p>当然，Koa 本身只提供了 HTTP 模块和洋葱模型的最小封装，Express 是一种更高形式的抽象，其设计思路和面向目标也有不同。</p>
<p>Redux 中间件设计和实现</p>
<p>通过前文，我们了解了 Node.js 两个当红框架的中间件设计，我们再换一个角度：从 Redux 这个状态管理方案的中间件设计，了解更全面的中间件系统。</p>
<p>类似 Koa 中的 koa-compose 实现，Redux 也实现了一个
compose
方法，完成中间件的注册和串联：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">function compose(...funcs: Function[]) {
</span></span><span class="line"><span class="cl">	return funcs.reduce((a, b) =&gt; (...args: any) =&gt; a(b(...args)));
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>compose
方法的执行效果如下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">compose([fn1, fn2, fn3])(args)
</span></span><span class="line"><span class="cl">=&gt;
</span></span><span class="line"><span class="cl">compose(fn1, fn2, fn3) (...args) = &gt; fn1(fn2(fn3(...args)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>简单来说，
compose
方法是一种高阶聚合，先执行 fn3，并将执行结果作为参数传给 fn2，以此类推。我们使用 Redux 创建一个 store 时，完成对
compose
方法的调用，Redux 精简源码类比为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="err">这是一个简单的打日志中间件</span>
</span></span><span class="line"><span class="cl"><span class="n">function</span> <span class="n">logger</span><span class="p">({</span> <span class="n">getState</span><span class="p">,</span> <span class="n">dispatch</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">next</span> <span class="err">代表下一个中间件包装过后的</span> <span class="n">dispatch</span> <span class="err">方法，</span><span class="n">action</span> <span class="err">表示当前接收到的动作</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">next</span> <span class="o">=&gt;</span> <span class="n">action</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&#34;before change&#34;</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">调用下一个中间件包装的</span> <span class="n">dispatch</span> 
</span></span><span class="line"><span class="cl">        <span class="n">let</span> <span class="n">val</span> <span class="o">=</span> <span class="n">next</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&#34;after change&#34;</span><span class="p">,</span> <span class="n">getState</span><span class="p">(),</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">使用</span> <span class="n">logger</span> <span class="err">中间件，创建一个增强的</span> <span class="n">store</span>
</span></span><span class="line"><span class="cl"><span class="n">let</span> <span class="n">createStoreWithMiddleware</span> <span class="o">=</span> <span class="n">Redux</span><span class="o">.</span><span class="n">applyMiddleware</span><span class="p">(</span><span class="n">logger</span><span class="p">)(</span><span class="n">Redux</span><span class="o">.</span><span class="n">createStore</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">function</span> <span class="n">applyMiddleware</span><span class="p">(</span><span class="o">...</span><span class="n">middlewares</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">middlewares</span> <span class="err">为中间件列表，返回一个接受原始</span> <span class="n">createStore</span> <span class="err">方法（</span><span class="n">Redux</span><span class="o">.</span><span class="n">createStore</span><span class="err">）作为参数的函数</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">createStore</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="o">...</span><span class="n">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">创建原始的</span> <span class="n">store</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">store</span> <span class="o">=</span> <span class="n">createStore</span><span class="p">(</span><span class="o">...</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">每个中间件都会被传入</span> <span class="n">middlewareAPI</span> <span class="err">对象，作为中间件参数</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">middlewareAPI</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">getState</span><span class="p">:</span> <span class="n">store</span><span class="o">.</span><span class="n">getState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">dispatch</span><span class="p">:</span> <span class="p">(</span><span class="o">...</span><span class="n">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">dispatch</span><span class="p">(</span><span class="o">...</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">给每个中间件传入</span> <span class="n">middlewareAPI</span> <span class="err">参数</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">中间件的统一模板为</span> <span class="n">next</span> <span class="o">=&gt;</span> <span class="n">action</span> <span class="o">=&gt;</span> <span class="n">next</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="err">格式</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">chain</span> <span class="err">中保存的都是</span> <span class="n">next</span> <span class="o">=&gt;</span> <span class="n">action</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">next</span><span class="p">(</span><span class="n">action</span><span class="p">)}</span> <span class="err">的方法</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">middlewares</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">middleware</span> <span class="o">=&gt;</span> <span class="n">middleware</span><span class="p">(</span><span class="n">middlewareAPI</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">传入最原始</span> <span class="n">store</span><span class="o">.</span><span class="n">dispatch</span> <span class="err">方法，作为</span> <span class="n">compose</span> <span class="err">二级参数，</span><span class="n">compose</span> <span class="err">方法最终返回一个增强的</span><span class="n">dispatch</span> <span class="err">方法</span>
</span></span><span class="line"><span class="cl">    <span class="n">dispatch</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="o">...</span><span class="n">chain</span><span class="p">)(</span><span class="n">store</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span><span class="n">store</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">dispatch</span>  <span class="o">//</span> <span class="err">返回一个增强版的</span> <span class="n">dispatch</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上代码，我们将 Redux 中间件特点总结为：</p>
<p>Redux 中间件接收
getState
和
dispatch
两个方法组成的对象作为参数；</p>
<p>Redux 中间件返回一个函数，该函数接收下一个
next
方法作为参数，并返回一个接收 action 的新的
dispatch
方法；</p>
<p>Redux 中间件通过手动调用
next(action)
方法，执行下一个中间件。</p>
<p>我们将 Redux 的中间件作用机制总结为下图：</p>
<p>Redux 的中间件作用机制</p>
<p>看上去也像是一个洋葱圈模型，但是对于同步调用和异步调用稍有不同，以三个中间件为例。</p>
<p>三个中间件均是正常同步调用
next(action)
，则执行顺序为：中间件 1 before next → 中间件 2 before next → 中间件 3 before next → dispatch 方法调用 → 中间件 3 after next → 中间件 2 after next → 中间件 1 after next。</p>
<p>第二个中间件没有调用
next(action)
，则执行顺序为：中间件 1 befoe next → 中间件 2 逻辑 → 中间件 1 after next，注意此时中间件 3 没有被执行。</p>
<p>第二个中间件异步调用
next(action)
，其他中间件均是正常同步调用
nextt(action)
，则执行顺序为：中间件 1 before next → 中间件 2 同步代码部分 → 中间件 1 after next → 中间件 2 异步代码部分 before next → 中间件 3 before next → dispatch 方法调用 → 中间件 3 after next → 中间件 2 异步代码部分 after next。</p>
<p>利用中间件思想，实现一个中间件化的 Fetch 库</p>
<p>上面我们分析了前端中的中间件化思想，这一部分，我们活学活用，利用中间件思路，结合上一讲内容，实现一个中间件化的 Fetch 库。</p>
<p>我们先来思考一个中间件化的 Fetch 库有哪些优点呢？Fetch 库的核心实现请求的发送，而各种业务逻辑以中间件化的插件模式进行增强，这样一来，实现了特定业务需求和请求库的解耦，更加灵活，也是一种分层思想的体现。具体来说，一个中间件化的 Fetch 库：</p>
<p>支持业务方递归扩展底层 Fetch API 能力；</p>
<p>方便测试；</p>
<p>一个中间件化的 Fetch 库，天然支持各类型的 Fetch 封装（比如 Native Fetch、fetch-ponyfill、fetch-polyfill 等）。</p>
<p>我们给这个中间件化的 Fetch 库取名为：fetch-wrap，借助 fetch-wrap 的实现，预期使用方式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">const</span> <span class="n">fetchWrap</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;fetch-wrap&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">这里可以接入自己的核心</span> <span class="n">Fetch</span> <span class="err">底层实现，比如使用原生</span> <span class="n">Fetch</span><span class="err">，或同构的</span> <span class="n">isomorphic</span><span class="o">-</span><span class="n">fetch</span> <span class="err">等</span>
</span></span><span class="line"><span class="cl"><span class="n">let</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;isomorphic-fetch&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">扩展</span> <span class="n">Fetch</span> <span class="err">中间件</span>
</span></span><span class="line"><span class="cl"><span class="n">fetch</span> <span class="o">=</span> <span class="n">fetchWrap</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="n">middleware1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">middleware2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">middleware3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">一个典型的中间件</span>
</span></span><span class="line"><span class="cl"><span class="n">function</span> <span class="n">middleware1</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">innerFetch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="err">业务扩展</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">innerFetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">一个更改</span> <span class="n">URL</span> <span class="err">的中间件</span>
</span></span><span class="line"><span class="cl"><span class="n">function</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">fetch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">modify</span> <span class="n">url</span> <span class="ow">or</span> <span class="n">options</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">/^</span><span class="p">(</span><span class="n">http</span><span class="p">:)</span><span class="err">?</span><span class="o">/</span><span class="p">,</span> <span class="s1">&#39;https:&#39;</span><span class="p">),</span> <span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">一个修改返回结果的中间件</span>
</span></span><span class="line"><span class="cl"><span class="n">function</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">fetch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="n">statusText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="o">/</span><span class="n">application</span>\<span class="o">/</span><span class="n">json</span><span class="o">/.</span><span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	  <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">一个做错误处理的中间件</span>
</span></span><span class="line"><span class="cl"><span class="n">function</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">fetch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">catch</span> <span class="n">errors</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="n">throw</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>核心实现也不困难，观察
fetchWrap
使用方式，我们实现源码为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="err">接受第一个参数为基础</span> <span class="n">Fetch</span><span class="err">，第二个参数为中间件数组或单个中间件</span>
</span></span><span class="line"><span class="cl"><span class="n">module</span><span class="o">.</span><span class="n">exports</span> <span class="o">=</span> <span class="n">function</span> <span class="n">fetchWrap</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="n">middleware</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">没有使用中间件，则返回原生</span> <span class="n">fetch</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">middleware</span> <span class="o">||</span> <span class="n">middleware</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fetch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="err">递归调用</span> <span class="n">extend</span> <span class="err">方法，每次递归时剔除出</span> <span class="n">middleware</span> <span class="err">数组中的首项</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">innerFetch</span> <span class="o">=</span> <span class="n">middleware</span><span class="o">.</span><span class="n">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="err">?</span> <span class="n">fetch</span> <span class="p">:</span> <span class="n">fetchWrap</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="n">middleware</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">next</span> <span class="o">=</span> <span class="n">middleware</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">function</span> <span class="n">extendedFetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		  <span class="o">//</span> <span class="err">每一个</span> <span class="n">Fetch</span> <span class="err">中间件通过</span> <span class="n">Promsie</span> <span class="err">来串联</span>
</span></span><span class="line"><span class="cl">		  <span class="k">return</span> <span class="n">Promise</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">next</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">options</span> <span class="o">||</span> <span class="p">{},</span> <span class="n">innerFetch</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		  <span class="k">return</span> <span class="n">Promise</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到，每一个中间件都接收一个
url
和
options
参数，因此具有了改写
url
和
options
的能力；同时接收一个
innerFetch
方法，
innerFetch
为上一个中间件包装过的
fetch
方法，而每一个中间件也都返回一个包装过的
fetch
方法，将各个中间件依次调用串联。</p>
<p>另外，社区上的 umi-request 的中间件机制也是类似的，其核心代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">class</span> <span class="n">Onion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">middlewares</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="err">存储中间件</span>
</span></span><span class="line"><span class="cl">  <span class="n">use</span><span class="p">(</span><span class="n">newMiddleware</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">middlewares</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">newMiddleware</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="err">执行中间件</span>
</span></span><span class="line"><span class="cl">  <span class="n">execute</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">middlewares</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">default</span> <span class="n">function</span> <span class="n">compose</span><span class="p">(</span><span class="n">middlewares</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">function</span> <span class="n">wrapMiddlewares</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">let</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">function</span> <span class="n">dispatch</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">middlewares</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="p">)</span> <span class="k">return</span> <span class="n">Promise</span><span class="o">.</span><span class="n">resolve</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">Promise</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">dispatch</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dispatch</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到，上述源码更像 Koa 的实现了，但其实道理和上面的 fetch-wrap 大同小异。至此，相信你已经了解了中间件的思想，也能够体会洋葱模型的精妙设计。</p>
<p>总结</p>
<p>这一讲，我们通过分析前端不同框架的中间件设计，剖析了中间件化这一重要思想。中间件化意味着插件化，这也是上一讲提到的分层思想的一种实现，同时，这种实现思路灵活且扩展能力强，能够和核心逻辑相解耦，需要你细心体会。</p>
<p>本讲主要内容如下：</p>
<p>在下一讲中，我们将继续围绕着代码设计中的灵活性和定制性这一话题展开，同时也给大家留一个思考题：你在平时开发中，见过或者使用过哪些插件化的工程或技术呢？欢迎在留言区和我分享你的观点，我们下一讲再见。</p>
<p>-&ndash; ### 精选评论 ##### **伦： &gt; 插件化还是比较常见的，比如常用的 eggjs,webpack，最近在看的技术比如 LogicFlow antv/x6</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80%E5%BB%BA%E8%AE%BE%E4%B8%8E%E6%9E%B6%E6%9E%8430%E8%AE%B2/">前端基础建设与架构30讲</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/go%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%9838%E8%AE%B2/18%E6%A1%88%E4%BE%8Bgo-kit%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90grpc/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">18案例：Go-kit如何集成gRPC？</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/24%E8%AE%B2%E5%90%83%E9%80%8F%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/18%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B8%8A%E9%99%A4%E4%BA%86xa%E8%BF%98%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8E%9F%E5%AD%90%E6%8F%90%E4%BA%A4%E7%AE%97%E6%B3%95%E5%90%97/">
            <span class="next-text nav-default">18分布式事务（上）：除了XA，还有哪些原子提交算法吗？</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
