<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>33__字符设备（下）：如何建立直销模式？ - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="上一节，我们讲了一个设备能够被打开、能够读写，主流的功能基本就完成了。我们讲输出输出设备的时候说到，如果一个设备有事情需要通知操作系统，会通过中断和设备驱动程序进行交互，今天我们就来解析中断处理机制。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/33__%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E4%B8%8B%E5%A6%82%E4%BD%95%E5%BB%BA%E7%AB%8B%E7%9B%B4%E9%94%80%E6%A8%A1%E5%BC%8F/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/33__%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E4%B8%8B%E5%A6%82%E4%BD%95%E5%BB%BA%E7%AB%8B%E7%9B%B4%E9%94%80%E6%A8%A1%E5%BC%8F/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="33__字符设备（下）：如何建立直销模式？">
  <meta property="og:description" content="上一节，我们讲了一个设备能够被打开、能够读写，主流的功能基本就完成了。我们讲输出输出设备的时候说到，如果一个设备有事情需要通知操作系统，会通过中断和设备驱动程序进行交互，今天我们就来解析中断处理机制。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="趣谈Linux操作系统">

  <meta itemprop="name" content="33__字符设备（下）：如何建立直销模式？">
  <meta itemprop="description" content="上一节，我们讲了一个设备能够被打开、能够读写，主流的功能基本就完成了。我们讲输出输出设备的时候说到，如果一个设备有事情需要通知操作系统，会通过中断和设备驱动程序进行交互，今天我们就来解析中断处理机制。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="6477">
  <meta itemprop="keywords" content="趣谈Linux操作系统">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="33__字符设备（下）：如何建立直销模式？">
  <meta name="twitter:description" content="上一节，我们讲了一个设备能够被打开、能够读写，主流的功能基本就完成了。我们讲输出输出设备的时候说到，如果一个设备有事情需要通知操作系统，会通过中断和设备驱动程序进行交互，今天我们就来解析中断处理机制。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">33__字符设备（下）：如何建立直销模式？</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 6477 字 </span>
          <span class="more-meta"> 预计阅读 13 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#总结时刻">总结时刻</a></li>
        <li><a href="#课堂练习">课堂练习</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>上一节，我们讲了一个设备能够被打开、能够读写，主流的功能基本就完成了。我们讲输出输出设备的时候说到，如果一个设备有事情需要通知操作系统，会通过中断和设备驱动程序进行交互，今天我们就来解析中断处理机制。</p>
<p>鼠标就是通过中断，将自己的位置和按键信息，传递给设备驱动程序。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static int logibm_open(struct input_dev *dev)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if (request_irq(logibm_irq, logibm_interrupt, 0, &#34;logibm&#34;, NULL)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		printk(KERN_ERR &#34;logibm.c: Can&#39;t allocate irq %d\n&#34;, logibm_irq);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		return -EBUSY;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	outb(LOGIBM_ENABLE_IRQ, LOGIBM_CONTROL_PORT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  static irqreturn_t logibm_interrupt(int irq, void *dev_id)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	char dx, dy;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	unsigned char buttons;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	outb(LOGIBM_READ_X_LOW, LOGIBM_CONTROL_PORT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	dx = (inb(LOGIBM_DATA_PORT) &amp; 0xf);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	outb(LOGIBM_READ_X_HIGH, LOGIBM_CONTROL_PORT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	dx |= (inb(LOGIBM_DATA_PORT) &amp; 0xf) &lt;&lt; 4;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	outb(LOGIBM_READ_Y_LOW, LOGIBM_CONTROL_PORT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	dy = (inb(LOGIBM_DATA_PORT) &amp; 0xf);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	outb(LOGIBM_READ_Y_HIGH, LOGIBM_CONTROL_PORT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	buttons = inb(LOGIBM_DATA_PORT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	dy |= (buttons &amp; 0xf) &lt;&lt; 4;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	buttons = ~buttons &gt;&gt; 5;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	input_report_rel(logibm_dev, REL_X, dx);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	input_report_rel(logibm_dev, REL_Y, dy);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	input_report_key(logibm_dev, BTN_RIGHT,  buttons &amp; 1);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	input_report_key(logibm_dev, BTN_MIDDLE, buttons &amp; 2);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	input_report_key(logibm_dev, BTN_LEFT,   buttons &amp; 4);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	input_sync(logibm_dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	outb(LOGIBM_ENABLE_IRQ, LOGIBM_CONTROL_PORT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return IRQ_HANDLED
</span></span></code></pre></td></tr></table>
</div>
</div><p>要处理中断，需要有一个中断处理函数。定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">irq_handler_t</span><span class="p">)(</span><span class="ne">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span> <span class="n">dev_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/**</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="k">enum</span> <span class="n">irqreturn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">IRQ_NONE</span>		<span class="n">interrupt</span> <span class="n">was</span> <span class="ow">not</span> <span class="n">from</span> <span class="n">this</span> <span class="n">device</span> <span class="ow">or</span> <span class="n">was</span> <span class="ow">not</span> <span class="n">handled</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">IRQ_HANDLED</span>		<span class="n">interrupt</span> <span class="n">was</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">this</span> <span class="n">device</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">IRQ_WAKE_THREAD</span>	<span class="n">handler</span> <span class="n">requests</span> <span class="n">to</span> <span class="n">wake</span> <span class="n">the</span> <span class="n">handler</span> <span class="n">thread</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">irqreturn</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">IRQ_NONE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">IRQ_HANDLED</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">IRQ_WAKE_THREAD</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，irq 是一个整数，是中断信号。dev_id 是一个 void * 的通用指针，主要用于区分同一个中断处理函数对于不同设备的处理。</p>
<p>这里的返回值有三种：IRQ_NONE 表示不是我的中断，不归我管；IRQ_HANDLED 表示处理完了的中断；IRQ_WAKE_THREAD 表示有一个进程正在等待这个中断，中断处理完了，应该唤醒它。</p>
<p>上面的例子中，logibm_interrupt 这个中断处理函数，先是获取了 x 和 y 的移动坐标，以及左中右的按键，上报上去，然后返回 IRQ_HANDLED，这表示处理完毕。</p>
<p>其实，写一个真正生产用的中断处理程序还是很复杂的。当一个中断信号 A 触发后，正在处理的过程中，这个中断信号 A 是应该暂时关闭的，这样是为了防止再来一个中断信号 A，在当前的中断信号 A 的处理过程中插一杠子。但是，这个暂时关闭的时间应该多长呢？</p>
<p>如果太短了，应该原子化处理完毕的没有处理完毕，又被另一个中断信号 A 中断了，很多操作就不正确了；如果太长了，一直关闭着，新的中断信号 A 进不来，系统就显得很慢。所以，很多中断处理程序将整个中断要做的事情分成两部分，称为上半部和下半部，或者成为关键处理部分和延迟处理部分。在中断处理函数中，仅仅处理关键部分，完成了就将中断信号打开，使得新的中断可以进来，需要比较长时间处理的部分，也即延迟部分，往往通过工作队列等方式慢慢处理。</p>
<p>这个写起来可以是一本书了，推荐你好好读一读《Linux Device Drivers》这本书，这里我就不详细介绍了。</p>
<p>有了中断处理函数，接下来要调用 request_irq 来注册这个中断处理函数。request_irq 有这样几个参数：</p>
<ul>
<li>unsigned int irq 是中断信号；</li>
<li>irq_handler_t handler 是中断处理函数；</li>
<li>unsigned long flags 是一些标识位；</li>
<li>const char *name 是设备名称；</li>
<li>void *dev 这个通用指针应该和中断处理函数的 void *dev 相对应。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">inline</span> <span class="ne">int</span> <span class="n">__must_check</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">request_irq</span><span class="p">(</span><span class="n">unsigned</span> <span class="ne">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>中断处理函数被注册到哪里去呢？让我们沿着 request_irq 看下去。request_irq 调用的是 request_threaded_irq。代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">unsigned</span> <span class="ne">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			 <span class="n">irq_handler_t</span> <span class="n">thread_fn</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="n">irqflags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			 <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">irqaction</span> <span class="o">*</span><span class="n">action</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span> <span class="n">retval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">desc</span> <span class="o">=</span> <span class="n">irq_to_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">action</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">struct</span> <span class="n">irqaction</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">action</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">action</span><span class="o">-&gt;</span><span class="n">thread_fn</span> <span class="o">=</span> <span class="n">thread_fn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">action</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">irqflags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">action</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">devname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">action</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">retval</span> <span class="o">=</span> <span class="n">__setup_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于每一个中断，都有一个对中断的描述结构 struct irq_desc。它有一个重要的成员变量是 struct irqaction，用于表示处理这个中断的动作。如果我们仔细看这个结构，会发现，它里面有 next 指针，也就是说，这是一个链表，对于这个中断的所有处理动作，都串在这个链表上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">struct</span> <span class="n">irq_desc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">irqaction</span>	<span class="o">*</span><span class="n">action</span><span class="p">;</span>	<span class="o">/*</span> <span class="n">IRQ</span> <span class="n">action</span> <span class="n">list</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">module</span>		<span class="o">*</span><span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">/**</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">struct</span> <span class="n">irqaction</span> <span class="o">-</span> <span class="n">per</span> <span class="n">interrupt</span> <span class="n">action</span> <span class="n">descriptor</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">handler</span><span class="p">:</span>	<span class="n">interrupt</span> <span class="n">handler</span> <span class="n">function</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">name</span><span class="p">:</span>	<span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">dev_id</span><span class="p">:</span>	<span class="n">cookie</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">device</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">percpu_dev_id</span><span class="p">:</span>	<span class="n">cookie</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">device</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">next</span><span class="p">:</span>	<span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">next</span> <span class="n">irqaction</span> <span class="k">for</span> <span class="n">shared</span> <span class="n">interrupts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">irq</span><span class="p">:</span>	<span class="n">interrupt</span> <span class="n">number</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">flags</span><span class="p">:</span>	<span class="n">flags</span> <span class="p">(</span><span class="n">see</span> <span class="n">IRQF_</span><span class="o">*</span> <span class="n">above</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">thread_fn</span><span class="p">:</span>	<span class="n">interrupt</span> <span class="n">handler</span> <span class="n">function</span> <span class="k">for</span> <span class="n">threaded</span> <span class="n">interrupts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">thread</span><span class="p">:</span>	<span class="n">thread</span> <span class="n">pointer</span> <span class="k">for</span> <span class="n">threaded</span> <span class="n">interrupts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">secondary</span><span class="p">:</span>	<span class="n">pointer</span> <span class="n">to</span> <span class="n">secondary</span> <span class="n">irqaction</span> <span class="p">(</span><span class="n">force</span> <span class="n">threading</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">thread_flags</span><span class="p">:</span>	<span class="n">flags</span> <span class="n">related</span> <span class="n">to</span> <span class="err">@</span><span class="n">thread</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">thread_mask</span><span class="p">:</span>	<span class="n">bitmask</span> <span class="k">for</span> <span class="n">keeping</span> <span class="n">track</span> <span class="n">of</span> <span class="err">@</span><span class="n">thread</span> <span class="n">activity</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="err">@</span><span class="n">dir</span><span class="p">:</span>	<span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">proc</span><span class="o">/</span><span class="n">irq</span><span class="o">/</span><span class="n">NN</span><span class="o">/</span><span class="n">name</span> <span class="n">entry</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">struct</span> <span class="n">irqaction</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">irq_handler_t</span>		<span class="n">handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">void</span>			<span class="o">*</span><span class="n">dev_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">void</span> <span class="n">__percpu</span>		<span class="o">*</span><span class="n">percpu_dev_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">irqaction</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">irq_handler_t</span>		<span class="n">thread_fn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">task_struct</span>	<span class="o">*</span><span class="n">thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">irqaction</span>	<span class="o">*</span><span class="n">secondary</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span>		<span class="n">irq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span>		<span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span>		<span class="n">thread_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span>		<span class="n">thread_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">proc_dir_entry</span>	<span class="o">*</span><span class="n">dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>每一个中断处理动作的结构 struct irqaction，都有以下成员：</p>
<ul>
<li>中断处理函数 handler；</li>
<li>void *dev_id 为设备 id；</li>
<li>irq 为中断信号；</li>
<li>如果中断处理函数在单独的线程运行，则有 thread_fn 是线程的执行函数，thread 是线程的 task_struct。</li>
</ul>
<p>在 request_threaded_irq 函数中，irq_to_desc 根据中断信号查找中断描述结构。如何查找呢？这就要区分情况。一般情况下，所有的 struct irq_desc 都放在一个数组里面，我们直接按下标查找就可以了。如果配置了 CONFIG_SPARSE_IRQ，那中断号是不连续的，就不适合用数组保存了，</p>
<p>我们可以放在一棵基数树上。我们不是第一次遇到这个数据结构了。这种结构对于从某个整型 key 找到 value 速度很快，中断信号 irq 是这个整数。通过它，我们很快就能定位到对应的 struct irq_desc。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef CONFIG_SPARSE_IRQ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static RADIX_TREE(irq_desc_tree, GFP_KERNEL);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">struct irq_desc *irq_to_desc(unsigned int irq)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return radix_tree_lookup(&amp;irq_desc_tree, irq);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#else /* !CONFIG_SPARSE_IRQ */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">struct irq_desc irq_desc[NR_IRQS] __cacheline_aligned_in_smp = {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	[0 ... NR_IRQS-1] = {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">};
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">struct irq_desc *irq_to_desc(unsigned int irq)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return (irq &lt; NR_IRQS) ? irq_desc + irq : NULL;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#endif /* !CONFIG_SPARSE_IRQ */
</span></span></code></pre></td></tr></table>
</div>
</div><p>为什么中断信号会有稀疏，也就是不连续的情况呢？这里需要说明一下，这里的 irq 并不是真正的、物理的中断信号，而是一个抽象的、虚拟的中断信号。因为物理的中断信号和硬件关联比较大，中断控制器也是各种各样的。</p>
<p>作为内核，我们不可能写程序的时候，适配各种各样的硬件中断控制器，因而就需要有一层中断抽象层。这里虚拟中断信号到中断描述结构的映射，就是抽象中断层的主要逻辑。</p>
<p>下面我们讲真正中断响应的时候，会涉及物理中断信号。可以想象，如果只有一个 CPU，一个中断控制器，则基本能够保证从物理中断信号到虚拟中断信号的映射是线性的，这样用数组表示就没啥问题，但是如果有多个 CPU，多个中断控制器，每个中断控制器各有各的物理中断信号，就没办法保证虚拟中断信号是连续的，所以就要用到基数树了。</p>
<p>接下来，request_threaded_irq 函数分配了一个 struct irqaction，并且初始化它，接着调用 __setup_irq。在这个函数里面，如果 struct irq_desc 里面已经有 struct irqaction 了，我们就将新的 struct irqaction 挂在链表的末端。如果设定了以单独的线程运行中断处理函数，setup_irq_thread 就会创建这个内核线程，wake_up_process 会唤醒它。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static int
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">__setup_irq(unsigned int irq, struct irq_desc *desc, struct irqaction *new)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct irqaction *old, **old_ptr;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	unsigned long flags, thread_mask = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int ret, nested, shared = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	new-&gt;irq = irq;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	/*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 * Create a handler thread when a thread function is supplied
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 * and the interrupt does not nest into another interrupt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 * thread.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if (new-&gt;thread_fn &amp;&amp; !nested) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		ret = setup_irq_thread(new, irq, false);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	old_ptr = &amp;desc-&gt;action;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	old = *old_ptr;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if (old) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		/* add new interrupt at end of irq queue */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		do {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			thread_mask |= old-&gt;thread_mask;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			old_ptr = &amp;old-&gt;next;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			old = *old_ptr;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		} while (old);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	*old_ptr = new;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if (new-&gt;thread)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		wake_up_process(new-&gt;thread);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  static int
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">setup_irq_thread(struct irqaction *new, unsigned int irq, bool secondary)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct task_struct *t;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct sched_param param = {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		.sched_priority = MAX_USER_RT_PRIO/2,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	};
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	t = kthread_create(irq_thread, new, &#34;irq/%d-%s&#34;, irq, new-&gt;name);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	sched_setscheduler_nocheck(t, SCHED_FIFO, &amp;param);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	get_task_struct(t);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	new-&gt;thread = t;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return 0;
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此为止，request_irq 完成了它的使命。总结来说，它就是根据中断信号 irq，找到基数树上对应的 irq_desc，然后将新的 irqaction 挂在链表上。</p>
<p>接下来，我们就来看，真正中断来了的时候，会发生一些什么。</p>
<p>真正中断的发生还是要从硬件开始。这里面有四个层次。</p>
<ul>
<li>第一个层次是外部设备给中断控制器发送物理中断信号。</li>
<li>第二个层次是中断控制器将物理中断信号转换成为中断向量 interrupt vector，发给各个 CPU。</li>
<li>第三个层次是每个 CPU 都会有一个中断向量表，根据 interrupt vector 调用一个 IRQ 处理函数。注意这里的 IRQ 处理函数还不是咱们上面指定的 irq_handler_t，到这一层还是 CPU 硬件的要求。</li>
<li>第四个层次是在 IRQ 处理函数中，将 interrupt vector 转化为抽象中断层的中断信号 irq，调用中断信号 irq 对应的中断描述结构里面的 irq_handler_t。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/c6f60ac30f9a92722931064a7575df30.png" alt=""></p>
<p>在这里，我们不解析硬件的部分，我们从 CPU 收到中断向量开始分析。</p>
<p>CPU 收到的中断向量是什么样的呢？这个定义在文件 arch/x86/include/asm/irq_vectors.h 中。这里面的注释非常好，建议你仔细阅读。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Linux</span> <span class="n">IRQ</span> <span class="n">vector</span> <span class="n">layout</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">There</span> <span class="n">are</span> <span class="mi">256</span> <span class="n">IDT</span> <span class="n">entries</span> <span class="p">(</span><span class="n">per</span> <span class="n">CPU</span> <span class="o">-</span> <span class="n">each</span> <span class="n">entry</span> <span class="n">is</span> <span class="mi">8</span> <span class="n">bytes</span><span class="p">)</span> <span class="n">which</span> <span class="n">can</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">be</span> <span class="n">defined</span> <span class="n">by</span> <span class="n">Linux</span><span class="o">.</span> <span class="n">They</span> <span class="n">are</span> <span class="n">used</span> <span class="n">as</span> <span class="n">a</span> <span class="n">jump</span> <span class="n">table</span> <span class="n">by</span> <span class="n">the</span> <span class="n">CPU</span> <span class="n">when</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">given</span> <span class="n">vector</span> <span class="n">is</span> <span class="n">triggered</span> <span class="o">-</span> <span class="n">by</span> <span class="n">a</span> <span class="n">CPU</span><span class="o">-</span><span class="n">external</span><span class="p">,</span> <span class="n">CPU</span><span class="o">-</span><span class="n">internal</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">software</span><span class="o">-</span><span class="n">triggered</span> <span class="n">event</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Linux</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">kernel</span> <span class="n">code</span> <span class="n">address</span> <span class="n">each</span> <span class="n">entry</span> <span class="n">jumps</span> <span class="n">to</span> <span class="n">early</span> <span class="n">during</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">bootup</span><span class="p">,</span> <span class="ow">and</span> <span class="n">never</span> <span class="n">changes</span> <span class="n">them</span><span class="o">.</span> <span class="n">This</span> <span class="n">is</span> <span class="n">the</span> <span class="n">general</span> <span class="n">layout</span> <span class="n">of</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">IDT</span> <span class="n">entries</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>  <span class="n">Vectors</span>   <span class="mi">0</span> <span class="o">...</span>  <span class="mi">31</span> <span class="p">:</span> <span class="n">system</span> <span class="n">traps</span> <span class="ow">and</span> <span class="n">exceptions</span> <span class="o">-</span> <span class="n">hardcoded</span> <span class="n">events</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>  <span class="n">Vectors</span>  <span class="mi">32</span> <span class="o">...</span> <span class="mi">127</span> <span class="p">:</span> <span class="n">device</span> <span class="n">interrupts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>  <span class="n">Vector</span>  <span class="mi">128</span>         <span class="p">:</span> <span class="n">legacy</span> <span class="n">int80</span> <span class="n">syscall</span> <span class="n">interface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>  <span class="n">Vectors</span> <span class="mi">129</span> <span class="o">...</span> <span class="n">INVALIDATE_TLB_VECTOR_START</span><span class="o">-</span><span class="mi">1</span> <span class="n">except</span> <span class="mi">204</span> <span class="p">:</span> <span class="n">device</span> <span class="n">interrupts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>  <span class="n">Vectors</span> <span class="n">INVALIDATE_TLB_VECTOR_START</span> <span class="o">...</span> <span class="mi">255</span> <span class="p">:</span> <span class="n">special</span> <span class="n">interrupts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">x86</span> <span class="n">has</span> <span class="n">per</span> <span class="n">CPU</span> <span class="n">IDT</span> <span class="n">tables</span><span class="p">,</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">has</span> <span class="n">one</span> <span class="n">shared</span> <span class="n">IDT</span> <span class="n">table</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">This</span> <span class="n">file</span> <span class="n">enumerates</span> <span class="n">the</span> <span class="n">exact</span> <span class="n">layout</span> <span class="n">of</span> <span class="n">them</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define FIRST_EXTERNAL_VECTOR		0x20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define IA32_SYSCALL_VECTOR		0x80</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define NR_VECTORS			 256</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define FIRST_SYSTEM_VECTOR		NR_VECTORS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过这些注释，我们可以看出，CPU 能够处理的中断总共 256 个，用宏 NR_VECTOR 或者 FIRST_SYSTEM_VECTOR 表示。</p>
<p>为了处理中断，CPU 硬件要求每一个 CPU 都有一个中断向量表，通过 load_idt 加载，里面记录着每一个中断对应的处理方法，这个中断向量表定义在文件 arch/x86/kernel/traps.c 中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gate_desc idt_table[NR_VECTORS] __page_aligned_bss;
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于一个 CPU 可以处理的中断被分为几个部分，第一部分 0 到 31 的前 32 位是系统陷入或者系统异常，这些错误无法屏蔽，一定要处理。</p>
<p>这些中断的处理函数在系统初始化的时候，在 start_kernel 函数中调用过 trap_init()。这个咱们讲系统初始化和系统调用的时候，都大概讲过这个函数，这里还需要仔细看一下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">__init</span> <span class="n">trap_init</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">set_intr_gate</span><span class="p">(</span><span class="n">X86_TRAP_DE</span><span class="p">,</span> <span class="n">divide_error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">各种各样的</span> <span class="n">set_intr_gate</span><span class="err">，不都贴在这里了，只贴一头一尾</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">set_intr_gate</span><span class="p">(</span><span class="n">X86_TRAP_XF</span><span class="p">,</span> <span class="n">simd_coprocessor_error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="o">/*</span> <span class="n">Reserve</span> <span class="n">all</span> <span class="n">the</span> <span class="n">builtin</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">syscall</span> <span class="n">vector</span><span class="p">:</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIRST_EXTERNAL_VECTOR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">used_vectors</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">#ifdef CONFIG_X86_32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">set_system_intr_gate</span><span class="p">(</span><span class="n">IA32_SYSCALL_VECTOR</span><span class="p">,</span> <span class="n">entry_INT80_32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">set_bit</span><span class="p">(</span><span class="n">IA32_SYSCALL_VECTOR</span><span class="p">,</span> <span class="n">used_vectors</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="o">/*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">IDT</span> <span class="n">descriptor</span> <span class="n">to</span> <span class="n">a</span> <span class="n">fixed</span> <span class="n">read</span><span class="o">-</span><span class="n">only</span> <span class="n">location</span><span class="p">,</span> <span class="n">so</span> <span class="n">that</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="s2">&#34;sidt&#34;</span> <span class="n">instruction</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">leak</span> <span class="n">the</span> <span class="n">location</span> <span class="n">of</span> <span class="n">the</span> <span class="n">kernel</span><span class="p">,</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">to</span> <span class="n">defend</span> <span class="n">the</span> <span class="n">IDT</span> <span class="n">against</span> <span class="n">arbitrary</span> <span class="n">memory</span> <span class="n">write</span> <span class="n">vulnerabilities</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reloaded</span> <span class="ow">in</span> <span class="n">cpu_init</span><span class="p">()</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">__set_fixmap</span><span class="p">(</span><span class="n">FIX_RO_IDT</span><span class="p">,</span> <span class="n">__pa_symbol</span><span class="p">(</span><span class="n">idt_table</span><span class="p">),</span> <span class="n">PAGE_KERNEL_RO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">idt_descr</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">fix_to_virt</span><span class="p">(</span><span class="n">FIX_RO_IDT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我这里贴的代码省略了很多，在 trap_init 函数的一开始，调用了大量的 set_intr_gate，最终都会调用 _set_gate，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static inline void _set_gate(int gate, unsigned type, void *addr,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			     unsigned dpl, unsigned ist, unsigned seg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	gate_desc s;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	pack_gate(&amp;s, type, (unsigned long)addr, dpl, ist, seg);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	write_idt_entry(idt_table, gate, &amp;s);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>从代码可以看出，set_intr_gate 其实就是将每个中断都设置了中断处理函数，放在中断向量表 idt_table 中。</p>
<p>在 trap_init 中，由于 set_intr_gate 调用的太多，容易让人眼花缭乱。其实 arch/x86/include/asm/traps.h 文件中，早就定义好了前 32 个中断。如果仔细对比一下，你会发现，这些都在 trap_init 中使用 set_intr_gate 设置过了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Interrupts</span><span class="o">/</span><span class="n">Exceptions</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_DE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="o">/*</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">Divide</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">zero</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_DB</span><span class="p">,</span>		<span class="o">/*</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">Debug</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_NMI</span><span class="p">,</span>		<span class="o">/*</span>  <span class="mi">2</span><span class="p">,</span> <span class="n">Non</span><span class="o">-</span><span class="n">maskable</span> <span class="n">Interrupt</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_BP</span><span class="p">,</span>		<span class="o">/*</span>  <span class="mi">3</span><span class="p">,</span> <span class="n">Breakpoint</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_OF</span><span class="p">,</span>		<span class="o">/*</span>  <span class="mi">4</span><span class="p">,</span> <span class="n">Overflow</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_BR</span><span class="p">,</span>		<span class="o">/*</span>  <span class="mi">5</span><span class="p">,</span> <span class="n">Bound</span> <span class="ne">Range</span> <span class="n">Exceeded</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_UD</span><span class="p">,</span>		<span class="o">/*</span>  <span class="mi">6</span><span class="p">,</span> <span class="n">Invalid</span> <span class="n">Opcode</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_NM</span><span class="p">,</span>		<span class="o">/*</span>  <span class="mi">7</span><span class="p">,</span> <span class="n">Device</span> <span class="n">Not</span> <span class="n">Available</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_DF</span><span class="p">,</span>		<span class="o">/*</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">Double</span> <span class="n">Fault</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_OLD_MF</span><span class="p">,</span>	<span class="o">/*</span>  <span class="mi">9</span><span class="p">,</span> <span class="n">Coprocessor</span> <span class="n">Segment</span> <span class="n">Overrun</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_TS</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Invalid</span> <span class="n">TSS</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_NP</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Segment</span> <span class="n">Not</span> <span class="n">Present</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_SS</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Stack</span> <span class="n">Segment</span> <span class="n">Fault</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_GP</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">13</span><span class="p">,</span> <span class="n">General</span> <span class="n">Protection</span> <span class="n">Fault</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_PF</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Page</span> <span class="n">Fault</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_SPURIOUS</span><span class="p">,</span>	<span class="o">/*</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Spurious</span> <span class="n">Interrupt</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_MF</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">x87</span> <span class="n">Floating</span><span class="o">-</span><span class="n">Point</span> <span class="n">Exception</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_AC</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">17</span><span class="p">,</span> <span class="n">Alignment</span> <span class="n">Check</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_MC</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">18</span><span class="p">,</span> <span class="n">Machine</span> <span class="n">Check</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_XF</span><span class="p">,</span>		<span class="o">/*</span> <span class="mi">19</span><span class="p">,</span> <span class="n">SIMD</span> <span class="n">Floating</span><span class="o">-</span><span class="n">Point</span> <span class="n">Exception</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">X86_TRAP_IRET</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>	<span class="o">/*</span> <span class="mi">32</span><span class="p">,</span> <span class="n">IRET</span> <span class="n">Exception</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们回到 trap_init 中，当前 32 个中断都用 set_intr_gate 设置完毕。在中断向量表 idt_table 中填完了之后，接下来的 for 循环，for (i = 0; i &lt; FIRST_EXTERNAL_VECTOR; i++)，将前 32 个中断都在 used_vectors 中标记为 1，表示这些都设置过中断处理函数了。</p>
<p>接下来，trap_init 对单独调用 set_intr_gate 来设置 32 位系统调用的中断。IA32_SYSCALL_VECTOR，也即 128，单独将 used_vectors 中的第 128 位标记为 1。</p>
<p>在 trap_init 的最后，我们将 idt_table 放在一个固定的虚拟地址上。trap_init 结束后，中断向量表中已经填好了前 32 位，外加一位 32 位系统调用，其他的都是用于设备中断。</p>
<p>在 start_kernel 调用完毕 trap_init 之后，还会调用 init_IRQ() 来初始化其他的设备中断，最终会调用到 native_init_IRQ。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">void __init native_init_IRQ(void)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int i;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	i = FIRST_EXTERNAL_VECTOR;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifndef CONFIG_X86_LOCAL_APIC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define first_system_vector NR_VECTORS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	for_each_clear_bit_from(i, used_vectors, first_system_vector) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		/* IA32_SYSCALL_VECTOR could be used in trap_init already. */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		set_intr_gate(i, irq_entries_start +
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				8 * (i - FIRST_EXTERNAL_VECTOR));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里面从第 32 个中断开始，到最后 NR_VECTORS 为止，对于 used_vectors 中没有标记为 1 的位置，都会调用 set_intr_gate 设置中断向量表。</p>
<p>其实 used_vectors 中没有标记为 1 的，都是设备中断的部分。</p>
<p>也即所有的设备中断的中断处理函数，在中断向量表里面都会设置为从 irq_entries_start 开始，偏移量为 i - FIRST_EXTERNAL_VECTOR 的一项。</p>
<p>看来中断处理函数是定义在 irq_entries_start 这个表里面的，我们在 arch\x86\entry\entry_32.S 和 arch\x86\entry\entry_64.S 都能找到这个函数表的定义。</p>
<p>这又是汇编语言，不需要完全看懂，但是我们还是能看出来，这里面定义了 FIRST_SYSTEM_VECTOR - FIRST_EXTERNAL_VECTOR 项。每一项都是中断处理函数，会跳到 common_interrupt 去执行。这里会最终调用 do_IRQ，调用完毕后，就从中断返回。这里我们需要区分返回用户态还是内核态。这里会有一个几乎触发抢占，咱们讲进程切换的时候讲过的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ENTRY(irq_entries_start)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    vector=FIRST_EXTERNAL_VECTOR
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    .rept (FIRST_SYSTEM_VECTOR - FIRST_EXTERNAL_VECTOR)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	pushl	$(~vector+0x80)			/* Note: always in signed byte range */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    vector=vector+1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	jmp	common_interrupt /* 会调用到 do_IRQ */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.align	8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    .endr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">END(irq_entries_start)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  common_interrupt:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	ASM_CLAC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	addq	$-0x80, (%rsp)			/* Adjust vector to [-256, -1] range */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	interrupt do_IRQ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	/* 0(%rsp): old RSP */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ret_from_intr:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	/* Interrupt came from user space */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GLOBAL(retint_user)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/* Returning to kernel space */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">retint_kernel:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样任何一个中断向量到达任何一个 CPU，最终都会走到 do_IRQ。我们来看 do_IRQ 的实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> * do_IRQ handles all normal device IRQ&#39;s (the special
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> * SMP cross-CPU interrupts have their own specific
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> * handlers).
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">__visible unsigned int __irq_entry do_IRQ(struct pt_regs *regs)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct pt_regs *old_regs = set_irq_regs(regs);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct irq_desc * desc;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	/* high bit used in ret_from_ code  */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	unsigned vector = ~regs-&gt;orig_ax;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	desc = __this_cpu_read(vector_irq[vector]);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if (!handle_irq(desc, regs)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	set_irq_regs(old_regs);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return 1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里面，从 AX 寄存器里面拿到了中断向量 vector，但是别忘了中断控制器发送给每个 CPU 的中断向量都是每个 CPU 局部的，而抽象中断处理层的虚拟中断信号 irq 以及它对应的中断描述结构 irq_desc 是全局的，也即这个 CPU 的 200 号的中断向量和另一个 CPU 的 200 号中断向量对应的虚拟中断信号 irq 和中断描述结构 irq_desc 可能不一样，这就需要一个映射关系。这个映射关系放在 Per CPU 变量 vector_irq 里面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DECLARE_PER_CPU(vector_irq_t, vector_irq);
</span></span></code></pre></td></tr></table>
</div>
</div><p>在系统初始化的时候，我们会调用 __assign_irq_vector，将虚拟中断信号 irq 分配到某个 CPU 上的中断向量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">int</span> <span class="n">__assign_irq_vector</span><span class="p">(</span><span class="ne">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">struct</span> <span class="n">apic_chip_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			       <span class="k">const</span> <span class="n">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			       <span class="n">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">irqdata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="ne">int</span> <span class="n">current_vector</span> <span class="o">=</span> <span class="n">FIRST_EXTERNAL_VECTOR</span> <span class="o">+</span> <span class="n">VECTOR_OFFSET_START</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="ne">int</span> <span class="n">current_offset</span> <span class="o">=</span> <span class="n">VECTOR_OFFSET_START</span> <span class="o">%</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">vector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="ne">int</span> <span class="n">new_cpu</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">vector</span> <span class="o">=</span> <span class="n">current_vector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">offset</span> <span class="o">=</span> <span class="n">current_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">next</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">vector</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">&gt;=</span> <span class="n">first_system_vector</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">vector</span> <span class="o">=</span> <span class="n">FIRST_EXTERNAL_VECTOR</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  		<span class="o">/*</span> <span class="n">If</span> <span class="n">the</span> <span class="n">search</span> <span class="n">wrapped</span> <span class="n">around</span><span class="p">,</span> <span class="n">try</span> <span class="n">the</span> <span class="n">next</span> <span class="n">cpu</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">current_vector</span> <span class="o">==</span> <span class="n">vector</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">goto</span> <span class="n">next_cpu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">used_vectors</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">goto</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="o">/*</span> <span class="n">Found</span> <span class="n">one</span><span class="o">!</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">current_vector</span> <span class="o">=</span> <span class="n">vector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">current_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="o">/*</span> <span class="n">Schedule</span> <span class="n">the</span> <span class="n">old</span> <span class="n">vector</span> <span class="k">for</span> <span class="n">cleanup</span> <span class="n">on</span> <span class="n">all</span> <span class="n">cpus</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">old_domain</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">new_cpu</span><span class="p">,</span> <span class="n">vector_searchmask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">per_cpu</span><span class="p">(</span><span class="n">vector_irq</span><span class="p">,</span> <span class="n">new_cpu</span><span class="p">)[</span><span class="n">vector</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq_to_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">goto</span> <span class="n">update</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">next_cpu</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">cpumask_or</span><span class="p">(</span><span class="n">searched_cpumask</span><span class="p">,</span> <span class="n">searched_cpumask</span><span class="p">,</span> <span class="n">vector_cpumask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">cpumask_andnot</span><span class="p">(</span><span class="n">vector_cpumask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">searched_cpumask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">cpu</span> <span class="o">=</span> <span class="n">cpumask_first_and</span><span class="p">(</span><span class="n">vector_cpumask</span><span class="p">,</span> <span class="n">cpu_online_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">....</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里，一旦找到某个向量，就将 CPU 的此向量对应的向量描述结构 irq_desc，设置为虚拟中断信号 irq 对应的向量描述结构 irq_to_desc(irq)。</p>
<p>这样 do_IRQ 会根据中断向量 vector 得到对应的 irq_desc，然后调用 handle_irq。handle_irq 会调用 generic_handle_irq_desc，里面调用 irq_desc 的 handle_irq。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static inline void generic_handle_irq_desc(struct irq_desc *desc)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	desc-&gt;handle_irq(desc);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的 handle_irq，最终会调用 __handle_irq_event_percpu。代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">irqreturn_t __handle_irq_event_percpu(struct irq_desc *desc, unsigned int *flags)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	irqreturn_t retval = IRQ_NONE;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	unsigned int irq = desc-&gt;irq_data.irq;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct irqaction *action;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	record_irq_time(desc);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	for_each_action_of_desc(desc, action) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		irqreturn_t res;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		res = action-&gt;handler(irq, action-&gt;dev_id);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		switch (res) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		case IRQ_WAKE_THREAD:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			__irq_wake_thread(desc, action);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		case IRQ_HANDLED:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			*flags |= action-&gt;flags;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			break;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		default:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			break;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		retval |= res;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return retval;
</span></span></code></pre></td></tr></table>
</div>
</div><p>__handle_irq_event_percpu 里面调用了 irq_desc 里每个 hander，这些 hander 是我们在所有 action 列表中注册的，这才是我们设置的那个中断处理函数。如果返回值是 IRQ_HANDLED，就说明处理完毕；如果返回值是 IRQ_WAKE_THREAD 就唤醒线程。</p>
<p>至此，中断的整个过程就结束了。</p>
<h2 id="总结时刻">总结时刻</h2>
<p>这一节，我们讲了中断的整个处理过程。中断是从外部设备发起的，会形成外部中断。外部中断会到达中断控制器，中断控制器会发送中断向量 Interrupt Vector 给 CPU。</p>
<p>对于每一个 CPU，都要求有一个 idt_table，里面存放了不同的中断向量的处理函数。中断向量表中已经填好了前 32 位，外加一位 32 位系统调用，其他的都是用于设备中断。</p>
<p>硬件中断的处理函数是 do_IRQ 进行统一处理，在这里会让中断向量，通过 vector_irq 映射为 irq_desc。</p>
<p>irq_desc 是一个用于描述用户注册的中断处理函数的结构，为了能够根据中断向量得到 irq_desc 结构，会把这些结构放在一个基数树里面，方便查找。</p>
<p>irq_desc 里面有一个成员是 irqaction，指向设备驱动程序里面注册的中断处理函数。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/7610517533444824e3e80739bc523c31.png" alt=""></p>
<h2 id="课堂练习">课堂练习</h2>
<p>你知道如何查看每个 CPU 都收到了哪些中断吗？</p>
<p>欢迎留言和我分享你的疑惑和见解，也欢迎可以收藏本节内容，反复研读。你也可以把今天的内容分享给你的朋友，和他一起学习和进步。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/1a5564dd4e1c9f25d4772c7f844ca84a.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">趣谈Linux操作系统</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E4%B9%8B%E7%BE%8E/33__%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D%E5%9F%BA%E7%A1%80%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E7%9A%84%E6%9F%A5%E6%89%BE%E5%8A%9F%E8%83%BD/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">33__字符串匹配基础（中）：如何实现文本编辑器中的查找功能？</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/33__%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E5%86%99%E9%AB%98%E6%80%A7%E8%83%BDhttp%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BA%8Ci_o%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0/">
            <span class="next-text nav-default">33__自己动手写高性能HTTP服务器（二）：I_O模型和多线程模型实现</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
