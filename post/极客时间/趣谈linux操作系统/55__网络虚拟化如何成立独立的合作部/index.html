<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>55__网络虚拟化：如何成立独立的合作部？ - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="上一节，我们讲了存储虚拟化，这一节我们来讲网络虚拟化。
网络虚拟化有和存储虚拟化类似的地方，例如，它们都是基于 virtio 的，因而我们在看网络虚拟化的过程中，会看到和存储虚拟化很像的数据结构和原理。但是，网络虚拟化也有自己的特殊性。例如，存储虚拟化是将宿主机上的文件作为客户机上的硬盘，而网络虚拟化需要依赖于内核协议栈进行网络包的封装与解封装。那怎么实现客户机和宿主机之间的互通呢？我们就一起来看一看。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/55__%E7%BD%91%E7%BB%9C%E8%99%9A%E6%8B%9F%E5%8C%96%E5%A6%82%E4%BD%95%E6%88%90%E7%AB%8B%E7%8B%AC%E7%AB%8B%E7%9A%84%E5%90%88%E4%BD%9C%E9%83%A8/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/55__%E7%BD%91%E7%BB%9C%E8%99%9A%E6%8B%9F%E5%8C%96%E5%A6%82%E4%BD%95%E6%88%90%E7%AB%8B%E7%8B%AC%E7%AB%8B%E7%9A%84%E5%90%88%E4%BD%9C%E9%83%A8/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="55__网络虚拟化：如何成立独立的合作部？">
  <meta property="og:description" content="上一节，我们讲了存储虚拟化，这一节我们来讲网络虚拟化。
网络虚拟化有和存储虚拟化类似的地方，例如，它们都是基于 virtio 的，因而我们在看网络虚拟化的过程中，会看到和存储虚拟化很像的数据结构和原理。但是，网络虚拟化也有自己的特殊性。例如，存储虚拟化是将宿主机上的文件作为客户机上的硬盘，而网络虚拟化需要依赖于内核协议栈进行网络包的封装与解封装。那怎么实现客户机和宿主机之间的互通呢？我们就一起来看一看。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="趣谈Linux操作系统">

  <meta itemprop="name" content="55__网络虚拟化：如何成立独立的合作部？">
  <meta itemprop="description" content="上一节，我们讲了存储虚拟化，这一节我们来讲网络虚拟化。
网络虚拟化有和存储虚拟化类似的地方，例如，它们都是基于 virtio 的，因而我们在看网络虚拟化的过程中，会看到和存储虚拟化很像的数据结构和原理。但是，网络虚拟化也有自己的特殊性。例如，存储虚拟化是将宿主机上的文件作为客户机上的硬盘，而网络虚拟化需要依赖于内核协议栈进行网络包的封装与解封装。那怎么实现客户机和宿主机之间的互通呢？我们就一起来看一看。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="7874">
  <meta itemprop="keywords" content="趣谈Linux操作系统">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="55__网络虚拟化：如何成立独立的合作部？">
  <meta name="twitter:description" content="上一节，我们讲了存储虚拟化，这一节我们来讲网络虚拟化。
网络虚拟化有和存储虚拟化类似的地方，例如，它们都是基于 virtio 的，因而我们在看网络虚拟化的过程中，会看到和存储虚拟化很像的数据结构和原理。但是，网络虚拟化也有自己的特殊性。例如，存储虚拟化是将宿主机上的文件作为客户机上的硬盘，而网络虚拟化需要依赖于内核协议栈进行网络包的封装与解封装。那怎么实现客户机和宿主机之间的互通呢？我们就一起来看一看。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">55__网络虚拟化：如何成立独立的合作部？</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 7874 字 </span>
          <span class="more-meta"> 预计阅读 16 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#解析初始化过程">解析初始化过程</a></li>
        <li><a href="#qemu-的启动过程中的网络虚拟化">qemu 的启动过程中的网络虚拟化</a></li>
        <li><a href="#关联前端设备驱动和后端设备驱动">关联前端设备驱动和后端设备驱动</a></li>
        <li><a href="#发送网络包过程">发送网络包过程</a></li>
        <li><a href="#总结时刻">总结时刻</a></li>
        <li><a href="#课堂练习">课堂练习</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>上一节，我们讲了存储虚拟化，这一节我们来讲网络虚拟化。</p>
<p>网络虚拟化有和存储虚拟化类似的地方，例如，它们都是基于 virtio 的，因而我们在看网络虚拟化的过程中，会看到和存储虚拟化很像的数据结构和原理。但是，网络虚拟化也有自己的特殊性。例如，存储虚拟化是将宿主机上的文件作为客户机上的硬盘，而网络虚拟化需要依赖于内核协议栈进行网络包的封装与解封装。那怎么实现客户机和宿主机之间的互通呢？我们就一起来看一看。</p>
<h2 id="解析初始化过程">解析初始化过程</h2>
<p>我们还是从 Virtio Network Device 这个设备的初始化讲起。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">device_type_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TYPE_DEVICE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_OBJECT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">DeviceState</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">instance_init</span> <span class="o">=</span> <span class="n">device_initfn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">instance_post_init</span> <span class="o">=</span> <span class="n">device_post_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">instance_finalize</span> <span class="o">=</span> <span class="n">device_finalize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">class_base_init</span> <span class="o">=</span> <span class="n">device_class_base_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">class_init</span> <span class="o">=</span> <span class="n">device_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="bp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">class_size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">DeviceClass</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">virtio_device_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TYPE_VIRTIO_DEVICE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_DEVICE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">VirtIODevice</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">class_init</span> <span class="o">=</span> <span class="n">virtio_device_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">instance_finalize</span> <span class="o">=</span> <span class="n">virtio_device_instance_finalize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="bp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">class_size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">VirtioDeviceClass</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">virtio_net_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TYPE_VIRTIO_NET</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_VIRTIO_DEVICE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">VirtIONet</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">instance_init</span> <span class="o">=</span> <span class="n">virtio_net_instance_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">class_init</span> <span class="o">=</span> <span class="n">virtio_net_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="n">void</span> <span class="n">virtio_register_types</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">type_register_static</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_net_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">type_init</span><span class="p">(</span><span class="n">virtio_register_types</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Virtio Network Device 这种类的定义是有多层继承关系的，TYPE_VIRTIO_NET 的父类是 TYPE_VIRTIO_DEVICE，TYPE_VIRTIO_DEVICE 的父类是 TYPE_DEVICE，TYPE_DEVICE 的父类是 TYPE_OBJECT，继承关系到头了。</p>
<p>type_init 用于注册这种类。这里面每一层都有 class_init，用于从 TypeImpl 生产 xxxClass，也有 instance_init，会将 xxxClass 初始化为实例。</p>
<p>TYPE_VIRTIO_NET 层的 class_init 函数 virtio_net_class_init，定义了 DeviceClass 的 realize 函数为 virtio_net_device_realize，这一点和存储块设备是一样的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static void virtio_net_device_realize(DeviceState *dev, Error **errp)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtIODevice *vdev = VIRTIO_DEVICE(dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtIONet *n = VIRTIO_NET(dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    NetClientState *nc;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    int i;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    virtio_init(vdev, &#34;virtio-net&#34;, VIRTIO_ID_NET, n-&gt;config_size);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     /*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     * We set a lower limit on RX queue size to what it always was.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     * Guests that want a smaller ring can always resize it without
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     * help from us (using virtio 1 and up).
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (n-&gt;net_conf.rx_queue_size &lt; VIRTIO_NET_RX_QUEUE_MIN_SIZE ||
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        n-&gt;net_conf.rx_queue_size &gt; VIRTQUEUE_MAX_SIZE ||
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        !is_power_of_2(n-&gt;net_conf.rx_queue_size)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     if (n-&gt;net_conf.tx_queue_size &lt; VIRTIO_NET_TX_QUEUE_MIN_SIZE ||
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        n-&gt;net_conf.tx_queue_size &gt; VIRTQUEUE_MAX_SIZE ||
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        !is_power_of_2(n-&gt;net_conf.tx_queue_size)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     n-&gt;max_queues = MAX(n-&gt;nic_conf.peers.queues, 1);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (n-&gt;max_queues * 2 + 1 &gt; VIRTIO_QUEUE_MAX) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    n-&gt;vqs = g_malloc0(sizeof(VirtIONetQueue) * n-&gt;max_queues);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    n-&gt;curr_queues = 1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    n-&gt;net_conf.tx_queue_size = MIN(virtio_net_max_tx_queue_size(n),
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                    n-&gt;net_conf.tx_queue_size);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     for (i = 0; i &lt; n-&gt;max_queues; i++) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        virtio_net_add_queue(n, i);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     n-&gt;ctrl_vq = virtio_add_queue(vdev, 64, virtio_net_handle_ctrl);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    qemu_macaddr_default_if_unset(&amp;n-&gt;nic_conf.macaddr);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    memcpy(&amp;n-&gt;mac[0], &amp;n-&gt;nic_conf.macaddr, sizeof(n-&gt;mac));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    n-&gt;status = VIRTIO_NET_S_LINK_UP;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     if (n-&gt;netclient_type) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        n-&gt;nic = qemu_new_nic(&amp;net_virtio_info, &amp;n-&gt;nic_conf,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                              n-&gt;netclient_type, n-&gt;netclient_name, n);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } else {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        n-&gt;nic = qemu_new_nic(&amp;net_virtio_info, &amp;n-&gt;nic_conf,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                              object_get_typename(OBJECT(dev)), dev-&gt;id, n);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里面创建了一个 VirtIODevice，这一点和存储虚拟化也是一样的。virtio_init 用来初始化这个设备。VirtIODevice 结构里面有一个 VirtQueue 数组，这就是 virtio 前端和后端互相传数据的队列，最多有 VIRTIO_QUEUE_MAX 个。</p>
<p>刚才我们说的都是一样的地方，其实也有不一样的地方，我们下面来看。</p>
<p>你会发现，这里面有这样的语句 n-&gt;max_queues * 2 + 1 &gt; VIRTIO_QUEUE_MAX。为什么要乘以 2 呢？这是因为，对于网络设备来讲，应该分发送队列和接收队列两个方向，所以乘以 2。</p>
<p>接下来，我们调用 virtio_net_add_queue 来初始化队列，可以看出来，这里面就有发送 tx_vq 和接收 rx_vq 两个队列。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">typedef struct VirtIONetQueue {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtQueue *rx_vq;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtQueue *tx_vq;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    QEMUTimer *tx_timer;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    QEMUBH *tx_bh;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    uint32_t tx_waiting;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    struct {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        VirtQueueElement *elem;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } async_tx;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    struct VirtIONet *n;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">} VirtIONetQueue;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> static void virtio_net_add_queue(VirtIONet *n, int index)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtIODevice *vdev = VIRTIO_DEVICE(n);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     n-&gt;vqs[index].rx_vq = virtio_add_queue(vdev, n-&gt;net_conf.rx_queue_size, virtio_net_handle_rx);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> ......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     n-&gt;vqs[index].tx_vq = virtio_add_queue(vdev, n-&gt;net_conf.tx_queue_size, virtio_net_handle_tx_bh);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    n-&gt;vqs[index].tx_bh = qemu_bh_new(virtio_net_tx_bh, &amp;n-&gt;vqs[index]);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    n-&gt;vqs[index].n = n;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>每个 VirtQueue 中，都有一个 vring 用来维护这个队列里面的数据；另外还有函数 virtio_net_handle_rx 用于处理网络包的接收；函数 virtio_net_handle_tx_bh 用于网络包的发送，这个函数我们后面会用到。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NICState</span> <span class="o">*</span><span class="n">qemu_new_nic</span><span class="p">(</span><span class="n">NetClientInfo</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       <span class="n">NICConf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       <span class="n">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">NetClientState</span> <span class="o">**</span><span class="n">peers</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">peers</span><span class="o">.</span><span class="n">ncs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">NICState</span> <span class="o">*</span><span class="n">nic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="ne">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">queues</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">peers</span><span class="o">.</span><span class="n">queues</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nic</span> <span class="o">=</span> <span class="n">g_malloc0</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">NetClientState</span><span class="p">)</span> <span class="o">*</span> <span class="n">queues</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nic</span><span class="o">-&gt;</span><span class="n">ncs</span> <span class="o">=</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">nic</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nic</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nic</span><span class="o">-&gt;</span><span class="n">opaque</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">qemu_net_client_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">ncs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">info</span><span class="p">,</span> <span class="n">peers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">nic</span><span class="o">-&gt;</span><span class="n">ncs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">nic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="n">void</span> <span class="n">qemu_net_client_setup</span><span class="p">(</span><span class="n">NetClientState</span> <span class="o">*</span><span class="n">nc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                  <span class="n">NetClientInfo</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                  <span class="n">NetClientState</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                  <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                  <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                  <span class="n">NetClientDestructor</span> <span class="o">*</span><span class="n">destructor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nc</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">g_strdup</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">nc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">g_strdup</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">nc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">assign_name</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="n">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_clients</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="n">nc</span><span class="o">-&gt;</span><span class="n">incoming_queue</span> <span class="o">=</span> <span class="n">qemu_new_net_queue</span><span class="p">(</span><span class="n">qemu_deliver_packet_iov</span><span class="p">,</span> <span class="n">nc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nc</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">destructor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">QTAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nc</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，qemu_new_nic 会创建一个虚拟机里面的网卡。</p>
<h2 id="qemu-的启动过程中的网络虚拟化">qemu 的启动过程中的网络虚拟化</h2>
<p>初始化过程解析完毕以后，我们接下来从 qemu 的启动过程看起。</p>
<p>对于网卡的虚拟化，qemu 的启动参数里面有关的是下面两行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-netdev tap,fd=32,id=hostnet0,vhost=on,vhostfd=37
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:d1:2d:99,bus=pci.0,addr=0x3
</span></span></code></pre></td></tr></table>
</div>
</div><p>qemu 的 main 函数会调用 net_init_clients 进行网络设备的初始化，可以解析 net 参数，也可以在 net_init_clients 中解析 netdev 参数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">int net_init_clients(Error **errp)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    QTAILQ_INIT(&amp;net_clients);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (qemu_opts_foreach(qemu_find_opts(&#34;netdev&#34;),
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                          net_init_netdev, NULL, errp)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return -1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (qemu_opts_foreach(qemu_find_opts(&#34;nic&#34;), net_param_nic, NULL, errp)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return -1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (qemu_opts_foreach(qemu_find_opts(&#34;net&#34;), net_init_client, NULL, errp)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return -1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}  
</span></span></code></pre></td></tr></table>
</div>
</div><p>net_init_clients 会解析参数。上面的参数 netdev 会调用 net_init_netdev-&gt;net_client_init-&gt;net_client_init1。</p>
<p>net_client_init1 会根据不同的 driver 类型，调用不同的初始化函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">int</span> <span class="p">(</span><span class="o">*</span> <span class="k">const</span> <span class="n">net_client_init_fun</span><span class="p">[</span><span class="n">NET_CLIENT_DRIVER__MAX</span><span class="p">])(</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">Netdev</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">NetClientState</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">NET_CLIENT_DRIVER_NIC</span><span class="p">]</span>       <span class="o">=</span> <span class="n">net_init_nic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">NET_CLIENT_DRIVER_TAP</span><span class="p">]</span>       <span class="o">=</span> <span class="n">net_init_tap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">NET_CLIENT_DRIVER_SOCKET</span><span class="p">]</span>    <span class="o">=</span> <span class="n">net_init_socket</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">NET_CLIENT_DRIVER_HUBPORT</span><span class="p">]</span>   <span class="o">=</span> <span class="n">net_init_hubport</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于我们配置的 driver 的类型是 tap，因而这里会调用 net_init_tap-&gt;net_tap_init-&gt;tap_open。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define PATH_NET_TUN &#34;/dev/net/tun&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> int tap_open(char *ifname, int ifname_size, int *vnet_hdr,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             int vnet_hdr_required, int mq_required, Error **errp)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    struct ifreq ifr;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    int fd, ret;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    int len = sizeof(struct virtio_net_hdr);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    unsigned int features;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     TFR(fd = open(PATH_NET_TUN, O_RDWR));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    memset(&amp;ifr, 0, sizeof(ifr));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ifr.ifr_flags = IFF_TAP | IFF_NO_PI;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     if (ioctl(fd, TUNGETFEATURES, &amp;features) == -1) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        features = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     if (features &amp; IFF_ONE_QUEUE) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        ifr.ifr_flags |= IFF_ONE_QUEUE;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     if (*vnet_hdr) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if (features &amp; IFF_VNET_HDR) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            *vnet_hdr = 1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            ifr.ifr_flags |= IFF_VNET_HDR;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        } else {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            *vnet_hdr = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        ioctl(fd, TUNSETVNETHDRSZ, &amp;len);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ret = ioctl(fd, TUNSETIFF, (void *) &amp;ifr);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    fcntl(fd, F_SETFL, O_NONBLOCK);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return fd;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 tap_open 中，我们打开一个文件&quot;/dev/net/tun&quot;，然后通过 ioctl 操作这个文件。这是 Linux 内核的一项机制，和 KVM 机制很像。其实这就是一种通过打开这个字符设备文件，然后通过 ioctl 操作这个文件和内核打交道，来使用内核的能力。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/76edd17e9cfd95899f7be48a4ab2bed9.png" alt=""></p>
<p>为什么需要使用内核的机制呢？因为网络包需要从虚拟机里面发送到虚拟机外面，发送到宿主机上的时候，必须是一个正常的网络包才能被转发。要形成一个网络包，我们那就需要经过复杂的协议栈，协议栈的复杂咱们在<a href="./106490.md">发送网络包</a>那一节讲过了。</p>
<p>客户机会将网络包发送给 qemu。qemu 自己没有网络协议栈，现去实现一个也不可能，太复杂了。于是，它就要借助内核的力量。</p>
<p>qemu 会将客户机发送给它的网络包，然后转换成为文件流，写入&quot;/dev/net/tun&quot;字符设备。就像写一个文件一样。内核中 TUN/TAP 字符设备驱动会收到这个写入的文件流，然后交给 TUN/TAP 的虚拟网卡驱动。这个驱动会将文件流再次转成网络包，交给 TCP/IP 栈，最终从虚拟 TAP 网卡 tap0 发出来，成为标准的网络包。后面我们会看到这个过程。</p>
<p>现在我们到内核里面，看一看打开&quot;/dev/net/tun&quot;字符设备后，内核会发生什么事情。内核的实现在 drivers/net/tun.c 文件中。这是一个字符设备驱动程序，应该符合字符设备的格式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">module_init(tun_init);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">module_exit(tun_cleanup);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MODULE_DESCRIPTION(DRV_DESCRIPTION);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MODULE_AUTHOR(DRV_COPYRIGHT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MODULE_LICENSE(&#34;GPL&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MODULE_ALIAS_MISCDEV(TUN_MINOR);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MODULE_ALIAS(&#34;devname:net/tun&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> static int __init tun_init(void)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	ret = rtnl_link_register(&amp;tun_link_ops);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	ret = misc_register(&amp;tun_miscdev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	ret = register_netdevice_notifier(&amp;tun_notifier_block);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里面注册了一个 tun_miscdev 字符设备，从它的定义可以看出，这就是&quot;/dev/net/tun&quot;字符设备。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">struct</span> <span class="n">miscdevice</span> <span class="n">tun_miscdev</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">TUN_MINOR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;tun&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">nodename</span> <span class="o">=</span> <span class="s2">&#34;net/tun&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tun_fops</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="k">const</span> <span class="n">struct</span> <span class="n">file_operations</span> <span class="n">tun_fops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">read_iter</span>  <span class="o">=</span> <span class="n">tun_chr_read_iter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">write_iter</span> <span class="o">=</span> <span class="n">tun_chr_write_iter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">poll</span>	<span class="o">=</span> <span class="n">tun_chr_poll</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">tun_chr_ioctl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">open</span>	<span class="o">=</span> <span class="n">tun_chr_open</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">tun_chr_close</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">fasync</span> <span class="o">=</span> <span class="n">tun_chr_fasync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>qemu 的 tap_open 函数会打开这个字符设备 PATH_NET_TUN。打开字符设备的过程我们不再重复。我就说一下，到了驱动这一层，调用的是 tun_chr_open。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static int tun_chr_open(struct inode *inode, struct file * file)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct tun_file *tfile;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tfile = (struct tun_file *)sk_alloc(net, AF_UNSPEC, GFP_KERNEL,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					    &amp;tun_proto, 0);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	RCU_INIT_POINTER(tfile-&gt;tun, NULL);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tfile-&gt;flags = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tfile-&gt;ifindex = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	init_waitqueue_head(&amp;tfile-&gt;wq.wait);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	RCU_INIT_POINTER(tfile-&gt;socket.wq, &amp;tfile-&gt;wq);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	tfile-&gt;socket.file = file;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tfile-&gt;socket.ops = &amp;tun_socket_ops;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	sock_init_data(&amp;tfile-&gt;socket, &amp;tfile-&gt;sk);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	tfile-&gt;sk.sk_write_space = tun_sock_write_space;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tfile-&gt;sk.sk_sndbuf = INT_MAX;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	file-&gt;private_data = tfile;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	INIT_LIST_HEAD(&amp;tfile-&gt;next);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	sock_set_flag(&amp;tfile-&gt;sk, SOCK_ZEROCOPY);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	return 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 tun_chr_open 的参数里面，有一个 struct file，这是代表什么文件呢？它代表的就是打开的字符设备文件&quot;/dev/net/tun&quot;，因而往这个字符设备文件中写数据，就会通过这个 struct file 写入。这个 struct file 里面的 file_operations，按照字符设备打开的规则，指向的就是 tun_fops。</p>
<p>另外，我们还需要在 tun_chr_open 创建了一个结构 struct tun_file，并且将 struct file 的 private_data 指向它。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">A</span> <span class="n">tun_file</span> <span class="n">connects</span> <span class="n">an</span> <span class="n">open</span> <span class="n">character</span> <span class="n">device</span> <span class="n">to</span> <span class="n">a</span> <span class="n">tuntap</span> <span class="n">netdevice</span><span class="o">.</span> <span class="n">It</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">also</span> <span class="n">contains</span> <span class="n">all</span> <span class="n">socket</span> <span class="n">related</span> <span class="n">structures</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">to</span> <span class="n">serve</span> <span class="n">as</span> <span class="n">one</span> <span class="n">transmit</span> <span class="n">queue</span> <span class="k">for</span> <span class="n">tuntap</span> <span class="n">device</span><span class="o">.</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">struct</span> <span class="n">tun_file</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">sock</span> <span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">socket</span> <span class="n">socket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">socket_wq</span> <span class="n">wq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">tun_struct</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">tun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">fasync_struct</span> <span class="o">*</span><span class="n">fasync</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">/*</span> <span class="n">only</span> <span class="n">used</span> <span class="k">for</span> <span class="n">fasnyc</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">u16</span> <span class="n">queue_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">unsigned</span> <span class="ne">int</span> <span class="n">ifindex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">list_head</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">tun_struct</span> <span class="o">*</span><span class="n">detached</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">skb_array</span> <span class="n">tx_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">struct</span> <span class="n">tun_struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">tun_file</span> <span class="n">__rcu</span>	<span class="o">*</span><span class="n">tfiles</span><span class="p">[</span><span class="n">MAX_TAP_QUEUES</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span>            <span class="n">numqueues</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span> 		<span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">kuid_t</span>			<span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">kgid_t</span>			<span class="n">group</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="n">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">netdev_features_t</span>	<span class="n">set_features</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span>			<span class="n">align</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span>			<span class="n">vnet_hdr_sz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span>			<span class="n">sndbuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">tap_filter</span>	<span class="n">txflt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">sock_fprog</span>	<span class="n">fprog</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">/*</span> <span class="n">protected</span> <span class="n">by</span> <span class="n">rtnl</span> <span class="n">lock</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">bool</span>			<span class="n">filter_attached</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">hlist_head</span> <span class="n">flows</span><span class="p">[</span><span class="n">TUN_NUM_FLOW_ENTRIES</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">timer_list</span> <span class="n">flow_gc_timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span> <span class="n">ageing_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span> <span class="n">numdisabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">list_head</span> <span class="n">disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">void</span> <span class="o">*</span><span class="n">security</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">flow_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">rx_batched</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">tun_pcpu_stats</span> <span class="n">__percpu</span> <span class="o">*</span><span class="n">pcpu_stats</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="k">const</span> <span class="n">struct</span> <span class="n">proto_ops</span> <span class="n">tun_socket_ops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">peek_len</span> <span class="o">=</span> <span class="n">tun_peek_len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">sendmsg</span> <span class="o">=</span> <span class="n">tun_sendmsg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">recvmsg</span> <span class="o">=</span> <span class="n">tun_recvmsg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 struct tun_file 中，有一个成员 struct tun_struct，它里面有一个 struct net_device，这个用来表示宿主机上的 tuntap 网络设备。在 struct tun_file 中，还有 struct socket 和 struct sock，因为要用到内核的网络协议栈，所以就需要这两个结构，这在<a href="./105338.md">网络协议</a>那一节已经分析过了。</p>
<p>所以，按照 struct tun_file 的注释说的，这是一个很重要的数据结构。&quot;/dev/net/tun&quot;对应的 struct file 的 private_data 指向它，因而可以接收 qemu 发过来的数据。除此之外，它还可以通过 struct sock 来操作内核协议栈，然后将网络包从宿主机上的 tuntap 网络设备发出去，宿主机上的 tuntap 网络设备对应的 struct net_device 也归它管。</p>
<p>在 qemu 的 tap_open 函数中，打开这个字符设备文件之后，接下来要做的事情是，通过 ioctl 来设置宿主机的网卡 TUNSETIFF。</p>
<p>接下来，ioctl 到了内核里面，会调用 tun_chr_ioctl。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static long __tun_chr_ioctl(struct file *file, unsigned int cmd,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			    unsigned long arg, int ifreq_len)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct tun_file *tfile = file-&gt;private_data;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct tun_struct *tun;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	void __user* argp = (void __user*)arg;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct ifreq ifr;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	kuid_t owner;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	kgid_t group;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int sndbuf;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int vnet_hdr_sz;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	unsigned int ifindex;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int le;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int ret;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	if (cmd == TUNSETIFF || cmd == TUNSETQUEUE || _IOC_TYPE(cmd) == SOCK_IOC_TYPE) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		if (copy_from_user(&amp;ifr, argp, ifreq_len))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			return -EFAULT;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	} 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun = __tun_get(tfile);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if (cmd == TUNSETIFF) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		ifr.ifr_name[IFNAMSIZ-1] = &#39;\0&#39;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		ret = tun_set_iff(sock_net(&amp;tfile-&gt;sk), file, &amp;ifr);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		if (copy_to_user(argp, &amp;ifr, ifreq_len))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			ret = -EFAULT;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 __tun_chr_ioctl 中，我们首先通过 copy_from_user 把配置从用户态拷贝到内核态，调用 tun_set_iff 设置 tuntap 网络设备，然后调用 copy_to_user 将配置结果返回。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static int tun_set_iff(struct net *net, struct file *file, struct ifreq *ifr)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct tun_struct *tun;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct tun_file *tfile = file-&gt;private_data;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct net_device *dev;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	char *name;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	unsigned long flags = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int queues = ifr-&gt;ifr_flags &amp; IFF_MULTI_QUEUE ?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			     MAX_TAP_QUEUES : 1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	if (ifr-&gt;ifr_flags &amp; IFF_TUN) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		/* TUN device */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		flags |= IFF_TUN;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		name = &#34;tun%d&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	} else if (ifr-&gt;ifr_flags &amp; IFF_TAP) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		/* TAP device */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		flags |= IFF_TAP;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		name = &#34;tap%d&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	} else
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		return -EINVAL;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	if (*ifr-&gt;ifr_name)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		name = ifr-&gt;ifr_name;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	dev = alloc_netdev_mqs(sizeof(struct tun_struct), name,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				       NET_NAME_UNKNOWN, tun_setup, queues,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				       queues);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	err = dev_get_valid_name(net, dev, name);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	dev_net_set(dev, net);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	dev-&gt;rtnl_link_ops = &amp;tun_link_ops;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	dev-&gt;ifindex = tfile-&gt;ifindex;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	dev-&gt;sysfs_groups[0] = &amp;tun_attr_group;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	tun = netdev_priv(dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun-&gt;dev = dev;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun-&gt;flags = flags;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun-&gt;txflt.count = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun-&gt;vnet_hdr_sz = sizeof(struct virtio_net_hdr);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	tun-&gt;align = NET_SKB_PAD;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun-&gt;filter_attached = false;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun-&gt;sndbuf = tfile-&gt;socket.sk-&gt;sk_sndbuf;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun-&gt;rx_batched = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	tun_net_init(dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	tun_flow_init(tun);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	err = tun_attach(tun, file, false);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	err = register_netdevice(tun-&gt;dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	netif_carrier_on(tun-&gt;dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	if (netif_running(tun-&gt;dev))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		netif_tx_wake_all_queues(tun-&gt;dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	strcpy(ifr-&gt;ifr_name, tun-&gt;dev-&gt;name);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tun_set_iff 创建了 struct tun_struct 和 struct net_device，并且将这个 tuntap 网络设备通过 register_netdevice 注册到内核中。这样，我们就能在宿主机上通过 ip addr 看到这个网卡了。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/9d8e82da768fc5e39e4579ec13700252.png" alt=""></p>
<p>至此宿主机上的内核的数据结构也完成了。</p>
<h2 id="关联前端设备驱动和后端设备驱动">关联前端设备驱动和后端设备驱动</h2>
<p>下面，我们来解析在客户机中发送一个网络包的时候，会发生哪些事情。</p>
<p>虚拟机里面的进程发送一个网络包，通过文件系统和 Socket 调用网络协议栈，到达网络设备层。只不过这个不是普通的网络设备，而是 virtio_net 的驱动。</p>
<p>virtio_net 的驱动程序代码在 Linux 操作系统的源代码里面，文件名为 drivers/net/virtio_net.c。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static __init int virtio_net_driver_init(void)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ret = register_virtio_driver(&amp;virtio_net_driver);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">module_init(virtio_net_driver_init);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">module_exit(virtio_net_driver_exit);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> MODULE_DEVICE_TABLE(virtio, id_table);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MODULE_DESCRIPTION(&#34;Virtio network driver&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MODULE_LICENSE(&#34;GPL&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> static struct virtio_driver virtio_net_driver = {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.driver.name =	KBUILD_MODNAME,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.driver.owner =	THIS_MODULE,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.id_table =	id_table,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.validate =	virtnet_validate,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.probe =	virtnet_probe,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.remove =	virtnet_remove,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.config_changed = virtnet_config_changed,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">};
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 virtio_net 的驱动程序的初始化代码中，我们需要注册一个驱动函数 virtio_net_driver。</p>
<p>当一个设备驱动作为一个内核模块被初始化的时候，probe 函数会被调用，因而我们来看一下 virtnet_probe。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">int</span> <span class="n">virtnet_probe</span><span class="p">(</span><span class="n">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">virtnet_info</span> <span class="o">*</span><span class="n">vi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">u16</span> <span class="n">max_queue_pairs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span> <span class="n">mtu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="o">/*</span> <span class="n">Allocate</span> <span class="n">ourselves</span> <span class="n">a</span> <span class="n">network</span> <span class="n">device</span> <span class="n">with</span> <span class="n">room</span> <span class="k">for</span> <span class="n">our</span> <span class="n">info</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">struct</span> <span class="n">virtnet_info</span><span class="p">),</span> <span class="n">max_queue_pairs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="o">/*</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">network</span> <span class="n">device</span> <span class="n">as</span> <span class="n">normal</span><span class="o">.</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_UNICAST_FLT</span> <span class="o">|</span> <span class="n">IFF_LIVE_ADDR_CHANGE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">virtnet_netdev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">virtnet_ethtool_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">/*</span> <span class="n">MTU</span> <span class="nb">range</span><span class="p">:</span> <span class="mi">68</span> <span class="o">-</span> <span class="mi">65535</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">min_mtu</span> <span class="o">=</span> <span class="n">MIN_MTU</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_mtu</span> <span class="o">=</span> <span class="n">MAX_MTU</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="o">/*</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">our</span> <span class="n">device</span><span class="o">-</span><span class="n">specific</span> <span class="n">information</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vi</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">vi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vi</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="n">alloc_percpu</span><span class="p">(</span><span class="n">struct</span> <span class="n">virtnet_stats</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">config_work</span><span class="p">,</span> <span class="n">virtnet_config_changed_work</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vi</span><span class="o">-&gt;</span><span class="n">max_queue_pairs</span> <span class="o">=</span> <span class="n">max_queue_pairs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="o">/*</span> <span class="n">Allocate</span><span class="o">/</span><span class="n">initialize</span> <span class="n">the</span> <span class="n">rx</span><span class="o">/</span><span class="n">tx</span> <span class="n">queues</span><span class="p">,</span> <span class="ow">and</span> <span class="n">invoke</span> <span class="n">find_vqs</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="n">init_vqs</span><span class="p">(</span><span class="n">vi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">curr_queue_pairs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">netif_set_real_num_rx_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">curr_queue_pairs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="n">virtnet_init_settings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">virtio_device_ready</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">virtnet_set_queues</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">curr_queue_pairs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 virtnet_probe 中，会创建 struct net_device，并且通过 register_netdev 注册这个网络设备，这样在客户机里面，就能看到这个网卡了。</p>
<p>在 virtnet_probe 中，还有一件重要的事情就是，init_vqs 会初始化发送和接收的 virtqueue。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static int init_vqs(struct virtnet_info *vi)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int ret;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	/* Allocate send &amp; receive queues */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	ret = virtnet_alloc_queues(vi);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	ret = virtnet_find_vqs(vi);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	get_online_cpus();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	virtnet_set_affinity(vi);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	put_online_cpus();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	return 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> static int virtnet_alloc_queues(struct virtnet_info *vi)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int i;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	vi-&gt;sq = kzalloc(sizeof(*vi-&gt;sq) * vi-&gt;max_queue_pairs, GFP_KERNEL);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	vi-&gt;rq = kzalloc(sizeof(*vi-&gt;rq) * vi-&gt;max_queue_pairs, GFP_KERNEL);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	INIT_DELAYED_WORK(&amp;vi-&gt;refill, refill_work);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	for (i = 0; i &lt; vi-&gt;max_queue_pairs; i++) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		vi-&gt;rq[i].pages = NULL;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		netif_napi_add(vi-&gt;dev, &amp;vi-&gt;rq[i].napi, virtnet_poll,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			       napi_weight);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		netif_tx_napi_add(vi-&gt;dev, &amp;vi-&gt;sq[i].napi, virtnet_poll_tx,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				  napi_tx ? napi_weight : 0);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 		sg_init_table(vi-&gt;rq[i].sg, ARRAY_SIZE(vi-&gt;rq[i].sg));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		ewma_pkt_len_init(&amp;vi-&gt;rq[i].mrg_avg_pkt_len);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		sg_init_table(vi-&gt;sq[i].sg, ARRAY_SIZE(vi-&gt;sq[i].sg));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	return 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>按照上一节的 virtio 原理，virtqueue 是一个介于客户机前端和 qemu 后端的一个结构，用于在这两端之间传递数据，对于网络设备来讲有发送和接收两个方向的队列。这里建立的 struct virtqueue 是客户机前端对于队列的管理的数据结构。</p>
<p>队列的实体需要通过函数 virtnet_find_vqs 查找或者生成，这里还会指定接收队列的 callback 函数为 skb_recv_done，发送队列的 callback 函数为 skb_xmit_done。那当 buffer 使用发生变化的时候，我们可以调用这个 callback 函数进行通知。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">int</span> <span class="n">virtnet_find_vqs</span><span class="p">(</span><span class="n">struct</span> <span class="n">virtnet_info</span> <span class="o">*</span><span class="n">vi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vq_callback_t</span> <span class="o">**</span><span class="n">callbacks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">virtqueue</span> <span class="o">**</span><span class="n">vqs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="ne">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">total_vqs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">char</span> <span class="o">**</span><span class="n">names</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="o">/*</span> <span class="n">Allocate</span> <span class="n">space</span> <span class="k">for</span> <span class="n">find_vqs</span> <span class="n">parameters</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">vqs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">total_vqs</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vqs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">callbacks</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">total_vqs</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">callbacks</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">names</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">total_vqs</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="o">/*</span> <span class="n">Allocate</span><span class="o">/</span><span class="n">initialize</span> <span class="n">parameters</span> <span class="k">for</span> <span class="n">send</span><span class="o">/</span><span class="n">receive</span> <span class="n">virtqueues</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">max_queue_pairs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">callbacks</span><span class="p">[</span><span class="n">rxq2vq</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">skb_recv_done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">callbacks</span><span class="p">[</span><span class="n">txq2vq</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">skb_xmit_done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">names</span><span class="p">[</span><span class="n">rxq2vq</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">names</span><span class="p">[</span><span class="n">txq2vq</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="n">ret</span> <span class="o">=</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">find_vqs</span><span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">total_vqs</span><span class="p">,</span> <span class="n">vqs</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">max_queue_pairs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">vq</span> <span class="o">=</span> <span class="n">vqs</span><span class="p">[</span><span class="n">rxq2vq</span><span class="p">(</span><span class="n">i</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min_buf_len</span> <span class="o">=</span> <span class="n">mergeable_min_buf_len</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">vq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">vq</span> <span class="o">=</span> <span class="n">vqs</span><span class="p">[</span><span class="n">txq2vq</span><span class="p">(</span><span class="n">i</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的 find_vqs 是在 struct virtnet_info 里的 struct virtio_device 里的 struct virtio_config_ops *config 里面定义的。</p>
<p>根据 virtio_config_ops 的定义，find_vqs 会调用 vp_modern_find_vqs，到这一步和块设备是一样的了。</p>
<p>在 vp_modern_find_vqs 中，vp_find_vqs 会调用 vp_find_vqs_intx。在 vp_find_vqs_intx 中，通过 request_irq 注册一个中断处理函数 vp_interrupt。当设备向队列中写入信息时，会产生一个中断，也就是 vq 中断。中断处理函数需要调用相应的队列的回调函数，然后根据队列的数目，依次调用 vp_setup_vq 完成 virtqueue、vring 的分配和初始化。</p>
<p>同样，这些数据结构会和 virtio 后端的 VirtIODevice、VirtQueue、vring 对应起来，都应该指向刚才创建的那一段内存。</p>
<p>客户机同样会通过调用专门给外部设备发送指令的函数 iowrite 告诉外部的 pci 设备，这些共享内存的地址。</p>
<p>至此前端设备驱动和后端设备驱动之间的两个收发队列就关联好了，这两个队列的格式和块设备是一样的。</p>
<h2 id="发送网络包过程">发送网络包过程</h2>
<p>接下来，我们来看当真的发送一个网络包的时候，会发生什么。</p>
<p>当网络包经过客户机的协议栈到达 virtio_net 驱动的时候，按照 net_device_ops 的定义，start_xmit 会被调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">struct</span> <span class="n">net_device_ops</span> <span class="n">virtnet_netdev</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_open</span>            <span class="o">=</span> <span class="n">virtnet_open</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_stop</span>   	     <span class="o">=</span> <span class="n">virtnet_close</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_start_xmit</span>      <span class="o">=</span> <span class="n">start_xmit</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_validate_addr</span>   <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">virtnet_set_mac_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_set_rx_mode</span>     <span class="o">=</span> <span class="n">virtnet_set_rx_mode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_get_stats64</span>     <span class="o">=</span> <span class="n">virtnet_stats</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_vlan_rx_add_vid</span> <span class="o">=</span> <span class="n">virtnet_vlan_rx_add_vid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_vlan_rx_kill_vid</span> <span class="o">=</span> <span class="n">virtnet_vlan_rx_kill_vid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_xdp</span>		<span class="o">=</span> <span class="n">virtnet_xdp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">ndo_features_check</span>	<span class="o">=</span> <span class="n">passthru_features_check</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来的调用链为：start_xmit-&gt;xmit_skb-&gt; virtqueue_add_outbuf-&gt;virtqueue_add，将网络包放入队列中，并调用 virtqueue_notify 通知接收方。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static netdev_tx_t start_xmit(struct sk_buff *skb, struct net_device *dev)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct virtnet_info *vi = netdev_priv(dev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int qnum = skb_get_queue_mapping(skb);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct send_queue *sq = &amp;vi-&gt;sq[qnum];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int err;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct netdev_queue *txq = netdev_get_tx_queue(dev, qnum);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	bool kick = !skb-&gt;xmit_more;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	bool use_napi = sq-&gt;napi.weight;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	/* Try to transmit */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	err = xmit_skb(sq, skb);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if (kick || netif_xmit_stopped(txq))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		virtqueue_kick(sq-&gt;vq);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return NETDEV_TX_OK;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> bool virtqueue_kick(struct virtqueue *vq)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if (virtqueue_kick_prepare(vq))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		return virtqueue_notify(vq);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return true;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>写入一个 I/O 会使得 qemu 触发 VM exit，这个逻辑我们在解析 CPU 的时候看到过。</p>
<p>接下来，我们那会调用 VirtQueue 的 handle_output 函数。前面我们已经设置过这个函数了，其实就是 virtio_net_handle_tx_bh。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static void virtio_net_handle_tx_bh(VirtIODevice *vdev, VirtQueue *vq)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtIONet *n = VIRTIO_NET(vdev);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtIONetQueue *q = &amp;n-&gt;vqs[vq2q(virtio_get_queue_index(vq))];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     q-&gt;tx_waiting = 1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     virtio_queue_set_notification(vq, 0);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    qemu_bh_schedule(q-&gt;tx_bh);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>virtio_net_handle_tx_bh 调用了 qemu_bh_schedule，而在 virtio_net_add_queue 中调用 qemu_bh_new，并把函数设置为 virtio_net_tx_bh。</p>
<p>virtio_net_tx_bh 函数调用发送函数 virtio_net_flush_tx。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static int32_t virtio_net_flush_tx(VirtIONetQueue *q)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtIONet *n = q-&gt;n;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtIODevice *vdev = VIRTIO_DEVICE(n);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    VirtQueueElement *elem;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    int32_t num_packets = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    int queue_index = vq2q(virtio_get_queue_index(q-&gt;tx_vq));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     for (;;) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        ssize_t ret;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        unsigned int out_num;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        struct iovec sg[VIRTQUEUE_MAX_SIZE], sg2[VIRTQUEUE_MAX_SIZE + 1], *out_sg;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        struct virtio_net_hdr_mrg_rxbuf mhdr;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         elem = virtqueue_pop(q-&gt;tx_vq, sizeof(VirtQueueElement));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        out_num = elem-&gt;out_num;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        out_sg = elem-&gt;out_sg;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        ret = qemu_sendv_packet_async(qemu_get_subqueue(n-&gt;nic, queue_index),out_sg, out_num, virtio_net_tx_complete);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return num_packets;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>virtio_net_flush_tx 会调用 virtqueue_pop。这里面，我们能看到对于 vring 的操作，也即从这里面将客户机里面写入的数据读取出来。</p>
<p>然后，我们调用 qemu_sendv_packet_async 发送网络包。接下来的调用链为：qemu_sendv_packet_async-&gt;qemu_net_queue_send_iov-&gt;qemu_net_queue_flush-&gt;qemu_net_queue_deliver。</p>
<p>在 qemu_net_queue_deliver 中，我们会调用 NetQueue 的 deliver 函数。前面 qemu_new_net_queue 会把 deliver 函数设置为 qemu_deliver_packet_iov。它会调用 nc-&gt;info-&gt;receive_iov。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">NetClientInfo</span> <span class="n">net_tap_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NET_CLIENT_DRIVER_TAP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">TAPState</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">receive</span> <span class="o">=</span> <span class="n">tap_receive</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">receive_raw</span> <span class="o">=</span> <span class="n">tap_receive_raw</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">receive_iov</span> <span class="o">=</span> <span class="n">tap_receive_iov</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">tap_poll</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">tap_cleanup</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">has_ufo</span> <span class="o">=</span> <span class="n">tap_has_ufo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">has_vnet_hdr</span> <span class="o">=</span> <span class="n">tap_has_vnet_hdr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">has_vnet_hdr_len</span> <span class="o">=</span> <span class="n">tap_has_vnet_hdr_len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">using_vnet_hdr</span> <span class="o">=</span> <span class="n">tap_using_vnet_hdr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">set_offload</span> <span class="o">=</span> <span class="n">tap_set_offload</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">set_vnet_hdr_len</span> <span class="o">=</span> <span class="n">tap_set_vnet_hdr_len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">set_vnet_le</span> <span class="o">=</span> <span class="n">tap_set_vnet_le</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">set_vnet_be</span> <span class="o">=</span> <span class="n">tap_set_vnet_be</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据 net_tap_info 的定义调用的是 tap_receive_iov。他会调用 tap_write_packet-&gt;writev 写入这个字符设备。</p>
<p>在内核的字符设备驱动中，tun_chr_write_iter 会被调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static ssize_t tun_chr_write_iter(struct kiocb *iocb, struct iov_iter *from)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct file *file = iocb-&gt;ki_filp;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct tun_struct *tun = tun_get(file);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	struct tun_file *tfile = file-&gt;private_data;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	ssize_t result;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	result = tun_get_user(tun, tfile, NULL, from,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			      file-&gt;f_flags &amp; O_NONBLOCK, false);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	tun_put(tun);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return result;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当我们使用 writev() 系统调用向 tun/tap 设备的字符设备文件写入数据时，tun_chr_write 函数将被调用。它会使用 tun_get_user，从用户区接收数据，将数据存入 skb 中，然后调用关键的函数 netif_rx_ni(skb) ，将 skb 送给 tcp/ip 协议栈处理，最终完成虚拟网卡的数据接收。</p>
<p>至此，从虚拟机内部到宿主机的网络传输过程才算结束。</p>
<h2 id="总结时刻">总结时刻</h2>
<p>最后，我们把网络虚拟化场景下网络包的发送过程总结一下。</p>
<ul>
<li>在虚拟机里面的用户态，应用程序通过 write 系统调用写入 socket。</li>
<li>写入的内容经过 VFS 层，内核协议栈，到达虚拟机里面的内核的网络设备驱动，也即 virtio_net。</li>
<li>virtio_net 网络设备有一个操作结构 struct net_device_ops，里面定义了发送一个网络包调用的函数为 start_xmit。</li>
<li>在 virtio_net 的前端驱动和 qemu 中的后端驱动之间，有两个队列 virtqueue，一个用于发送，一个用于接收。然后，我们需要在 start_xmit 中调用 virtqueue_add，将网络包放入发送队列，然后调用 virtqueue_notify 通知 qemu。</li>
<li>qemu 本来处于 KVM_RUN 的状态，收到通知后，通过 VM exit 指令退出客户机模式，进入宿主机模式。发送网络包的时候，virtio_net_handle_tx_bh 函数会被调用。</li>
<li>接下来是一个 for 循环，我们需要在循环中调用 virtqueue_pop，从传输队列中获取要发送的数据，然后调用 qemu_sendv_packet_async 进行发送。</li>
<li>qemu 会调用 writev 向字符设备文件写入，进入宿主机的内核。</li>
<li>在宿主机内核中字符设备文件的 file_operations 里面的 write_iter 会被调用，也即会调用 tun_chr_write_iter。</li>
<li>在 tun_chr_write_iter 函数中，tun_get_user 将要发送的网络包从 qemu 拷贝到宿主机内核里面来，然后调用 netif_rx_ni 开始调用宿主机内核协议栈进行处理。</li>
<li>宿主机内核协议栈处理完毕之后，会发送给 tap 虚拟网卡，完成从虚拟机里面到宿主机的整个发送过程。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/1c9b574efe926d8baadc3925a4110c43.png" alt=""></p>
<h2 id="课堂练习">课堂练习</h2>
<p>这一节我们解析的是发送过程，请你根据类似的思路，解析一下接收过程。</p>
<p>欢迎留言和我分享你的疑惑和见解，也欢迎收藏本节内容，反复研读。你也可以把今天的内容分享给你的朋友，和他一起学习和进步。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/1a5564dd4e1c9f25d4772c7f844ca84a.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">趣谈Linux操作系统</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/55__%E5%A5%97%E8%B7%AF%E7%AF%87%E5%88%86%E6%9E%90%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E7%9A%84%E4%B8%80%E8%88%AC%E6%AD%A5%E9%AA%A4/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">55__套路篇：分析性能问题的一般步骤</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E/55__%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%89%96%E6%9E%90%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E5%9C%A8java_integerstring%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">
            <span class="next-text nav-default">55__享元模式（下）：剖析享元模式在Java_Integer、String中的应用</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
