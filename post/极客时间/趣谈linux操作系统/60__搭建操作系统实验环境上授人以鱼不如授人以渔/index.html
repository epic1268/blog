<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>60__搭建操作系统实验环境（上）：授人以鱼不如授人以渔 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="操作系统的理论部分我们就讲完了，但是计算机这门学科是实验性的。为了更加深入地了解操作系统的本质，我们必须能够做一些上手实验。操作系统的实验，相比其他计算机课程的实验要更加复杂一些。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/60__%E6%90%AD%E5%BB%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E4%B8%8A%E6%8E%88%E4%BA%BA%E4%BB%A5%E9%B1%BC%E4%B8%8D%E5%A6%82%E6%8E%88%E4%BA%BA%E4%BB%A5%E6%B8%94/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/60__%E6%90%AD%E5%BB%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E4%B8%8A%E6%8E%88%E4%BA%BA%E4%BB%A5%E9%B1%BC%E4%B8%8D%E5%A6%82%E6%8E%88%E4%BA%BA%E4%BB%A5%E6%B8%94/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="60__搭建操作系统实验环境（上）：授人以鱼不如授人以渔">
  <meta property="og:description" content="操作系统的理论部分我们就讲完了，但是计算机这门学科是实验性的。为了更加深入地了解操作系统的本质，我们必须能够做一些上手实验。操作系统的实验，相比其他计算机课程的实验要更加复杂一些。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="趣谈Linux操作系统">

  <meta itemprop="name" content="60__搭建操作系统实验环境（上）：授人以鱼不如授人以渔">
  <meta itemprop="description" content="操作系统的理论部分我们就讲完了，但是计算机这门学科是实验性的。为了更加深入地了解操作系统的本质，我们必须能够做一些上手实验。操作系统的实验，相比其他计算机课程的实验要更加复杂一些。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="3544">
  <meta itemprop="keywords" content="趣谈Linux操作系统">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="60__搭建操作系统实验环境（上）：授人以鱼不如授人以渔">
  <meta name="twitter:description" content="操作系统的理论部分我们就讲完了，但是计算机这门学科是实验性的。为了更加深入地了解操作系统的本质，我们必须能够做一些上手实验。操作系统的实验，相比其他计算机课程的实验要更加复杂一些。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">60__搭建操作系统实验环境（上）：授人以鱼不如授人以渔</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 3544 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#创建虚拟机">创建虚拟机</a></li>
        <li><a href="#下载源代码">下载源代码</a></li>
        <li><a href="#编译内核">编译内核</a></li>
        <li><a href="#总结时刻">总结时刻</a></li>
        <li><a href="#课堂练习">课堂练习</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>操作系统的理论部分我们就讲完了，但是计算机这门学科是实验性的。为了更加深入地了解操作系统的本质，我们必须能够做一些上手实验。操作系统的实验，相比其他计算机课程的实验要更加复杂一些。</p>
<p>我们做任何实验，都需要一个实验环境。这个实验环境要搭建在操作系统之上，但是，我们这个课程本身就是操作系统实验，难不成要自己 debug 自己？到底该咋整呢？</p>
<p>我们有一个利器，那就是 qemu 啊，不知道你还记得吗？它可以在操作系统之上模拟一个操作系统，就像一个普通的进程。那我们是否可以像 debug 普通进程那样，通过 qemu 来 debug 虚拟机里面的操作系统呢？</p>
<p>这一节和下一节，我们就按照这个思路，来试试看，搭建一个操作系统的实验环境。</p>
<p>运行一个 qemu 虚拟机，首先我们要有一个虚拟机的镜像。咱们在<a href="./108964.md">虚拟机</a>那一节，已经制作了一个虚拟机的镜像。假设我们要基于 <a href="./ubuntu-18.04.2-live-server-amd64.iso.md">ubuntu-18.04.2-live-server-amd64.iso</a>，它对应的内核版本是 linux-source-4.15.0。</p>
<p>当时我们启动虚拟机的过程很复杂，设置参数的时候也很复杂，以至于解析这些参数就花了我们一章的时间。所以，这里我介绍一个简单的创建和管理虚拟机的方法。</p>
<p>在<a href="./109335.md">CPU 虚拟化</a>那一节，我留过一个思考题，OpenStack 是如何创建和管理虚拟机的？当时我给了你一个提示，就是用 libvirt。没错，这一节，我们就用 libvirt 来创建和管理虚拟机。</p>
<h2 id="创建虚拟机">创建虚拟机</h2>
<p>首先，在宿主机上，我们需要一个网桥。我们用下面的命令创建一个网桥，并且设置一个 IP 地址。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">brctl addbr br0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ip link set br0 up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ifconfig br0 192.168.57.1/24
</span></span></code></pre></td></tr></table>
</div>
</div><p>为了访问外网，这里还需要设置 /etc/sysctl.conf 文件中 net.ipv4.ip_forward=1 参数，并且执行以下的命令，设置 NAT。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，就要创建虚拟机了。这次我们就不再一个个指定虚拟机启动的参数，而是用 libvirt。首先，使用下面的命令，安装 libvirt。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apt-get install libvirt-bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apt-get install virtinst
</span></span></code></pre></td></tr></table>
</div>
</div><p>libvirt 管理 qemu 虚拟机，是基于 XML 文件，这样容易维护。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;domain type=&#39;qemu&#39;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;name&gt;ubuntutest&lt;/name&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;uuid&gt;0f0806ab-531d-6134-5def-c5b4955292aa&lt;/uuid&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;memory unit=&#39;GiB&#39;&gt;4&lt;/memory&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;currentMemory unit=&#39;GiB&#39;&gt;4&lt;/currentMemory&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;vcpu placement=&#39;static&#39;&gt;2&lt;/vcpu&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;os&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-trusty&#39;&gt;hvm&lt;/type&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;boot dev=&#39;hd&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;/os&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;features&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;acpi/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;apic/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;pae/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;/features&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;clock offset=&#39;utc&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;on_crash&gt;restart&lt;/on_crash&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &lt;devices&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;driver name=&#39;qemu&#39; type=&#39;qcow2&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;source file=&#39;/mnt/vdc/ubuntutest.img&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;target dev=&#39;vda&#39; bus=&#39;virtio&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;/disk&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;controller type=&#39;pci&#39; index=&#39;0&#39; model=&#39;pci-root&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;interface type=&#39;bridge&#39;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;mac address=&#39;fa:16:3e:6e:89:ce&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;source bridge=&#39;br0&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;target dev=&#39;tap1&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;model type=&#39;virtio&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;/interface&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;serial type=&#39;pty&#39;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;target port=&#39;0&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;/serial&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;console type=&#39;pty&#39;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;target type=&#39;serial&#39; port=&#39;0&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;/console&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;graphics type=&#39;vnc&#39; port=&#39;-1&#39; autoport=&#39;yes&#39; listen=&#39;0.0.0.0&#39;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;listen type=&#39;address&#39; address=&#39;0.0.0.0&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;/graphics&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;video&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      &lt;model type=&#39;cirrus&#39;/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;/video&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;/devices&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/domain&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个 XML 文件中，/mnt/vdc/ubuntutest.img 就是虚拟机的镜像，br0 就是我们创建的网桥，连接到网桥上的网卡 libvirt 会自动帮我们创建。</p>
<p>接下来，需要将这个 XML 保存为 domain.xml，然后调用下面的命令，交给 libvirt 进行管理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">virsh define domain.xml
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，运行 virsh list &ndash;all，我们就可以看到这个定义好的虚拟机了，然后我们调用 virsh start ubuntutest，启动这个虚拟机。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># virsh list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Id    Name                           State
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">----------------------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 1     ubuntutest                     running
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以通过 ps 查看 libvirt 启动的 qemu 进程。这个命令行是不是很眼熟？我们之前花了一章来讲解。如果不记得了，你可以回去看看前面的内容。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ps aux | grep qemu</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libvirt</span><span class="o">+</span>  <span class="mi">9343</span> <span class="mf">85.1</span> <span class="mf">34.7</span> <span class="mi">10367352</span> <span class="mi">5699400</span> <span class="err">?</span>    <span class="n">Sl</span>   <span class="n">Jul27</span> <span class="mi">1239</span><span class="p">:</span><span class="mi">18</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span> <span class="o">-</span><span class="n">name</span> <span class="n">ubuntutest</span> <span class="o">-</span><span class="n">S</span> <span class="o">-</span><span class="n">machine</span> <span class="n">pc</span><span class="o">-</span><span class="n">i440fx</span><span class="o">-</span><span class="n">trusty</span><span class="p">,</span><span class="n">accel</span><span class="o">=</span><span class="n">tcg</span><span class="p">,</span><span class="n">usb</span><span class="o">=</span><span class="n">off</span> <span class="o">-</span><span class="n">m</span> <span class="mi">4096</span> <span class="o">-</span><span class="n">realtime</span> <span class="n">mlock</span><span class="o">=</span><span class="n">off</span> <span class="o">-</span><span class="n">smp</span> <span class="mi">2</span><span class="p">,</span><span class="n">sockets</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">threads</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">uuid</span> <span class="mi">0</span><span class="n">f0806ab</span><span class="o">-</span><span class="mi">531</span><span class="n">d</span><span class="o">-</span><span class="mi">6134</span><span class="o">-</span><span class="mi">5</span><span class="n">def</span><span class="o">-</span><span class="n">c5b4955292aa</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">config</span> <span class="o">-</span><span class="n">nodefaults</span> <span class="o">-</span><span class="n">chardev</span> <span class="n">socket</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">charmonitor</span><span class="p">,</span><span class="n">path</span><span class="o">=/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">qemu</span><span class="o">/</span><span class="n">domain</span><span class="o">-</span><span class="n">ubuntutest</span><span class="o">/</span><span class="n">monitor</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span><span class="n">server</span><span class="p">,</span><span class="n">nowait</span> <span class="o">-</span><span class="n">mon</span> <span class="n">chardev</span><span class="o">=</span><span class="n">charmonitor</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">monitor</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">control</span> <span class="o">-</span><span class="n">rtc</span> <span class="n">base</span><span class="o">=</span><span class="n">utc</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">shutdown</span> <span class="o">-</span><span class="n">boot</span> <span class="n">strict</span><span class="o">=</span><span class="n">on</span> <span class="o">-</span><span class="n">device</span> <span class="n">piix3</span><span class="o">-</span><span class="n">usb</span><span class="o">-</span><span class="n">uhci</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">usb</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">pci</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span><span class="n">addr</span><span class="o">=</span><span class="mh">0x1</span><span class="o">.</span><span class="mh">0x2</span> <span class="o">-</span><span class="n">drive</span> <span class="n">file</span><span class="o">=/</span><span class="n">mnt</span><span class="o">/</span><span class="n">vdc</span><span class="o">/</span><span class="n">ubuntutest</span><span class="o">.</span><span class="n">img</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">qcow2</span><span class="p">,</span><span class="k">if</span><span class="o">=</span><span class="n">none</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">drive</span><span class="o">-</span><span class="n">virtio</span><span class="o">-</span><span class="n">disk0</span> <span class="o">-</span><span class="n">device</span> <span class="n">virtio</span><span class="o">-</span><span class="n">blk</span><span class="o">-</span><span class="n">pci</span><span class="p">,</span><span class="n">scsi</span><span class="o">=</span><span class="n">off</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">pci</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span><span class="n">addr</span><span class="o">=</span><span class="mh">0x4</span><span class="p">,</span><span class="n">drive</span><span class="o">=</span><span class="n">drive</span><span class="o">-</span><span class="n">virtio</span><span class="o">-</span><span class="n">disk0</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">virtio</span><span class="o">-</span><span class="n">disk0</span><span class="p">,</span><span class="n">bootindex</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">netdev</span> <span class="n">tap</span><span class="p">,</span><span class="n">fd</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">hostnet0</span> <span class="o">-</span><span class="n">device</span> <span class="n">virtio</span><span class="o">-</span><span class="n">net</span><span class="o">-</span><span class="n">pci</span><span class="p">,</span><span class="n">netdev</span><span class="o">=</span><span class="n">hostnet0</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">net0</span><span class="p">,</span><span class="n">mac</span><span class="o">=</span><span class="n">fa</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">3</span><span class="n">e</span><span class="p">:</span><span class="mi">6</span><span class="n">e</span><span class="p">:</span><span class="mi">89</span><span class="p">:</span><span class="n">ce</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">pci</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span><span class="n">addr</span><span class="o">=</span><span class="mh">0x3</span> <span class="o">-</span><span class="n">chardev</span> <span class="n">pty</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">charserial0</span> <span class="o">-</span><span class="n">device</span> <span class="n">isa</span><span class="o">-</span><span class="n">serial</span><span class="p">,</span><span class="n">chardev</span><span class="o">=</span><span class="n">charserial0</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">serial0</span> <span class="o">-</span><span class="n">vnc</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">0</span> <span class="o">-</span><span class="n">device</span> <span class="n">cirrus</span><span class="o">-</span><span class="n">vga</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">video0</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">pci</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span><span class="n">addr</span><span class="o">=</span><span class="mh">0x2</span> <span class="o">-</span><span class="n">device</span> <span class="n">virtio</span><span class="o">-</span><span class="n">balloon</span><span class="o">-</span><span class="n">pci</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">balloon0</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">pci</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span><span class="n">addr</span><span class="o">=</span><span class="mh">0x5</span> <span class="o">-</span><span class="n">msg</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">on</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从这里，我们可以看到，VNC 的设置为 0.0.0.0:0。我们可以用 VNCViewer 工具登录到这个虚拟机的界面，但是这样实在是太麻烦了，其实 virsh 有一个特别好的工具，但是需要在虚拟机里面配置一些东西。</p>
<p>在虚拟机里面，我们修改 /boot/grub/ 里面的两个文件，一个是 grub.cfg，另一个是 menu.lst，这里面就是咱们在<a href="./89739.md">系统初始化</a>的时候，讲过的那个启动列表。</p>
<p>在 grub.cfg 中，在 submenu‘Advanced options for Ubuntu’这一项，在这一行的 linux /boot/vmlinuz-4.15.0-55-generic root=UUID=470f3a42-7a97-4b9d-aaa0-26deb3d234f9 ro console=ttyS0 maybe-ubiquity 中，加上了 console=ttyS0。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">submenu</span> <span class="s1">&#39;Advanced options for Ubuntu&#39;</span> <span class="o">$</span><span class="n">menuentry_id_option</span> <span class="s1">&#39;gnulinux-advanced-470f3a42-7a97-4b9d-aaa0-26deb3d234f9&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">menuentry</span> <span class="s1">&#39;Ubuntu, with Linux 4.15.0-55-generic&#39;</span> <span class="o">--</span><span class="k">class</span> <span class="n">ubuntu</span> <span class="o">--</span><span class="k">class</span> <span class="n">gnu</span><span class="o">-</span><span class="n">linux</span> <span class="o">--</span><span class="k">class</span> <span class="n">gnu</span> <span class="o">--</span><span class="k">class</span> <span class="n">os</span> <span class="o">$</span><span class="n">menuentry_id_option</span> <span class="s1">&#39;gnulinux-4.15.0-55-generic-advanced-470f3a42-7a97-4b9d-aaa0-26deb3d234f9&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">recordfail</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">load_video</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">gfxmode</span> <span class="o">$</span><span class="n">linux_gfx_mode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">insmod</span> <span class="n">gzio</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">[</span> <span class="n">x</span><span class="o">$</span><span class="n">grub_platform</span> <span class="o">=</span> <span class="n">xxen</span> <span class="p">];</span> <span class="n">then</span> <span class="n">insmod</span> <span class="n">xzio</span><span class="p">;</span> <span class="n">insmod</span> <span class="n">lzopio</span><span class="p">;</span> <span class="n">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">insmod</span> <span class="n">part_gpt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">insmod</span> <span class="n">ext2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">set</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;hd0,gpt2&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">[</span> <span class="n">x</span><span class="o">$</span><span class="n">feature_platform_search_hint</span> <span class="o">=</span> <span class="n">xy</span> <span class="p">];</span> <span class="n">then</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">search</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span> <span class="o">--</span><span class="n">fs</span><span class="o">-</span><span class="n">uuid</span> <span class="o">--</span><span class="n">set</span><span class="o">=</span><span class="n">root</span> <span class="o">--</span><span class="n">hint</span><span class="o">-</span><span class="n">bios</span><span class="o">=</span><span class="n">hd0</span><span class="p">,</span><span class="n">gpt2</span> <span class="o">--</span><span class="n">hint</span><span class="o">-</span><span class="n">efi</span><span class="o">=</span><span class="n">hd0</span><span class="p">,</span><span class="n">gpt2</span> <span class="o">--</span><span class="n">hint</span><span class="o">-</span><span class="n">baremetal</span><span class="o">=</span><span class="n">ahci0</span><span class="p">,</span><span class="n">gpt2</span>  <span class="mi">470</span><span class="n">f3a42</span><span class="o">-</span><span class="mi">7</span><span class="n">a97</span><span class="o">-</span><span class="mi">4</span><span class="n">b9d</span><span class="o">-</span><span class="n">aaa0</span><span class="o">-</span><span class="mi">26</span><span class="n">deb3d234f9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">search</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span> <span class="o">--</span><span class="n">fs</span><span class="o">-</span><span class="n">uuid</span> <span class="o">--</span><span class="n">set</span><span class="o">=</span><span class="n">root</span> <span class="mi">470</span><span class="n">f3a42</span><span class="o">-</span><span class="mi">7</span><span class="n">a97</span><span class="o">-</span><span class="mi">4</span><span class="n">b9d</span><span class="o">-</span><span class="n">aaa0</span><span class="o">-</span><span class="mi">26</span><span class="n">deb3d234f9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">echo</span>    <span class="s1">&#39;Loading Linux 4.15.0-55-generic ...&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">linux</span>   <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="mf">4.15</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">55</span><span class="o">-</span><span class="n">generic</span> <span class="n">root</span><span class="o">=</span><span class="n">UUID</span><span class="o">=</span><span class="mi">470</span><span class="n">f3a42</span><span class="o">-</span><span class="mi">7</span><span class="n">a97</span><span class="o">-</span><span class="mi">4</span><span class="n">b9d</span><span class="o">-</span><span class="n">aaa0</span><span class="o">-</span><span class="mi">26</span><span class="n">deb3d234f9</span> <span class="n">ro</span> <span class="n">console</span><span class="o">=</span><span class="n">ttyS0</span> <span class="n">maybe</span><span class="o">-</span><span class="n">ubiquity</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">echo</span>    <span class="s1">&#39;Loading initial ramdisk ...&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">initrd</span>  <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">4.15</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">55</span><span class="o">-</span><span class="n">generic</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 menu.lst 文件中，在 Ubuntu 18.04.2 LTS, kernel 4.15.0-55-generic 这一项，在 kernel /boot/vmlinuz-4.15.0-55-generic root=/dev/hda1 ro console=hvc0 console=ttyS0 这一行加入 console=ttyS0。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">title           Ubuntu 18.04.2 LTS, kernel 4.15.0-55-generic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root            (hd0)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kernel          /boot/vmlinuz-4.15.0-55-generic root=/dev/hda1 ro console=hvc0 console=ttyS0 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">initrd          /boot/initrd.img-4.15.0-55-generic
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，我们重启虚拟机，重启后上面的配置就起作用了。这时候，我们可以通过下面的命令，进入机器的控制台，可以不依赖于 SSH 和 IP 地址进行登录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># virsh console ubuntutest
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Connected to domain ubuntutest
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Escape character is ^]
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面，我们可以配置这台机器的 IP 地址了。对于 ubuntu-18.04 来讲，IP 地址的配置方式为修改 /etc/netplan/50-cloud-init.yaml 文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">network:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ethernets:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        ens3:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                addresses: [192.168.57.100/24]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                gateway4: 192.168.57.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                dhcp4: no
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                nameservers:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        addresses: [8.8.8.8,114.114.114.114]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                optional: true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    version: 2
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，我们可以通过 netplan apply，让配置生效，这样，虚拟机里面的 IP 地址就配置好了。现在，我们应该能 ping 得通公网的一个网站了。</p>
<p>虚拟机就此创建好了，接下来我们需要下载源代码重新编译。</p>
<h2 id="下载源代码">下载源代码</h2>
<p>首先，我们先下载源代码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apt-get install linux-source-4.15.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>这行命令会将代码下载到 /usr/src/ 目录下，我们可以通过下面的命令解压缩。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tar vjxkf linux-source-4.15.0.tar.bz2
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，路径 /usr/src/linux-source-4.15.0 下，就是解压好的内核代码。</p>
<p>准备工作都做好了。这一节，我们先来做第一个实验，也就是，在原有内核代码的基础上加一个我们自己的系统调用。</p>
<p>在哪里加代码呢？如果你忘了，请出门左转，回顾一下<a href="./90394.md">系统调用</a>那一节。</p>
<p>第一个要加的地方是 arch/x86/entry/syscalls/syscall_64.tbl。这里面登记了所有的系统调用号以及相应的处理函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">332     common  statx                   sys_statx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">333     64      sayhelloworld           sys_sayhelloworld
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里，我们找到 332 号系统调用 sys_statx，然后照猫画虎，添加一个 sys_sayhelloworld，这里我们只添加 64 位操作系统的。</p>
<p>第二个要加的地方是 include/linux/syscalls.h，也就是系统调用的头文件，然后添加一个系统调用的声明。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">asmlinkage</span> <span class="n">long</span> <span class="n">sys_statx</span><span class="p">(</span><span class="ne">int</span> <span class="n">dfd</span><span class="p">,</span> <span class="k">const</span> <span class="n">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                          <span class="n">unsigned</span> <span class="n">mask</span><span class="p">,</span> <span class="n">struct</span> <span class="n">statx</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">asmlinkage</span> <span class="ne">int</span> <span class="n">sys_sayhelloworld</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span> <span class="n">words</span><span class="p">,</span> <span class="ne">int</span> <span class="n">count</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>同样，我们找到 sys_statx 的声明，照猫画虎，声明一个 sys_sayhelloworld。其中，words 参数是用户态传递给内核态的文本的指针，count 是数目。</p>
<p>第三个就是对于这个系统调用的实现，方便起见，我们不再用 SYSCALL_DEFINEx 系列的宏来定义了，直接在 kernel/sys.c 中实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">asmlinkage int sys_sayhelloworld(char * words, int count){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	int ret;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	char buffer[512];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if(count &gt;= 512){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		return -1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	copy_from_user(buffer, words, count);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	ret=printk(&#34;User Mode says %s to the Kernel Mode!&#34;, buffer);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return ret;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来就要开始编译内核了。</p>
<h2 id="编译内核">编译内核</h2>
<p>编译之前，我们需要安装一些编译要依赖的包。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apt-get install libncurses5-dev libssl-dev bison flex libelf-dev gcc make openssl libc6-dev
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先，我们要定义编译选项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">make menuconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，我们能通过选中下面的选项，激活 CONFIG_DEBUG_INFO 和 CONFIG_FRAME_POINTER 选项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Kernel hacking  ---&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Compile-time checks and compiler options  ---&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[*] Compile the kernel with debug info 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[*] Compile the kernel with frame pointers
</span></span></code></pre></td></tr></table>
</div>
</div><p>选择完毕之后，配置会保存在.config 文件中。如果我们打开看，能看到这样的配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CONFIG_FRAME_POINTER=y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CONFIG_DEBUG_INFO=y
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，我们编译内核。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nohup make -j8 &gt; make1.log 2&gt;&amp;1 &amp;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nohup make modules_install &gt; make2.log 2&gt;&amp;1 &amp;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nohup make install &gt; make3.log 2&gt;&amp;1 &amp;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是一个非常长的过程，请耐心等待，可能需要数个小时，因而这里用了 nohup，你可以去干别的事情。</p>
<p>当编译完毕之后，grub 和 menu.lst 都会发生改变。例如，grub.conf 里面会多一个新内核的项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">submenu</span> <span class="s1">&#39;Advanced options for Ubuntu&#39;</span> <span class="o">$</span><span class="n">menuentry_id_option</span> <span class="s1">&#39;gnulinux-advanced-470f3a42-7a97-4b9d-aaa0-26deb3d234f9&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">menuentry</span> <span class="s1">&#39;Ubuntu, with Linux 4.15.18&#39;</span> <span class="o">--</span><span class="k">class</span> <span class="n">ubuntu</span> <span class="o">--</span><span class="k">class</span> <span class="n">gnu</span><span class="o">-</span><span class="n">linux</span> <span class="o">--</span><span class="k">class</span> <span class="n">gnu</span> <span class="o">--</span><span class="k">class</span> <span class="n">os</span> <span class="o">$</span><span class="n">menuentry_id_option</span> <span class="s1">&#39;gnulinux-4.15.18-advanced-470f3a42-7a97-4b9d-aaa0-26deb3d234f9&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">recordfail</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">load_video</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">gfxmode</span> <span class="o">$</span><span class="n">linux_gfx_mode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">insmod</span> <span class="n">gzio</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">[</span> <span class="n">x</span><span class="o">$</span><span class="n">grub_platform</span> <span class="o">=</span> <span class="n">xxen</span> <span class="p">];</span> <span class="n">then</span> <span class="n">insmod</span> <span class="n">xzio</span><span class="p">;</span> <span class="n">insmod</span> <span class="n">lzopio</span><span class="p">;</span> <span class="n">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">insmod</span> <span class="n">part_gpt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">insmod</span> <span class="n">ext2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">[</span> <span class="n">x</span><span class="o">$</span><span class="n">feature_platform_search_hint</span> <span class="o">=</span> <span class="n">xy</span> <span class="p">];</span> <span class="n">then</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  <span class="n">search</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span> <span class="o">--</span><span class="n">fs</span><span class="o">-</span><span class="n">uuid</span> <span class="o">--</span><span class="n">set</span><span class="o">=</span><span class="n">root</span>  <span class="mi">470</span><span class="n">f3a42</span><span class="o">-</span><span class="mi">7</span><span class="n">a97</span><span class="o">-</span><span class="mi">4</span><span class="n">b9d</span><span class="o">-</span><span class="n">aaa0</span><span class="o">-</span><span class="mi">26</span><span class="n">deb3d234f9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  <span class="n">search</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span> <span class="o">--</span><span class="n">fs</span><span class="o">-</span><span class="n">uuid</span> <span class="o">--</span><span class="n">set</span><span class="o">=</span><span class="n">root</span> <span class="mi">470</span><span class="n">f3a42</span><span class="o">-</span><span class="mi">7</span><span class="n">a97</span><span class="o">-</span><span class="mi">4</span><span class="n">b9d</span><span class="o">-</span><span class="n">aaa0</span><span class="o">-</span><span class="mi">26</span><span class="n">deb3d234f9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">echo</span>    <span class="s1">&#39;Loading Linux 4.15.18 ...&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">linux</span>   <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="mf">4.15</span><span class="o">.</span><span class="mi">18</span> <span class="n">root</span><span class="o">=</span><span class="n">UUID</span><span class="o">=</span><span class="mi">470</span><span class="n">f3a42</span><span class="o">-</span><span class="mi">7</span><span class="n">a97</span><span class="o">-</span><span class="mi">4</span><span class="n">b9d</span><span class="o">-</span><span class="n">aaa0</span><span class="o">-</span><span class="mi">26</span><span class="n">deb3d234f9</span> <span class="n">ro</span> <span class="n">console</span><span class="o">=</span><span class="n">ttyS0</span> <span class="n">maybe</span><span class="o">-</span><span class="n">ubiquity</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">echo</span>    <span class="s1">&#39;Loading initial ramdisk ...&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">initrd</span>  <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">4.15</span><span class="o">.</span><span class="mi">18</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>例如，menu.lst 也多了新的内核的项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">title           Ubuntu 18.04.2 LTS, kernel 4.15.18
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root            (hd0)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kernel          /boot/vmlinuz-4.15.18 root=/dev/hda1 ro console=hvc0 console=ttyS0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">initrd          /boot/initrd.img-4.15.18
</span></span></code></pre></td></tr></table>
</div>
</div><p>别忘了，这里面都要加上 console=ttyS0。</p>
<p>下面，我们要做的就是重启虚拟机。进入的时候，会出现 GRUB 界面。我们选择 Ubuntu 高级选项，然后选择第一项进去，通过 uname 命令，我们就进入了新的内核。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># uname -a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Linux popsuper 4.15.18 #1 SMP Sat Jul 27 13:43:42 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
</span></span></code></pre></td></tr></table>
</div>
</div><p>进入新的系统后，我们写一个测试程序。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#include &lt;stdio.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#include &lt;stdlib.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#include &lt;unistd.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#include &lt;linux/kernel.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#include &lt;sys/syscall.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#include &lt;string.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> int main ()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  char * words = &#34;I am liuchao from user mode.&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  int ret;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ret = syscall(333, words, strlen(words)+1);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  printf(&#34;return %d from kernel mode.\n&#34;, ret);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  return 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，我们能利用 gcc 编译器编译后运行。如果我们查看日志 /var/log/syslog，就能够看到里面打印出来下面的日志，这说明我们的系统调用已经添加成功了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Aug  1 06:33:12 popsuper kernel: [ 2048.873393] User Mode says I am liuchao from user mode. to the Kernel Mode!
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结时刻">总结时刻</h2>
<p>这一节是一节实战课，我们创建了一台虚拟机，在里面下载源代码，尝试修改了 Linux 内核，添加了一个自己的系统调用，并且进行了编译并安装了新内核。如果你按照这个过程做下来，你会惊喜地发现，原来令我们敬畏的内核，也是能够加以干预，为我而用的呢。没错，这就是你开始逐渐掌握内核的重要一步。</p>
<h2 id="课堂练习">课堂练习</h2>
<p>这一节的课堂练习，希望你能够按照整个过程，一步一步操作下来。毕竟看懂不算懂，做出来才算入门啊。</p>
<p>欢迎留言和我分享你的疑惑和见解，也欢迎你收藏本节内容，反复研读。你也可以把今天的内容分享给你的朋友，和他一起学习、进步。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/1a5564dd4e1c9f25d4772c7f844ca84a.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E8%B6%A3%E8%B0%88linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">趣谈Linux操作系统</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E/60__%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8A%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%86%97%E9%95%BF%E7%9A%84if-else_switch%E5%88%86%E6%94%AF%E5%88%A4%E6%96%AD%E4%BB%A3%E7%A0%81/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">60__策略模式（上）：如何避免冗长的if-else_switch分支判断代码？</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/60__%E6%9E%B6%E6%9E%84%E5%88%86%E8%A7%A3%E8%BE%B9%E7%95%8C%E4%B8%8D%E6%96%AD%E9%87%8D%E6%96%B0%E5%AE%A1%E8%A7%86%E8%BE%B9%E7%95%8C/">
            <span class="next-text nav-default">60__架构分解：边界，不断重新审视边界</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
