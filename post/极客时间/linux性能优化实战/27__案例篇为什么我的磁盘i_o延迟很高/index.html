<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>27__案例篇：为什么我的磁盘I_O延迟很高？ - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是倪朋飞。
上一节，我们研究了一个狂打日志引发 I/O 性能问题的案例，先来简单回顾一下。
日志，是了解应用程序内部运行情况，最常用也是最有效的工具。日志一般会分为调试、信息、警告、错误等多个不同级别。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/27__%E6%A1%88%E4%BE%8B%E7%AF%87%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E7%9A%84%E7%A3%81%E7%9B%98i_o%E5%BB%B6%E8%BF%9F%E5%BE%88%E9%AB%98/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/27__%E6%A1%88%E4%BE%8B%E7%AF%87%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E7%9A%84%E7%A3%81%E7%9B%98i_o%E5%BB%B6%E8%BF%9F%E5%BE%88%E9%AB%98/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="27__案例篇：为什么我的磁盘I_O延迟很高？">
  <meta property="og:description" content="你好，我是倪朋飞。
上一节，我们研究了一个狂打日志引发 I/O 性能问题的案例，先来简单回顾一下。
日志，是了解应用程序内部运行情况，最常用也是最有效的工具。日志一般会分为调试、信息、警告、错误等多个不同级别。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="Linux性能优化实战">

  <meta itemprop="name" content="27__案例篇：为什么我的磁盘I_O延迟很高？">
  <meta itemprop="description" content="你好，我是倪朋飞。
上一节，我们研究了一个狂打日志引发 I/O 性能问题的案例，先来简单回顾一下。
日志，是了解应用程序内部运行情况，最常用也是最有效的工具。日志一般会分为调试、信息、警告、错误等多个不同级别。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="5400">
  <meta itemprop="keywords" content="Linux性能优化实战">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="27__案例篇：为什么我的磁盘I_O延迟很高？">
  <meta name="twitter:description" content="你好，我是倪朋飞。
上一节，我们研究了一个狂打日志引发 I/O 性能问题的案例，先来简单回顾一下。
日志，是了解应用程序内部运行情况，最常用也是最有效的工具。日志一般会分为调试、信息、警告、错误等多个不同级别。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">27__案例篇：为什么我的磁盘I_O延迟很高？</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 5400 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#案例准备"><strong>案例准备</strong></a></li>
        <li><a href="#案例分析"><strong>案例分析</strong></a></li>
        <li><a href="#小结">小结</a></li>
        <li><a href="#思考">思考</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是倪朋飞。</p>
<p>上一节，我们研究了一个狂打日志引发 I/O 性能问题的案例，先来简单回顾一下。</p>
<p>日志，是了解应用程序内部运行情况，最常用也是最有效的工具。日志一般会分为调试、信息、警告、错误等多个不同级别。</p>
<p>通常，生产环境只用开启警告级别的日志，这一般不会导致 I/O 问题。但在偶尔排查问题时，可能需要我们开启调试日志。调试结束后，很可能忘了把日志级别调回去。这时，大量的调试日志就可能会引发 I/O 性能问题。</p>
<p>你可以用 iostat，确认是否有 I/O 性能瓶颈。再用 strace 和 lsof，来定位应用程序以及它正在写入的日志文件路径。最后通过应用程序的接口调整日志级别，完美解决 I/O 问题。</p>
<p>不过，如果应用程序没有动态调整日志级别的功能，你还需要修改应用配置并重启应用，以便让配置生效。</p>
<p>今天，我们再来看一个新的案例。这次案例是一个基于 Python Flask 框架的 Web 应用，它提供了一个查询单词热度的 API，但是 API 的响应速度并不让人满意。</p>
<p>非常感谢携程系统研发部资深后端工程师董国星，帮助提供了今天的案例。</p>
<h2 id="案例准备"><strong>案例准备</strong></h2>
<p>本次案例还是基于 Ubuntu 18.04，同样适用于其他的 Linux 系统。我使用的案例环境如下所示：</p>
<ul>
<li>机器配置：2 CPU，8GB 内存</li>
<li>预先安装 docker、sysstat 等工具，如 apt install <a href="./docker.io.md">docker.io</a> sysstat</li>
</ul>
<p>为了方便你运行今天的案例，我把它打包成了一个 Docker 镜像。这样，你就只需要运行 Docker 命令就可以启动它。</p>
<p>今天的案例需要两台虚拟机，其中一台是案例分析的目标机器，运行 Flask 应用，它的 IP 地址是 192.168.0.10；而另一台作为客户端，请求单词的热度。我画了一张图表示它们的关系，如下所示：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/83976f9ff6919586334cd2c9b29a7531.png" alt=""></p>
<p>接下来，打开两个终端，分别 SSH 登录到这两台虚拟机中，并在第一台虚拟机中，安装上述工具。</p>
<p>跟以前一样，案例中所有命令都默认以 root 用户运行，如果你是用普通用户身份登陆系统，请运行 sudo su root 命令切换到 root 用户。</p>
<p>到这里，准备工作就完成了。接下来，我们正式进入操作环节。</p>
<blockquote>
<p>温馨提示：案例中 Python 应用的核心逻辑比较简单，你可能一眼就能看出问题，但实际生产环境中的源码就复杂多了。所以，我依旧建议，操作之前别看源码，避免先入为主，而要把它当成一个黑盒来分析。这样，你可以更好把握，怎么从系统的资源使用问题出发，分析出瓶颈所在的应用，以及瓶颈在应用中大概的位置。</p>
</blockquote>
<h2 id="案例分析"><strong>案例分析</strong></h2>
<p>首先，我们在第一个终端中执行下面的命令，运行本次案例要分析的目标应用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ docker run --name=app -p 10000:80 -itd feisky/word-pop 
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，在第二个终端中运行 curl 命令，访问 <a href="http://192.168.0.10:1000/">http://192.168.0.10:1000/</a>，确认案例正常启动。你应该可以在 curl 的输出界面里，看到一个 hello world 的输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ curl http://192.168.0.10:10000/ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hello world 
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，在第二个终端中，访问案例应用的单词热度接口，也就是 <a href="http://192.168.0.10:1000/popularity/word">http://192.168.0.10:1000/popularity/word</a>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ curl http://192.168.0.10:1000/popularity/word 
</span></span></code></pre></td></tr></table>
</div>
</div><p>稍等一会儿，你会发现，这个接口居然这么长时间都没响应，究竟是怎么回事呢？我们先回到终端一来分析一下。</p>
<p>我们试试在第一个终端里，随便执行一个命令，比如执行 df 命令，查看一下文件系统的使用情况。奇怪的是，这么简单的命令，居然也要等好久才有输出。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ df 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Filesystem     1K-blocks    Used Available Use% Mounted on 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">udev             4073376       0   4073376   0% /dev 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tmpfs             816932    1188    815744   1% /run 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/dev/sda1       30308240 8713640  21578216  29% / 
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过 df 我们知道，系统还有足够多的磁盘空间。那为什么响应会变慢呢？看来还是得观察一下，系统的资源使用情况，像是 CPU、内存和磁盘 I/O 等的具体使用情况。</p>
<p>这里的思路其实跟上一个案例比较类似，我们可以先用 top 来观察 CPU 和内存的使用情况，然后再用 iostat 来观察磁盘的 I/O 情况。</p>
<p>为了避免分析过程中 curl 请求突然结束，我们回到终端二，按 Ctrl+C 停止刚才的应用程序；然后，把 curl 命令放到一个循环里执行；这次我们还要加一个 time 命令，观察每次的执行时间：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ while true; do time curl http://192.168.0.10:10000/popularity/word; sleep 1; done 
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续回到终端一来分析性能。我们在终端一中运行 top 命令，观察 CPU 和内存的使用情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">top</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">top</span> <span class="o">-</span> <span class="mi">14</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">02</span> <span class="n">up</span> <span class="mi">10</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>  <span class="mi">1</span> <span class="n">user</span><span class="p">,</span>  <span class="nb">load</span> <span class="n">average</span><span class="p">:</span> <span class="mf">1.82</span><span class="p">,</span> <span class="mf">1.26</span><span class="p">,</span> <span class="mf">0.76</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Tasks</span><span class="p">:</span> <span class="mi">129</span> <span class="n">total</span><span class="p">,</span>   <span class="mi">1</span> <span class="n">running</span><span class="p">,</span>  <span class="mi">74</span> <span class="n">sleeping</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">stopped</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">zombie</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">Cpu0</span>  <span class="p">:</span>  <span class="mf">3.5</span> <span class="n">us</span><span class="p">,</span>  <span class="mf">2.1</span> <span class="n">sy</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">ni</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">id</span><span class="p">,</span> <span class="mf">94.4</span> <span class="n">wa</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">hi</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">si</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">st</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">Cpu1</span>  <span class="p">:</span>  <span class="mf">2.4</span> <span class="n">us</span><span class="p">,</span>  <span class="mf">0.7</span> <span class="n">sy</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">ni</span><span class="p">,</span> <span class="mf">70.4</span> <span class="n">id</span><span class="p">,</span> <span class="mf">26.5</span> <span class="n">wa</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">hi</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">si</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">st</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">KiB</span> <span class="n">Mem</span> <span class="p">:</span>  <span class="mi">8169300</span> <span class="n">total</span><span class="p">,</span>  <span class="mi">3323248</span> <span class="n">free</span><span class="p">,</span>   <span class="mi">436748</span> <span class="n">used</span><span class="p">,</span>  <span class="mi">4409304</span> <span class="n">buff</span><span class="o">/</span><span class="n">cache</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">KiB</span> <span class="n">Swap</span><span class="p">:</span>        <span class="mi">0</span> <span class="n">total</span><span class="p">,</span>        <span class="mi">0</span> <span class="n">free</span><span class="p">,</span>        <span class="mi">0</span> <span class="n">used</span><span class="o">.</span>  <span class="mi">7412556</span> <span class="n">avail</span> <span class="n">Mem</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">PID</span> <span class="n">USER</span>      <span class="n">PR</span>  <span class="n">NI</span>    <span class="n">VIRT</span>    <span class="n">RES</span>    <span class="n">SHR</span> <span class="n">S</span>  <span class="o">%</span><span class="n">CPU</span> <span class="o">%</span><span class="n">MEM</span>     <span class="n">TIME</span><span class="o">+</span> <span class="n">COMMAND</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">12280</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>  <span class="mi">103304</span>  <span class="mi">28824</span>   <span class="mi">7276</span> <span class="n">S</span>  <span class="mf">14.0</span>  <span class="mf">0.4</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">08.77</span> <span class="n">python</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="mi">16</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">S</span>   <span class="mf">0.3</span>  <span class="mf">0.0</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">09.22</span> <span class="n">ksoftirqd</span><span class="o">/</span><span class="mi">1</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">1549</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>  <span class="mi">236712</span>  <span class="mi">24480</span>   <span class="mi">9864</span> <span class="n">S</span>   <span class="mf">0.3</span>  <span class="mf">0.3</span>   <span class="mi">3</span><span class="p">:</span><span class="mf">31.38</span> <span class="n">python3</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>观察 top 的输出可以发现，两个 CPU 的 iowait 都非常高。特别是 CPU0，iowait 已经高达 94 %，而剩余内存还有 3GB，看起来也是充足的。</p>
<p>再往下看，进程部分有一个 python 进程的 CPU 使用率稍微有点高，达到了 14%。虽然 14% 并不能成为性能瓶颈，不过有点嫌疑——可能跟 iowait 的升高有关。</p>
<p>那这个 PID 号为 12280 的 python 进程，到底是不是我们的案例应用呢？</p>
<p>我们在第一个终端中，按下 Ctrl+C，停止 top 命令；然后执行下面的 ps 命令，查找案例应用 <a href="./app.py.md">app.py</a> 的 PID 号：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ps aux | grep app.py 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root     12222  0.4  0.2  96064 23452 pts/0    Ss+  14:37   0:00 python /app.py 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root     12280 13.9  0.3 102424 27904 pts/0    Sl+  14:37   0:09 /usr/local/bin/python /app.py 
</span></span></code></pre></td></tr></table>
</div>
</div><p>从 ps 的输出，你可以看到，这个 CPU 使用率较高的进程，正是我们的案例应用。不过先别着急分析 CPU 问题，毕竟 iowait 已经高达 94%，I/O 问题才是我们首要解决的。</p>
<p>接下来，我们在终端一中，运行下面的 iostat 命令，其中:</p>
<ul>
<li>-d 选项是指显示出 I/O 的性能指标；</li>
<li>-x 选项是指显示出扩展统计信息（即显示所有 I/O 指标）。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ iostat -d -x 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">loop0            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sda              0.00   71.00      0.00  32912.00     0.00     0.00   0.00   0.00    0.00 18118.31 241.89     0.00   463.55  13.86  98.40 
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次看到 iostat 的输出，你还记得这个界面中的性能指标含义吗？先自己回忆一下，如果实在想不起来，一定要先查看上节内容，或者用 man iostat 查明白。</p>
<p>明白了指标含义，再来具体观察 iostat 的输出。你可以发现，磁盘 sda 的 I/O 使用率已经达到 98% ，接近饱和了。而且，写请求的响应时间高达 18 秒，每秒的写数据为 32 MB，显然写磁盘碰到了瓶颈。</p>
<p>那要怎么知道，这些 I/O 请求到底是哪些进程导致的呢？我想，你已经还记得上一节我们用到的 pidstat。</p>
<p>在终端一中，运行下面的 pidstat 命令，观察进程的 I/O 情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ pidstat -d 1 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">14:39:14      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">14:39:15        0     12280      0.00 335716.00      0.00       0  python 
</span></span></code></pre></td></tr></table>
</div>
</div><p>从 pidstat 的输出，我们再次看到了 PID 号为 12280 的结果。这说明，正是案例应用引发 I/O 的性能瓶颈。</p>
<p>走到这一步，你估计觉得，接下来就很简单了，上一个案例不刚刚学过吗？无非就是，先用 strace 确认它是不是在写文件，再用 lsof 找出文件描述符对应的文件即可。</p>
<p>到底是不是这样呢？我们不妨来试试。还是在终端一中，执行下面的 strace 命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ strace -p 12280 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">strace: Process 12280 attached 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">select(0, NULL, NULL, NULL, {tv_sec=0, tv_usec=567708}) = 0 (Timeout) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">stat(&#34;/usr/local/lib/python3.7/importlib/_bootstrap.py&#34;, {st_mode=S_IFREG|0644, st_size=39278, ...}) = 0 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">stat(&#34;/usr/local/lib/python3.7/importlib/_bootstrap.py&#34;, {st_mode=S_IFREG|0644, st_size=39278, ...}) = 0 
</span></span></code></pre></td></tr></table>
</div>
</div><p>从 strace 中，你可以看到大量的 stat 系统调用，并且大都为 python 的文件，但是，请注意，这里并没有任何 write 系统调用。</p>
<p>由于 strace 的输出比较多，我们可以用 grep，来过滤一下 write，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ strace -p 12280 2&gt;&amp;1 | grep write 
</span></span></code></pre></td></tr></table>
</div>
</div><p>遗憾的是，这里仍然没有任何输出。</p>
<p>难道此时已经没有性能问题了吗？重新执行刚才的 top 和 iostat 命令，你会不幸地发现，性能问题仍然存在。</p>
<p>我们只好综合 strace、pidstat 和 iostat 这三个结果来分析了。很明显，你应该发现了这里的矛盾：iostat 已经证明磁盘 I/O 有性能瓶颈，而 pidstat 也证明了，这个瓶颈是由 12280 号进程导致的，但 strace 跟踪这个进程，却没有找到任何 write 系统调用。</p>
<p>这就奇怪了。难道因为案例使用的编程语言是 Python，而 Python 是解释型的，所以找不到？还是说，因为案例运行在 Docker 中呢？这里留个悬念，你自己想想。</p>
<p>文件写，明明应该有相应的 write 系统调用，但用现有工具却找不到痕迹，这时就该想想换工具的问题了。怎样才能知道哪里在写文件呢？</p>
<p>这里我给你介绍一个新工具， <a href="./filetop.py.md">filetop</a>。它是 <a href="./bcc.md">bcc</a> 软件包的一部分，基于 Linux 内核的 eBPF（extended Berkeley Packet Filters）机制，主要跟踪内核中文件的读写情况，并输出线程 ID（TID）、读写大小、读写类型以及文件名称。</p>
<p>eBPF 的工作原理，你暂时不用深究，后面内容我们会逐渐接触到，先会使用就可以了。</p>
<p>至于老朋友 bcc 的安装方法，可以参考它的 Github 网站 <a href="https://github.com/iovisor/bcc">https://github.com/iovisor/bcc</a>。比如在 Ubuntu 16 以上的版本中，你可以运行下面的命令来安装它：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">adv</span> <span class="o">--</span><span class="n">keyserver</span> <span class="n">keyserver</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">recv</span><span class="o">-</span><span class="n">keys</span> <span class="mi">4052245</span><span class="n">BD4284CDD</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">echo</span> <span class="s2">&#34;deb https://repo.iovisor.org/apt/$(lsb_release -cs) $(lsb_release -cs) main&#34;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">iovisor</span><span class="o">.</span><span class="n">list</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">bcc</span><span class="o">-</span><span class="n">tools</span> <span class="n">libbcc</span><span class="o">-</span><span class="n">examples</span> <span class="n">linux</span><span class="o">-</span><span class="n">headers</span><span class="o">-$</span><span class="p">(</span><span class="n">uname</span> <span class="o">-</span><span class="n">r</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装后，bcc 提供的所有工具，就全部安装到了 /usr/share/bcc/tools 这个目录中。接下来我们就用这个工具，观察一下文件的读写情况。</p>
<p>首先，在终端一中运行下面的命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 切换到工具目录 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">bcc</span><span class="o">/</span><span class="n">tools</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1"># -C 选项表示输出新内容时不清空屏幕 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="o">./</span><span class="n">filetop</span> <span class="o">-</span><span class="n">C</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">TID</span>    <span class="n">COMM</span>             <span class="n">READS</span>  <span class="n">WRITES</span> <span class="n">R_Kb</span>    <span class="n">W_Kb</span>    <span class="n">T</span> <span class="n">FILE</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">0</span>      <span class="mi">1</span>      <span class="mi">0</span>       <span class="mi">2832</span>    <span class="n">R</span> <span class="mf">669.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">0</span>      <span class="mi">1</span>      <span class="mi">0</span>       <span class="mi">2490</span>    <span class="n">R</span> <span class="mf">667.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">0</span>      <span class="mi">1</span>      <span class="mi">0</span>       <span class="mi">2685</span>    <span class="n">R</span> <span class="mf">671.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">0</span>      <span class="mi">1</span>      <span class="mi">0</span>       <span class="mi">2392</span>    <span class="n">R</span> <span class="mf">670.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">0</span>      <span class="mi">1</span>      <span class="mi">0</span>       <span class="mi">2050</span>    <span class="n">R</span> <span class="mf">672.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">TID</span>    <span class="n">COMM</span>             <span class="n">READS</span>  <span class="n">WRITES</span> <span class="n">R_Kb</span>    <span class="n">W_Kb</span>    <span class="n">T</span> <span class="n">FILE</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">2</span>      <span class="mi">0</span>      <span class="mi">5957</span>    <span class="mi">0</span>       <span class="n">R</span> <span class="mf">651.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">2</span>      <span class="mi">0</span>      <span class="mi">5371</span>    <span class="mi">0</span>       <span class="n">R</span> <span class="mf">112.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">2</span>      <span class="mi">0</span>      <span class="mi">4785</span>    <span class="mi">0</span>       <span class="n">R</span> <span class="mf">861.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">2</span>      <span class="mi">0</span>      <span class="mi">4736</span>    <span class="mi">0</span>       <span class="n">R</span> <span class="mf">213.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">514</span>    <span class="n">python</span>           <span class="mi">2</span>      <span class="mi">0</span>      <span class="mi">4443</span>    <span class="mi">0</span>       <span class="n">R</span> <span class="mf">45.</span><span class="n">txt</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>你会看到，filetop 输出了 8 列内容，分别是线程 ID、线程命令行、读写次数、读写的大小（单位 KB）、文件类型以及读写的文件名称。</p>
<p>这些内容里，你可能会看到很多动态链接库，不过这不是我们的重点，暂且忽略即可。我们的重点，是一个 python 应用，所以要特别关注 python 相关的内容。</p>
<p>多观察一会儿，你就会发现，每隔一段时间，线程号为 514 的 python 应用就会先写入大量的 txt 文件，再大量地读。</p>
<p>线程号为 514 的线程，属于哪个进程呢？我们可以用 ps 命令查看。先在终端一中，按下 Ctrl+C，停止 filetop；然后，运行下面的 ps 命令。这个输出的第二列内容，就是我们想知道的进程号：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ps -efT | grep 514
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root     12280  514 14626 33 14:47 pts/0    00:00:05 /usr/local/bin/python /app.py 
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们看到，这个线程正是案例应用 12280 的线程。终于可以先松一口气，不过还没完，filetop 只给出了文件名称，却没有文件路径，还得继续找啊。</p>
<p>我再介绍一个好用的工具，opensnoop。它同属于 bcc 软件包，可以动态跟踪内核中的 open 系统调用。这样，我们就可以找出这些 txt 文件的路径。</p>
<p>接下来，在终端一中，运行下面的 opensnoop 命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ opensnoop 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">12280  python              6   0 /tmp/9046db9e-fe25-11e8-b13f-0242ac110002/650.txt 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">12280  python              6   0 /tmp/9046db9e-fe25-11e8-b13f-0242ac110002/651.txt 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">12280  python              6   0 /tmp/9046db9e-fe25-11e8-b13f-0242ac110002/652.txt 
</span></span></code></pre></td></tr></table>
</div>
</div><p>这次，通过 opensnoop 的输出，你可以看到，这些 txt 路径位于 /tmp 目录下。你还能看到，它打开的文件数量，按照数字编号，从 0.txt 依次增大到 999.txt，这可远多于前面用 filetop 看到的数量。</p>
<p>综合 filetop 和 opensnoop，我们就可以进一步分析了。我们可以大胆猜测，案例应用在写入 1000 个 txt 文件后，又把这些内容读到内存中进行处理。我们来检查一下，这个目录中是不是真的有 1000 个文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ls /tmp/9046db9e-fe25-11e8-b13f-0242ac110002 | wc -l 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ls: cannot access &#39;/tmp/9046db9e-fe25-11e8-b13f-0242ac110002&#39;: No such file or directory 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0 
</span></span></code></pre></td></tr></table>
</div>
</div><p>操作后却发现，目录居然不存在了。怎么回事呢？我们回到 opensnoop 再观察一会儿：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ opensnoop 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">12280  python              6   0 /tmp/defee970-fe25-11e8-b13f-0242ac110002/261.txt 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">12280  python              6   0 /tmp/defee970-fe25-11e8-b13f-0242ac110002/840.txt 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">12280  python              6   0 /tmp/defee970-fe25-11e8-b13f-0242ac110002/136.txt 
</span></span></code></pre></td></tr></table>
</div>
</div><p>原来，这时的路径已经变成了另一个目录。这说明，这些目录都是应用程序动态生成的，用完就删了。</p>
<p>结合前面的所有分析，我们基本可以判断，案例应用会动态生成一批文件，用来临时存储数据，用完就会删除它们。但不幸的是，正是这些文件读写，引发了 I/O 的性能瓶颈，导致整个处理过程非常慢。</p>
<p>当然，我们还需要验证这个猜想。老办法，还是查看应用程序的源码 <a href="./app.py.md">app.py</a>，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@app.route(&#34;/popularity/&lt;word&gt;&#34;) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def word_popularity(word): 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  dir_path = &#39;/tmp/{}&#39;.format(uuid.uuid1()) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  count = 0 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  sample_size = 1000 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     def save_to_file(file_name, content): 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    with open(file_name, &#39;w&#39;) as f: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    f.write(content) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   try: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # initial directory firstly 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    os.mkdir(dir_path) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     # save article to files 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    for i in range(sample_size): 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        file_name = &#39;{}/{}.txt&#39;.format(dir_path, i) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        article = generate_article() 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        save_to_file(file_name, article) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     # count word popularity 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    for root, dirs, files in os.walk(dir_path): 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        for file_name in files: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            with open(&#39;{}/{}&#39;.format(dir_path, file_name)) as f: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                if validate(word, f.read()): 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    count += 1 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    finally: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # clean files 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        shutil.rmtree(dir_path, ignore_errors=True) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     return jsonify({&#39;popularity&#39;: count / sample_size * 100, &#39;word&#39;: word}) 
</span></span></code></pre></td></tr></table>
</div>
</div><p>源码中可以看到，这个案例应用，在每个请求的处理过程中，都会生成一批临时文件，然后读入内存处理，最后再把整个目录删除掉。</p>
<p>这是一种常见的利用磁盘空间处理大量数据的技巧，不过，本次案例中的 I/O 请求太重，导致磁盘 I/O 利用率过高。</p>
<p>要解决这一点，其实就是算法优化问题了。比如在内存充足时，就可以把所有数据都放到内存中处理，这样就能避免 I/O 的性能问题。</p>
<p>你可以检验一下，在终端二中分别访问 <a href="http://192.168.0.10:10000/popularity/word">http://192.168.0.10:10000/popularity/word</a> 和 <a href="http://192.168.0.10:10000/popular/word">http://192.168.0.10:10000/popular/word</a> ，对比前后的效果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ time curl http://192.168.0.10:10000/popularity/word
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{ 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &#34;popularity&#34;: 0.0, 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &#34;word&#34;: &#34;word&#34; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">} 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    2m43.172s 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">user    0m0.004s 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sys    0m0.007s
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ time curl http://192.168.0.10:10000/popular/word
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &#34;popularity&#34;: 0.0,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &#34;word&#34;: &#34;word&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> real    0m8.810s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">user    0m0.010s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sys    0m0.000s 
</span></span></code></pre></td></tr></table>
</div>
</div><p>新的接口只要 8 秒就可以返回，明显比一开始的 3 分钟好很多。</p>
<p>当然，这只是优化的第一步，并且方法也不算完善，还可以做进一步的优化。不过，在实际系统中，我们大都是类似的做法，先用最简单的方法，尽早解决线上问题，然后再继续思考更好的优化方法。</p>
<h2 id="小结">小结</h2>
<p>今天，我们分析了一个响应过慢的单词热度案例。</p>
<p>首先，我们用 top、iostat，分析了系统的 CPU 和磁盘使用情况。我们发现了磁盘 I/O 瓶颈，也知道了这个瓶颈是案例应用导致的。</p>
<p>接着，我们试着照搬上一节案例的方法，用 strace 来观察进程的系统调用，不过这次很不走运，没找到任何 write 系统调用。</p>
<p>于是，我们又用了新的工具，借助动态追踪工具包 bcc 中的 filetop 和 opensnoop，找出了案例应用的问题，发现这个根源是大量读写临时文件。</p>
<p>找出问题后，优化方法就相对比较简单了。如果内存充足时，最简单的方法，就是把数据都放在速度更快的内存中，这样就没有磁盘 I/O 的瓶颈了。当然，再进一步，你可以还可以利用 Trie 树等各种算法，进一步优化单词处理的效率。</p>
<h2 id="思考">思考</h2>
<p>最后，给你留一个思考题，也是我在文章中提到过的，让你思考的问题。</p>
<p>今天的案例中，iostat 已经证明，磁盘 I/O 出现了性能瓶颈，pidstat 也证明了这个瓶颈是由 12280 号进程导致的。但是，strace 跟踪这个进程，却没有发现任何 write 系统调用。</p>
<p>这究竟是怎么回事？难道是因为案例使用的编程语言 Python 本身是解释型？还是说，因为案例运行在 Docker 中呢？</p>
<p>这里我小小提示一下。当你发现性能工具的输出无法解释时，最好返回去想想，是不是分析中漏掉了什么线索，或者去翻翻工具手册，看看是不是某些默认选项导致的。</p>
<p>欢迎在留言区和我讨论，也欢迎把这篇文章分享给你的同事、朋友。我们一起在实战中演练，在交流中进步。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/f3ab291e71ad0a9d7fe2c894ccb9706a.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/">Linux性能优化实战</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%B7%9F%E6%9C%88%E5%BD%B1%E5%AD%A6%E5%8F%AF%E8%A7%86%E5%8C%96/27__%E6%A1%88%E4%BE%8B%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%843d%E5%8F%AF%E8%A7%86%E5%8C%96%E5%9B%BE%E8%A1%A8/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">27__案例：如何实现简单的3D可视化图表？</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/27__%E7%BC%96%E8%AF%91%E6%8F%92%E6%A1%A9%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E6%B3%95aspectjasmredex/">
            <span class="next-text nav-default">27__编译插桩的三种方法：AspectJ、ASM、ReDex</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
