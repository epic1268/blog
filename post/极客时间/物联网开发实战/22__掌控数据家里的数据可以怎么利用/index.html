<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>22__掌控数据：家里的数据可以怎么利用？ - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是郭朝斌。
到目前为止，我们已经完成智能电灯、光照传感器、智能音箱和自动浇花器的实战训练，在这个过程中，我们主要关注的是设备功能和远程控制的实现。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/22__%E6%8E%8C%E6%8E%A7%E6%95%B0%E6%8D%AE%E5%AE%B6%E9%87%8C%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%AF%E4%BB%A5%E6%80%8E%E4%B9%88%E5%88%A9%E7%94%A8/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/22__%E6%8E%8C%E6%8E%A7%E6%95%B0%E6%8D%AE%E5%AE%B6%E9%87%8C%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%AF%E4%BB%A5%E6%80%8E%E4%B9%88%E5%88%A9%E7%94%A8/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="22__掌控数据：家里的数据可以怎么利用？">
  <meta property="og:description" content="你好，我是郭朝斌。
到目前为止，我们已经完成智能电灯、光照传感器、智能音箱和自动浇花器的实战训练，在这个过程中，我们主要关注的是设备功能和远程控制的实现。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="物联网开发实战">

  <meta itemprop="name" content="22__掌控数据：家里的数据可以怎么利用？">
  <meta itemprop="description" content="你好，我是郭朝斌。
到目前为止，我们已经完成智能电灯、光照传感器、智能音箱和自动浇花器的实战训练，在这个过程中，我们主要关注的是设备功能和远程控制的实现。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="6569">
  <meta itemprop="keywords" content="物联网开发实战">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="22__掌控数据：家里的数据可以怎么利用？">
  <meta name="twitter:description" content="你好，我是郭朝斌。
到目前为止，我们已经完成智能电灯、光照传感器、智能音箱和自动浇花器的实战训练，在这个过程中，我们主要关注的是设备功能和远程控制的实现。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">22__掌控数据：家里的数据可以怎么利用？</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 6569 字 </span>
          <span class="more-meta"> 预计阅读 14 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#方法一基于数据流的设备消息推送应用">方法一：基于数据流的设备消息推送应用</a></li>
        <li><a href="#方法二基于-http-数据同步的-web-数据应用">方法二：基于 HTTP 数据同步的 Web 数据应用</a>
          <ul>
            <li><a href="#数据同步体验">数据同步体验</a></li>
            <li><a href="#准备-django-开发环境">准备 Django 开发环境</a></li>
            <li><a href="#django-应用开发">Django 应用开发</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#create-your-models-here">Create your models here.</a></li>
    <li><a href="#create-your-views-here">Create your views here.</a>
      <ul>
        <li>
          <ul>
            <li><a href="#django-应用部署">Django 应用部署</a></li>
            <li><a href="#云平台数据同步-url-更新">云平台数据同步 URL 更新</a></li>
          </ul>
        </li>
        <li><a href="#小结">小结</a></li>
        <li><a href="#思考题">思考题</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是郭朝斌。</p>
<p>到目前为止，我们已经完成智能电灯、光照传感器、智能音箱和自动浇花器的实战训练，在这个过程中，我们主要关注的是设备功能和远程控制的实现。</p>
<p>其实，物联网设备会生成大量的数据。如果我们能把这些数据存储到物联网系统的数据库中，并且好好应用这些数据，比如提供查询和分析功能，就能够产出更大的价值。</p>
<p>这一讲，我就基于自动浇花器来讲一讲数据的应用方法，主要包括以下两种：</p>
<ol>
<li>基于腾讯云物联网平台提供的<strong>数据流</strong>功能，介绍一个<strong>设备消息推送应用</strong>的配置方法。</li>
<li>基于腾讯云的 <strong>HTTP 方式的数据同步</strong>功能，开发一个 <strong>Web 数据应用系统</strong>。因为需要购买云服务器，所以你可以酌情选择是否实际部署。</li>
</ol>
<h2 id="方法一基于数据流的设备消息推送应用">方法一：基于数据流的设备消息推送应用</h2>
<p>腾讯云物联网平台已经为我们提供了一种简便的数据应用方法。我们可以使用它的可视化编辑界面来完成数据流的创建工作。</p>
<p>你可以登录腾讯云物联网平台的控制台，然后进入我们之前创建的“智能家居”项目，点击左边菜单栏中的“数据开发”。</p>
<p>然后，你需要新建一个数据流，名称可以是“自动浇花器”。点击数据流列表中的“自动浇花器”项目，你就可以进入可视化的编辑界面。</p>
<p>在可视化编辑界面，我们可以看到，一个数据流包括“输入”“处理”和“输出”三个部分。</p>
<ol>
<li>输入，包括设备数据、设备事件和设备状态三种，其中设备数据和设备事件与物模型中的定义是一致的。设备状态是设备的上线、下线的状态变化。</li>
<li>处理，可以编写基本的判断逻辑来过滤输入数据。</li>
<li>输出，可以作为消息将数据推送到 App 或者小程序中。你可以对消息的内容模板进行定义。</li>
</ol>
<p>自动浇花器设备会上报环境的温度、湿度信息，那么我们可以定义一个温湿度不适宜的消息提醒。</p>
<p>你可以拖拽“设备数据”到编辑区域，然后点击这个模块，在右边的选项中定义设备数据，产品选择“自动浇花器”，属性选择“环境温度”和“环境湿度”。</p>
<p>接着，你可以添加“数据过滤”模块，并且将这个模块与“设备数据”模块相连，然后点击这个模块，在右边编辑过滤条件。</p>
<p>完成数据过滤的定义后，你需要继续添加“公众号推送”模块，并且编辑消息推送的模板。具体的消息模板定义，你可以参考下面内容：</p>
<p>环境温度、湿度不适宜：<br>
当前温度是$env_temp<br>
当前湿度是$env_hum<br>
当前时间是$timeStamp</p>
<p>最后，点击页面上方的“保存”和“启用”，你就完成了数据流的定义。</p>
<p>如果你的自动浇花器设备是在线状态，那么当环境的温度或者湿度过高、过低时，你就会在腾讯连连小程序的消息列表中收到“告警”消息。</p>
<h2 id="方法二基于-http-数据同步的-web-数据应用">方法二：基于 HTTP 数据同步的 Web 数据应用</h2>
<p>物联网平台除了提供数据流的方式，还可以基于 HTTP 协议把数据推送到你指定的网址，比如你开发的 Web 服务器的网址。所以你也可以使用这种方式，更加灵活地利用物联网设备的数据。</p>
<h3 id="数据同步体验">数据同步体验</h3>
<p>我们借助在线的 Webhook 服务，测试一下数据同步功能。</p>
<p>首先，打开webhook.site网站，并且记录页面中显示的专属 URL 地址。</p>
<p>然后，你需要登录腾讯云物联网平台，进入我们之前创建的“智能家居”项目，再点击左边菜单栏中的“数据同步”，选择“HTTPS”标签。</p>
<p>接着，点击“自动浇花器”对应的“设置”链接，在设置窗口，将 webhook 网站获取到的 URL 地址，粘贴在输入框。</p>
<p>完成设置后，打开“生效状态”。</p>
<p>在保证自动浇花器设备正常运行的情况下，你就可以在 webhook 网站的页面中看到设备上报的数据了。</p>
<p>下面我来介绍一下用 Python 语言来开发 Web 服务器的方法。</p>
<p>因为购买云服务器需要费用，所以这个实战任务是选学内容，你可以在自己的电脑上实践一下 Web 服务器的开发过程，然后酌情考虑要不要部署到云服务器上。</p>
<h3 id="准备-django-开发环境">准备 Django 开发环境</h3>
<p>Django 是一个流行的基于 Python 语言的 Web 开发框架。它提供了强大的功能，同时也简单易用。接下来，我们就基于 Django 来实现一个 Web 应用程序。</p>
<p>首先是在电脑上配置 Django 的开发环境，在终端上运行下面的命令安装 Django，准备好需要用到的工具。</p>
<p>$ pip3 install django</p>
<p>安装完成后，你可以在终端上切换到一个代码开发目录，比如：</p>
<p>$ cd ~/study/iot/geektime</p>
<p>然后，直接使用 Django 提供的脚手架工具 django-admin 来创建一个项目：</p>
<p>$ django-admin startproject watering_web</p>
<p>这时，命令会创建一个名称为 watering_web 的目录。目录中包含 manage.py、settings.py、urls.py、wsgi.py 和 asgi.py 等几个项目“骨架”文件，其中：</p>
<ol>
<li>manage.py 是项目管理脚本，比如创建子应用、运行开发服务器等都可以通过它实现。</li>
<li>settings.py 是项目的整体配置文件。比如子应用的配置、数据库的配置等。</li>
<li>urls.py 是项目的全局路由声明文件。</li>
<li>wsgi.py 是 WSGI（Python Web Server Gateway Interface 的缩写）服务接口文件，是整个 Django 应用的调用入口。</li>
<li>asgi.py 是 ASGI（Asynchronous Server Gateway Interface 的缩写）服务接口文件。ASGI 是 WSGI 的替代者，它增加了异步应用的能力。除了支持 WSGI 协议，同时对 Websocket 和 HTTP2.0 这些长连接方式的协议提供了支持。</li>
</ol>
<p>现在，我们进入 watering_web 目录，运行下面的命令，就可以在电脑上启动这个项目的开发服务器了。</p>
<p>$ python manage.py runserver</p>
<p>这非常有利于你的开发调试工作。比如，你可以在浏览器输入 http://127.0.0.1:8000/ 随时访问 Web 应用的开发效果。</p>
<p>当你在浏览器上看到这个界面时，就说明 Django 应用的开发环境已经准备好了。下面，我们就来开发 Web 应用。</p>
<h3 id="django-应用开发">Django 应用开发</h3>
<h4 id="创建子应用-watering">创建子应用 watering</h4>
<p>首先，我们通过运行下面的命令，创建 watering_web 项目的子应用 watering：</p>
<p>$ python manage.py startapp watering</p>
<p>这时，你应该可以看到项目目录下，新增加了 watering 的目录。目录中包含了 watering 子应用的基本代码模块。</p>
<ol>
<li>admin.py 是后台管理应用的配置文件，我们可以在其中增加数据库模型对象，让 Django 应用管理员能通过后台管理页面进行编辑。你在浏览器输入http://127.0.0.1:8000/admin/可以访问到后台管理应用。</li>
<li>apps.py 是子应用的配置文件。</li>
<li>migrations 是数据库迁移的文件目录，它下面会保存每次数据库迁移的中间文件。</li>
<li>models.py 是定义子应用的数据库数据模型文件。</li>
<li>tests.py 是子应用的单元测试代码文件。</li>
<li>views.py 是子应用的视图代码文件。</li>
</ol>
<h4 id="理解-django-的视图调用">理解 Django 的视图调用</h4>
<p>在 Django 里面，网页或者说 HTTP 的响应都是视图生成的，每个视图对应 views.py 中的一个函数。Django 会根据 HTTP 请求的 URL 域名地址来选择相应的视图，而 URL 和视图函数的映射关系是在 urls.py 文件中定义的。</p>
<p>比如，你可以打开 watering 目录下的 views.py 文件，添加下面的函数：</p>
<p>from django.http import HttpResponse</p>
<p>def demo(request):<br>
return HttpResponse(&lsquo;Hello World!&rsquo;)</p>
<p>然后，在 watering 目录下，新建一个 urls.py 文件，文件内容如下：</p>
<p>from django.urls import path</p>
<p>from . import views</p>
<p>urlpatterns = [<br>
path(&lsquo;demo&rsquo;, views.demo, name=&lsquo;demo&rsquo;),<br>
]</p>
<p>最后，在 watering_web 目录下的项目全局路由文件中，将 urlpatterns 的内容替换为下面的内容：</p>
<p>from django.contrib import admin<br>
from django.urls import path, include</p>
<p>urlpatterns = [<br>
path(&lsquo;admin/&rsquo;, admin.site.urls),<br>
path(&rsquo;&rsquo;, include(&lsquo;watering.urls&rsquo;)),<br>
]</p>
<p>现在，你在浏览器输入地址http://127.0.0.1:8000/demo，就可以看看我们刚刚定义的 demo 视图的内容。</p>
<h4 id="应用代码开发">应用代码开发</h4>
<p>接下来，我们正式开始子应用的开发。</p>
<p>首先，我们需要定义数据库的数据模型。Django 框架实现了 ORM（Object-Relational Mapping，对象关系映射器）技术。你可以直接在 Python 代码中定义数据库的表结构。</p>
<p>基于这个定义，Django 的 migration 工具能自动在数据库中创建相应的数据库表。在后面的部署阶段，我会讲解到具体的 migration 命令。</p>
<p>我把 models.py 的代码贴在文稿中，供你参考：</p>
<p>from django.db import models</p>
<h1 id="create-your-models-here">Create your models here.</h1>
<p>class Watering(models.Model):<br>
seq_no = models.IntegerField(blank=False, null=False)<br>
device_name = models.CharField(max_length=64, blank=False)<br>
product_id = models.CharField(max_length=64, blank=False)<br>
power_switch = models.IntegerField(default=0)<br>
humidity = models.IntegerField(default=0)<br>
env_temp = models.FloatField(default=0.0)<br>
env_hum = models.IntegerField(default=0)<br>
env_illum = models.IntegerField(default=0)<br>
timestamp = models.DateTimeField(auto_now=False)</p>
<pre><code>def __str__(self):  
    return self.device_name + '_' + str(self.seq_no)
</code></pre>
<p>有了数据模型之后，你就可以在 views.py 文件中开发视图，接收腾讯云物联网平台推送的 HTTP 请求，并且将数据存储到数据库中。</p>
<p>文稿中是我的示例代码，供你参考：</p>
<p>from django.shortcuts import render</p>
<h1 id="create-your-views-here">Create your views here.</h1>
<p>from django.http import HttpResponse, HttpResponseBadRequest<br>
from django.views.decorators.csrf import csrf_exempt<br>
from django.forms.models import model_to_dict<br>
import json<br>
from datetime import datetime<br>
from tencentcloud.common import credential<br>
from tencentcloud.common.profile.client_profile import ClientProfile<br>
from tencentcloud.common.profile.http_profile import HttpProfile<br>
from tencentcloud.common.exception.tencent_cloud_sdk_exception import TencentCloudSDKException<br>
from tencentcloud.iotexplorer.v20190423 import iotexplorer_client, models</p>
<p>SECRET_ID = &ldquo;你的 Secret ID&rdquo;<br>
SECRET_KEY = &ldquo;你的 Secret Key&rdquo;<br>
PRODUCT_ID = &ldquo;你的 ProductID&rdquo;</p>
<p>from .models import Watering</p>
<p>def build_response(resp, msg):<br>
dict = {<br>
&ldquo;resp&rdquo;: resp,<br>
&ldquo;msg&rdquo;: msg,<br>
}<br>
return HttpResponse(json.dumps(dict), content_type=&lsquo;application/json&rsquo;)</p>
<p>def demo(request):<br>
return HttpResponse(&lsquo;Hello World!&rsquo;)</p>
<p>@csrf_exempt<br>
def data_sync(request):<br>
if request.method == &lsquo;POST&rsquo;:<br>
json_data = json.loads(request.body.decode())<br>
else:<br>
return HttpResponseBadRequest(&lsquo;Bad Request&rsquo;)</p>
<pre><code>if 'seq' in json_data:  
    _seq = json_data['seq']  
if 'devicename' in json_data:  
    _device_name = json_data['devicename']  
if 'productid' in json_data:  
    _product_id = json_data['productid']  
if 'timestamp' in json_data:  
    _timestamp = json_data['timestamp']  
if 'payload' in json_data:  
    _payload = json_data['payload']  
    if 'method' in _payload and 'report' == _payload['method']:  
        _params = _payload['params']  
        _env_temp = _params['env_temp']  
        _env_hum = _params['env_hum']  
        _env_illum = _params['env_illum']  
        _humidity = _params['humidity']  
        _power_status = _params['power_switch']  
      
        try:  
            Watering.objects.create(  
                seq_no=_seq, device_name=_device_name, product_id=_product_id,  
                power_switch=_power_status, humidity=_humidity,  
                env_temp = _env_temp, env_hum = _env_hum, env_illum = _env_illum,  
                timestamp=datetime.fromtimestamp(_timestamp) )  
              
        except:  
            return HttpResponse('Insert Failed!')  

return HttpResponse('OK')  
</code></pre>
<p>@csrf_exempt<br>
def latest_data(request):<br>
if request.method == &lsquo;POST&rsquo;:<br>
json_data = json.loads(request.body.decode())<br>
else:<br>
return HttpResponseBadRequest(&lsquo;Bad Request&rsquo;)</p>
<pre><code>if 'devicename' in json_data:  
    _device_name = json_data['devicename']  
else:  
    _device_name = None  
  
if _device_name is not None:  
    try:  
        data = Watering.objects.filter(device_name=_device_name).latest('timestamp')  
        data_dict = model_to_dict(data, fields=['seq_no','device_name','product_id','power_switch','humidity','env_temp','env_hum','env_illum'])  
        data_dict['timestamp'] = str(data.timestamp)  
        dict = {  
            &quot;resp&quot;: 0,  
            &quot;msg&quot;: &quot;OK&quot;,  
            &quot;data&quot;: data_dict  
        }  
        return HttpResponse(json.dumps(dict), content_type='application/json')  
    except Exception as e:  
        return build_response(1, str(e))  
else:  
    return build_response(1, 'Parameter invalid.')
</code></pre>
<p>为了能够控制自动浇花器的水泵打开和关闭，你也可以增加发送控制命令的视图。同样，你可以参考下面的代码：</p>
<p>@csrf_exempt<br>
def control_device(request):<br>
if request.method == &lsquo;POST&rsquo;:<br>
json_data = json.loads(request.body.decode())<br>
else:<br>
return HttpResponseBadRequest(&lsquo;Bad Request&rsquo;)</p>
<pre><code>if 'devicename' in json_data:  
    _device_name = json_data['devicename']  
else:  
    _device_name = None  
if 'status' in json_data:  
    _status = json_data['status']  
else:  
    _status = None  

if _device_name is not None and _status is not None:  
    try:   
        cred = credential.Credential(SECRET_ID, SECRET_KEY)   
        httpProfile = HttpProfile()  
        httpProfile.endpoint = &quot;iotexplorer.tencentcloudapi.com&quot;  

        clientProfile = ClientProfile()  
        clientProfile.httpProfile = httpProfile  
        client = iotexplorer_client.IotexplorerClient(cred, &quot;ap-guangzhou&quot;, clientProfile)   

        req = models.ControlDeviceDataRequest()  
        data = {  
            &quot;power_switch&quot;: _status  
        }  
        data_str = json.dumps(data)  

        params = {  
            &quot;DeviceName&quot;: _device_name,  
            &quot;ProductId&quot;: PRODUCT_ID,  
            &quot;Data&quot;: data_str  
        }  
        req.from_json_string(json.dumps(params))  

        resp = client.ControlDeviceData(req)  

        return build_response(0, resp.to_json_string())  

    except TencentCloudSDKException as err:   
        return build_response(1, str(err))  

else:  
    return build_response(1, 'Parameter invalid.')
</code></pre>
<p>完成视图的开发后，你需要更新 urls.py 文件中的 urlpatterns，为新增视图添加映射关系。</p>
<p>from django.contrib import admin<br>
from django.urls import path, include</p>
<p>urlpatterns = [<br>
path(&lsquo;admin/&rsquo;, admin.site.urls),<br>
path(&lsquo;geektime/&rsquo;, include(&lsquo;watering.urls&rsquo;)),<br>
]</p>
<p>同时，在 watering 子应用的目录增加一个 urls.py 文件，内容如下：</p>
<p>from django.urls import path</p>
<p>from . import views</p>
<p>urlpatterns = [<br>
path(&lsquo;demo&rsquo;, views.demo, name=&lsquo;demo&rsquo;),<br>
path(&lsquo;data&rsquo;, views.data_sync, name=&lsquo;data_sync&rsquo;),<br>
path(&lsquo;control&rsquo;, views.control_device, name=&lsquo;control_device&rsquo;),<br>
path(&lsquo;fetch&rsquo;, views.latest_data, name=&lsquo;latest_data&rsquo;),<br>
]</p>
<p>然后，我们来开发一个简单的网页，实现设备信息的显示和控制。为了便于理解，我这里只使用最基础的方法。当熟悉基本原理之后，你可以尝试使用 VUE、React 等前端应用框架来开发功能更丰富的 Web 前端应用。</p>
<p>我把代码贴在文稿中，供你参考：</p>
<p>&lt;!doctype html&gt;</p>
<html>  
<head>  
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">  
<meta content="webkit" name="renderer">  
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">  
<meta content="IE=Edge,chrome=1" http-equiv="X-UA-Compatible">  
<style type="text/css">  
    th {  
    text-align: left;  
    }  
</style>  
<title>Plant Watering</title>  
<script src="jquery-3.1.1.min.js"></script>  
</head>  
<body>  
    <h1>Plant Watering</h1>  
<pre><code>&lt;table&gt;  
    &lt;tr&gt;  
        &lt;th&gt;Device Name: &lt;/th&gt;&lt;th id='devicename'&gt;&lt;/th&gt;  
    &lt;/tr&gt;  

    &lt;tr&gt;  
        &lt;th&gt;Date: &lt;/th&gt;&lt;th id='datetime'&gt;&lt;/th&gt;  
    &lt;/tr&gt;  

    &lt;tr&gt;  
        &lt;th&gt;Soil Moisture (&amp;#37;): &lt;/th&gt;&lt;th id='moisture'&gt;&lt;/th&gt;  
    &lt;/tr&gt;  

    &lt;tr&gt;  
        &lt;th&gt;Environment Temperature (℃): &lt;/th&gt;&lt;th id='envtemp'&gt;&lt;/th&gt;  
    &lt;/tr&gt;  

    &lt;tr&gt;  
        &lt;th&gt;Environment Humidity (&amp;#37;): &lt;/th&gt;&lt;th id='envhum'&gt;&lt;/th&gt;  
    &lt;/tr&gt;  

    &lt;tr&gt;  
        &lt;th&gt;Environment Illumination (Lux): &lt;/th&gt;&lt;th id='envillum'&gt;&lt;/th&gt;  
    &lt;/tr&gt;  

&lt;/table&gt;  

&lt;button id='on'&gt;Open&lt;/button&gt;  
&lt;button id='off'&gt;Close&lt;/button&gt;  

&lt;script type='text/javascript'&gt;  
    var timer = false  
    var interval = 5*1000   //5 seconds  
    var device_name = 'Watering_1'  

    $(&quot;#on&quot;).on('click',function(){  
        control(1)  
    })  
    $(&quot;#off&quot;).on('click',function(){  
        control(0)  
    })  

    function control(state){  

        var payload = {  
            &quot;devicename&quot;:device_name,  
            &quot;status&quot;:state  
        }  

        $.ajax({  
            url : &quot;http://159.75.214.14/geektime/control&quot;,  
            contentType: &quot;application/json; charset=utf-8&quot;,  
            method : 'POST',  
            dataType: &quot;json&quot;,  
            data: JSON.stringify(payload),  
              
            success:function (obj) {  

                if(obj.resp === 0){  
                    console.log(&quot;pump on&quot;);  
                }  
                else{  
                    console.log(obj.msg);  
                }  
            },  
            error:function(e){  
                console.log(&quot;control device post failed.&quot;);  
            }  
        })  
    }  

    function update_data(){  
        var payload = {  
            &quot;devicename&quot;:device_name,  
        }  

        $.ajax({  
            url : &quot;http://159.75.214.14/geektime/fetch&quot;,  
            contentType: &quot;application/json; charset=utf-8&quot;,  
            method : 'POST',  
            dataType: &quot;json&quot;,  
            data: JSON.stringify(payload),  
              
            success:function (obj) {  

                if(obj.resp === 0){  
                    console.log(&quot;fetch success&quot;);  
                    $(&quot;#devicename&quot;).text(device_name)  
                    $(&quot;#datetime&quot;).text(obj.data.timestamp)  
                    $(&quot;#moisture&quot;).text(obj.data.humidity)  
                    $(&quot;#envtemp&quot;).text(obj.data.env_temp)  
                    $(&quot;#envhum&quot;).text(obj.data.env_hum)  
                    $(&quot;#envillum&quot;).text(obj.data.env_illum)  
                }  
                else{  
                    console.log(obj.msg);  
                }  
            },  
            error:function(e){  
                console.log(&quot;fetch latest data failed.&quot;);  
            }  
        })  
    }  

    window.onload = function(){  
        update_data()   //Fetch data to get devicename first.  
        timer = setInterval(function(){  
            update_data()  
        }, interval)  
    }  
&lt;/script&gt;  
</code></pre>
</body>  
</html>
<p>对于这些前端代码文件，你可以在 watering_web 项目的根目录下创建一个 web 目录，然后把它们放入这个目录下。</p>
<p>关于 Django 项目的 settings.py 文件，你需要在 ALLOWED_HOSTS 中增加自己服务器的 IP 地址。</p>
<p>ALLOWED_HOSTS = [<br>
&lsquo;159.75.214.14&rsquo;,    #替换自己的云服务器 IP<br>
]</p>
<p>同时，在数据库的配置中，修改为 MySQL 的配置内容：</p>
<p>DATABASES = {<br>
# &lsquo;default&rsquo;: {<br>
#     &lsquo;ENGINE&rsquo;: &lsquo;django.db.backends.sqlite3&rsquo;,<br>
#     &lsquo;NAME&rsquo;: BASE_DIR / &lsquo;db.sqlite3&rsquo;,<br>
# }<br>
&lsquo;default&rsquo;: {<br>
&lsquo;ENGINE&rsquo;: &lsquo;django.db.backends.mysql&rsquo;,<br>
&lsquo;NAME&rsquo;: &lsquo;geektime&rsquo;,<br>
&lsquo;USER&rsquo;: &lsquo;root&rsquo;,<br>
&lsquo;PASSWORD&rsquo;: &lsquo;geektime&rsquo;,<br>
&lsquo;HOST&rsquo;: &lsquo;127.0.0.1&rsquo;,<br>
&lsquo;PORT&rsquo;: &lsquo;3306&rsquo;,<br>
}<br>
}</p>
<h3 id="django-应用部署">Django 应用部署</h3>
<p>完成 Django 应用的开发，我们就可以把它部署到云服务器中。</p>
<p>首先，你需要先登录到腾讯云控制台，从“云产品”中点击选择“云服务器”，进入云服务的配置页面。</p>
<p>在云服务器页面，点击“新建”，购买一台服务器。</p>
<p>在新建的页面，你可以根据自己的需求选择服务器的硬件配置。如果只是用来练习，选择最低的配置就行了。</p>
<p>服务器的操作系统选择“Ubuntu Server 16.04.1”，其他选项保持默认值。</p>
<p>点击“立即购买”，完成支付后，我们重新进入云服务器控制台，就可以看到我们的服务器新实例了。</p>
<p>准备好云服务器后，我再介绍一下 Django 应用在 Ubuntu 服务器上的具体部署操作。</p>
<p>以下的介绍都是针对单台服务器部署展开的。如果多台机子部署，你需要做相应的调整，比如使用腾讯云的 CDB（云数据库服务），你就需要对 Django 应用的设置文件（settings.py）中数据库部分作修改。</p>
<h4 id="ubuntu-准备">Ubuntu 准备</h4>
<p>首先，通过 SSH 登录到 Ubuntu 服务器，像连接树莓派一样，你仍然可以使用 Putty 或者 SecureCRT 这样的终端软件。</p>
<p>服务器的 IP 地址可以从腾讯云的云服务器控制台获取。关于用户名和密码，“腾讯云助手”公众号会在购买云服务器时发送消息通知。如果没有收到，你可以在控制台重置密码。</p>
<p>登录后，首先需要更新 apt，你可以运行下面的命令：</p>
<p>$ sudo apt-get update</p>
<h4 id="代码上传">代码上传</h4>
<p>接着，你需要将 Django 应用的代码上传到服务器某个目录下，比如 /home/ubuntu/iot/ 这个目录下。这涉及到下面介绍的 Nginx 和 uWSGI 的配置文件中的路径，因此，如果代码的路径不是这个，你需要相应地修改这些配置中的路径。</p>
<p>上传的工具，你还是可以使用第 19 讲中提到的 FileZilla 等软件。</p>
<h4 id="数据库">数据库</h4>
<p>我们使用的 MySQL 数据库，可以通过以下命令来安装：</p>
<p>$ sudo apt-get install mysql-server mysql-client libmysqlclient-dev</p>
<p>说明一下，如果没有安装 libmysqlclient-dev 的话，接下来安装 mysql-python 的步骤可能会报错。</p>
<p>安装过程中，终端也提示你输入 MySQL 数据库的密码，你可以像我一样，输入“geektime”。</p>
<p>安装完成后，你可以通过下面的命令，连接上数据库。</p>
<p>$ mysql -p -u root</p>
<p>然后，在数据库的交互命令行中，你需要输入下面的命令，创建 geektime 数据库。</p>
<p>create database geektime;<br>
exit;</p>
<h4 id="python-环境">Python 环境</h4>
<p>接下来，我们需要配置 Python 语言环境，因为应用程序和 Django 应用框架都是基于 Python 的。</p>
<p>首先，我们修改一下系统的默认 python，将它修改为 python3 版本。运行下面的命令：</p>
<p>$ vim ~/.bashrc</p>
<p>在文件中，增加下面的内容：</p>
<p>alias python=&rsquo;/usr/bin/python3&rsquo;</p>
<p>添加完成后，退出 vim。在终端输入下面的命令，使其生效：</p>
<p>$ source ~/.bashrc</p>
<p>接着，我们需要安装 pip，Python 包管理器（Python package manager）。你可以运行下面的命令：</p>
<p>$ sudo apt-get install python3-pip<br>
$ sudo pip3 install &ndash;upgrade pip</p>
<p>接着，你还需要安装 python-dev，一些软件包的安装需要依赖它。命令如下：</p>
<p>$ sudo apt-get install python3-dev</p>
<p>后面，你需要进入 Django 应用目录（我们这里是 /home/ubuntu/iot/watering_web），然后运行下面的命令，安装所有依赖的软件包。：</p>
<p>pip3 install -r requirements.txt</p>
<p>如果出现 locale.Error: unsupported locale setting 的错误，请在命令行输入下面的命令：</p>
<p>export LC_ALL=&ldquo;en_US.UTF-8&rdquo;</p>
<p>requirements.txt 文件的内容如下：</p>
<p>tencentcloud-sdk-python==3.0.313<br>
mysqlclient<br>
Django</p>
<p>现在，环境已经准备就绪，下面我来讲解一下数据库和 uWSGI、Nginx 的配置。</p>
<h4 id="数据库-migrate">数据库 Migrate</h4>
<p>在 Django 中，数据库的创建已经处理得非常简单，框架本身做了很多的工作。</p>
<p>首先，在 manage.py 文件所在的目录，运行下面的命令：</p>
<p>$ python manage.py makemigrations</p>
<p>接着，只需要运行下面的命令，就可以完成所有的数据库表创建工作。</p>
<p>$ python manage.py migrate</p>
<h4 id="确认测试">确认测试</h4>
<p>现在，你可以执行下面的命令，启动 Django 应用。然后，你可以通过浏览器确认 Django 应用是否可以正常运行。</p>
<p>$ python manage.py runserver 0.0.0.0:8080</p>
<p>下面，我们就可以安装 uWSGI 和 Nginx 了。</p>
<h4 id="uwsgi-安装">uWSGI 安装</h4>
<p>uWSGI 相当于是 Django 应用和 Nginx 之间的桥梁，它使用标准的 WSGI 接口与应用通信。你需要运行命令，安装 uWSGI：</p>
<p>$ sudo apt-get install -y uwsgi<br>
$ sudo apt-get install uwsgi-plugin-python3<br>
$ pip3 install uwsgi</p>
<p>然后，在 /home/ubuntu/iot/config 目录下为 uWSGI 增加配置文件，文件内容如下:</p>
<p>[uwsgi]<br>
socket = 127.0.0.1:3031<br>
chdir = /home/ubuntu/iot/watering_web<br>
wsgi-file = watering_web/wsgi.py<br>
processes = 4<br>
plugins = python3<br>
threads = 2<br>
stats = 127.0.0.1:9191</p>
<p>接着，运行下面的命令，查看 uWSGI 是否可以正常运行。</p>
<p>$ sudo uwsgi &ndash;ini ./config/uwsgi.ini</p>
<p>之后，我们还需要配置基于 systemd 的 uWSGI 的自启动流程。这需要创建 systemd 的 unit 文件。我们还是在 /home/ubuntu/config 目录下增加 uwsgi.service 文件，内容如下：</p>
<p>[Unit]<br>
Description=uWSGI<br>
After=syslog.target</p>
<p>[Service]<br>
User=ubuntu<br>
ExecStart=/usr/bin/uwsgi &ndash;ini /home/ubuntu/iot/config/uwsgi.ini<br>
Restart=always<br>
KillSignal=SIGQUIT<br>
Type=notify<br>
StandardError=syslog<br>
NotifyAccess=all</p>
<p>[Install]<br>
WantedBy=multi-user.target</p>
<p>这时，你还不需要添加这个 service，在后面我们会通过命令添加、执行这个配置文件。</p>
<h4 id="安装-nginx">安装 Nginx</h4>
<p>首先，你需要执行下面的命令，安装 Nginx 软件。</p>
<p>$ sudo apt-get install nginx</p>
<p>然后，我们需要配置它。我们通过新添加文件，来配置我们的服务，在 /etc/nginx/conf.d/ 目录下，增加 iot.conf 文件，文件的内容如下:</p>
<p>server {<br>
listen 80;<br>
#listen [::]:80 default_server;<br>
server_name 159.75.214.14; #替换为自己服务器 IP 地址</p>
<pre><code>location / {  
    root /home/ubuntu/iot/watering_web/web/;  
    index index.html;   
}  

location ^~ /geektime/ {  
    include uwsgi_params;  
    uwsgi_pass 127.0.0.1:3031;   
}  

error_page 404 /404.html;   
location = /40x.html {  
}  

error_page 500 502 503 504 /50x.html;   
location = /50x.html {  
}  
</code></pre>
<p>}</p>
<p>并且，将 /etc/nginx/nginx.conf 文件中的“user www-data;”修改为“user ubuntu;”。</p>
<p>现在，你需要执行下面的命令检查 Nginx 配置文件的语法：</p>
<p>$ sudo nginx -t</p>
<p>如果没有错误，就可以重启 Nginx，来加载新的配置文件：</p>
<p>$ sudo service nginx restart</p>
<p>然后，把 uWSGI 的 service 配置文件拷贝到 systemd 配置目录下：</p>
<p>$ sudo cp uwsgi.service /etc/systemd/system/</p>
<p>现在，你可以执行下面的命令，启动 uWSGI 服务：</p>
<p>$ sudo systemctl start uwsgi</p>
<p>如果一切正常，我们就可以把 uWSGI 添加到开机自启动中：</p>
<p>$ sudo systemctl enable uwsgi</p>
<p>到这里，服务就部署完毕了。</p>
<h3 id="云平台数据同步-url-更新">云平台数据同步 URL 更新</h3>
<p>云服务器上的 Web 应用运行正常后，你可以对腾讯云物联网平台上的 HTTP 数据同步进行更新。修改配置中的 URL 地址为自己云服务器的视图地址。</p>
<p>更新完成后，你就可以在浏览器上访问自己的服务器地址，查看自动浇花器的实时数据，并且控制它进行浇水。</p>
<h2 id="小结">小结</h2>
<p>总结一下，在这一讲中，我围绕自动浇花器讲解了智能家居系统中设备数据的应用系统开发方法。主要的内容有：</p>
<ol>
<li>腾讯云物联网平台为我们提供了简单易用的数据开发方法。基于可视化界面，我们编辑“输入”，“处理”和“输出”就可以完成一个数据流的创建，实现数据的过滤和消息推送。</li>
<li>我们可以基于物联网平台的数据同步能力，比如 HTTP 推送，实现物联网平台和应用服务器的对接。在应用服务器上，我们可以灵活地开发数据应用系统。</li>
<li>Django 是非常流行的，基于 Python 语言的 Web 应用开发框架。工作中，你可以使用 Django 比较快速地实现一个 Web 应用系统。</li>
</ol>
<p>在这一讲中，我们的数据应用系统只包含了自动浇花器的数据，你在时间允许的情况下，也可以尝试在这个系统中增加一下智能电灯和光照传感器的数据。</p>
<p>另外，物联网平台的数据同步也提供了 CKafka（Cloud Kafka）的数据转发方式。通过订阅 Topic 主题消息，我们可以消费 Kafka 的消息，也可以直接将 Kafka 消息转储到 MySQL 云数据库中。</p>
<p>不过，Kafka 的费用比云服务器要贵不少，这里就不介绍了。如果你的条件允许，也可以动手实践一下这种方式。</p>
<p>这里，我整理了一个思维导图，供你参考：</p>
<h2 id="思考题">思考题</h2>
<p>最后，我给你留一个思考题吧。</p>
<p>在 Django 应用开发的介绍部分，我提到了 admin.py 是后台管理应用的配置文件，而且访问http://127.0.0.1:8000/admin/地址，就会出现管理员登录页面。你知道在 Django 项目中如果创建管理员账号吗？另外，如何在 admin.py 文件中增加 Watering 数据库模型对象，实现对自动浇花器监测数据的查询呢？</p>
<p>欢迎你在留言区写一写自己的思考，同时，也欢迎你将这一讲分享给对 Web 应用开发感兴趣的朋友，大家一起交流学习。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/">物联网开发实战</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E4%BA%BA%E4%BA%BA%E9%83%BD%E8%83%BD%E5%AD%A6%E4%BC%9A%E7%9A%84%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8%E8%AF%BE/22__%E6%A0%88%E4%B8%8E%E5%8D%95%E8%B0%83%E6%A0%88%E6%9C%80%E5%A4%A7%E7%9F%A9%E5%BD%A2%E9%9D%A2%E7%A7%AF/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">22__栈与单调栈：最大矩形面积</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/22__%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95%E4%BF%A1%E6%81%AF%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E8%A7%A3%E5%86%B3for%E5%BE%AA%E7%8E%AF%E4%BA%A7%E7%94%9F%E7%9A%84%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/">
            <span class="next-text nav-default">22__支付订单信息：如何高效解决for循环产生的内存溢出？</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
