<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>19__场景联动：智能电灯如何感知光线？（下） - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是郭朝斌。
在上一讲，我们基于 NodeMCU ESP32 开发板，开发了一款光照传感器。考虑到低功耗的需求，它是基于低功耗蓝牙技术来实现的。但是蓝牙设备本身无法直接联网上报数据，那么我们要怎么根据光照强度数据来联动控制智能电灯呢？
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/19__%E5%9C%BA%E6%99%AF%E8%81%94%E5%8A%A8%E6%99%BA%E8%83%BD%E7%94%B5%E7%81%AF%E5%A6%82%E4%BD%95%E6%84%9F%E7%9F%A5%E5%85%89%E7%BA%BF%E4%B8%8B/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/19__%E5%9C%BA%E6%99%AF%E8%81%94%E5%8A%A8%E6%99%BA%E8%83%BD%E7%94%B5%E7%81%AF%E5%A6%82%E4%BD%95%E6%84%9F%E7%9F%A5%E5%85%89%E7%BA%BF%E4%B8%8B/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="19__场景联动：智能电灯如何感知光线？（下）">
  <meta property="og:description" content="你好，我是郭朝斌。
在上一讲，我们基于 NodeMCU ESP32 开发板，开发了一款光照传感器。考虑到低功耗的需求，它是基于低功耗蓝牙技术来实现的。但是蓝牙设备本身无法直接联网上报数据，那么我们要怎么根据光照强度数据来联动控制智能电灯呢？">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="物联网开发实战">

  <meta itemprop="name" content="19__场景联动：智能电灯如何感知光线？（下）">
  <meta itemprop="description" content="你好，我是郭朝斌。
在上一讲，我们基于 NodeMCU ESP32 开发板，开发了一款光照传感器。考虑到低功耗的需求，它是基于低功耗蓝牙技术来实现的。但是蓝牙设备本身无法直接联网上报数据，那么我们要怎么根据光照强度数据来联动控制智能电灯呢？">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="4609">
  <meta itemprop="keywords" content="物联网开发实战">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="19__场景联动：智能电灯如何感知光线？（下）">
  <meta name="twitter:description" content="你好，我是郭朝斌。
在上一讲，我们基于 NodeMCU ESP32 开发板，开发了一款光照传感器。考虑到低功耗的需求，它是基于低功耗蓝牙技术来实现的。但是蓝牙设备本身无法直接联网上报数据，那么我们要怎么根据光照强度数据来联动控制智能电灯呢？">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">19__场景联动：智能电灯如何感知光线？（下）</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 4609 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#网关系统架构">网关系统架构</a></li>
        <li><a href="#南向蓝牙通信">南向蓝牙通信</a>
          <ul>
            <li><a href="#通过终端登录树莓派">通过终端登录树莓派</a></li>
            <li><a href="#通过图形化窗口软件登录树莓派">通过图形化窗口软件登录树莓派</a></li>
            <li><a href="#在树莓派开发蓝牙程序">在树莓派开发蓝牙程序</a></li>
          </ul>
        </li>
        <li><a href="#北向-mqtt-对接云平台">北向 MQTT 对接云平台</a>
          <ul>
            <li><a href="#mqtt-开发环境准备">MQTT 开发环境准备</a></li>
            <li><a href="#云平台创建光照传感器设备">云平台创建光照传感器设备</a></li>
            <li><a href="#产品联网开发">产品联网开发</a></li>
            <li><a href="#在树莓派上部署软件">在树莓派上部署软件</a></li>
          </ul>
        </li>
        <li><a href="#设置场景联动">设置场景联动</a>
          <ul>
            <li><a href="#场景联动任务分解">场景联动任务分解</a></li>
            <li><a href="#联动设备准备">联动设备准备</a></li>
            <li><a href="#联动任务创建">联动任务创建</a></li>
          </ul>
        </li>
        <li><a href="#小结">小结</a></li>
        <li><a href="#思考题">思考题</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是郭朝斌。</p>
<p>在上一讲，我们基于 NodeMCU ESP32 开发板，开发了一款光照传感器。考虑到低功耗的需求，它是基于低功耗蓝牙技术来实现的。但是蓝牙设备本身无法直接联网上报数据，那么我们要怎么根据光照强度数据来联动控制智能电灯呢？</p>
<p>不知道你还记不记得第 9 讲的内容？对于蓝牙设备，我们需要借助<strong>网关</strong>来实现联网的目的。所以在这一讲中，我会带你用树莓派打造蓝牙网关，最终实现光照传感器和智能电灯的场景联动。</p>
<h2 id="网关系统架构">网关系统架构</h2>
<p>首先，我们先看一下网关的系统架构。</p>
<p>网关的主要功能是<strong>协议转换</strong>，一方面它需要接收低功耗蓝牙技术的光照传感器的广播数据，另一方面，它需要把解析的数据上传到云平台。</p>
<p>具体的架构图如下所示。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/9f6aa13d68580a64f72631c382737c04.png" alt=""></p>
<h2 id="南向蓝牙通信">南向蓝牙通信</h2>
<p>在树莓派上进行蓝牙开发，你可以使用bluepy软件包。它提供了一个 Python 语言版本的低功耗蓝牙 API 接口，而且对树莓派的适配非常好。</p>
<h3 id="通过终端登录树莓派">通过终端登录树莓派</h3>
<p>在学习第 15 讲的时候，你应该已经在树莓派上部署好了包含 Gladys Assistant 系统的 Raspbian 操作系统，现在你可以直接使用这个系统。安装软件包之前，我们在电脑终端上输入下面的命令，通过 SSH 协议登录到树莓派系统中。</p>
<p>$ ssh <a href="mailto:pi@gladys.local">pi@gladys.local</a></p>
<p>其中，pi 就是默认的登录用户名，gladys.local 是树莓派开发板的本地域名。</p>
<p>当提示输入密码时，我们输入默认密码 raspberry，然后回车，就登录到了树莓派系统中。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/a1406ab72755e628336d82d20a8cd508.png" alt=""></p>
<h3 id="通过图形化窗口软件登录树莓派">通过图形化窗口软件登录树莓派</h3>
<p>当然，你也可以使用提供图形化窗口的软件来登录树莓派，比如 <strong>SecureCRT</strong>，它除了支持串口协议，同时也支持 SSH 协议。你只需要新建一个连接会话，按照下图所示的内容填写就行了：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/9e438e26031c7dbb7e4b610f3b2a99e7.png" alt=""></p>
<p>第一次登录时，SecureCRT 会弹窗提示我们查看“Host Key”，这时点击“Accept Once”即可。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/66274475d41c057f402777ef36a87ce7.png" alt=""></p>
<p>然后我们输入密码“raspberry”，同时勾选“Save password”，省去以后重复输入密码的麻烦。点击“OK”后，就进入树莓派系统了。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/021045b087be7344a33ad26d2345fba4.png" alt=""></p>
<h3 id="在树莓派开发蓝牙程序">在树莓派开发蓝牙程序</h3>
<p>我们在树莓派的终端上输入下面命令，就可以完成 bluepy 的安装：</p>
<p>$ sudo apt-get install python3-pip libglib2.0-dev<br>
$ sudo pip3 install bluepy</p>
<p>另外，我们还需要安装 interruptingcow 软件包。它主要是便于编写定时任务。它的安装命令是：</p>
<p>$ sudo pip3 install interruptingcow</p>
<p>具体代码如下，供参考：</p>
<p>#File: blescan.py<br>
import time<br>
from threading import Thread<br>
from interruptingcow import timeout</p>
<p>from bluepy.btle import DefaultDelegate, Peripheral, Scanner, UUID, capitaliseName, BTLEInternalError<br>
from bluepy.btle import BTLEDisconnectError, BTLEManagementError, BTLEGattError</p>
<p>class LightScanner():<br>
SCAN_TIMEOUT = 5</p>
<pre><code>def __init__(self, name):  
    self._name = name  
  
def status_update(self):  
    results = self._get_data()  

    # messages = [  
    #     MqttMessage(  
    #         topic=self.format_topic(&quot;property/light&quot;),  
    #         payload=results.lightlevel,  
    #     )  
    # ]  

    return results  

def _get_data(self):  

    scan_processor = ScanProcessor(self._name)  
    scanner = Scanner().withDelegate(scan_processor)  
    scanner.scan(self.SCAN_TIMEOUT, passive=True)  

    with timeout(  
        self.SCAN_TIMEOUT,  
        exception=Exception(  
            &quot;Retrieving data from {} device {} timed out after {} seconds&quot;.format(  
                repr(self), self._name, self.SCAN_TIMEOUT  
            )  
        ),  
    ):  
        while not scan_processor.ready:  
            time.sleep(1)  
        return scan_processor.results  

    return scan_processor.results  
</code></pre>
<p>class ScanProcessor:</p>
<pre><code>ADV_TYPE_SERVICE_DATA = 0x16  
def __init__(self, name):  
    self._ready = False  
    self._name = name  
    self._results = MiBeaconData()  

def handleDiscovery(self, dev, isNewDev, _):  
    is_nodemcu = False  
    if isNewDev:  
        for (adtype, desc, value) in dev.getScanData():  
            #Service Data UUID == 0xFE95 according to MiBeacon  
            if adtype == self.ADV_TYPE_SERVICE_DATA and value.startswith(&quot;95fe&quot;):  
                print(&quot;FOUND service Data:&quot;,adtype, desc, value)  
                #Object ID == 0x1007 according to MiBeacon  
                if len(value) == 38 and value[26:30] == '0710':  
                    light_den = int((value[-2:] + value[-4:-2]), 16)  
                    mac = value[14:26]  

                    self._results.lightlevel = light_den  
                    self._results.mac = mac  

                    self.ready = True  

@property  
def mac(self):  
    return self._mac  

@property  
def ready(self):  
    return self._ready  

@ready.setter  
def ready(self, var):  
    self._ready = var  

@property  
def results(self):  
    return self._results  
</code></pre>
<p>class MiBeaconData:<br>
def <strong>init</strong>(self):<br>
self._lightlevel = None<br>
self._mac = None</p>
<pre><code>@property  
def lightlevel(self):  
    return self._lightlevel  

@lightlevel.setter  
def lightlevel(self, var):  
    self._lightlevel = var  

@property  
def mac(self):  
    return self._mac  

@mac.setter  
def mac(self, var):  
    self._mac = var
</code></pre>
<h2 id="北向-mqtt-对接云平台">北向 MQTT 对接云平台</h2>
<p>接下来，我们要实现网关和云平台的对接。</p>
<h3 id="mqtt-开发环境准备">MQTT 开发环境准备</h3>
<p>安装软件包</p>
<p>蓝牙网关与云平台交互的通信协议也是使用 MQTT 协议，所以我们需要安装 MQTT 的软件包。</p>
<p>使用哪个软件包呢？在第 8 讲中我介绍过几个常用的 MQTT 软件包，这里我们选择支持 Python 语言开发的Eclipse Paho软件包。我们在树莓派的终端上输入下面的命令来安装。</p>
<p>$ sudo pip3 install paho-mqtt</p>
<p>安装成功后，我们可以写一个 demo 程序测试一下。下面是我测试的代码，你可以参考。和第 8 讲一样，这段代码仍然会连接到 test.mosquitto.org，并且订阅“/geektime/iot”的主题消息。</p>
<p>#File: mqttdemo.py<br>
import paho.mqtt.client as mqtt</p>
<p>def on_connect(client, userdata, flags, rc):<br>
print(&ldquo;Connected with result code &ldquo;+str(rc))</p>
<pre><code>client.subscribe(&quot;/geektime/iot&quot;)  
</code></pre>
<p>def on_message(client, userdata, msg):<br>
print(msg.topic+&rdquo; &ldquo;+str(msg.payload))</p>
<p>client = mqtt.Client()<br>
client.on_connect = on_connect<br>
client.on_message = on_message</p>
<p>#Still connect to mqtt.eclipse.org<br>
client.connect(&ldquo;test.mosquitto.org&rdquo;, 1883, 60)</p>
<p>client.loop_forever()</p>
<ol>
<li><strong>部署文件到树莓派</strong></li>
</ol>
<p>现在，我们把测试文件 mqttdemo.py 上传到树莓派上。</p>
<p>你可以在电脑终端上，运行下面的命令。（注意，你需要先在树莓派上创建 pi-gateway 这个目录。）</p>
<p>$ scp mqttdemo.py <a href="mailto:pi@gladys.local">pi@gladys.local</a>:/home/pi/pi-gateway/</p>
<p>其中这个 scp 命令是基于 SSH 协议实现的安全文档传输功能。</p>
<p>当然，你也可能更习惯图形化的软件，所以我再介绍一个能实现 scp 功能的软件 FileZilla。它支持 MacOS、Windows 和 Linux 操作系统，操作界面也非常直观。</p>
<p>打开“站点管理器”，创建“新站点”。你可以按照下图设置具体配置参数，然后点击“连接”，登录到树莓派系统。为了方便之后的使用，你可以勾选“保存密码”选项。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/53b0a1a09107610382e8d7e55edfa879.png" alt=""></p>
<p>在软件界面的左半部分是你的电脑上的文件目录，右半部分是树莓派上的目录。你只需要双击左边的某个文件，就可以将文件传输到树莓派上。当然你也可以双击右边树莓派上的文件，将它传输到你的电脑。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/3572f80f52c7e96f63d2e2f547de908a.png" alt=""></p>
<p>把文件传输到树莓派之后，我们就可以在树莓派的终端上输入下面的命令，运行上面的 demo 程序。</p>
<p>$ sudo python3 mqttdemo.py</p>
<p>这时我们把第 8 讲中的发布消息命令再执行一次，如果一切顺利执行，那么就可以在树莓派的终端上看到这个消息。</p>
<p>hbmqtt_pub &ndash;url mqtt://test.mosquitto.org:1883 -t /geektime/iot -m Hello,World!</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/b57986e475a0d18b099327430ebe248f.png" alt=""></p>
<h3 id="云平台创建光照传感器设备">云平台创建光照传感器设备</h3>
<p>现在，我们已经做好了对接云平台的准备工作。在树莓派上开发与云平台的通信代码之前，我们还需要在腾讯云平台上创建对应的光照传感器设备。</p>
<p>创建的过程与第 17 讲智能电灯的过程类似。我快速介绍一下，你重点关注不同的地方就可以了。</p>
<p>在“新建产品”中，产品类别选择“智慧生活”&ndash;&gt;“安防报警”&ndash;&gt;“光照度传感器”。数据协议仍然选择“数据模板”，其他的保持默认值即可。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/6a4c84a79150db8b2ac13f593055ca5d.png" alt=""></p>
<p>创建成功后，我们点击进入数据模板的设置界面。为了尽量简单，我只定义了一个属性“光照度”，而且是只读类型。你可以直接导入下面的 JSON 文件完成数据模板的设置。</p>
<p>{<br>
&ldquo;version&rdquo;: &ldquo;1.0&rdquo;,<br>
&ldquo;profile&rdquo;: {<br>
&ldquo;ProductId&rdquo;: &ldquo;你的 ProductID&rdquo;,<br>
&ldquo;CategoryId&rdquo;: &ldquo;112&rdquo;<br>
},<br>
&ldquo;properties&rdquo;: [<br>
{<br>
&ldquo;id&rdquo;: &ldquo;Illuminance&rdquo;,<br>
&ldquo;name&rdquo;: &ldquo;光照度&rdquo;,<br>
&ldquo;desc&rdquo;: &ldquo;光照度检测&rdquo;,<br>
&ldquo;mode&rdquo;: &ldquo;r&rdquo;,<br>
&ldquo;define&rdquo;: {<br>
&ldquo;type&rdquo;: &ldquo;float&rdquo;,<br>
&ldquo;min&rdquo;: &ldquo;0&rdquo;,<br>
&ldquo;max&rdquo;: &ldquo;6000&rdquo;,<br>
&ldquo;start&rdquo;: &ldquo;0&rdquo;,<br>
&ldquo;step&rdquo;: &ldquo;1&rdquo;,<br>
&ldquo;unit&rdquo;: &ldquo;Lux&rdquo;<br>
}<br>
}<br>
],<br>
&ldquo;events&rdquo;: [],<br>
&ldquo;actions&rdquo;: []<br>
}</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/2456d4e3f46e1534582714a5c96508c0.png" alt=""></p>
<p>在“交互开发”标签页中，和智能电灯一样，我们仍然保持“使用官方小程序控制产品”选项是打开状态。另外，还有一个配置项需要关注，那就是“智能联动配置”，因为后面我们要为光照传感器设置联动场景。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/596528960a316374823f4bca50066c62.png" alt=""></p>
<p>我们点击“配置”，在设置页面中，就可以看到“光照度”这个属性，因为它是只读属性，所以只能作为联动的触发条件。我们勾选“作为条件”的选项，完成配置。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/666b54985708502049391e7225e9f188.png" alt=""></p>
<p>下一步，在“设备调试”界面中，我们创建一个测试设备。点击“新建设备”，输入设备名称“Lightsensor_1”。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/8fcf2a275826b6fe0b2c51c6f1ee3c46.png" alt=""></p>
<p>创建成功后，在测试设备列表中，点击“Lightsensor_1”，进入设备的详情页面，我们可以看到设备三元组的信息。你需要将这些信息记录下来，因为后面的开发中需要使用。</p>
<p>在测试设备列表中，我们点击“二维码”操作，获取测试设备的二维码，以便在小程序“腾讯连连”中添加这个设备。</p>
<p>到这里，腾讯云平台上的产品创建工作就完成了。</p>
<h3 id="产品联网开发">产品联网开发</h3>
<p>在腾讯云平台准备好产品的配置工作之后，我们继续在树莓派上完成北向的通信交互的开发工作。</p>
<p>在第 17 讲中，我们已经了解了 MQTT 通信的主题 Topic，以及 Broker 服务器地址、端口号、设备 ID（ClientID）、用户名（UserName）和密码（Password）等连接参数的知识。</p>
<p>我们还是可以使用 <strong>sign.html</strong> 这个网页工具生产用户名和密码，然后就能得到所有的参数。这时，把这些参数替换到下面这段代码的对应位置就可以了。</p>
<p>#File: gateway.py<br>
from blescan import LightScanner, MiBeaconData</p>
<p>import time<br>
import asyncio<br>
import json<br>
import uuid<br>
import paho.mqtt.client as MQTTClient</p>
<p>&quot;&rdquo;&rdquo;<br>
QCloud Device Info<br>
&quot;&quot;&quot;<br>
DEVICE_NAME = &ldquo;Lightsensor_1&rdquo;<br>
PRODUCT_ID = &ldquo;MAO3SVUCFO&rdquo;<br>
DEVICE_KEY = &ldquo;TYjuKNc2GpDykXUv4MWBOA==&rdquo;</p>
<p>&quot;&quot;&quot;<br>
MQTT topic<br>
&quot;&quot;&quot;<br>
MQTT_CONTROL_TOPIC = &ldquo;$thing/down/property/&quot;+PRODUCT_ID+&rdquo;/&quot;+DEVICE_NAME<br>
MQTT_CONTROL_REPLY_TOPIC = &ldquo;$thing/up/property/&quot;+PRODUCT_ID+&rdquo;/&quot;+DEVICE_NAME</p>
<p>def mqtt_callback(client, userdata, msg):<br>
# Callback<br>
print(f&quot;Received <code>{msg.payload.decode()}</code> from <code>{msg.topic}</code> topic&quot;)</p>
<p>async def mqtt_connect():<br>
#connect callback<br>
def on_connect(client, userdata, flags, rc):<br>
if rc == 0:<br>
print(&ldquo;Connected to MQTT Broker!&rdquo;)<br>
else:<br>
print(&ldquo;Failed to connect, return code %d\n&rdquo;, rc)</p>
<pre><code>mqtt_client = None  
MQTT_SERVER = PRODUCT_ID + &quot;.iotcloud.tencentdevices.com&quot;  
MQTT_PORT = 1883  
MQTT_CLIENT_ID = PRODUCT_ID+DEVICE_NAME  
MQTT_USER_NAME = &quot;MAO3SVUCFOLightsensor_1;12010126;2OYA5;1609057368&quot;  
MQTTT_PASSWORD = &quot;8f79b7f1b0bef9cde7fd9652383b6ff8bfeb8003cc994c64f3c8e069c11fd4c7;hmacsha256&quot;  

mqtt_client = MQTTClient.Client(MQTT_CLIENT_ID)  
mqtt_client.username_pw_set(MQTT_USER_NAME, MQTTT_PASSWORD)  
mqtt_client.on_connect = on_connect  
  
mqtt_client.connect(MQTT_SERVER, MQTT_PORT, 60)  

return mqtt_client  
</code></pre>
<p>def mqtt_report(client, light_level):<br>
client_token = &ldquo;clientToken-&rdquo; + str(uuid.uuid4())</p>
<pre><code>msg = {  
    &quot;method&quot;: &quot;report&quot;,  
    &quot;clientToken&quot;: client_token,  
    &quot;params&quot;: {  
        &quot;Illuminance&quot;: light_level  
    }  
}  

client.publish(MQTT_CONTROL_REPLY_TOPIC, json.dumps(msg))  
</code></pre>
<p>async def light_loop(mclient):</p>
<pre><code>bles = LightScanner('Nodemcu')  

mclient.subscribe(MQTT_CONTROL_TOPIC)  
mclient.on_message = mqtt_callback  

mclient.loop_start()  

while True:  
    try:  
        data = bles.status_update()  
    except Exception as e:  
        print(&quot;BLE SCAN error:&quot;, e)  
        continue  
      
    print(&quot;Light Level:&quot;, data.lightlevel)  

    mqtt_report(mclient, data.lightlevel)  
      
    time.sleep(0.1)  
</code></pre>
<p>async def main():<br>
mqtt_client = None<br>
# MQTT connection<br>
try:<br>
mqtt_client = await asyncio.wait_for(mqtt_connect(), 20)<br>
except asyncio.TimeoutError:<br>
print(&ldquo;mqtt connected timeout!&rdquo;)</p>
<pre><code>if mqtt_client is not None:  
    await asyncio.gather(light_loop(mqtt_client))  
</code></pre>
<p>asyncio.run(main())</p>
<h3 id="在树莓派上部署软件">在树莓派上部署软件</h3>
<p>接下来，我们把代码文件 gateway.py 和 blescan.py 两个文件也上传到树莓派的 /home/pi/pi-gateway 目录中。</p>
<p>同时，为了让程序作为后台服务运行，并且能够开机自启动，我们来做一个 Pi Gateway Service。</p>
<p>首先，你需要新建一个 service.sh 脚本文件，内容如下：</p>
<p>#!/bin/sh<br>
set -e<br>
SCRIPT_DIR=$( cd &ldquo;$( dirname &ldquo;$0&rdquo; )&rdquo; &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd )</p>
<p>cd &ldquo;$SCRIPT_DIR&rdquo;<br>
sudo python3 ./gateway.py &ldquo;$@&rdquo;</p>
<p>然后，创建我们 service 的配置文件，内容如下：</p>
<p>[Unit]<br>
Description=Pi Gateway<br>
Documentation=https://time.geekbang.org/column/intro/100063601<br>
After=network.target</p>
<p>[Service]<br>
Type=simple<br>
WorkingDirectory=/home/pi/pi-gateway<br>
ExecStart=/home/pi/pi-gateway/service.sh<br>
Restart=always</p>
<p>[Install]<br>
WantedBy=multi-user.target</p>
<p>接着，把这两个文件上传到树莓派系统的 /home/pi/pi-gateway 目录中，并且运行下面命令，修改文件的属性。</p>
<p>$ sudo chmod a+x service.sh<br>
$ sudo chmod a+x pi-gateway.service</p>
<p>最后，执行下面的几条命令，为树莓派系统增添上 Pi Gateway 这个服务。</p>
<p>$ sudo cp /home/pi/pi-gateway/pi-gateway.service /etc/systemd/system/<br>
$ sudo systemctl daemon-reload<br>
$ sudo systemctl start pi-gateway<br>
$ sudo systemctl status pi-gateway<br>
$ sudo systemctl enable pi-gateway</p>
<p>到这里，网关程序已经在树莓派上运行起来。我们在腾讯云物联网平台上可以看到，光照传感器变为“在线”状态。</p>
<h2 id="设置场景联动">设置场景联动</h2>
<p>在第 17 讲和第 18 讲的实战中，我们分别完成了智能电灯和光照传感器的开发，现在终于可以为它们设置场景联动了。</p>
<h3 id="场景联动任务分解">场景联动任务分解</h3>
<p>我们希望实现的联动场景是，基于环境的光照强度自动控制电灯的开和关。具体来说，这个目标可以拆解为 3 个自动触发任务：</p>
<ol>
<li>当光照强度大于 1024Lux 时，关闭电灯。</li>
<li>当光照强度小于 1024Lux 时，打开电灯。</li>
<li>至于光照强度等于 1024Lux 时，也打开电灯。</li>
</ol>
<p>注意，这里的 1024Lux 是我自己选择的一个值，你可以根据房屋情况自己调整。</p>
<h3 id="联动设备准备">联动设备准备</h3>
<p>如果你还没有在小程序中添加光照传感器设备，这时可以打开微信中的腾讯连连小程序，扫描上面云平台“设备调试”中保存的那个二维码，添加光照传感器测试设备“Lightsensor_1”。</p>
<p>现在你的小程序里面已经有了两个设备，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/263ed9f8d129173c0e41c830204441c9.png" alt=""></p>
<p>刚才我们已经在腾讯云物联网平台上，为光照传感器设置了“智能联动配置”。现在，我们来为智能电灯配置智能联动能力。</p>
<p>我们进入智能电灯的“交互开发”页面，打开下面的“智能联动配置”页面，然后，像下图显示的那样，把“电灯开关”的“作为任务”条件勾选上。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/87118cfe876628f70a200bfa265aa1a1.png" alt=""></p>
<h3 id="联动任务创建">联动任务创建</h3>
<p>然后，我们进入腾讯连连小程序，点击下面的“+”，选择“添加智能”，开始配置工作。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/36e29e77624400499c4aad617aa4e4d3.png" alt=""></p>
<p>我们从弹框里选择“自动智能”，可以看到下图的配置界面：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/6ad585ca95f45f607b1f286a22689576.png" alt=""></p>
<p>首先，我们添加条件，选择光照传感器设备，然后就会看到光照度属性。我们先设置大于 1024Lux 的条件。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/2c6a1bb1808780787579102c77d07c37.png" alt=""></p>
<p>然后，我们添加任务，选择智能电灯设备后，可以看到电灯开关的属性，选择“关”，点击保存。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/1e3cee21930c87aeec79a8986474db83.png" alt=""></p>
<p>这时，我们可以看到这个智能联动的条件和任务已经配置完成。腾讯连连小程序还支持配置“生效时间段”，可以限定智能联动在选定的时间段内运行。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/863a89bc9dd3d9d8bef29cea1f4d58cb.png" alt=""></p>
<p>接下来，我们还可以设置一个主题图片和名称，这个根据喜好来就行了。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/e3268752f2d02e280b03755a8c9af6ad.png" alt=""></p>
<p>按照相同的方法，我们可以设置其他两个条件，如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/85f65df75282bdc0a459f80f7b330d03.png" alt=""></p>
<p>最终的智能联动，包括了刚才提到的 3 个不同的触发条件。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/0f926fd2984bc5089d1643afbd5d45f9.png" alt=""></p>
<p>现在，你可以通过控制光照传感器的光照明暗（比如用手遮挡光敏元器件然后再把手拿开），来观察智能电灯的打开和关闭，检验功能是否正常。</p>
<h2 id="小结">小结</h2>
<p>总结一下，在这一讲中，我介绍了利用树莓派打造网关，让光照传感器接入物联网平台的办法，并且带你实现了光照传感器和智能电灯的场景联动。你需要重点关注的内容有：</p>
<ol>
<li>为了实现协议转换，树莓派的南向接口，也就是蓝牙功能，你可以基于 bluepy 软件包开发。这里实现的功能是扫描光照传感器的广播包，并按照 MiBeacon 蓝牙协议解析出光照强度的数值。</li>
<li>北向接口要实现对接云平台的功能，这是基于 MQTT 协议实现的。你可以基于 Eclipse paho 的 Python 语言版本来开发 MQTT Client 的功能。</li>
<li>场景联动一般由条件和任务组成。其中，条件和任务是从我们的设备中定义的智能联动配置中选择的。</li>
</ol>
<p>为了避免光照的短暂变化，导致智能电灯的忽明忽暗，我将光照传感器的数据上报间隔设置得比较长。如果你有特殊的需求，可以修改光照传感器和网关程序中的参数来实现。</p>
<p>下一讲，我将讲解智能音箱的实现，并通过智能音箱控制智能电灯的开关。</p>
<h2 id="思考题">思考题</h2>
<p>最后，我给你留一个动手实践题。</p>
<p>在这一讲的场景联动中，我们实现了光照强度对电灯打开和关闭的自动控制。你可以通过光照强度的不同数值实现对智能电灯亮度，或者颜色的控制吗？</p>
<p>你可以动手设置一下，并且在留言区和我分享你的成果，同时，也欢迎你将这一讲分享给你的朋友，大家一起讨论学习。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E7%89%A9%E8%81%94%E7%BD%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/">物联网开发实战</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E4%B9%94%E6%96%B0%E4%BA%AE%E7%9A%84cto%E6%88%90%E9%95%BF%E5%A4%8D%E7%9B%98/19__%E4%BA%A7%E5%93%81%E6%80%9D%E7%BB%B4%E5%A5%91%E7%BA%A6%E7%B2%BE%E7%A5%9E%E6%98%AF%E5%9F%BA%E7%A1%80%E6%B4%9E%E5%AF%9F%E4%BA%BA%E6%80%A7%E6%89%8D%E8%83%BD%E6%88%90%E5%B0%B1%E5%8D%93%E8%B6%8A/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">19__产品思维，契约精神是基础，洞察人性才能成就卓越</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%8B%8F%E6%9D%B0%E7%9A%84%E4%BA%A7%E5%93%81%E5%88%9B%E6%96%B0%E8%AF%BE/19__%E4%BB%8E%E4%BA%A7%E5%93%81%E5%88%B0%E4%BA%A7%E5%93%81%E7%9F%A9%E9%98%B5%E5%8F%AF%E5%A4%8D%E7%94%A8%E8%83%BD%E7%A7%AF%E7%B4%AF%E5%96%84%E7%94%9F%E6%AD%BB/">
            <span class="next-text nav-default">19__从产品到产品矩阵：可复用、能积累、善生死</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
