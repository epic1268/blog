<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>练习Sample跑起来__唯鹿同学的练习手记_第1辑 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content=" 你好，我是张绍文，今天我要跟你分享唯鹿同学完成专栏课后练习作业的“手记”。专栏承诺会为坚持完成练习作业的同学送出 GMTC 大会门票，唯鹿同学通过自己的努力和坚持，为自己赢得了 GMTC 大会的门票。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/%E7%BB%83%E4%B9%A0sample%E8%B7%91%E8%B5%B7%E6%9D%A5__%E5%94%AF%E9%B9%BF%E5%90%8C%E5%AD%A6%E7%9A%84%E7%BB%83%E4%B9%A0%E6%89%8B%E8%AE%B0_%E7%AC%AC1%E8%BE%91/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/%E7%BB%83%E4%B9%A0sample%E8%B7%91%E8%B5%B7%E6%9D%A5__%E5%94%AF%E9%B9%BF%E5%90%8C%E5%AD%A6%E7%9A%84%E7%BB%83%E4%B9%A0%E6%89%8B%E8%AE%B0_%E7%AC%AC1%E8%BE%91/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="练习Sample跑起来__唯鹿同学的练习手记_第1辑">
  <meta property="og:description" content="你好，我是张绍文，今天我要跟你分享唯鹿同学完成专栏课后练习作业的“手记”。专栏承诺会为坚持完成练习作业的同学送出 GMTC 大会门票，唯鹿同学通过自己的努力和坚持，为自己赢得了 GMTC 大会的门票。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="Android开发高手课">

  <meta itemprop="name" content="练习Sample跑起来__唯鹿同学的练习手记_第1辑">
  <meta itemprop="description" content="你好，我是张绍文，今天我要跟你分享唯鹿同学完成专栏课后练习作业的“手记”。专栏承诺会为坚持完成练习作业的同学送出 GMTC 大会门票，唯鹿同学通过自己的努力和坚持，为自己赢得了 GMTC 大会的门票。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="3635">
  <meta itemprop="keywords" content="Android开发高手课">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="练习Sample跑起来__唯鹿同学的练习手记_第1辑">
  <meta name="twitter:description" content="你好，我是张绍文，今天我要跟你分享唯鹿同学完成专栏课后练习作业的“手记”。专栏承诺会为坚持完成练习作业的同学送出 GMTC 大会门票，唯鹿同学通过自己的努力和坚持，为自己赢得了 GMTC 大会的门票。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">练习Sample跑起来__唯鹿同学的练习手记_第1辑</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 3635 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p>你好，我是张绍文，今天我要跟你分享唯鹿同学完成专栏课后练习作业的“手记”。专栏承诺会为坚持完成练习作业的同学送出 GMTC 大会门票，唯鹿同学通过自己的努力和坚持，为自己赢得了 GMTC 大会的门票。</p>
<p>如果你还没开始练习，我强烈建议你花一些时间在练习上，因为每个练习的 Sample 都是我和学习委员花费很多精力精心准备的，为的是让你在学习完后可以有机会上手实践，帮你尽快消化专栏里的知识并为自己所用。</p>
</blockquote>
<p>大家好，我是唯鹿，来自西安，从事 Android 开发也有近 5 年的时间了，目前在做智慧社区方面的业务。我自己坚持写博客已经有三年多的时间了，希望分享自己在工作、学习中的收获。</p>
<p>先说说我学习专栏的方法，专栏更新当天我就会去学习，但是难度真的不小。我对自己的要求并不是看一遍就要搞明白，而是遇见不懂的地方立马查阅资料，要做到大体了解整篇内容。之后在周末的时候我会集中去做 Sample 练习，一边复习本周发布的内容，一边用写博客的方式记录练习的结果。</p>
<p>后面我计划专栏结束后再多看、多练习几遍，不断查漏补缺。说真的，我很喜欢《Android 开发高手课》的难度，让我在完成练习作业时有种翻越高山的快感。最后，希望同学们一起坚持，享受翻越高山带来的成就感。</p>
<hr>
<p>最近在学习张绍文老师的《Android 开发高手课》。课后作业可不是一般的难，最近几天抽空练习了一下，结合老师给的步骤和其他同学的经验，完成了前 5 课的内容。</p>
<p>我整理总结了一下，分享出来，希望可以帮到一起学习的同学（当然希望大家尽量靠自己解决问题）。</p>
<p><a href="./Chapter01.md"><strong>Chapter01</strong></a></p>
<blockquote>
<p>例子里集成了 Breakpad 来获取发生 Native Crash 时候的系统信息和线程堆栈信息。通过一个简单的 Native 崩溃捕获过程，完成 minidump 文件的生成和解析，在实践中加深对 Breakpad 工作机制的认识。</p>
</blockquote>
<p>直接运行项目，按照 README.md 的步骤操作就行。</p>
<p>中间有个问题，老师提供的 minidump_stackwalker 工具在 macOS 10.14 以上无法成功执行，因为没有 libstdc++.6.dylib 库，所以我就下载 Breakpad 源码重新编译了一遍。</p>
<p>使用 minidump_stackwalker 工具来根据 minidump 文件生成堆栈跟踪 log，得到的 crashLog.txt 文件如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Operating system: Android
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  0.0.0 Linux 4.9.112-perf-gb92eddd #1 SMP PREEMPT Tue Jan 1 21:35:06 CST 2019 aarch64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CPU: arm64  // 注意点 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     8 CPUs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> GPU: UNKNOWN
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Crash reason:  SIGSEGV /SEGV_MAPERR
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Crash address: 0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Process uptime: not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Thread 0 (crashed)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 0  libcrash-lib.so + 0x600 // 注意点 2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     x0 = 0x00000078e0ce8460    x1 = 0x0000007fd4000314
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     x2 = 0x0000007fd40003b0    x3 = 0x00000078e0237134
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     x4 = 0x0000007fd40005d0    x5 = 0x00000078dca14200
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     x6 = 0x0000007fd4000160    x7 = 0x00000078c8987e18
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     x8 = 0x0000000000000000    x9 = 0x0000000000000001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x10 = 0x0000000000430000   x11 = 0x00000078e05ef688
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x12 = 0x00000079664ab050   x13 = 0x0ad046ab5a65bfdf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x14 = 0x000000796650c000   x15 = 0xffffffffffffffff
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x16 = 0x00000078c83defe8   x17 = 0x00000078c83ce5ec
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x18 = 0x0000000000000001   x19 = 0x00000078e0c14c00
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x20 = 0x0000000000000000   x21 = 0x00000078e0c14c00
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x22 = 0x0000007fd40005e0   x23 = 0x00000078c89fa661
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x24 = 0x0000000000000004   x25 = 0x00000079666cc5e0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x26 = 0x00000078e0c14ca0   x27 = 0x0000000000000001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    x28 = 0x0000007fd4000310    fp = 0x0000007fd40002e0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     lr = 0x00000078c83ce624    sp = 0x0000007fd40002c0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     pc = 0x00000078c83ce600
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Found by: given as instruction pointer in context
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 1  libcrash-lib.so + 0x620
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     fp = 0x0000007fd4000310    lr = 0x00000078e051c7e4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     sp = 0x0000007fd40002f0    pc = 0x00000078c83ce624
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Found by: previous frame&#39;s frame pointer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 2  libart.so + 0x55f7e0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     fp = 0x130c0cf800000001    lr = 0x00000079666cc5e0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     sp = 0x0000007fd4000320    pc = 0x00000078e051c7e4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Found by: previous frame&#39;s frame pointer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>下来是符号解析，可以使用 NDK 中提供的<code>addr2line</code>来根据地址进行一个符号反解的过程，该工具在<code>$NDK_HOME/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/arm-linux-androideabi-addr2line</code>。</p>
<p>注意：此处要注意一下平台，如果是 ARM 64 位的 so，解析是需要使用 aarch64-linux-android-4.9 下的工具链。</p>
<p>因为我的是 ARM 64 位的 so。所以使用 aarch64-linux-android-4.9，libcrash-lib.so 在<code>app/build/intermediates/cmake/debug/obj/arm64-v8a</code>下，<code>0x600</code>为错误位置符号。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">aarch64-linux-android-addr2line -f -C -e libcrash-lib.so 0x600
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Crash</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">weilu</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">Chapter01</span><span class="o">-</span><span class="n">master</span><span class="o">/</span><span class="n">sample</span><span class="o">/.</span><span class="n">externalNativeBuild</span><span class="o">/</span><span class="n">cmake</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">arm64</span><span class="o">-</span><span class="n">v8a</span><span class="o">/../../../../</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">cpp</span><span class="o">/</span><span class="n">crash</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到输出结果与下图错误位置一致（第 10 行）。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/85a7e7f06cd7db0ea3ac707f258eb339.png" alt=""></p>
<p><a href="./Chapter02.md"><strong>Chapter02</strong></a></p>
<blockquote>
<p>该例子主要演示了如何通过关闭 FinalizerWatchdogDaemon 来减少 TimeoutException 的触发。</p>
</blockquote>
<p>在我的上一篇博客：<a href="./84789495.md#t1">安卓开发中遇到的奇奇怪怪的问题（三）</a>中有说明，就不重复赘述了。</p>
<p><a href="./Chapter03.md"><strong>Chapter03</strong></a></p>
<blockquote>
<p>项目使用了 Inline Hook 来拦截内存对象分配时候的 RecordAllocation 函数，通过拦截该接口可以快速获取到当时分配对象的类名和分配的内存大小。</p>
<p>在初始化的时候我们设置了一个分配对象数量的最大值，如果从 start 开始对象分配数量超过最大值就会触发内存 dump，然后清空 alloc 对象列表，重新计算。该功能和 Android Studio 里的 Allocation Tracker 类似，只不过可以在代码级别更细粒度的进行控制。可以精确到方法级别。</p>
</blockquote>
<p>项目直接跑起来后，点击开始记录，然后点击 5 次生成 1000 对象按钮。生成对象代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">for (int i = 0; i &lt; 1000; i++) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     Message msg = new Message();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     msg.what = i;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为代码从点击开始记录开始，触发到 5000 的数据就 dump 到文件中，点击 5 次后就会在<code>sdcard/crashDump</code>下生成一个时间戳命名的文件。项目根目录下调用命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">tools</span><span class="o">/</span><span class="n">DumpPrinter</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="n">jar</span> <span class="n">dump</span> <span class="err">文件路径</span> <span class="o">&gt;</span> <span class="n">dump_log</span><span class="o">.</span><span class="n">txt</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后就可以在 dump_log.txt 中看到解析出来的数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Found 5000 records:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tid=4509 android.graphics.drawable.RippleForeground (112 bytes)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.graphics.drawable.RippleDrawable.tryRippleEnter (RippleDrawable.java:569)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.graphics.drawable.RippleDrawable.setRippleActive (RippleDrawable.java:276)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.graphics.drawable.RippleDrawable.onStateChange (RippleDrawable.java:266)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.graphics.drawable.Drawable.setState (Drawable.java:778)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.drawableStateChanged (View.java:21137)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.widget.TextView.drawableStateChanged (TextView.java:5289)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.support.v7.widget.AppCompatButton.drawableStateChanged (AppCompatButton.java:155)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.refreshDrawableState (View.java:21214)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.setPressed (View.java:10583)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.setPressed (View.java:10561)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.onTouchEvent (View.java:13865)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.widget.TextView.onTouchEvent (TextView.java:10070)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.dispatchTouchEvent (View.java:12533)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.ViewGroup.dispatchTransformedTouchEvent (ViewGroup.java:3032)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.ViewGroup.dispatchTouchEvent (ViewGroup.java:2662)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.ViewGroup.dispatchTransformedTouchEvent (ViewGroup.java:3032)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tid=4515 int[] (104 bytes)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tid=4509 android.os.BaseLooper$MessageMonitorInfo (88 bytes)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.os.Message.&lt;init&gt; (Message.java:123)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    com.dodola.alloctrack.MainActivity$4.onClick (MainActivity.java:70)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.performClick (View.java:6614)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.performClickInternal (View.java:6591)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View.access$3100 (View.java:786)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.view.View$PerformClick.run (View.java:25948)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.os.Handler.handleCallback (Handler.java:873)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.os.Handler.dispatchMessage (Handler.java:99)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.os.Looper.loop (Looper.java:201)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    android.app.ActivityThread.main (ActivityThread.java:6806)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    java.lang.reflect.Method.invoke (Native method)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run (RuntimeInit.java:547)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    com.android.internal.os.ZygoteInit.main (ZygoteInit.java:873)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们用 Android Profiler 查找一个 Message 对象对比一下，一模一样。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/098f20d2ab3c3f4a3d218924187f0367.png" alt=""></p>
<p>简单看一下 Hook 代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">void hookFunc() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    LOGI(&#34;start hookFunc&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    void *handle = ndk_dlopen(&#34;libart.so&#34;, RTLD_LAZY | RTLD_GLOBAL);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     if (!handle) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        LOGE(&#34;libart.so open fail&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    void *hookRecordAllocation26 = ndk_dlsym(handle,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                             &#34;_ZN3art2gc20AllocRecordObjectMap16RecordAllocationEPNS_6ThreadEPNS_6ObjPtrINS_6mirror6ObjectEEEj&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     void *hookRecordAllocation24 = ndk_dlsym(handle,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                             &#34;_ZN3art2gc20AllocRecordObjectMap16RecordAllocationEPNS_6ThreadEPPNS_6mirror6ObjectEj&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     void *hookRecordAllocation23 = ndk_dlsym(handle,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                             &#34;_ZN3art3Dbg16RecordAllocationEPNS_6ThreadEPNS_6mirror5ClassEj&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     void *hookRecordAllocation22 = ndk_dlsym(handle,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                             &#34;_ZN3art3Dbg16RecordAllocationEPNS_6mirror5ClassEj&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     if (hookRecordAllocation26 != nullptr) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        LOGI(&#34;Finish get symbol26&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        MSHookFunction(hookRecordAllocation26, (void *) &amp;newArtRecordAllocation26,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       (void **) &amp;oldArtRecordAllocation26);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     } else if (hookRecordAllocation24 != nullptr) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        LOGI(&#34;Finish get symbol24&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        MSHookFunction(hookRecordAllocation26, (void *) &amp;newArtRecordAllocation26,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       (void **) &amp;oldArtRecordAllocation26);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     } else if (hookRecordAllocation23 != NULL) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        LOGI(&#34;Finish get symbol23&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        MSHookFunction(hookRecordAllocation23, (void *) &amp;newArtRecordAllocation23,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       (void **) &amp;oldArtRecordAllocation23);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } else {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        LOGI(&#34;Finish get symbol22&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if (hookRecordAllocation22 == NULL) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            LOGI(&#34;error find hookRecordAllocation22&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        } else {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            MSHookFunction(hookRecordAllocation22, (void *) &amp;newArtRecordAllocation22,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                           (void **) &amp;oldArtRecordAllocation22);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    dlclose(handle);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用了 Inline Hook 方案 Substrate 来拦截内存对象分配时候 libart.so 的 RecordAllocation 函数。首先如果我们要 hook 一个函数，需要知道这个函数的地址。我们也看到了代码中这个地址判断了四种不同系统。这里有一个<a href="./demangler.com.md">网页版的解析工具</a>可以快速获取。下面以 8.0 为例。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/a01b2aca5e48165a9323433f8c4a1490.png" alt=""></p>
<p>我在 8.0 的源码中找到了对应的方法：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/6a430d0f3da5774182a6ba2cfccfb591.png" alt=""></p>
<p>7.0 方法就明显不同：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/82dd6d574ac68316e8bde27eaf5c3eb1.png" alt=""></p>
<p>我也同时参看了 9.0 的代码，发现没有变化，所以我的测试机是 9.0 的也没有问题。</p>
<p>Hook 新内存对象分配处理代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static bool newArtRecordAllocationDoing24(Class *type, size_t byte_count) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     allocObjectCount++;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	// 根据 class 获取类名
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    char *typeName = GetDescriptor(type, &amp;a);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 达到 max
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (allocObjectCount &gt; setAllocRecordMax) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        CMyLock lock(g_Lock);// 此处需要 loc 因为对象分配的时候不知道在哪个线程，不 lock 会导致重复 dump
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        allocObjectCount = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         // dump alloc 里的对象转换成 byte 数据
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        jbyteArray allocData = getARTAllocationData();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 将 alloc 数据写入文件
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        SaveAllocationData saveData{allocData};
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        saveARTAllocationData(saveData);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        resetARTAllocRecord();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        LOGI(&#34;===========CLEAR ALLOC MAPS=============&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         lock.Unlock();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return true;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="./Chapter04.md"><strong>Chapter04</strong></a></p>
<blockquote>
<p>通过分析内存文件 hprof 快速判断内存中是否存在重复的图片，并且将这些重复图片的 PNG、堆栈等信息输出。</p>
</blockquote>
<p>首先是获取我们需要分析的 hprof 文件，我们加载两张相同的图片：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Bitmap bitmap1 = BitmapFactory.decodeResource(getResources(), R.mipmap.test);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Bitmap bitmap2 = BitmapFactory.decodeResource(getResources(), R.mipmap.test);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  imageView1.setImageBitmap(bitmap1);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> imageView2.setImageBitmap(bitmap2);
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成 hprof 文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 手动触发 GC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Runtime.getRuntime().gc();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> System.runFinalization();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Debug.dumpHprofData(file.getAbsolutePath());
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来就是利用<a href="./haha.md">HAHA 库</a>进行文件分析的核心代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 打开 hprof 文件
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">final HeapSnapshot heapSnapshot = new HeapSnapshot(hprofFile);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 获得 snapshot
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">final Snapshot snapshot = heapSnapshot.getSnapshot();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 获得 Bitmap Class
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">final ClassObj bitmapClass = snapshot.findClass(&#34;android.graphics.Bitmap&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 获得 heap, 只需要分析 app 和 default heap 即可
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Collection&lt;Heap&gt; heaps = snapshot.getHeaps();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> for (Heap heap : heaps) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 只需要分析 app 和 default heap 即可
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (!heap.getName().equals(&#34;app&#34;) &amp;&amp; !heap.getName().equals(&#34;default&#34;)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        continue;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    for (ClassObj clazz : bitmapClasses) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 从 heap 中获得所有的 Bitmap 实例
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        List&lt;Instance&gt; bitmapInstances = clazz.getHeapInstances(heap.getId());
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		// 从 Bitmap 实例中获得 buffer 数组， 宽高信息等。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        ArrayInstance buffer = HahaHelper.fieldValue(((ClassInstance) bitmapInstance).getValues(), &#34;mBuffer&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        int bitmapHeight = fieldValue(bitmapInstance, &#34;mHeight&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        int bitmapWidth = fieldValue(bitmapInstance, &#34;mWidth&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 引用链信息
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        while (bitmapInstance.getNextInstanceToGcRoot() != null) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            print(instance.getNextInstanceToGcRoot());
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            instance = instance.getNextInstanceToGcRoot();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 根据 hashcode 来进行重复判断
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终的输出结果：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/b45c5defd370ac4a9c6a13e5c4fc4306.png" alt=""></p>
<p>我们用 Studio 打开 hprof 文件对比一下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/f91a5827ef12ee7e9cc20c0f18112032.png" alt=""></p>
<p>可以看到信息是一摸一样的。对于更优处理引用链的信息，可以参看<a href="./leakcanary.md">LeakCanary</a>源码的实现。</p>
<p>我已经将上面的代码打成 JAR 包，可以直接调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">调用方法：</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">tools</span><span class="o">/</span><span class="n">DuplicatedBitmapAnalyzer</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="n">jar</span> <span class="n">hprof</span> <span class="err">文件路径</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>详细的代码我提交到了<a href="./Chapter04.md">Github</a>，供大家参考。</p>
<p><a href="./Chapter05.md"><strong>Chapter05</strong></a></p>
<blockquote>
<p>尝试模仿<a href="./ProcessCpuTracker.java.md">ProcessCpuTracker.java</a>拿到一段时间内各个线程的耗时占比。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">usage: CPU usage 5000ms(from 23:23:33.000 to 23:23:38.000):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> System TOTAL: 2.1% user + 16% kernel + 9.2% iowait + 0.2% irq + 0.1% softirq + 72% idle
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> CPU Core: 8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Load Average: 8.74 / 7.74 / 7.36
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Process:com.sample.app 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   50% 23468/com.sample.app(S): 11% user + 38% kernel faults:4965
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Threads:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   43% 23493/singleThread(R): 6.5% user + 36% kernel faults：3094
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   3.2% 23485/RenderThread(S): 2.1% user + 1% kernel faults：329
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   0.3% 23468/.sample.app(S): 0.3% user + 0% kernel faults：6
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   0.3% 23479/HeapTaskDaemon(S): 0.3% user + 0% kernel faults：982
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为了解 Linux 不多，所以看这个有点懵逼。好在课代表孙鹏飞同学解答了相关问题，看懂了上面信息，同时学习到了一些 Linux 知识。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">private void testIO() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Thread thread = new Thread(new Runnable() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            @Override
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            public void run() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                File f = new File(getFilesDir(), &#34;aee.txt&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				FileOutputStream fos = new FileOutputStream(f);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				byte[] data = new byte[1024 * 4 * 3000];// 此处分配一个 12mb 大小的 byte 数组
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					for (int i = 0; i &lt; 30; i++) {// 由于 IO cache 机制的原因所以此处写入多次 cache，触发 dirty writeback 到磁盘中
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    				Arrays.fill(data, (byte) i);// 当执行到此处的时候产生 minor fault，并且产生 User cpu useage
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    				fos.write(data);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				fos.flush();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				fos.close();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        });
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        thread.setName(&#34;SingleThread&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        thread.start();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述代码就是导致的问题罪魁祸首，这种密集 I/O 操作集中在 SingleThread 线程中处理，导致发生了 3094 次 faults、36% kernel，完全没有很好利用到 8 核 CPU。</p>
<p>最后，通过检测 CPU 的使用率，可以更好地避免卡顿现象，防止 ANR 的发生。</p>
<p>前前后后用了两三天的时间，远远没有当初想的顺利，感觉身体被掏空。中间也爬了不少坑，虽然没有太深入实现代码，但是中间的体验过程也是收获不小。所以总不能因为难就放弃了，先做到力所能及的部分，让自己动起来！</p>
<p><strong>参考</strong></p>
<ul>
<li><a href="./73068.md">练习 Sample 跑起来 | 热点问题答疑第 1 期</a></li>
<li><a href="./75440.md">练习 Sample 跑起来 | 热点问题答疑第 2 期</a></li>
</ul>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/0e5461ae1393aa633b672fbee779c7e1.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/">Android开发高手课</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/%E7%BB%83%E4%B9%A0sample%E8%B7%91%E8%B5%B7%E6%9D%A5__%E7%83%AD%E7%82%B9%E9%97%AE%E9%A2%98%E7%AD%94%E7%96%91%E7%AC%AC4%E6%9C%9F/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">练习Sample跑起来__热点问题答疑第4期</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/android%E5%BC%80%E5%8F%91%E9%AB%98%E6%89%8B%E8%AF%BE/%E7%BB%83%E4%B9%A0sample%E8%B7%91%E8%B5%B7%E6%9D%A5__%E5%94%AF%E9%B9%BF%E5%90%8C%E5%AD%A6%E7%9A%84%E7%BB%83%E4%B9%A0%E6%89%8B%E8%AE%B0_%E7%AC%AC2%E8%BE%91/">
            <span class="next-text nav-default">练习Sample跑起来__唯鹿同学的练习手记_第2辑</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
