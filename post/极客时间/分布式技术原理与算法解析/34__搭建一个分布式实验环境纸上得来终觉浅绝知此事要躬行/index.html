<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>34__搭建一个分布式实验环境：纸上得来终觉浅，绝知此事要躬行 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是聂鹏程。
上一讲，我以购买火车票为例，为你串讲了分布式技术的应用，帮助你理解所学分布式技术可以应用到哪些业务中。其实，到目前为止，我们主要是从理论上学习相关的分布式技术。但，“纸上得来终觉浅，绝知此事要躬行”。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90/34__%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E7%BA%B8%E4%B8%8A%E5%BE%97%E6%9D%A5%E7%BB%88%E8%A7%89%E6%B5%85%E7%BB%9D%E7%9F%A5%E6%AD%A4%E4%BA%8B%E8%A6%81%E8%BA%AC%E8%A1%8C/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90/34__%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E7%BA%B8%E4%B8%8A%E5%BE%97%E6%9D%A5%E7%BB%88%E8%A7%89%E6%B5%85%E7%BB%9D%E7%9F%A5%E6%AD%A4%E4%BA%8B%E8%A6%81%E8%BA%AC%E8%A1%8C/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="34__搭建一个分布式实验环境：纸上得来终觉浅，绝知此事要躬行">
  <meta property="og:description" content="你好，我是聂鹏程。
上一讲，我以购买火车票为例，为你串讲了分布式技术的应用，帮助你理解所学分布式技术可以应用到哪些业务中。其实，到目前为止，我们主要是从理论上学习相关的分布式技术。但，“纸上得来终觉浅，绝知此事要躬行”。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="分布式技术原理与算法解析">

  <meta itemprop="name" content="34__搭建一个分布式实验环境：纸上得来终觉浅，绝知此事要躬行">
  <meta itemprop="description" content="你好，我是聂鹏程。
上一讲，我以购买火车票为例，为你串讲了分布式技术的应用，帮助你理解所学分布式技术可以应用到哪些业务中。其实，到目前为止，我们主要是从理论上学习相关的分布式技术。但，“纸上得来终觉浅，绝知此事要躬行”。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="5491">
  <meta itemprop="keywords" content="分布式技术原理与算法解析">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="34__搭建一个分布式实验环境：纸上得来终觉浅，绝知此事要躬行">
  <meta name="twitter:description" content="你好，我是聂鹏程。
上一讲，我以购买火车票为例，为你串讲了分布式技术的应用，帮助你理解所学分布式技术可以应用到哪些业务中。其实，到目前为止，我们主要是从理论上学习相关的分布式技术。但，“纸上得来终觉浅，绝知此事要躬行”。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">34__搭建一个分布式实验环境：纸上得来终觉浅，绝知此事要躬行</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 5491 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#搭建目标">搭建目标</a></li>
        <li><a href="#搭建前的准备">搭建前的准备</a></li>
        <li><a href="#kubernetes-集群搭建">Kubernetes 集群搭建</a>
          <ul>
            <li><a href="#1-安装-docker">1. 安装 Docker</a></li>
            <li><a href="#2-安装部署-kubeadmkubeletkubectl">2. 安装部署 kubeadm、kubelet、kubectl</a></li>
            <li><a href="#3-部署-master-节点">3. 部署 Master 节点</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#可以拉取的相对应的组件和版本">可以拉取的相对应的组件和版本</a></li>
    <li><a href="#通过打-tag-的方式修改为所需要的镜像">通过打 tag 的方式修改为所需要的镜像</a>
      <ul>
        <li>
          <ul>
            <li><a href="#4-部署-worker-节点">4. 部署 Worker 节点</a></li>
            <li><a href="#5-安装网络插件">5. 安装网络插件</a></li>
            <li><a href="#6-验证">6. 验证</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#name-----------status---roles----age---version">NAME           STATUS   ROLES    AGE   VERSION</a></li>
    <li><a href="#vm1-pc---ready----master---11h---v1163">vm1-pc   Ready    master   11h   v1.16.3</a></li>
    <li><a href="#vm2-pc---ready----none---11h---v1163">vm2-pc   Ready    <none>   11h   v1.16.3</a></li>
    <li><a href="#vm3-pc---ready----none---24m---v1163">vm3-pc   Ready    <none>   24m   v1.16.3</a></li>
    <li><a href="#namespace-----name-----------------------------------ready---status----restarts---age">NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE</a></li>
    <li><a href="#kube-system---coredns-5644d7b6d9-9dprc---------------11-----running---0----------11h">kube-system   coredns-5644d7b6d9-9dprc               1/1     Running   0          11h</a></li>
    <li><a href="#kube-system---coredns-5644d7b6d9-ljv5w---------------11-----running---0----------11h">kube-system   coredns-5644d7b6d9-ljv5w               1/1     Running   0          11h</a></li>
    <li><a href="#kube-system---etcd-vm1-pc----------------------11-----running---0----------11h">kube-system   etcd-vm1-pc                      1/1     Running   0          11h</a></li>
    <li><a href="#kube-system---kube-apiserver-vm1-pc------------11-----running---0----------11h">kube-system   kube-apiserver-vm1-pc            1/1     Running   0          11h</a></li>
    <li><a href="#kube-system---kube-controller-manager-vm1-pc---11-----running---0----------11h">kube-system   kube-controller-manager-vm1-pc   1/1     Running   0          11h</a></li>
    <li><a href="#kube-system---kube-proxy-qpvtb-----------------------11-----running---0----------25m">kube-system   kube-proxy-qpvtb                       1/1     Running   0          25m</a></li>
    <li><a href="#kube-system---kube-proxy-v2xnb-----------------------11-----running---0----------11h">kube-system   kube-proxy-v2xnb                       1/1     Running   0          11h</a></li>
    <li><a href="#kube-system---kube-proxy-wkxzg-----------------------11-----running---0----------11h">kube-system   kube-proxy-wkxzg                       1/1     Running   0          11h</a></li>
    <li><a href="#kube-system---kube-scheduler-vm1-pc------------11-----running---0----------11h">kube-system   kube-scheduler-vm1-pc            1/1     Running   0          11h</a></li>
    <li><a href="#kube-system---weave-net-6nj4c------------------------22-----running---0----------25m">kube-system   weave-net-6nj4c                        2/2     Running   0          25m</a></li>
    <li><a href="#kube-system---weave-net-lm6dh------------------------22-----running---0----------37m">kube-system   weave-net-lm6dh                        2/2     Running   0          37m</a></li>
    <li><a href="#kube-system---weave-net-vwnc2------------------------22-----running---0----------37m">kube-system   weave-net-vwnc2                        2/2     Running   0          37m</a>
      <ul>
        <li>
          <ul>
            <li><a href="#7-可能遇到的问题">7. 可能遇到的问题</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#检查所有-pod-是否正常">检查所有 pod 是否正常</a></li>
    <li><a href="#如果-pod-处于非-running-状态则查看该-pod">如果 pod 处于非 running 状态，则查看该 pod：</a>
      <ul>
        <li><a href="#nginx-服务部署">Nginx 服务部署</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是聂鹏程。</p>
<p>上一讲，我以购买火车票为例，为你串讲了分布式技术的应用，帮助你理解所学分布式技术可以应用到哪些业务中。其实，到目前为止，我们主要是从理论上学习相关的分布式技术。但，“纸上得来终觉浅，绝知此事要躬行”。</p>
<p>今天，我就以 Kubernetes 为例，和你一起搭建一个分布式实验环境。我先简单和你说下这篇文章的内容分配：</p>
<ol>
<li>不会特别详细地讲述搭建过程，而是着重说明搭建的主要步骤以及可能遇到的问题；</li>
<li>在讲述搭建过程时，串联一下其中涉及的分布式相关知识；</li>
<li>搭建完 Kubernetes 集群之后，我会以部署 Nginx 服务为例，帮助你更直观地体验分布式技术，以巩固、加深对分布式技术的理解。</li>
</ol>
<p>话不多说，接下来，我们就一起搭建这个分布式实验环境吧。</p>
<h2 id="搭建目标">搭建目标</h2>
<p>Kubernetes 是 Google 开源的容器集群管理系统，是 Borg 的开源版本。我在第 9 篇文章中讲解集中式架构时，和你分析过 Kubernetes 集群属于主从架构的分布式集群。</p>
<p>Kubernetes 集群主要由 Master 节点和 Worker 节点组成。Master 节点就是中心服务器，负责对集群进行调度管理；Worker 节点是真正的工作节点，负责运行业务应用的容器。而容器是一种虚拟化技术，通过限制自身使用的资源来实现资源隔离，可以为应用提供一整套运行环境，从而实现了服务运行环境的隔离，进而实现了故障隔离。你可以回顾下第 30 篇文章中，资源隔离的相关内容。</p>
<p>接下来，我们明确下这次搭建分布式实验室环境的目标：</p>
<ol>
<li>搭建一个 Kubernetes 集群，包括一个 Master 节点，两个 Worker 节点 ;</li>
<li>在 Kubernetes 集群上创建一个 Nginx 服务。</li>
</ol>
<h2 id="搭建前的准备">搭建前的准备</h2>
<p>今天我们要搭建的 Kubernetes 集群，以 3 台服务器为例，一台作为 Master 节点，两台作为 Worker 节点。服务器应具备的条件如下：</p>
<ol>
<li>Ubuntu 16.04 操作系统；</li>
<li>2GB 或以上的内存；</li>
<li>2 核 CPU 或以上；</li>
<li>服务器间网络连通；</li>
<li>每台服务器具有唯一的主机名、MAC 地址和 product_uuid；</li>
<li>通过执行命令 swapoff -a 来关闭 Swap；</li>
<li>30GB 及以上的磁盘空间；</li>
<li>具备外网访问权限，以方便获取相关镜像。</li>
</ol>
<p>在这次部署中，我采用的机器配置如下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90/473015886db7f70fc53d5738379136a3.png" alt=""></p>
<p>准备工作完成后，我们就开始搭建集群吧。</p>
<h2 id="kubernetes-集群搭建">Kubernetes 集群搭建</h2>
<p>搭建 Kubernetes 集群的步骤，主要包括安装 Docker，安装部署 kubeadm、kubelet、kubectl，部署 Master 节点，部署 Worker 节点，安装网络插件这几步。</p>
<p>其中，安装 Docker、部署 Master 节点和 Worker 节点涉及分布式的，需要在多个节点上部署，比如 Docker 节点需要在每个 Worker 节点部署，Master 节点若为集群模式，需要在多个节点上配置主备，Worker 节点需要与 Master 节点建立连接等。</p>
<p>接下来，我们具体看看如何一步一步搭建出 Kubernetes 集群吧。</p>
<h3 id="1-安装-docker">1. 安装 Docker</h3>
<p>Kubernetes 是一个容器集群管理系统，因此每个 Worker 节点会运行容器，以实现业务运行环境隔离。我们在每台服务器上采用如下命令安装 Docker：</p>
<p>apt-get install -y docker.io</p>
<h3 id="2-安装部署-kubeadmkubeletkubectl">2. 安装部署 kubeadm、kubelet、kubectl</h3>
<p>kubeadm 是 Kubernetes 社区提供的一个部署工具，该工具将 kubelet 组件之外的其他组件均采用容器部署，实现了自动化，避免了手动部署容器的麻烦，简化了部署操作。</p>
<p>其中，Master 节点包括 API Server、Scheduler、Cluster State Store(默认 etcd) 和 Control Manager Srever 核心组件；Worker 节点包括 kubelet 和 kube-proxy 核心组件。具体的组件功能和原理，你可以再回顾下第 9 篇文章中的相关内容。</p>
<p>kubelet 组件本身是一个管控容器的组件，需要执行配置容器网络等操作，这些操作需要在宿主机上执行，不采用容器部署。因此，kubelet 组件需要单独部署，而不能用 kubeadm 进行部署。</p>
<p>除此之外，我们还需要安装一下 kubectl 组件。这个组件是 Kubernetes 的命令行工具，通过 kubectl 可以部署和管理应用，查看资源，创建、删除和更新组件。</p>
<p>那么，如何部署 kubeadm、kubelet 和 kubectl 这三个组件呢？</p>
<p>apt 是 Linux 下常用的安装管理工具，这里我就采用 apt 来安装这三个组件。</p>
<p>首先，我们需要添加 Kubernetes 源。</p>
<ol>
<li>你可以通过执行以下语句获取 Kubernetes 源（需要外网权限）：</li>
</ol>
<p>sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https curl<br>
curl -s <a href="https://packages.cloud.google.com/apt/doc/apt-key.gpg">https://packages.cloud.google.com/apt/doc/apt-key.gpg</a> | sudo apt-key add -<br>
cat &laquo;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list<br>
deb <a href="https://apt.kubernetes.io/">https://apt.kubernetes.io/</a> kubernetes-xenial main<br>
EOF</p>
<p>然后使用以下命令更新源：</p>
<p>sudo apt-get update</p>
<ol>
<li>这时，我们就可以使用如下命令来安装 kubelet、kubectl 和 kubeadm 了：</li>
</ol>
<p>sudo apt-get install -y kubelet kubeadm kubectl</p>
<ol>
<li>如果没有外网访问权限，在添加 kubernetes 源的时候可以执行以下命令来添加阿里云的 Kubernetes 源：</li>
</ol>
<p>cat &laquo;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list<br>
deb <a href="https://mirrors.aliyun.com/kubernetes/apt">https://mirrors.aliyun.com/kubernetes/apt</a> kubernetes-xenial main<br>
EOF</p>
<p>同样的，使用以下命令来更新源：</p>
<p>apt-get update # 忽略 gpg 的报错信息</p>
<p>最后，使用如下命令安装 kubelet、kubectl 和 kubeadm：</p>
<p>apt-get install -y kubelet kubeadm kubectl &ndash;allow-unauthenticated</p>
<p>安装好这三个组件之后，我们就可以使用 kubeadm 来一键部署集群节点了。</p>
<p>首先，我们来部署 Master 节点。</p>
<h3 id="3-部署-master-节点">3. 部署 Master 节点</h3>
<p>这一步其实就是容器化启动 Master 节点中的各个组件，直接使用 kubeadm 工具提供的一条命令 kubeadm init 即可自动安装。</p>
<p>kubeadm init 这条命令底层其实就是将 Master 的各个组件，比如 API Server、etcd 等，以 Pod 形式（容器集合）运行起来。</p>
<p>当然了，你可以部署多个 Master 节点来实现集群的高可用，比如两个 Master 节点互为主备（你可以回顾下第 31 篇文章中介绍的主备机制）。具体的部署方法，你可以参考这篇文章。</p>
<p>除此之外，etcd 组件也可以采用集群方式部署，从而保证了数据不会丢失。etcd 采用的是 Raft 强一致性协议，相关技术你可以再回顾下第 4 篇文章中的相关问题。</p>
<p><strong>在本次部署中我以一个 Master 节点为例为你讲解集群的搭建</strong>，关于 Master 为集群的方式，各节点上 kubernetes 配置类似，你可以参考 Kubernetes 官网。</p>
<p>在这里，我把 192.168.124.49 这台机器作为 Master 节点。在该机器上直接执行 kubeadm init，即可完成部署：</p>
<p>kubeadm init</p>
<p>如果有外网访问权限，基本就可以部署成功了。那么，我们可以根据如下信息判断自己是否部署成功：</p>
<p>Your Kubernetes control-plane has initialized successfully!</p>
<p>To start using your cluster, you need to run the following as a regular user:</p>
<p>mkdir -p $HOME/.kube<br>
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>
sudo chown $(id -u):$(id -g) $HOME/.kube/config</p>
<p>You should now deploy a pod network to the cluster.<br>
Run &ldquo;kubectl apply -f [podnetwork].yaml&rdquo; with one of the options listed at:<br>
<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/">https://kubernetes.io/docs/concepts/cluster-administration/addons/</a></p>
<p>Then you can join any number of worker nodes by running the following on each as root:</p>
<p>kubeadm join 192.168.124.49:6443 &ndash;token uv17vd.q3ber8i5knxg4h0x \<br>
&ndash;discovery-token-ca-cert-hash sha256:c55bd70d346d809e1079565cc1fc1a05f001671cc9f2d02c55bbbc4a00bcc2a3</p>
<p>可以看到，想要使用集群，需要执行以下命令，执行结束后才可以使用 kubectl。</p>
<p>mkdir -p $HOME/.kube<br>
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>
chown $(id -u):$(id -g) $HOME/.kube/config</p>
<p>如果没有外网访问权限，会报 pull image xxxxxx 的错误。</p>
<p>此时不要慌，从报错信息中，我们可以看到哪些镜像拉取不成功。我们可以手动在 Docker Hub 上寻找相对应的组件及版本，进行拉取，然后再通过 Docker 打 tag，修改为需要的镜像。</p>
<p>比如，以 [ERROR ImagePull]: failed to pull image k8s.gcr.io/kube-apiserver:v1.16.3 为例，可以通过以下代码进行拉取。</p>
<h1 id="可以拉取的相对应的组件和版本">可以拉取的相对应的组件和版本</h1>
<p>docker pull aiotceo/kube-apiserver:v1.16.3</p>
<h1 id="通过打-tag-的方式修改为所需要的镜像">通过打 tag 的方式修改为所需要的镜像</h1>
<p>docker tag aiotceo/kube-apiserver:v1.16.3 k8s.gcr.io/kube-apiserver:v1.16.3</p>
<p>然后重新执行 kubeadm init 即可。</p>
<p>从以上操作也可以看出，<strong>kubeadm 的底层其实就是将容器化组件的操作实现了自动化，省去了手动部署的麻烦</strong>。</p>
<p>部署完 Master 节点后，我们来继续部署 Worker 节点。</p>
<h3 id="4-部署-worker-节点">4. 部署 Worker 节点</h3>
<p>部署 Worker 节点与部署 Master 节点类似，都可以通过命令一键部署。这里，我们使用 kubeadm 提供的 kubeadm join 命令来进行自动化部署。</p>
<p>kubeadm join 命令的底层与 kubeadm init 类似，会自动以 Pod 形式运行 Worker 节点中需要的组件。不同的是，命令执行后，底层还需要将 Worker 节点加入到 Kubernetes 集群中。</p>
<p>执行 kubeadm join 命令后（具体命令如下所示），就可以看到 Kubernetes 集群中的节点信息了。这条命令中需要配置 Master 节点的 IP 和 Port 信息，目的是 Worker 节点根据 IP 和 Port 信息建立连接，并在建立连接的基础上，建立心跳机制。</p>
<p>具体的心跳机制，你可以参考第 31 篇文章中关于故障恢复的内容。</p>
<p>到目前为止，Kubernetes 的集群已经完成大半了，下面我们继续部署集群。</p>
<p>根据 Master 节点部署成功后输出结果的最后几行可以知道，想要加入集群，可以执行 kubeadm join 命令。我在另外 2 台机器上都执行了如下命令：</p>
<p>kubeadm join 192.168.124.49:6443 &ndash;token uv17vd.q3ber8i5knxg4h0x \<br>
&ndash;discovery-token-ca-cert-hash sha256:c55bd70d346d809e1079565cc1fc1a05f001671cc9f2d02c55bbbc4a00bcc2a3</p>
<p>这条命令执行后，一个集中式架构的雏形就搭建完成了。接下来，我们需要安装相应的网络插件，以实现 Kubernetes 集群中 Pod 之间的通信。</p>
<h3 id="5-安装网络插件">5. 安装网络插件</h3>
<p>网络插件有很多，比如 Canal、Flannel、Weave 等。不同的插件命令不一致，具体命令可参考官网。</p>
<p>这里，我以安装 Weave 插件为例，通过执行以下命令完成安装：</p>
<p>sysctl net.bridge.bridge-nf-call-iptables=1</p>
<p>kubectl apply -f &ldquo;<a href="https://cloud.weave.works/k8s/net?k8s-version=$(kubectl">https://cloud.weave.works/k8s/net?k8s-version=$(kubectl</a> version | base64 | tr -d &lsquo;\n&rsquo;)&rdquo;</p>
<h3 id="6-验证">6. 验证</h3>
<p>到这里，集群就部署完成了，是不是很简单呢？接下来，我就通过获取节点和 Pod 信息来验证一下集群部署是否成功。</p>
<p>可以通过刚刚安装的 kubectl 组件提供的命令查看集群的相关信息。比如，查看节点的运行状态可以通过 kubectl get nodes 来获得，查看各个组件对应的 Pod 运行状态可以通过 kubectl get pods 来获得。命令执行结果，如下所示：</p>
<p>kubectl get nodes</p>
<h1 id="name-----------status---roles----age---version">NAME           STATUS   ROLES    AGE   VERSION</h1>
<h1 id="vm1-pc---ready----master---11h---v1163">vm1-pc   Ready    master   11h   v1.16.3</h1>
<h1 id="vm2-pc---ready----none---11h---v1163">vm2-pc   Ready    <none>   11h   v1.16.3</h1>
<h1 id="vm3-pc---ready----none---24m---v1163">vm3-pc   Ready    <none>   24m   v1.16.3</h1>
<p>kubectl get pods &ndash;all-namespaces</p>
<h1 id="namespace-----name-----------------------------------ready---status----restarts---age">NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE</h1>
<h1 id="kube-system---coredns-5644d7b6d9-9dprc---------------11-----running---0----------11h">kube-system   coredns-5644d7b6d9-9dprc               1/1     Running   0          11h</h1>
<h1 id="kube-system---coredns-5644d7b6d9-ljv5w---------------11-----running---0----------11h">kube-system   coredns-5644d7b6d9-ljv5w               1/1     Running   0          11h</h1>
<h1 id="kube-system---etcd-vm1-pc----------------------11-----running---0----------11h">kube-system   etcd-vm1-pc                      1/1     Running   0          11h</h1>
<h1 id="kube-system---kube-apiserver-vm1-pc------------11-----running---0----------11h">kube-system   kube-apiserver-vm1-pc            1/1     Running   0          11h</h1>
<h1 id="kube-system---kube-controller-manager-vm1-pc---11-----running---0----------11h">kube-system   kube-controller-manager-vm1-pc   1/1     Running   0          11h</h1>
<h1 id="kube-system---kube-proxy-qpvtb-----------------------11-----running---0----------25m">kube-system   kube-proxy-qpvtb                       1/1     Running   0          25m</h1>
<h1 id="kube-system---kube-proxy-v2xnb-----------------------11-----running---0----------11h">kube-system   kube-proxy-v2xnb                       1/1     Running   0          11h</h1>
<h1 id="kube-system---kube-proxy-wkxzg-----------------------11-----running---0----------11h">kube-system   kube-proxy-wkxzg                       1/1     Running   0          11h</h1>
<h1 id="kube-system---kube-scheduler-vm1-pc------------11-----running---0----------11h">kube-system   kube-scheduler-vm1-pc            1/1     Running   0          11h</h1>
<h1 id="kube-system---weave-net-6nj4c------------------------22-----running---0----------25m">kube-system   weave-net-6nj4c                        2/2     Running   0          25m</h1>
<h1 id="kube-system---weave-net-lm6dh------------------------22-----running---0----------37m">kube-system   weave-net-lm6dh                        2/2     Running   0          37m</h1>
<h1 id="kube-system---weave-net-vwnc2------------------------22-----running---0----------37m">kube-system   weave-net-vwnc2                        2/2     Running   0          37m</h1>
<p>可以看到，节点全部是 Ready 状态，各个组件对应的 Pod 也处于 Running 状态，表明部署成功。</p>
<h3 id="7-可能遇到的问题">7. 可能遇到的问题</h3>
<p>如果整个安装失败的话，可以重置，重新安装，即重新 kubeadm init</p>
<p>kubeadm reset</p>
<p>部署 Worker 节点时，pod 部署不成功。原因可能是因为没有外网访问权限，镜像拉取不下来，可以通过以下命令查看 pod 的相关信息：</p>
<h1 id="检查所有-pod-是否正常">检查所有 pod 是否正常</h1>
<p>kubectl get pod &ndash;all-namespaces -o wide</p>
<h1 id="如果-pod-处于非-running-状态则查看该-pod">如果 pod 处于非 running 状态，则查看该 pod：</h1>
<p>kubectl describe pod xxxxx -n kube-system</p>
<p>从错误信息里可以查看到是哪个镜像拉取不下来，与部署 Master 节点时采用的方式一样，到 Docker Hub 上手动拉取镜像，并设置 Tag 即可。</p>
<p>至此，Kubernetes 集群就配置成功了。</p>
<p>集群环境搭建后，如何验证集群是可用的呢？或者说，如何在集群上运行服务呢？接下来，我就以 Nginx 服务为例，带你了解如何在 Kubernetes 集群上进行服务部署。当然，你可以参考这个例子，在 Kubernetes 集群上部署其他服务。</p>
<h2 id="nginx-服务部署">Nginx 服务部署</h2>
<p>Kubernetes 推荐使用 YAML 配置文件的方式来创建服务，所以我接下来会使用这种方式部署完成 Nginx 服务的部署。</p>
<p>部署 Nginx 服务这个 Demo 时，我会创建两个 Kubernetes 对象（Kubernetes 对象是 Kubernetes 系统中的持久实体，用于表示集群的状态），一个是 Deployment，一个是 Service：</p>
<ol>
<li>Deployment 对象规定 Pod 创建的相关信息，比如期望创建几个 Pod，每个 Pod 应该部署什么应用等。</li>
<li>Service 对象用来给用户访问提供接口。它可以通过 Label Selector（标签选择器）来指定可以访问的 Pod 有哪些。关于 Kubernetes 对象的相关内容，你可以参考这篇文章。</li>
</ol>
<p>因为 Pod 是 Kubernetes 中最小的工作单元，所以 Nginx 服务都部署在 Pod 中。下面，我就来创建一个 Deployment 对象来创建我们期望的 Pod 状态。</p>
<p>首先，创建一个 YAML 配置文件，我将其命名为 nginx-deployment.yaml。为将用户请求负载均衡到不同的 Pod，减轻单个 Pod 的访问压力，这里我会创建三个 Pod 共同运行 Nginx 服务。</p>
<p>文件内容如下：</p>
<p>apiVersion: apps/v1<br>
kind: Deployment<br>
metadata:<br>
name: nginx-deployment<br>
labels:<br>
app: nginx<br>
spec:<br>
replicas: 3<br>
selector:<br>
matchLabels:<br>
app: nginx<br>
template:<br>
metadata:<br>
labels:<br>
app: nginx<br>
spec:<br>
containers:<br>
- name: nginx<br>
image: nginx:latest<br>
ports:<br>
- containerPort: 80</p>
<p>文件中，replicas 字段就是副本数量，也就是 Pod 数量，设置为 3，即创建三个 Pod 来运行 Nginx 服务；template 字段规定了单个 Pod 中运行哪些容器，这里运行的是名称为 nginx 的容器。</p>
<ol>
<li>创建完配置文件后，通过以下命令就可以将 Deployment 对象创建成功。</li>
</ol>
<p>kubectl apply -f nginx-deployment.yaml</p>
<p>执行后，就等待对象的创建，可以通过以下命令来查看创建是否成功。</p>
<p>kubectl get deployment</p>
<p>以下是我创建成功后的输出：</p>
<p>NAME               READY   UP-TO-DATE   AVAILABLE   AGE<br>
nginx-deployment   3/3     3            3           3m17s</p>
<p>同时，你也可以通过以下命令来查看创建的 Pod 的信息：</p>
<p>kubectl get pod</p>
<p>以下是我的输出结果：</p>
<p>NAME                               READY   STATUS    RESTARTS   AGE<br>
nginx-deployment-59c9f8dff-dtg4w   1/1     Running   0          3m15s<br>
nginx-deployment-59c9f8dff-f2hmv   1/1     Running   0          3m15s<br>
nginx-deployment-59c9f8dff-lsvdh   1/1     Running   0          3m15s</p>
<p>创建完 deployment 之后，我们来创建 Service 服务。同样是通过配置文件来创建，文件名是 nginx-service.yaml，内容如下：</p>
<p>apiVersion: v1<br>
kind: Service<br>
metadata:<br>
name: nginx-service<br>
labels:<br>
app: nginx<br>
spec:<br>
ports:</p>
<ul>
<li>port: 88<br>
targetPort: 80<br>
selector:<br>
app: nginx<br>
type: NodePort</li>
</ul>
<p>文件中 port 属性就是 service 对外提供的端口。</p>
<p>同样的，采用 kubectl apply 命令创建 Nginx 服务：</p>
<p>kubectl apply -f nginx-service.yaml</p>
<p>执行完成后，可以通过以下命令来查看创建是否成功：</p>
<p>kubectl get service</p>
<p>以下是我的输出结果：</p>
<p>NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE<br>
kubernetes      ClusterIP   10.96.0.1        <none>        443/TCP          12h<br>
nginx-service   NodePort    10.101.29.9      <none>        88:30755/TCP     5m12s</p>
<p>现在我们就可以通过访问 Nginx 服务来查看它是否部署成功了。访问该服务可以通过以下命令：</p>
<p>curl 10.101.29.9:88</p>
<p>结果如下，表明 Nginx 服务部署成功。</p>
<!DOCTYPE html>  
<html>  
<head>  
<title>Welcome to nginx!</title>  
<style>  
    body {  
        width: 35em;  
        margin: 0 auto;  
        font-family: Tahoma, Verdana, Arial, sans-serif;  
    }  
</style>  
</head>  
<body>  
<h1>Welcome to nginx!</h1>  
<p>If you see this page, the nginx web server is successfully installed and  
working. Further configuration is required.</p>  
<p>For online documentation and support please refer to  
<a href="http://nginx.org/">nginx.org</a>.<br/>  
Commercial support is available at  
<a href="http://nginx.com/">nginx.com</a>.</p>  
<p><em>Thank you for using nginx.</em></p>  
</body>  
</html>
<p>在这个过程中，有两个步骤涉及负载均衡的相关知识：</p>
<ol>
<li>一个是创建 Deployment 时，该 Deployment 会创建三个 Pod，而 Pod 需要部署到某个 Worker 节点中，因此会将 Pod 均衡部署到各个 Worker 节点中；</li>
<li>另一个是用户访问，Nginx 服务后台三个运行的 Pod 都可以提供服务，用户访问到来时，可以均衡分布到各个 Pod 中进行处理。</li>
</ol>
<p>到这里，我们搭建的目标就完成了，下面为你留几个实验题，你可以尝试去搭建一下或运行一下，以进一步加深对分布式技术的理解。</p>
<ol>
<li>实验一：搭建高可用 Kubernetes 集群，也就是通过 etcd 实现 Master 节点以集群模式部署。具体搭建方法可参考https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/；</li>
<li>实验二：在 Kubenetes 上部署 Cassandra，其中 Cassandra 作为服务部署到容器中，以学习 Cassandra 集群的节点发现、集群组件等原理，具体搭建方法可参考https://kubernetes.io/docs/tutorials/stateful-application/cassandra/；</li>
<li>实验三：在 Kubenetes 集群上通过部署一个 MySQL 服务，体验在 Kubenetes 集群上如何运行一个单实例有状态应用。具体搭建方法可参考https://kubernetes.io/docs/tasks/run-application/run-single-instance-stateful-application/。</li>
</ol>
<p>好了，整个搭建环境，我就讲到这里。</p>
<p>其实，到这里，对分布式世界的探索可以说才刚开始，只有动手去实践，你学到的知识才能真正转换为你自己的。加油，赶紧行动起来吧。</p>
<h2 id="总结">总结</h2>
<p>今天，我主要带你学习了搭建分布式实验环境。</p>
<p>首先，我以 Kubernetes 为例，介绍了如何搭建 Kubernetes 集群环境，其中包括容器、Master 节点、Worker 节点等配置和安装。</p>
<p>然后，在搭建好的 Kubernetes 集群的基础上，我以 Nginx 服务为例，展示了如何在 Kubernetes 集群上部署服务。</p>
<p>其实，今天我演示的 Demo 只是冰山一角。在 Kubernetes 中，有很多非常实用的功能，比如 Kubernetes 可以让服务持续不断运行，当有 Pod 出现故障时，会自动重启另一个 Pod 来达到 Deployment 配置文件中规定的期望状态；还可以自动实现版本更迭等。</p>
<p>相信通过本讲的学习，你会对分布式技术有更进一步的认知。加油，赶紧行动起来，为你的服务搭建一个分布式实验环境吧。</p>
<p>我是聂鹏程，感谢你的收听，欢迎你在评论区给我留言分享你的观点，也欢迎你把这篇文章分享给更多的朋友一起阅读。我们下期再会！</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90/c191f391e2aab7575517a886bbd7a681.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90/">分布式技术原理与算法解析</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/go%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%8336%E8%AE%B2/34__%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E5%AD%97%E5%85%B8sync.map_%E4%B8%8A/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">34__并发安全字典sync.Map_（上）</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/mysql%E5%AE%9E%E6%88%9845%E8%AE%B2/34__%E5%88%B0%E5%BA%95%E5%8F%AF%E4%B8%8D%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8join/">
            <span class="next-text nav-default">34__到底可不可以使用join？</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
