<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>27__原型模式与享元模式：提升系统性能的利器 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是刘超。
原型模式和享元模式，前者是在创建多个实例时，对创建过程的性能进行调优；后者是用减少创建实例的方式，来调优系统性能。这么看，你会不会觉得两个模式有点相互矛盾呢？
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/java%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/27__%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F%E4%B8%8E%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E6%8F%90%E5%8D%87%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E7%9A%84%E5%88%A9%E5%99%A8/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/java%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/27__%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F%E4%B8%8E%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E6%8F%90%E5%8D%87%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E7%9A%84%E5%88%A9%E5%99%A8/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="27__原型模式与享元模式：提升系统性能的利器">
  <meta property="og:description" content="你好，我是刘超。
原型模式和享元模式，前者是在创建多个实例时，对创建过程的性能进行调优；后者是用减少创建实例的方式，来调优系统性能。这么看，你会不会觉得两个模式有点相互矛盾呢？">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="Java性能调优实战">

  <meta itemprop="name" content="27__原型模式与享元模式：提升系统性能的利器">
  <meta itemprop="description" content="你好，我是刘超。
原型模式和享元模式，前者是在创建多个实例时，对创建过程的性能进行调优；后者是用减少创建实例的方式，来调优系统性能。这么看，你会不会觉得两个模式有点相互矛盾呢？">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="3842">
  <meta itemprop="keywords" content="Java性能调优实战">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="27__原型模式与享元模式：提升系统性能的利器">
  <meta name="twitter:description" content="你好，我是刘超。
原型模式和享元模式，前者是在创建多个实例时，对创建过程的性能进行调优；后者是用减少创建实例的方式，来调优系统性能。这么看，你会不会觉得两个模式有点相互矛盾呢？">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">27__原型模式与享元模式：提升系统性能的利器</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 3842 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#原型模式">原型模式</a>
          <ul>
            <li><a href="#实现原型模式">实现原型模式</a></li>
            <li><a href="#深拷贝和浅拷贝">深拷贝和浅拷贝</a></li>
            <li><a href="#适用场景">适用场景</a></li>
          </ul>
        </li>
        <li><a href="#享元模式">享元模式</a>
          <ul>
            <li><a href="#实现享元模式">实现享元模式</a></li>
            <li><a href="#适用场景-1">适用场景</a></li>
          </ul>
        </li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#思考题">思考题</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是刘超。</p>
<p>原型模式和享元模式，前者是在创建多个实例时，对创建过程的性能进行调优；后者是用减少创建实例的方式，来调优系统性能。这么看，你会不会觉得两个模式有点相互矛盾呢？</p>
<p>其实不然，它们的使用是分场景的。在有些场景下，我们需要重复创建多个实例，例如在循环体中赋值一个对象，此时我们就可以采用原型模式来优化对象的创建过程；而在有些场景下，我们则可以避免重复创建多个实例，在内存中共享对象就好了。</p>
<p>今天我们就来看看这两种模式的适用场景，了解了这些你就可以更高效地使用它们提升系统性能了。</p>
<h2 id="原型模式">原型模式</h2>
<p>我们先来了解下原型模式的实现。原型模式是通过给出一个原型对象来指明所创建的对象的类型，然后使用自身实现的克隆接口来复制这个原型对象，该模式就是用这种方式来创建出更多同类型的对象。</p>
<p>使用这种方式创建新的对象的话，就无需再通过 new 实例化来创建对象了。这是因为 Object 类的 clone 方法是一个本地方法，它可以直接操作内存中的二进制流，所以性能相对 new 实例化来说，更佳。</p>
<h3 id="实现原型模式">实现原型模式</h3>
<p>我们现在通过一个简单的例子来实现一个原型模式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   // 实现 Cloneable 接口的原型抽象类 Prototype 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   class Prototype implements Cloneable {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 重写 clone 方法
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        public Prototype clone(){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            Prototype prototype = null;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            try{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                prototype = (Prototype)super.clone();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            }catch(CloneNotSupportedException e){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                e.printStackTrace();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return prototype;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 实现原型类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    class ConcretePrototype extends Prototype{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        public void show(){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            System.out.println(&#34; 原型模式实现类 &#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     public class Client {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        public static void main(String[] args){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            ConcretePrototype cp = new ConcretePrototype();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            for(int i=0; i&lt; 10; i++){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                ConcretePrototype clonecp = (ConcretePrototype)cp.clone();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                clonecp.show();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>要实现一个原型类，需要具备三个条件：</strong></p>
<ul>
<li>实现 Cloneable 接口：Cloneable 接口与序列化接口的作用类似，它只是告诉虚拟机可以安全地在实现了这个接口的类上使用 clone 方法。在 JVM 中，只有实现了 Cloneable 接口的类才可以被拷贝，否则会抛出 CloneNotSupportedException 异常。</li>
<li>重写 Object 类中的 clone 方法：在 Java 中，所有类的父类都是 Object 类，而 Object 类中有一个 clone 方法，作用是返回对象的一个拷贝。</li>
<li>在重写的 clone 方法中调用 super.clone()：默认情况下，类不具备复制对象的能力，需要调用 super.clone() 来实现。</li>
</ul>
<p>从上面我们可以看出，原型模式的主要特征就是使用 clone 方法复制一个对象。通常，有些人会误以为 Object a=new Object();Object b=a; 这种形式就是一种对象复制的过程，然而这种复制只是对象引用的复制，也就是 a 和 b 对象指向了同一个内存地址，如果 b 修改了，a 的值也就跟着被修改了。</p>
<p>我们可以通过一个简单的例子来看看普通的对象复制问题：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Student {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private String name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public String getName() {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public void setName(String name) {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        this.name= name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">public class Test {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          public static void main(String args[]) {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Student stu1 = new Student();  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        stu1.setName(&#34;test1&#34;);  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         Student stu2 = stu1;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        stu1.setName(&#34;test2&#34;);  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         System.out.println(&#34; 学生 1:&#34; + stu1.getName());  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        System.out.println(&#34; 学生 2:&#34; + stu2.getName());  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果是复制对象，此时打印的日志应该为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">学生 1:test1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">学生 2:test2
</span></span></code></pre></td></tr></table>
</div>
</div><p>然而，实际上是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">学生 2:test2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">学生 2:test2
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过 clone 方法复制的对象才是真正的对象复制，clone 方法赋值的对象完全是一个独立的对象。刚刚讲过了，Object 类的 clone 方法是一个本地方法，它直接操作内存中的二进制流，特别是复制大对象时，性能的差别非常明显。我们可以用 clone 方法再实现一遍以上例子。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 学生类实现 Cloneable 接口
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Student implements Cloneable{  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private String name;  // 姓名
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public String getName() {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public void setName(String name) {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        this.name= name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   // 重写 clone 方法
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   public Student clone() { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Student student = null; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        try { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            student = (Student) super.clone(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } catch (CloneNotSupportedException e) { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            e.printStackTrace(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return student; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">public class Test {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          public static void main(String args[]) {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Student stu1 = new Student();  // 创建学生 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        stu1.setName(&#34;test1&#34;);  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         Student stu2 = stu1.clone();  // 通过克隆创建学生 2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        stu2.setName(&#34;test2&#34;);  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         System.out.println(&#34; 学生 1:&#34; + stu1.getName());  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        System.out.println(&#34; 学生 2:&#34; + stu2.getName());  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">学生 1:test1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">学生 2:test2
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="深拷贝和浅拷贝">深拷贝和浅拷贝</h3>
<p>在调用 super.clone() 方法之后，首先会检查当前对象所属的类是否支持 clone，也就是看该类是否实现了 Cloneable 接口。</p>
<p>如果支持，则创建当前对象所属类的一个新对象，并对该对象进行初始化，使得新对象的成员变量的值与当前对象的成员变量的值一模一样，但对于其它对象的引用以及 List 等类型的成员属性，则只能复制这些对象的引用了。所以简单调用 super.clone() 这种克隆对象方式，就是一种浅拷贝。</p>
<p>所以，当我们在使用 clone() 方法实现对象的克隆时，就需要注意浅拷贝带来的问题。我们再通过一个例子来看看浅拷贝。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 定义学生类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Student implements Cloneable{  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private String name; // 学生姓名
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private Teacher teacher; // 定义老师类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public String getName() {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public void setName(String name) {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        this.name = name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     public Teacher getTeacher() {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return teacher;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public void setName(Teacher teacher) {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        this.teacher = teacher;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   // 重写克隆方法
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   public Student clone() { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Student student = null; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        try { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            student = (Student) super.clone(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } catch (CloneNotSupportedException e) { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            e.printStackTrace(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return student; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> // 定义老师类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Teacher implements Cloneable{  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private String name;  // 老师姓名
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public String getName() {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      public void setName(String name) {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        this.name= name;  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 重写克隆方法，堆老师类进行克隆
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   public Teacher clone() { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Teacher teacher= null; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        try { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            teacher= (Teacher) super.clone(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } catch (CloneNotSupportedException e) { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            e.printStackTrace(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return student; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">public class Test {  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          public static void main(String args[]) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Teacher teacher = new Teacher (); // 定义老师 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        teacher.setName(&#34; 刘老师 &#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Student stu1 = new Student();  // 定义学生 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        stu1.setName(&#34;test1&#34;);           
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        stu1.setTeacher(teacher);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                Student stu2 = stu1.clone(); // 定义学生 2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        stu2.setName(&#34;test2&#34;);  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        stu2.getTeacher().setName(&#34; 王老师 &#34;);// 修改老师
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        System.out.println(&#34; 学生 &#34; + stu1.getName + &#34; 的老师是:&#34; + stu1.getTeacher().getName);  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        System.out.println(&#34; 学生 &#34; + stu1.getName + &#34; 的老师是:&#34; + stu2.getTeacher().getName);  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">学生 test1 的老师是：王老师
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">学生 test2 的老师是：王老师
</span></span></code></pre></td></tr></table>
</div>
</div><p>观察以上运行结果，我们可以发现：在我们给学生 2 修改老师的时候，学生 1 的老师也跟着被修改了。这就是浅拷贝带来的问题。</p>
<p>我们可以通过深拷贝来解决这种问题，其实深拷贝就是基于浅拷贝来递归实现具体的每个对象，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   public Student clone() { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Student student = null; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        try { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            student = (Student) super.clone(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            Teacher teacher = this.teacher.clone();// 克隆 teacher 对象
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            student.setTeacher(teacher);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } catch (CloneNotSupportedException e) { 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            e.printStackTrace(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return student; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   } 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="适用场景">适用场景</h3>
<p>前面我详讲了原型模式的实现原理，那到底什么时候我们要用它呢？</p>
<p>在一些重复创建对象的场景下，我们就可以使用原型模式来提高对象的创建性能。例如，我在开头提到的，循环体内创建对象时，我们就可以考虑用 clone 的方式来实现。</p>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">for(int i=0; i&lt;list.size(); i++){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Student stu = new Student(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以优化为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Student stu = new Student(); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">for(int i=0; i&lt;list.size(); i++){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Student stu1 = (Student)stu.clone();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>除此之外，原型模式在开源框架中的应用也非常广泛。例如 Spring 中，@Service 默认都是单例的。用了私有全局变量，若不想影响下次注入或每次上下文获取 bean，就需要用到原型模式，我们可以通过以下注解来实现，@Scope(“prototype”)。</p>
<h2 id="享元模式">享元模式</h2>
<p>享元模式是运用共享技术有效地最大限度地复用细粒度对象的一种模式。该模式中，以对象的信息状态划分，可以分为内部数据和外部数据。内部数据是对象可以共享出来的信息，这些信息不会随着系统的运行而改变；外部数据则是在不同运行时被标记了不同的值。</p>
<p>享元模式一般可以分为三个角色，分别为 Flyweight（抽象享元类）、ConcreteFlyweight（具体享元类）和 FlyweightFactory（享元工厂类）。抽象享元类通常是一个接口或抽象类，向外界提供享元对象的内部数据或外部数据；具体享元类是指具体实现内部数据共享的类；享元工厂类则是主要用于创建和管理享元对象的工厂类。</p>
<h3 id="实现享元模式">实现享元模式</h3>
<p>我们还是通过一个简单的例子来实现一个享元模式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 抽象享元类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">interface Flyweight {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 对外状态对象
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    void operation(String name);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 对内对象
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    String getType();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 具体享元类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class ConcreteFlyweight implements Flyweight {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private String type;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     public ConcreteFlyweight(String type) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        this.type = type;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     @Override
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public void operation(String name) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        System.out.printf(&#34;[类型 (内在状态)] - [%s] - [名字 (外在状态)] - [%s]\n&#34;, type, name);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     @Override
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public String getType() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return type;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 享元工厂类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class FlyweightFactory {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private static final Map&lt;String, Flyweight&gt; FLYWEIGHT_MAP = new HashMap&lt;&gt;();// 享元池，用来存储享元对象
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     public static Flyweight getFlyweight(String type) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if (FLYWEIGHT_MAP.containsKey(type)) {// 如果在享元池中存在对象，则直接获取
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return FLYWEIGHT_MAP.get(type);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        } else {// 在响应池不存在，则新创建对象，并放入到享元池
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            ConcreteFlyweight flyweight = new ConcreteFlyweight(type);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            FLYWEIGHT_MAP.put(type, flyweight);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return flyweight;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">public class Client {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     public static void main(String[] args) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Flyweight fw0 = FlyweightFactory.getFlyweight(&#34;a&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Flyweight fw1 = FlyweightFactory.getFlyweight(&#34;b&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Flyweight fw2 = FlyweightFactory.getFlyweight(&#34;a&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Flyweight fw3 = FlyweightFactory.getFlyweight(&#34;b&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        fw1.operation(&#34;abc&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        System.out.printf(&#34;[结果 (对象对比)] - [%s]\n&#34;, fw0 == fw2);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        System.out.printf(&#34;[结果 (内在状态)] - [%s]\n&#34;, fw1.getType());
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[类型 (内在状态)] - [b] - [名字 (外在状态)] - [abc]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[结果 (对象对比)] - [true]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[结果 (内在状态)] - [b]
</span></span></code></pre></td></tr></table>
</div>
</div><p>观察以上代码运行结果，我们可以发现：如果对象已经存在于享元池中，则不会再创建该对象了，而是共用享元池中内部数据一致的对象。这样就减少了对象的创建，同时也节省了同样内部数据的对象所占用的内存空间。</p>
<h3 id="适用场景-1">适用场景</h3>
<p>享元模式在实际开发中的应用也非常广泛。例如 Java 的 String 字符串，在一些字符串常量中，会共享常量池中字符串对象，从而减少重复创建相同值对象，占用内存空间。代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> String s1 = &#34;hello&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> String s2 = &#34;hello&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> System.out.println(s1==s2);//true
</span></span></code></pre></td></tr></table>
</div>
</div><p>还有，在日常开发中的应用。例如，线程池就是享元模式的一种实现；将商品存储在应用服务的缓存中，那么每当用户获取商品信息时，则不需要每次都从 redis 缓存或者数据库中获取商品信息，并在内存中重复创建商品信息了。</p>
<h2 id="总结">总结</h2>
<p>通过以上讲解，相信你对原型模式和享元模式已经有了更清楚的了解了。两种模式无论是在开源框架，还是在实际开发中，应用都十分广泛。</p>
<p>在不得已需要重复创建大量同一对象时，我们可以使用原型模式，通过 clone 方法复制对象，这种方式比用 new 和序列化创建对象的效率要高；在创建对象时，如果我们可以共用对象的内部数据，那么通过享元模式共享相同的内部数据的对象，就可以减少对象的创建，实现系统调优。</p>
<h2 id="思考题">思考题</h2>
<p>上一讲的单例模式和这一讲的享元模式都是为了避免重复创建对象，你知道这两者的区别在哪儿吗？</p>
<p>期待在留言区看到你的答案。也欢迎你点击“请朋友读”，把今天的内容分享给身边的朋友，邀请他一起讨论。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/Java%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/b7c462671ae86891c7f8ac1941814e21.png" alt="unpreview"></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98/">Java性能调优实战</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E4%BA%92%E8%81%94%E7%BD%91%E4%BA%BA%E7%9A%84%E8%8B%B1%E8%AF%AD%E7%A7%81%E6%95%99%E8%AF%BE/27__%E8%A1%8C%E4%B8%9A%E9%A2%84%E6%B5%8B%E7%B1%BB%E6%96%87%E7%AB%A0%E5%8A%A8%E8%AF%8D%E5%B0%B1%E6%98%AF%E5%AE%83%E7%9A%84%E5%85%A8%E9%83%A8/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">27__行业预测类文章，动词就是它的全部</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/mysql%E5%AE%9E%E6%88%9845%E8%AE%B2/27__%E4%B8%BB%E5%BA%93%E5%87%BA%E9%97%AE%E9%A2%98%E4%BA%86%E4%BB%8E%E5%BA%93%E6%80%8E%E4%B9%88%E5%8A%9E/">
            <span class="next-text nav-default">27__主库出问题了，从库怎么办？</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
