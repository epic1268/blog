<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>26__Facebook怎样实现代码提交的原子性？ - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是葛俊。今天，我们继续来聊聊如何通过 Git 提高代码提交的原子性吧。
在上一篇文章中，我给你详细介绍了 Git 助力提高代码提交原子性的五条基础操作，今天我们再来看看 Facebook 的开发人员具体是如何使用这些操作来实现提交的原子性的。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/26__facebook%E6%80%8E%E6%A0%B7%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%8F%90%E4%BA%A4%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/26__facebook%E6%80%8E%E6%A0%B7%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%8F%90%E4%BA%A4%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="26__Facebook怎样实现代码提交的原子性？">
  <meta property="og:description" content="你好，我是葛俊。今天，我们继续来聊聊如何通过 Git 提高代码提交的原子性吧。
在上一篇文章中，我给你详细介绍了 Git 助力提高代码提交原子性的五条基础操作，今天我们再来看看 Facebook 的开发人员具体是如何使用这些操作来实现提交的原子性的。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="研发效率破局之道">

  <meta itemprop="name" content="26__Facebook怎样实现代码提交的原子性？">
  <meta itemprop="description" content="你好，我是葛俊。今天，我们继续来聊聊如何通过 Git 提高代码提交的原子性吧。
在上一篇文章中，我给你详细介绍了 Git 助力提高代码提交原子性的五条基础操作，今天我们再来看看 Facebook 的开发人员具体是如何使用这些操作来实现提交的原子性的。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="9916">
  <meta itemprop="keywords" content="研发效率破局之道">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="26__Facebook怎样实现代码提交的原子性？">
  <meta name="twitter:description" content="你好，我是葛俊。今天，我们继续来聊聊如何通过 Git 提高代码提交的原子性吧。
在上一篇文章中，我给你详细介绍了 Git 助力提高代码提交原子性的五条基础操作，今天我们再来看看 Facebook 的开发人员具体是如何使用这些操作来实现提交的原子性的。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">26__Facebook怎样实现代码提交的原子性？</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 9916 字 </span>
          <span class="more-meta"> 预计阅读 20 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#工作流一使用一个分支完成所有需求的开发">工作流一：使用一个分支完成所有需求的开发</a></li>
        <li><a href="#查看远程分支细节">查看远程分支细节</a></li>
        <li><a href="#查看分支跟踪的远程代码仓细节">查看分支跟踪的远程代码仓细节</a>
          <ul>
            <li><a href="#单分支工作流具体步骤">单分支工作流具体步骤</a></li>
            <li><a href="#阶段-1开始开发需求-a">阶段 1：开始开发需求 A</a></li>
          </ul>
        </li>
        <li><a href="#文件内容">文件内容</a></li>
        <li><a href="#this-project-is-for-demoing-git">This project is for demoing git</a></li>
        <li><a href="#产生提交">产生提交</a></li>
        <li><a href="#查看提交历史">查看提交历史</a></li>
        <li><a href="#查看提交细节">查看提交细节</a>
          <ul>
            <li><a href="#阶段-2开始开发需求-b">阶段 2：开始开发需求 B</a></li>
          </ul>
        </li>
        <li><a href="#用-vim-修改">用 VIM 修改</a></li>
        <li><a href="#查看工作区中的改动">查看工作区中的改动</a></li>
        <li><a href="#用命令行工具-httpie-验证结果">用命令行工具 httpie 验证结果</a></li>
        <li><a href="#产生提交-1">产生提交</a></li>
        <li><a href="#查看提交历史-1">查看提交历史</a></li>
        <li><a href="#查看提交细节-1">查看提交细节</a></li>
        <li><a href="#this-project-is-for-demoing-git-1">This project is for demoing git</a></li>
        <li><a href="#添加改动到-b1">添加改动到 B1</a></li>
        <li><a href="#查看提交历史-2">查看提交历史</a>
          <ul>
            <li><a href="#阶段-3拆分需求-b-的代码把-b1提交检查系统">阶段 3：拆分需求 B 的代码，把 B1’提交检查系统</a></li>
          </ul>
        </li>
        <li><a href="#将-b1拆分">将 B1&rsquo;拆分</a></li>
        <li><a href="#查看提交历史-3">查看提交历史</a></li>
        <li><a href="#下面是弹出的编辑器">下面是弹出的编辑器</a></li>
      </ul>
    </li>
    <li><a href="#rebase-7b6ea3068d813f-onto-7b6ea30-3-commands">Rebase 7b6ea30..68d813f onto 7b6ea30 (3 commands)</a></li>
    <li><a href="#rebase-7b6ea3068d813f-onto-7b6ea30-3-commands-1">Rebase 7b6ea30..68d813f onto 7b6ea30 (3 commands)</a>
      <ul>
        <li><a href="#检查提交链">检查提交链</a></li>
        <li><a href="#运行-arc-命令把-b提交到-phabricator-上">运行 arc 命令把 B&rsquo;&lsquo;&lsquo;提交到 Phabricator 上</a></li>
        <li><a href="#重新把-head-指向-b2">重新把 HEAD 指向 B2&rsquo;</a></li>
        <li><a href="#检查提交链-1">检查提交链</a>
          <ul>
            <li><a href="#阶段-4继续开发-b2同时得到-b1-的反馈修改-b1">阶段 4：继续开发 B2，同时得到 B1 的反馈，修改 B1</a></li>
          </ul>
        </li>
        <li><a href="#查看工作区中的修改">查看工作区中的修改</a></li>
        <li><a href="#this-project-is-for-demoing-git-2">This project is for demoing git</a></li>
        <li><a href="#把工作区中的修改添加到-b2中">把工作区中的修改添加到 B2&rsquo;中</a></li>
        <li><a href="#以下是弹出编辑器中的文本内容">以下是弹出编辑器中的文本内容</a></li>
        <li><a href="#以下是保存退出后-git-rebase--i-originmaster-的输出">以下是保存退出后 git rebase -i origin/master 的输出</a></li>
        <li><a href="#查看提交历史-4">查看提交历史</a></li>
        <li><a href="#根据同事反馈修改-indexjs">根据同事反馈，修改 index.js</a></li>
        <li><a href="#查看修改">查看修改</a></li>
        <li><a href="#把改动添加到-b1中">把改动添加到 B1&rsquo;&lsquo;&lsquo;中。</a></li>
        <li><a href="#查看提交链">查看提交链</a></li>
        <li><a href="#将-b1发送到代码审查系统">将 B1&rsquo;&lsquo;&lsquo;&lsquo;发送到代码审查系统</a></li>
        <li><a href="#查看提交历史-5">查看提交历史</a>
          <ul>
            <li><a href="#阶段-5继续开发-a1并发出代码审查">阶段 5：继续开发 A1，并发出代码审查</a></li>
          </ul>
        </li>
        <li><a href="#git-rebase-弹出编辑窗口">git rebase 弹出编辑窗口</a></li>
        <li><a href="#保存退出后-git-rebase--i-head-的结果">保存退出后 git rebase -i HEAD^^ 的结果</a></li>
        <li><a href="#对-a1修改">对 A1&rsquo;&lsquo;修改</a></li>
        <li><a href="#下面是-git-commit-弹出编辑器在里面完善-a1的-commit-message">下面是 git commit 弹出编辑器，在里面完善 A1&rsquo;&lsquo;的 Commit Message</a></li>
      </ul>
    </li>
    <li><a href="#please-enter-the-commit-message-for-your-changes-lines-starting">Please enter the Commit Message for your changes. Lines starting</a></li>
    <li><a href="#with--will-be-ignored-and-an-empty-message-aborts-the-commit">with &lsquo;#&rsquo; will be ignored, and an empty message aborts the commit.</a></li>
    <li><a href="#heading"></a></li>
    <li><a href="#date------tue-oct-15-124508-2019-0800">Date:      Tue Oct 15 12:45:08 2019 +0800</a></li>
    <li><a href="#heading-1"></a></li>
    <li><a href="#interactive-rebase-in-progress-onto-29c8249">interactive rebase in progress; onto 29c8249</a></li>
    <li><a href="#last-command-done-1-command-done">Last command done (1 command done):</a></li>
    <li><a href="#edit-1562cc7-readme">edit 1562cc7 readme</a></li>
    <li><a href="#next-command-to-do-1-remaining-command">Next command to do (1 remaining command):</a></li>
    <li><a href="#pick-bc0900d-do-not-push-add-documentation-for-getrandom-endpoint">pick bc0900d [DO NOT PUSH] Add documentation for getRandom endpoint</a></li>
    <li><a href="#you-are-currently-splitting-a-commit-while-rebasing-branch-master-on-29c8249">You are currently splitting a commit while rebasing branch &lsquo;master&rsquo; on &lsquo;29c8249&rsquo;.</a></li>
    <li><a href="#heading-2"></a></li>
    <li><a href="#changes-to-be-committed">Changes to be committed:</a></li>
    <li><a href="#new-file---readmemd">new file:   README.md</a></li>
    <li><a href="#heading-3"></a>
      <ul>
        <li><a href="#保存退出后-git-commit-输出结果">保存退出后 git commit 输出结果</a></li>
        <li><a href="#继续执行-git-rebase--i">继续执行 git rebase -i</a></li>
        <li><a href="#查看当前提交链">查看当前提交链</a></li>
        <li><a href="#查看冲突细节">查看冲突细节</a></li>
        <li><a href="#用-git-diff-和-git-diff---cached-查看更多细节">用 git diff 和 git diff &ndash;cached 查看更多细节</a></li>
        <li><a href="#this-project-is-for-demoing-git-3">This project is for demoing git</a></li>
        <li><a href="#这个是初始内容">这个是初始内容</a></li>
      </ul>
    </li>
    <li><a href="#this-project-is-for-demoing-atomic-commit-in-git">This project is for demoing atomic commit in git</a>
      <ul>
        <li><a href="#this-project-is-for-demoing-git-4">This project is for demoing git</a></li>
        <li><a href="#这个是修改后内容并保存退出">这个是修改后内容，并保存退出</a></li>
      </ul>
    </li>
    <li><a href="#this-project-is-for-demoing-atomic-commit-in-git-1">This project is for demoing atomic commit in git</a>
      <ul>
        <li><a href="#添加-readmemd-到暂存区并使用-git-status-查看状态">添加 README.md 到暂存区，并使用 git status 查看状态</a></li>
        <li><a href="#使用-git-status-查看状态">使用 git status 查看状态</a></li>
        <li><a href="#冲突成功解决继续-git-rebase--i-后续步骤">冲突成功解决，继续 git rebase -i 后续步骤</a></li>
        <li><a href="#git-rebase-提示编辑-b2的-commit-message">git rebase 提示编辑 B2&rsquo;&lsquo;&lsquo;&lsquo;的 Commit Message</a></li>
        <li><a href="#保存退出之后-git-rebase---continue-的输出">保存退出之后 git rebase &ndash;continue 的输出</a></li>
        <li><a href="#检查提交链-2">检查提交链</a>
          <ul>
            <li><a href="#阶段-6b1-检查通过推送到远程代码仓共享分支">阶段 6：B1 检查通过，推送到远程代码仓共享分支</a></li>
          </ul>
        </li>
        <li><a href="#修改第一行开头pick---edit">修改第一行开头：pick -&gt; edit</a></li>
        <li><a href="#保存退出结果">保存退出结果</a></li>
        <li><a href="#查看提交链-1">查看提交链</a></li>
        <li><a href="#直接推送因为当前-head-不在任何分支上推送失败">直接推送。因为当前 HEAD 不在任何分支上，推送失败。</a></li>
        <li><a href="#再次推送指定远端代码仓-origin-和远端分支-maser以及本地要推送的分支-head推送成功">再次推送，指定远端代码仓 origin 和远端分支 maser，以及本地要推送的分支 HEAD。推送成功</a></li>
        <li><a href="#查看提交链-2">查看提交链</a></li>
        <li><a href="#用本地多分支实现多个需求的提交的原子性">用本地多分支实现多个需求的提交的原子性</a>
          <ul>
            <li><a href="#多分支工作流具体步骤">多分支工作流具体步骤</a></li>
            <li><a href="#阶段-1开发需求-c">阶段 1：开发需求 C</a></li>
          </ul>
        </li>
        <li><a href="#修改代码产生提交">修改代码，产生提交</a></li>
        <li><a href="#填写详细-commit-message">填写详细 Commit Message</a></li>
        <li><a href="#以下是-commit-message-保存后退出git-commit-的输出结果">以下是 Commit Message 保存后退出，git commit 的输出结果</a></li>
        <li><a href="#使用-phabricator-的客户端arc把当前提交发送给-phabricator-进行检查">使用 Phabricator 的客户端，arc，把当前提交发送给 Phabricator 进行检查</a></li>
        <li><a href="#查看提交链-3">查看提交链</a>
          <ul>
            <li><a href="#阶段-2开发需求-d">阶段 2：开发需求 D</a></li>
          </ul>
        </li>
        <li><a href="#进行修改">进行修改</a></li>
        <li><a href="#添加产生修改过程中有输入-commit-message">添加，产生修改，过程中有输入 Commit Message</a></li>
        <li><a href="#查看修改-1">查看修改</a></li>
      </ul>
    </li>
    <li><a href="#this-project-is-for-demoing-atomic-commit-in-git-2">This project is for demoing atomic commit in git</a>
      <ul>
        <li><a href="#将提交发送到-phabricator-进行审查">将提交发送到 Phabricator 进行审查</a></li>
        <li><a href="#查看提交历史-6">查看提交历史</a>
          <ul>
            <li><a href="#阶段-3推送提交-c1-到远端代码仓共享分支">阶段 3：推送提交 C1 到远端代码仓共享分支</a></li>
          </ul>
        </li>
        <li><a href="#查看提交状态">查看提交状态</a>
          <ul>
            <li><a href="#阶段-4继续开发-d1">阶段 4：继续开发 D1</a></li>
          </ul>
        </li>
        <li><a href="#查看提交状态-1">查看提交状态</a></li>
        <li><a href="#两种工作流的对比">两种工作流的对比</a></li>
        <li><a href="#小结">小结</a></li>
        <li><a href="#思考题">思考题</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是葛俊。今天，我们继续来聊聊如何通过 Git 提高代码提交的原子性吧。</p>
<p>在上一篇文章中，我给你详细介绍了 Git 助力提高代码提交原子性的五条基础操作，今天我们再来看看 Facebook 的开发人员具体是如何使用这些操作来实现提交的原子性的。</p>
<p>为了帮助你更直观地理解、学习，在这篇文章里，我会与你详细描述工作场景，并列出具体命令。同时，我还把这些命令的输出也都放到了文章里，供你参考。所以，这篇文章会比较长、比较细。不过不要担心，这些内容都是日常工作中的自然流程，阅读起来也会比较顺畅。</p>
<p>在 Facebook，开发人员最常使用两种 Git 工作流：</p>
<ol>
<li>使用一个分支，完成所有需求的开发；</li>
<li>使用多个分支，每个分支支持一个需求的开发。</li>
</ol>
<p>两种工作流都利用 Git 的超强功能来提高代码原子性。这里的“需求”包括功能开发和缺陷修复，用大写字母 A、B、C 等表示；每个需求都可能包含有多个提交，每个提交用需求名 + 序号表示。比如，A 可能包含 A1、A2 两个提交，B 只包含 B1 这一个提交，而 C 包含 C1、C2、C3 三个提交。</p>
<p>需要强调的是，这两种工作流中的一个分支和多个分支，都是在开发者本地机器上的分支，不是远程代码仓中的功能分支。我在前面第 7 篇文章中提到过，Facebook 的主代码仓是不使用功能分支的。</p>
<p>另外，这两种 Git 工作流对代码提交原子性的助力作用，跟主代码仓是否使用单分支开发没有关系。也就是说，即使你所在团队的主仓没有使用 Facebook 那样的单分支开发模式，仍然可以使用这两种工作流来提高代码提交的原子性。</p>
<p>接下来，我们就先看看第一种工作流，也就是使用一个分支完成所有需求的开发。</p>
<h2 id="工作流一使用一个分支完成所有需求的开发">工作流一：使用一个分支完成所有需求的开发</h2>
<p>这种工作流程的最大特点是，<strong>使用一个分支上的提交链，大量使用 git rebase -i 来修改提交链上的提交</strong>。这里的提交链，指的是当前分支上，还没有推送到远端主仓共享分支的所有提交。</p>
<p>首先，我们需要设置一个本地分支来开发需求，通过这个分支和远端主仓的共享分支进行交互。本地分支通常直接使用 master 分支，而远端主仓的共享分支一般是 origin/master，也叫作上游分支（upstream）。</p>
<p>一般来说，在 git clone 的时候，master 是默认已经产生，并且是已经跟踪 origin/master 了的，你不需要做任何设置，可以查看.git/config 文件做确认：</p>
<blockquote>
<p>cat .git/config<br>
&hellip;<br>
[remote &ldquo;origin&rdquo;]<br>
url = <a href="mailto:git@github.com">git@github.com</a>:jungejason/git-atomic-demo.git<br>
fetch = +refs/heads/<em>:refs/remotes/origin/</em><br>
[branch &ldquo;master&rdquo;]<br>
remote = origin<br>
merge = refs/heads/master</p>
</blockquote>
<p>可以看到，branch &ldquo;master&quot;里有一个 remote = origin 选项，表明 master 分支在跟踪 origin 这个上游仓库；另外，config 文件里还有一个 remote &ldquo;origin&quot;选项，列举了 origin 这个上游仓库的地址。</p>
<p>当然，除了直接查看 config 文件外，Git 还提供了命令行工具。你可以使用 git branch -vv 查看某个分支是否在跟踪某个远程分支，然后再使用 git remote show去查看远程代码仓的细节。</p>
<h2 id="查看远程分支细节">查看远程分支细节</h2>
<blockquote>
<p>git branch -vv<br>
master      5055c14 [origin/master: behind 1] Add documentation for getRandom endpoint</p>
</blockquote>
<h2 id="查看分支跟踪的远程代码仓细节">查看分支跟踪的远程代码仓细节</h2>
<blockquote>
<p>git remote show origin</p>
</blockquote>
<ul>
<li>remote origin<br>
Fetch URL: <a href="mailto:git@github.com">git@github.com</a>:jungejason/git-atomic-demo.git<br>
Push  URL: <a href="mailto:git@github.com">git@github.com</a>:jungejason/git-atomic-demo.git<br>
HEAD branch: master<br>
Remote branch:<br>
master tracked<br>
Local branches configured for &lsquo;git pull&rsquo;:<br>
master  merges with remote master<br>
Local ref configured for &lsquo;git push&rsquo;:<br>
master pushes to master (fast-forwardable)<br>
11:07:36 (master2) <a href="mailto:jasonge@Juns-MacBook-Pro-2.local">jasonge@Juns-MacBook-Pro-2.local</a>:~/jksj-repo/git-atomic-demo</li>
</ul>
<p>因为 config 文件简单直观，所以我常常直接到 config 文件里面查看和修改来完成这些操作。关于远程跟踪上游代码仓分支的更多细节，比如产生新分支、设置上游分支等，你可以参考Git: Upstream Tracking Understanding这篇文章。</p>
<p>设置好分支之后，我们来看看<strong>这个工作流中的具体步骤</strong>。</p>
<h3 id="单分支工作流具体步骤">单分支工作流具体步骤</h3>
<p>单分支工作流的步骤，大致包括以下 4 步：</p>
<ol>
<li>一个原子性的功能完成后，使用第 25 篇文章中提到的改变提交顺序的方法，把它放到距离 origin/master 最近的地方。</li>
<li>把这个提交发到代码审查系统 Phabricator 上进行质量检查，包括代码审查和机器检查。在等待质量检查结果的同时，继续其他提交的开发。</li>
<li>如果没有通过质量检查，则需要对提交进行修改，修改之后返回第 2 步。</li>
<li>如果通过质量检查，就把这个提交推送到主代码仓的共享分支上，然后继续其他分支的开发，回到第 1 步。</li>
</ol>
<p>请注意第二步的目的是，确保入库代码的质量，你可以根据实际情况进行检查。比如，你可以通过提交 PR 触发机器检查的工作流，也可以运行单元测试自行检查。如果没有任何质量检查的话，至少也要进行简单手工验证，让进入到远程代码仓的代码有起码的质量保障。</p>
<p>接下来，我设计了一个案例，尽量模拟我在 Facebook 的真实开发场景，与你讲述这个工作流的操作步骤。大致场景是这样的：我本来在开发需求 A，这时来了更紧急的需求 B。于是，我开始开发 B，把 B 分成两个原子性提交 B1 和 B2，并在 B1 完成之后最先推送到远程代码仓共享分支。</p>
<p>这个案例中，提交的改动很简单，但里面涉及了很多开发技巧，可供你借鉴。</p>
<h3 id="阶段-1开始开发需求-a">阶段 1：开始开发需求 A</h3>
<p>某天，我接到开发需求 A 的任务，要求在项目中添加一个 README 文件，对项目进行描述。</p>
<p>我先添加一个简单的 README.md 文件，然后用 git commit -am‘readme’快速生成一个提交 A1，确保代码不会丢失。</p>
<h2 id="文件内容">文件内容</h2>
<blockquote>
<p>cat README.md</p>
</blockquote>
<h2 id="this-project-is-for-demoing-git">This project is for demoing git</h2>
<h2 id="产生提交">产生提交</h2>
<blockquote>
<p>git commit -am &lsquo;readme&rsquo;<br>
[master 0825c0b] readme<br>
1 file changed, 1 insertion(+)<br>
create mode 100644 README.md</p>
</blockquote>
<h2 id="查看提交历史">查看提交历史</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>0825c0b (HEAD -&gt; master) readme</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp<br>
&hellip;</li>
</ul>
<h2 id="查看提交细节">查看提交细节</h2>
<blockquote>
<p>git show<br>
commit 0825c0b6cd98af11b171b52367209ad6e29e38d1 (HEAD -&gt; master)<br>
Author: Jason Ge <a href="mailto:gejun_1978@yahoo.com">gejun_1978@yahoo.com</a><br>
Date:   Tue Oct 15 12:45:08 2019</p>
</blockquote>
<pre><code>readme  
</code></pre>
<p>diff &ndash;git a/README.md b/README.md<br>
new file mode 100644<br>
index 0000000..789cfa9<br>
&mdash; /dev/null<br>
+++ b/README.md<br>
@@ -0,0 +1 @@<br>
+## This project is for demoing git</p>
<p>这时，A1 是 master 上没有推送到 origin/master 的唯一提交，也就是说，是提交链上的唯一提交。</p>
<p>请注意，A1 的 Commit Message 很简单，就是“readme”这 6 个字符。在把 A1 发出去做代码质量检查之前，我需要添加 Commit Message 的细节。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/bc53789bacddfa9cd1acb8b9c4eeead9.png" alt=""></p>
<p>图 1 提交链状态第 1 步</p>
<h3 id="阶段-2开始开发需求-b">阶段 2：开始开发需求 B</h3>
<p>这时，来了另外一个紧急需求 B，要求是添加一个 endpoint getRandom。开发时，我不切换分支，直接在 master 上继续开发。</p>
<p>首先，我写一个 getRandom 的实现，并进行简单验证。</p>
<h2 id="用-vim-修改">用 VIM 修改</h2>
<blockquote>
<p>vim index.js</p>
</blockquote>
<h2 id="查看工作区中的改动">查看工作区中的改动</h2>
<blockquote>
<p>git diff<br>
diff &ndash;git a/index.js b/index.js<br>
index 986fcd8..06695f6 100644<br>
&mdash; a/index.js<br>
+++ b/index.js<br>
@@ -6,6 +6,10 @@ app.get(&rsquo;/timestamp&rsquo;, function (req, res) {<br>
res.send(&rsquo;&rsquo; + Date.now())<br>
})</p>
</blockquote>
<p>+app.get(&rsquo;/getRandom&rsquo;, function (req, res) {</p>
<ul>
<li>res.send(&rsquo;&rsquo; + Math.random())<br>
+})</li>
<li></li>
</ul>
<p>app.get(&rsquo;/&rsquo;, function (req, res) {<br>
res.send(&lsquo;hello world&rsquo;)<br>
})</p>
<h2 id="用命令行工具-httpie-验证结果">用命令行工具 httpie 验证结果</h2>
<blockquote>
<p>http localhost:3000/getRandom<br>
HTTP/1.1 200 OK<br>
Connection: keep-alive<br>
Content-Length: 19<br>
Content-Type: text/html; charset=utf-8<br>
Date: Tue, 15 Oct 2019 03:49:15 GMT<br>
ETag: W/&ldquo;13-U1KCE8QRuz+dioGnmVwMkEWypYI&rdquo;<br>
X-Powered-By: Express</p>
</blockquote>
<p>0.25407324324864167</p>
<p>为确保代码不丢失，我用 git commit -am‘random’命令生成了一个提交 B1：</p>
<h2 id="产生提交-1">产生提交</h2>
<blockquote>
<p>git commit -am &lsquo;random&rsquo;<br>
[master 7752df4] random<br>
1 file changed, 4 insertions(+)</p>
</blockquote>
<h2 id="查看提交历史-1">查看提交历史</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>7752df4 (HEAD -&gt; master) random</li>
<li>0825c0b readme</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp<br>
&hellip;</li>
</ul>
<h2 id="查看提交细节-1">查看提交细节</h2>
<blockquote>
<p>git show<br>
commit f59a4084e3a2c620bdec49960371f8cc93b86825 (HEAD -&gt; master)<br>
Author: Jason Ge <a href="mailto:gejun_1978@yahoo.com">gejun_1978@yahoo.com</a><br>
Date:   Tue Oct 15 11:55:06 2019</p>
</blockquote>
<pre><code>random  
</code></pre>
<p>diff &ndash;git a/index.js b/index.js<br>
index 986fcd8..06695f6 100644<br>
&mdash; a/index.js<br>
+++ b/index.js<br>
@@ -6,6 +6,10 @@ app.get(&rsquo;/timestamp&rsquo;, function (req, res) {<br>
res.send(&rsquo;&rsquo; + Date.now())<br>
})</p>
<p>+app.get(&rsquo;/getRandom&rsquo;, function (req, res) {</p>
<ul>
<li>res.send(&rsquo;&rsquo; + Math.random())<br>
+})</li>
<li></li>
</ul>
<p>app.get(&rsquo;/&rsquo;, function (req, res) {<br>
res.send(&lsquo;hello world&rsquo;)<br>
})</p>
<p>B1 的 Commit Message 也很简陋，因为当前的关键任务是先把功能运行起来。</p>
<p>现在，我的提交链上有 A1 和 B1 两个提交了。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/5be8fd1461341a40b235f959fa429992.png" alt=""></p>
<p>图 2 提交链状态第 2 步</p>
<p>接下来，我需要进行需求 B 的进一步开发：在 README 文件中给这个新的 endpoint 添加说明。</p>
<blockquote>
<p>git diff<br>
diff &ndash;git a/README.md b/README.md<br>
index 789cfa9..7b2b6af 100644<br>
&mdash; a/README.md<br>
+++ b/README.md<br>
@@ -1 +1,3 @@</p>
</blockquote>
<h2 id="this-project-is-for-demoing-git-1">This project is for demoing git</h2>
<ul>
<li></li>
</ul>
<p>+You can visit endpoint getRandom to get a random real number.</p>
<p>我认为这个改动是 B1 的一部分，所以我用 git commit &ndash;amend 把它添加到 B1 中。</p>
<h2 id="添加改动到-b1">添加改动到 B1</h2>
<blockquote>
<p>git add README.md<br>
git commit &ndash;amend<br>
[master 27c4d40] random<br>
Date: Tue Oct 15 11:55:06 2019 +0800<br>
2 files changed, 6 insertions(+)</p>
</blockquote>
<h2 id="查看提交历史-2">查看提交历史</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>27c4d40 (HEAD -&gt; master) random</li>
<li>0825c0b readme</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp</li>
</ul>
<p>现在，我的提交链上还是 A1 和 B1’两个提交。这里的 B1’是为了区别之前的 B1，B1 仍然存在代码仓中，不过是不再使用了而已。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/bdc21cca948baa0fc6cf07afe740ae64.png" alt=""></p>
<p>图 3 提交链状态第 3 步</p>
<h3 id="阶段-3拆分需求-b-的代码把-b1提交检查系统">阶段 3：拆分需求 B 的代码，把 B1’提交检查系统</h3>
<p>这时，我觉得 B1’的功能实现部分，也就是 index.js 的改动部分，可以推送到 origin/master 了。</p>
<p>不过，文档部分也就是 README.md 文件的改动，还不够好，而且功能实现和文档应该分成两个原子性提交。于是，我将 B1’拆分为 B1’’和 B2 两部分。</p>
<h2 id="将-b1拆分">将 B1&rsquo;拆分</h2>
<blockquote>
<p>git reset HEAD^<br>
Unstaged changes after reset:<br>
M  README.md   ## 这个将是 B2 的内容<br>
M  index.js    ## 这个将是 B1&rsquo;&lsquo;的内容</p>
</blockquote>
<blockquote>
<p>git status<br>
On branch master<br>
Your branch is ahead of &lsquo;origin/master&rsquo; by 1 commit.<br>
(use &ldquo;git push&rdquo; to publish your local commits)<br>
Changes not staged for commit:<br>
(use &ldquo;git add <file>&hellip;&rdquo; to update what will be committed)<br>
(use &ldquo;git checkout &ndash; <file>&hellip;&rdquo; to discard changes in working directory)<br>
modified:   README.md<br>
modified:   index.js<br>
no changes added to commit (use &ldquo;git add&rdquo; and/or &ldquo;git commit -a&rdquo;)</p>
</blockquote>
<blockquote>
<p>git add index.js<br>
git commit   ## 这里我认真填写 B1&rsquo;&lsquo;的 Commit Message</p>
</blockquote>
<blockquote>
<p>git add README.md<br>
git commit   ## 这里我认真填写 B2 的 Commit Message</p>
</blockquote>
<h2 id="查看提交历史-3">查看提交历史</h2>
<ul>
<li>68d813f (HEAD -&gt; master) [DO NOT PUSH] Add documentation for getRandom endpoint</li>
<li>7d43442 Add getRandom endpoint</li>
<li>0825c0b readme</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp</li>
</ul>
<p>现在，提交链上有 A1、B1’’、B2 三个提交。</p>
<p>请注意，在这里我把功能实现和文档分为两个原子性提交，只是为了帮助说明我需要把 B1’进行原子性拆分而已，在实际工作中，很可能功能实现和文档就应该放在一个提交当中。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/8f185598d5e3956bfcca3245726d4e89.png" alt=""></p>
<p>图 4 提交链状态第 4 步</p>
<p>提交 B1’拆开之后，为了把 B1’’推送到 origin/master 上去，我需要要把 B1’’挪到 A1 的前面。首先，运行 git rebase -i origin/master。</p>
<blockquote>
<p>git rebase -i origin/master</p>
</blockquote>
<h2 id="下面是弹出的编辑器">下面是弹出的编辑器</h2>
<p>pick 0825c0b readme                   ## 这个是 A1<br>
pick 7d43442 Add getRandom endpoint   ## 这个是 B1&rsquo;&rsquo;<br>
pick 68d813f [DO NOT PUSH] Add documentation for getRandom endpoint</p>
<h1 id="rebase-7b6ea3068d813f-onto-7b6ea30-3-commands">Rebase 7b6ea30..68d813f onto 7b6ea30 (3 commands)</h1>
<p>&hellip;</p>
<p>然后，我把针对 B1’’的那一行挪到第一行，保存退出。</p>
<p>pick 7d43442 Add getRandom endpoint  ## 这个是 B1&rsquo;&rsquo;<br>
pick 0825c0b readme                  ## 这个是 A1  <br>
pick 68d813f [DO NOT PUSH] Add documentation for getRandom endpoint</p>
<h1 id="rebase-7b6ea3068d813f-onto-7b6ea30-3-commands-1">Rebase 7b6ea30..68d813f onto 7b6ea30 (3 commands)</h1>
<p>&hellip;</p>
<p>git rebase -i 命令会显示运行成功，使用 git log 命令可以看到我成功改变了提交的顺序。</p>
<blockquote>
<p>git rebase -i origin/master<br>
Successfully rebased and updated refs/heads/master.</p>
</blockquote>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>86126f7 (HEAD -&gt; master) [DO NOT PUSH] Add documentation for getRandom endpoint</li>
<li>7113c16 readme</li>
<li>4d37768 Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp</li>
</ul>
<p>现在，提交链上有 B1’’’、A1’、B2’三个提交了。请注意，B2’也是一个新的提交。虽然我只是交换了 B1’’和 A 的顺序，但 git rebase 的操作是重新应用，产生出了三个新提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/2f254c2e5aeb2d8f56b834a9bf807c6a.png" alt=""></p>
<p>图 5 提交链状态第 5 步</p>
<p>现在，我可以把 B1’’’发送给质量检查系统了。</p>
<p>首先，产生一个临时分支 temp 指向 B2’，确保能回到原来的代码；然后，用 git reset &ndash;hard 命令把 master 和 HEAD 指向 B1’’’。</p>
<blockquote>
<p>git branch temp<br>
git reset &ndash;hard 4d37768<br>
HEAD is now at 4d37768 Add getRandom endpoint</p>
</blockquote>
<h2 id="检查提交链">检查提交链</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>4d37768 (HEAD -&gt; master) Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp<br>
&hellip;</li>
</ul>
<p>这时，提交链中只有 B1’’’。当然，A1’和 B2’仍然存在，只是不在提交链里了而已。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/28905d13461b06b07c1f077ed8fb47af.png" alt=""></p>
<p>图 6 提交链状态第 6 步</p>
<p>最后，运行命令把 B1’’’提交到 Phabricator 上，结束后使用 git reset &ndash;hard temp 命令重新把 HEAD 指向 B2’。</p>
<h2 id="运行-arc-命令把-b提交到-phabricator-上">运行 arc 命令把 B&rsquo;&lsquo;&lsquo;提交到 Phabricator 上</h2>
<blockquote>
<p>arc diff</p>
</blockquote>
<h2 id="重新把-head-指向-b2">重新把 HEAD 指向 B2&rsquo;</h2>
<blockquote>
<p>git reset &ndash;hard temp<br>
HEAD is now at 86126f7 [DO NOT PUSH] Add documentation for getRandom endpoint</p>
</blockquote>
<h2 id="检查提交链-1">检查提交链</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>86126f7 (HEAD -&gt; master, temp, single-branch-step-5) [DO NOT PUSH] Add documentation for getRandom endpoint</li>
<li>7113c16 readme</li>
<li>4d37768 Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp</li>
</ul>
<p>这时，提交链又恢复成为 B1’’’、A1’、B2’三个提交了。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/1b74e093bebb1f064f00778b5e11a4b2.png" alt=""></p>
<p>图 7 提交链状态第 7 步</p>
<h3 id="阶段-4继续开发-b2同时得到-b1-的反馈修改-b1">阶段 4：继续开发 B2，同时得到 B1 的反馈，修改 B1</h3>
<p>把 B1’’’发送到质量检查中心之后，我回到 B2’继续工作，也就是在 README 文件中继续添加关于 getRandom 的文档。我正在开发的过程中，得到 B1’’’的反馈，要求我对其进行修改。于是，我首先保存当前对 B2’的修改，用 git commit &ndash;amend 把它添加到 B2’中。</p>
<h2 id="查看工作区中的修改">查看工作区中的修改</h2>
<blockquote>
<p>git diff<br>
diff &ndash;git a/README.md b/README.md<br>
index 8a60943..1f06f52 100644<br>
&mdash; a/README.md<br>
+++ b/README.md<br>
@@ -1,3 +1,4 @@</p>
</blockquote>
<h2 id="this-project-is-for-demoing-git-2">This project is for demoing git</h2>
<p>You can visit endpoint getRandom to get a random real number.<br>
+The end endpoint is <code>/getRandom</code>.</p>
<h2 id="把工作区中的修改添加到-b2中">把工作区中的修改添加到 B2&rsquo;中</h2>
<blockquote>
<p>git add README.md<br>
git commit &ndash;amend<br>
[master 7b4269c] [DO NOT PUSH] Add documentation for getRandom endpoint<br>
Date: Tue Oct 15 17:17:18 2019 +0800<br>
1 file changed, 3 insertions(+)</p>
</blockquote>
<ul>
<li>7b4269c (HEAD -&gt; master) [DO NOT PUSH] Add documentation for getRandom endpoint</li>
<li>7113c16 readme</li>
<li>4d37768 Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp<br>
&hellip;</li>
</ul>
<p>这时，提交链成为 B1’’’、A1’、B2’’三个提交了。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/991857eeddc44439436a839bde6a5d9c.png" alt=""></p>
<p>图 8 提交链状态第 8 步</p>
<p>接下来，我使用第 25 篇文章中介绍的基础操作对 B1’’’进行修改。</p>
<p>首先，在 git rebase -i origin/master 的文本输入框中，将 pick B1’’’那一行修改为 edit B1’’’，然后保存退出，git rebase 暂停在 B1’’’处：</p>
<blockquote>
<p>git rebase -i origin/master</p>
</blockquote>
<h2 id="以下是弹出编辑器中的文本内容">以下是弹出编辑器中的文本内容</h2>
<p>edit 4d37768 Add getRandom endpoint   ## &lt;&ndash; 这一行开头原本是 pick<br>
pick 7113c16 readme<br>
pick 7b4269c [DO NOT PUSH] Add documentation for getRandom endpoint</p>
<h2 id="以下是保存退出后-git-rebase--i-originmaster-的输出">以下是保存退出后 git rebase -i origin/master 的输出</h2>
<p>Stopped at 4d37768&hellip;  Add getRandom endpoint<br>
You can amend the commit now, with<br>
git commit &ndash;amend<br>
Once you are satisfied with your changes, run<br>
git rebase &ndash;continue</p>
<h2 id="查看提交历史-4">查看提交历史</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>4d37768 (HEAD) Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp</li>
</ul>
<p>这时，提交链上只有 B1’’’一个提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/f75c481b0c8abab487c8bacd434eb4a5.png" alt=""></p>
<p>图 9 提交链状态第 9 步</p>
<p>然后，我对 index.js 进行修改，并添加到 B1’’’中，成为 B1’’’’。完成之后，再次把 B1’’’’发送到代码质量检查系统。</p>
<h2 id="根据同事反馈修改-indexjs">根据同事反馈，修改 index.js</h2>
<blockquote>
<p>vim index.js<br>
git add index.js</p>
</blockquote>
<h2 id="查看修改">查看修改</h2>
<blockquote>
<p>git diff &ndash;cached<br>
diff &ndash;git a/index.js b/index.js<br>
index 06695f6..cc92a42 100644<br>
&mdash; a/index.js<br>
+++ b/index.js<br>
@@ -7,7 +7,7 @@ app.get(&rsquo;/timestamp&rsquo;, function (req, res) {<br>
})</p>
</blockquote>
<p>app.get(&rsquo;/getRandom&rsquo;, function (req, res) {</p>
<ul>
<li>res.send(&rsquo;&rsquo; + Math.random())</li>
</ul>
<ul>
<li>res.send(&lsquo;The random number is:&rsquo; + Math.random())<br>
})</li>
</ul>
<p>app.get(&rsquo;/&rsquo;, function (req, res) {</p>
<h2 id="把改动添加到-b1中">把改动添加到 B1&rsquo;&lsquo;&lsquo;中。</h2>
<blockquote>
<p>git commit &ndash;amend<br>
[detached HEAD 29c8249] Add getRandom endpoint<br>
Date: Tue Oct 15 17:16:12 2019 +0800<br>
1 file changed, 4 insertions(+)<br>
19:17:28 (master|REBASE-i) <a href="mailto:jasonge@Juns-MacBook-Pro-2.local">jasonge@Juns-MacBook-Pro-2.local</a>:~/jksj-repo/git-atomic-demo<br>
git show<br>
commit 29c82490256459539c4a1f79f04823044f382d2b (HEAD)<br>
Author: Jason Ge <a href="mailto:gejun_1978@yahoo.com">gejun_1978@yahoo.com</a><br>
Date:   Tue Oct 15 17:16:12 2019<br>
Add getRandom endpoint</p>
</blockquote>
<pre><code>Summary:  
As title.  

Test:  
Verified it on localhost:3000/getRandom  
</code></pre>
<p>diff &ndash;git a/index.js b/index.js<br>
index 986fcd8..cc92a42 100644<br>
&mdash; a/index.js<br>
+++ b/index.js<br>
@@ -6,6 +6,10 @@ app.get(&rsquo;/timestamp&rsquo;, function (req, res) {<br>
res.send(&rsquo;&rsquo; + Date.now())<br>
})</p>
<p>+app.get(&rsquo;/getRandom&rsquo;, function (req, res) {</p>
<ul>
<li>res.send(&lsquo;The random number is:&rsquo; + Math.random())<br>
+})</li>
<li></li>
</ul>
<p>app.get(&rsquo;/&rsquo;, function (req, res) {<br>
res.send(&lsquo;hello world&rsquo;)<br>
})</p>
<h2 id="查看提交链">查看提交链</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>29c8249 (HEAD) Add getRandom endpoint</li>
<li>7b6ea30 (origin/master, git-add-p) Add a new endpoint to return timestamp</li>
</ul>
<h2 id="将-b1发送到代码审查系统">将 B1&rsquo;&lsquo;&lsquo;&lsquo;发送到代码审查系统</h2>
<blockquote>
<p>arc diff</p>
</blockquote>
<p>这时，提交链只有 B1’’’’一个提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/1a9d9b89f26242870816744cdd9e2d52.png" alt=""></p>
<p>图 10 提交链状态第 10 步</p>
<p>最后，运行 git rebase &ndash;continue 完成整个 git rebase -i 操作。</p>
<blockquote>
<p>git rebase &ndash;continue<br>
Successfully rebased and updated refs/heads/master.</p>
</blockquote>
<h2 id="查看提交历史-5">查看提交历史</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>bc0900d (HEAD -&gt; master) [DO NOT PUSH] Add documentation for getRandom endpoint</li>
<li>1562cc7 readme</li>
<li>29c8249 Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp<br>
&hellip;</li>
</ul>
<p>这时，提交链包含 B1’’’’、A1’’、B2’’’三个提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/443707e332023b891cf27ff7b1cdab34.png" alt=""></p>
<p>图 11 提交链状态第 11 步</p>
<h3 id="阶段-5继续开发-a1并发出代码审查">阶段 5：继续开发 A1，并发出代码审查</h3>
<p>这时，我认为 A1’’比 B2’’’更为紧急重要，于是决定先完成 A1’’的工作并发送审查，同样也是使用 git rebase -i。</p>
<blockquote>
<p>git rebase -i HEAD^^  ## 两个 ^^ 表示从当前 HEAD 前面两个提交的地方 rebase</p>
</blockquote>
<h2 id="git-rebase-弹出编辑窗口">git rebase 弹出编辑窗口</h2>
<p>edit 1562cc7 readme  &lt;&ndash; 这一行开头原来是 pick。这个是 A1&rsquo;&rsquo;<br>
pick bc0900d [DO NOT PUSH] Add documentation for getRandom endpoint</p>
<h2 id="保存退出后-git-rebase--i-head-的结果">保存退出后 git rebase -i HEAD^^ 的结果</h2>
<p>Stopped at 1562cc7&hellip;  readme<br>
You can amend the commit now, with<br>
git commit &ndash;amend<br>
Once you are satisfied with your changes, run<br>
git rebase &ndash;continue</p>
<h2 id="对-a1修改">对 A1&rsquo;&lsquo;修改</h2>
<blockquote>
<p>vim README.md<br>
git diff<br>
diff &ndash;git a/README.md b/README.md<br>
index 789cfa9..09bcc7d 100644<br>
&mdash; a/README.md<br>
+++ b/README.md<br>
@@ -1 +1 @@<br>
-## This project is for demoing git<br>
+# This project is for demoing atomic commit in git</p>
</blockquote>
<blockquote>
<p>git add README.md<br>
git commit &ndash;amend</p>
</blockquote>
<h2 id="下面是-git-commit-弹出编辑器在里面完善-a1的-commit-message">下面是 git commit 弹出编辑器，在里面完善 A1&rsquo;&lsquo;的 Commit Message</h2>
<p>Add README.md file</p>
<p>Summary: we need a README file for the project.</p>
<p>Test: none.</p>
<h1 id="please-enter-the-commit-message-for-your-changes-lines-starting">Please enter the Commit Message for your changes. Lines starting</h1>
<h1 id="with--will-be-ignored-and-an-empty-message-aborts-the-commit">with &lsquo;#&rsquo; will be ignored, and an empty message aborts the commit.</h1>
<h1 id="heading"></h1>
<h1 id="date------tue-oct-15-124508-2019-0800">Date:      Tue Oct 15 12:45:08 2019 +0800</h1>
<h1 id="heading-1"></h1>
<h1 id="interactive-rebase-in-progress-onto-29c8249">interactive rebase in progress; onto 29c8249</h1>
<h1 id="last-command-done-1-command-done">Last command done (1 command done):</h1>
<h1 id="edit-1562cc7-readme">edit 1562cc7 readme</h1>
<h1 id="next-command-to-do-1-remaining-command">Next command to do (1 remaining command):</h1>
<h1 id="pick-bc0900d-do-not-push-add-documentation-for-getrandom-endpoint">pick bc0900d [DO NOT PUSH] Add documentation for getRandom endpoint</h1>
<h1 id="you-are-currently-splitting-a-commit-while-rebasing-branch-master-on-29c8249">You are currently splitting a commit while rebasing branch &lsquo;master&rsquo; on &lsquo;29c8249&rsquo;.</h1>
<h1 id="heading-2"></h1>
<h1 id="changes-to-be-committed">Changes to be committed:</h1>
<h1 id="new-file---readmemd">new file:   README.md</h1>
<h1 id="heading-3"></h1>
<h2 id="保存退出后-git-commit-输出结果">保存退出后 git commit 输出结果</h2>
<p>[detached HEAD 2c66fe9] Add README.md file<br>
Date: Tue Oct 15 12:45:08 2019 +0800<br>
1 file changed, 1 insertion(+)<br>
create mode 100644 README.md</p>
<h2 id="继续执行-git-rebase--i">继续执行 git rebase -i</h2>
<blockquote>
<p>git rebase &ndash;continue<br>
Auto-merging README.md<br>
CONFLICT (content): Merge conflict in README.md<br>
error: could not apply bc0900d&hellip; [DO NOT PUSH] Add documentation for getRandom endpoint<br>
Resolve all conflicts manually, mark them as resolved with<br>
&ldquo;git add/rm &lt;conflicted_files&gt;&rdquo;, then run &ldquo;git rebase &ndash;continue&rdquo;.<br>
You can instead skip this commit: run &ldquo;git rebase &ndash;skip&rdquo;.<br>
To abort and get back to the state before &ldquo;git rebase&rdquo;, run &ldquo;git rebase &ndash;abort&rdquo;.<br>
Could not apply bc0900d&hellip; [DO NOT PUSH] Add documentation for getRandom endpoint</p>
</blockquote>
<p>这个过程可能会出现冲突，比如在 A1’’’之上应用 B2’’’时可能会出现冲突。冲突出现时，你可以使用 git log 和 git status 命令查看细节。</p>
<h2 id="查看当前提交链">查看当前提交链</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>2c66fe9 (HEAD) Add README.md file</li>
<li>29c8249 Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp<br>
&hellip;</li>
</ul>
<h2 id="查看冲突细节">查看冲突细节</h2>
<blockquote>
<p>git status<br>
interactive rebase in progress; onto 29c8249<br>
Last commands done (2 commands done):<br>
edit 1562cc7 readme<br>
pick bc0900d [DO NOT PUSH] Add documentation for getRandom endpoint<br>
No commands remaining.<br>
You are currently rebasing branch &lsquo;master&rsquo; on &lsquo;29c8249&rsquo;.<br>
(fix conflicts and then run &ldquo;git rebase &ndash;continue&rdquo;)<br>
(use &ldquo;git rebase &ndash;skip&rdquo; to skip this patch)<br>
(use &ldquo;git rebase &ndash;abort&rdquo; to check out the original branch)</p>
</blockquote>
<p>Unmerged paths:<br>
(use &ldquo;git reset HEAD <file>&hellip;&rdquo; to unstage)<br>
(use &ldquo;git add <file>&hellip;&rdquo; to mark resolution)</p>
<p>both modified:   README.md</p>
<p>no changes added to commit (use &ldquo;git add&rdquo; and/or &ldquo;git commit -a&rdquo;)</p>
<h2 id="用-git-diff-和-git-diff---cached-查看更多细节">用 git diff 和 git diff &ndash;cached 查看更多细节</h2>
<blockquote>
<p>git diff<br>
diff &ndash;cc README.md<br>
index 09bcc7d,1f06f52..0000000<br>
&mdash; a/README.md<br>
+++ b/README.md<br>
@@@ -1,1 -1,4 +1,8 @@@<br>
++&laquo;&laquo;&laquo;&lt; HEAD<br>
+# This project is for demoing atomic commit in git<br>
++=======</p>
</blockquote>
<ul>
<li>
<h2 id="this-project-is-for-demoing-git-3">This project is for demoing git</h2>
</li>
<li></li>
<li>You can visit endpoint getRandom to get a random real number.</li>
<li>The end endpoint is <code>/getRandom</code>.<br>
++&raquo;&raquo;&raquo;&gt; bc0900d&hellip; [DO NOT PUSH] Add documentation for getRandom endpoint</li>
</ul>
<blockquote>
<p>git diff &ndash;cached</p>
</blockquote>
<ul>
<li>Unmerged path README.md</li>
</ul>
<p>解决冲突的具体步骤是：</p>
<ol>
<li>手动修改冲突文件；</li>
<li>使用 git add 或者 git rm 把修改添加到暂存区；</li>
<li>运行 git rebase &ndash;continue。于是，git rebase 会把暂存区的内容生成提交，并继续 git-rebase 后续步骤。</li>
</ol>
<blockquote>
<p>vim README.md</p>
</blockquote>
<h2 id="这个是初始内容">这个是初始内容</h2>
<p>&laquo;&laquo;&laquo;&lt; HEAD</p>
<h1 id="this-project-is-for-demoing-atomic-commit-in-git">This project is for demoing atomic commit in git</h1>
<p>=======</p>
<h2 id="this-project-is-for-demoing-git-4">This project is for demoing git</h2>
<p>You can visit endpoint getRandom to get a random real number.<br>
The end endpoint is <code>/getRandom</code>.</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>bc0900d&hellip; [DO NOT PUSH] Add documentation for getRandom endpoint</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h2 id="这个是修改后内容并保存退出">这个是修改后内容，并保存退出</h2>
<h1 id="this-project-is-for-demoing-atomic-commit-in-git-1">This project is for demoing atomic commit in git</h1>
<p>You can visit endpoint getRandom to get a random real number.<br>
The end endpoint is <code>/getRandom</code>.</p>
<h2 id="添加-readmemd-到暂存区并使用-git-status-查看状态">添加 README.md 到暂存区，并使用 git status 查看状态</h2>
<blockquote>
<p>git add README.md<br>
19:51:16 (master|REBASE-i) <a href="mailto:jasonge@Juns-MacBook-Pro-2.local">jasonge@Juns-MacBook-Pro-2.local</a>:~/jksj-repo/git-atomic-demo</p>
</blockquote>
<h2 id="使用-git-status-查看状态">使用 git status 查看状态</h2>
<blockquote>
<p>git status<br>
interactive rebase in progress; onto 29c8249<br>
Last commands done (2 commands done):<br>
edit 1562cc7 readme<br>
pick bc0900d [DO NOT PUSH] Add documentation for getRandom endpoint<br>
No commands remaining.<br>
You are currently rebasing branch &lsquo;master&rsquo; on &lsquo;29c8249&rsquo;.<br>
(all conflicts fixed: run &ldquo;git rebase &ndash;continue&rdquo;)</p>
</blockquote>
<p>Changes to be committed:<br>
(use &ldquo;git reset HEAD <file>&hellip;&rdquo; to unstage)</p>
<p>modified:   README.md</p>
<h2 id="冲突成功解决继续-git-rebase--i-后续步骤">冲突成功解决，继续 git rebase -i 后续步骤</h2>
<blockquote>
<p>git rebase &ndash;continue</p>
</blockquote>
<h2 id="git-rebase-提示编辑-b2的-commit-message">git rebase 提示编辑 B2&rsquo;&lsquo;&lsquo;&lsquo;的 Commit Message</h2>
<p>[DO NOT PUSH] Add documentation for getRandom endpoint</p>
<p>Summary:<br>
AT.</p>
<p>Test:<br>
None.</p>
<h2 id="保存退出之后-git-rebase---continue-的输出">保存退出之后 git rebase &ndash;continue 的输出</h2>
<p>[detached HEAD ae38d9e] [DO NOT PUSH] Add documentation for getRandom endpoint<br>
1 file changed, 3 insertions(+)<br>
Successfully rebased and updated refs/heads/master.</p>
<h2 id="检查提交链-2">检查提交链</h2>
<ul>
<li>ae38d9e (HEAD -&gt; master) [DO NOT PUSH] Add documentation for getRandom endpoint</li>
<li>2c66fe9 Add README.md file</li>
<li>29c8249 Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp</li>
</ul>
<p>这时，提交链上有 B1’’’’、A1’’’、B2’’’’三个提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/302f0d2cc9ca78b084016d5febfd3d1d.png" alt=""></p>
<p>图 12 提交链状态第 12 步</p>
<h3 id="阶段-6b1-检查通过推送到远程代码仓共享分支">阶段 6：B1 检查通过，推送到远程代码仓共享分支</h3>
<p>这时，我从 Phabricator 得到通知，B1’’’’检查通过了，可以将其推送到 oringin/master 去了！</p>
<p>首先，使用 git fetch 和 git rebase origin/master 命令，确保本地有远端主代码仓的最新代码。</p>
<blockquote>
<p>git fetch<br>
git rebase origin/master<br>
Current branch master is up to date.</p>
</blockquote>
<p>然后，使用 git rebase -i，在 B1’’’’处暂停：</p>
<blockquote>
<p>git rebase -i origin/master</p>
</blockquote>
<h2 id="修改第一行开头pick---edit">修改第一行开头：pick -&gt; edit</h2>
<p>edit 29c8249 Add getRandom endpoint<br>
pick 2c66fe9 Add README.md file<br>
pick ae38d9e [DO NOT PUSH] Add documentation for getRandom endpoint</p>
<h2 id="保存退出结果">保存退出结果</h2>
<p>Stopped at 29c8249&hellip;  Add getRandom endpoint<br>
You can amend the commit now, with<br>
git commit &ndash;amend<br>
Once you are satisfied with your changes, run<br>
git rebase &ndash;continue</p>
<h2 id="查看提交链-1">查看提交链</h2>
<ul>
<li>29c8249 (HEAD) Add getRandom endpoint</li>
<li>7b6ea30 (origin/master) Add a new endpoint to return timestamp<br>
&hellip;</li>
</ul>
<p>这时，origin/master 和 HEAD 之间只有 B1’’’’一个提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/6eb0f476b2ed0c0d5bf5e4c3522f30ec.png" alt=""></p>
<p>图 13 提交链状态第 13 步</p>
<p>我终于可以运行 git push origin HEAD:master，去推送 B1’’’’了。</p>
<p>注意，当前 HEAD 不在任何分支上，master 分支仍然指向 B2’’’’，所以 push 命令需要明确指向远端代码仓 origin 和远端分支 maser，以及本地要推送的分支 HEAD。推送完成之后，再运行 git rebase &ndash;continue 完成 rebase 操作，把 master 分支重新指向 B2’’’’。</p>
<h2 id="直接推送因为当前-head-不在任何分支上推送失败">直接推送。因为当前 HEAD 不在任何分支上，推送失败。</h2>
<blockquote>
<p>git push<br>
fatal: You are not currently on a branch.<br>
To push the history leading to the current (detached HEAD)<br>
state now, use<br>
git push origin HEAD:<name-of-remote-branch></p>
</blockquote>
<h2 id="再次推送指定远端代码仓-origin-和远端分支-maser以及本地要推送的分支-head推送成功">再次推送，指定远端代码仓 origin 和远端分支 maser，以及本地要推送的分支 HEAD。推送成功</h2>
<blockquote>
<p>git push origin HEAD:master<br>
Enumerating objects: 5, done.<br>
Counting objects: 100% (5/5), done.<br>
Delta compression using up to 8 threads<br>
Compressing objects: 100% (3/3), done.<br>
Writing objects: 100% (3/3), 392 bytes | 392.00 KiB/s, done.<br>
Total 3 (delta 2), reused 0 (delta 0)<br>
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.<br>
To github.com:jungejason/git-atomic-demo.git<br>
7b6ea30..29c8249  HEAD -&gt; master</p>
</blockquote>
<blockquote>
<p>git rebase &ndash;continue<br>
Successfully rebased and updated refs/heads/master.</p>
</blockquote>
<h2 id="查看提交链-2">查看提交链</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph</p>
</blockquote>
<ul>
<li>ae38d9e (HEAD -&gt; master) [DO NOT PUSH] Add documentation for getRandom endpoint</li>
<li>2c66fe9 Add README.md file</li>
<li>29c8249 (origin/master) Add getRandom endpoint</li>
<li>7b6ea30 Add a new endpoint to return timestamp</li>
</ul>
<p>这时，origin/master 已经指向了 B1’’’’，提交链现在只剩下了 A1’’’和 B2’’’’。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/771baf8ef95f5f8db115117438e9d800.png" alt=""></p>
<p>图 14 提交链状态第 14 步</p>
<p>至此，我们完成了在一个分支上同时开发两个需求 A 和 B、把提交拆分为原子性提交，并尽早把完成的提交推送到远端代码仓共享分支的全过程！</p>
<p>这个过程看起来比较复杂，但实际上就是根据上面列举的“单分支工作流”的 4 个步骤执行而已。</p>
<p>接下来，我们再看看使用多个分支，每个分支支持一个需求的开发方式。</p>
<h2 id="用本地多分支实现多个需求的提交的原子性">用本地多分支实现多个需求的提交的原子性</h2>
<p>在这种开发工作流下，每个需求都拥有独享的分支。同样的，跟单分支实现提交原子性的方式一样，这些分支都是本地分支，并不是主代码仓上的功能分支。</p>
<p>需要注意的是，在下面的分析中，我只描述每个分支上只有一个提交的简单形式，而至于每个分支上使用多个提交的形式，操作流程与单分支提交链中的描述一样，就不再重复表述了。</p>
<h3 id="多分支工作流具体步骤">多分支工作流具体步骤</h3>
<p>分支工作流的具体步骤，大致包括以下 4 步：</p>
<ol>
<li>切换到某一个分支对某需求进行开发，产生提交。</li>
<li>提交完成后，将其发送到代码审查系统 Phabricator 上进行质量检查。在等待质量检查结果的同时，切换到其他分支，继续其他需求的开发。</li>
<li>如果第 2 步的提交没有通过质量检查，则切换回这个提交所在分支，对提交进行修改，修改之后返回第 2 步。</li>
<li>如果第 2 步的提交通过了质量检查，则切换回这个提交所在分支，把这个提交推送到远端代码仓中，然回到第 1 步进行其他需求的开发。</li>
</ol>
<p>接下来，我们看一个开发两个需求 C 和 D 的场景吧。</p>
<p>在这个场景中，我首先开发需求 C，并把它的提交 C1 发送到质量检查中心；然后开始开发需求 D，等到 C1 通过质量检查之后，我立即将其推送到远程共享代码仓中去。</p>
<h3 id="阶段-1开发需求-c">阶段 1：开发需求 C</h3>
<p>需求 C 是一个简单的重构，把 index.js 中所有的 var 都改成 const。</p>
<p>首先，使用 git checkout -b feature-c origin/master 产生本地分支 feature-c，并跟踪 origin/master。</p>
<blockquote>
<p>git checkout -b feature-c origin/master<br>
Branch &lsquo;feature-c&rsquo; set up to track remote branch &lsquo;master&rsquo; from &lsquo;origin&rsquo;.<br>
Switched to a new branch &lsquo;feature-c&rsquo;</p>
</blockquote>
<p>然后，进行 C 的开发，产生提交 C1，并把提交发送到 Phabricator 进行检查。</p>
<h2 id="修改代码产生提交">修改代码，产生提交</h2>
<blockquote>
<p>vim index.js<br>
git diff<br>
diff &ndash;git a/index.js b/index.js<br>
index cc92a42..e5908f0 100644<br>
&mdash; a/index.js<br>
+++ b/index.js<br>
@@ -1,6 +1,6 @@<br>
-var port = 3000<br>
-var express = require(&rsquo;express&rsquo;)<br>
-var app = express()<br>
+const port = 3000<br>
+const express = require(&rsquo;express&rsquo;)<br>
+const app = express()</p>
</blockquote>
<p>app.get(&rsquo;/timestamp&rsquo;, function (req, res) {<br>
res.send(&rsquo;&rsquo; + Date.now())<br>
20:54:10 (feature-c) <a href="mailto:jasonge@Juns-MacBook-Pro-2.local">jasonge@Juns-MacBook-Pro-2.local</a>:~/jksj-repo/git-atomic-demo</p>
<blockquote>
<p>git add .<br>
20:54:16 (feature-c) <a href="mailto:jasonge@Juns-MacBook-Pro-2.local">jasonge@Juns-MacBook-Pro-2.local</a>:~/jksj-repo/git-atomic-demo</p>
</blockquote>
<blockquote>
<p>git commit</p>
</blockquote>
<h2 id="填写详细-commit-message">填写详细 Commit Message</h2>
<p>Refactor to use const instead of var</p>
<p>Summary: const provides more info about a variable. Use it when possible.</p>
<p>Test: ran <code>node index.js</code> and verifeid it by visiting localhost:3000.<br>
Endpoints still work.</p>
<h2 id="以下是-commit-message-保存后退出git-commit-的输出结果">以下是 Commit Message 保存后退出，git commit 的输出结果</h2>
<p>[feature-c 2122faa] Refactor to use const instead of var<br>
1 file changed, 3 insertions(+), 3 deletions(-)</p>
<h2 id="使用-phabricator-的客户端arc把当前提交发送给-phabricator-进行检查">使用 Phabricator 的客户端，arc，把当前提交发送给 Phabricator 进行检查</h2>
<blockquote>
<p>arc diff</p>
</blockquote>
<h2 id="查看提交链-3">查看提交链</h2>
<ul>
<li>2122faa (HEAD -&gt; feature-c, multi-branch-step-1) Refactor to use const instead of var</li>
<li>5055c14 (origin/master) Add documentation for getRandom endpoint<br>
&hellip;</li>
</ul>
<p>这时，origin/master 之上只有 feature-c 一个分支，上面有 C1 一个提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/14bdf2cab26b4bc9618115d6b8a458c1.png" alt=""></p>
<p>图 15 多分支提交状态第 1 步</p>
<h3 id="阶段-2开发需求-d">阶段 2：开发需求 D</h3>
<p>C1 发出去进行质量检查后，我开始开发需求 D。需求 D 是在 README.md 中，添加所有 endpoint 的文档。</p>
<p>首先，也是使用 git checkout -b feature-d origin/master 产生一个分支 feature-d 并跟踪 origin/master。</p>
<blockquote>
<p>git checkout -b feature-d origin/master<br>
Branch &lsquo;feature-d&rsquo; set up to track remote branch &lsquo;master&rsquo; from &lsquo;origin&rsquo;.<br>
Switched to a new branch &lsquo;feature-d&rsquo;<br>
Your branch is up to date with &lsquo;origin/master&rsquo;.</p>
</blockquote>
<p>然后，开始开发 D，产生提交 D1，并把提交发送到 Phabricator 进行检查。</p>
<h2 id="进行修改">进行修改</h2>
<blockquote>
<p>vim README.md</p>
</blockquote>
<h2 id="添加产生修改过程中有输入-commit-message">添加，产生修改，过程中有输入 Commit Message</h2>
<blockquote>
<p>git add README.md<br>
git commit</p>
</blockquote>
<h2 id="查看修改-1">查看修改</h2>
<blockquote>
<p>git show<br>
commit 97047a33071420dce3b95b89f6d516e5c5b59ec9 (HEAD -&gt; feature-d, multi-branch-step-2)<br>
Author: Jason Ge <a href="mailto:gejun_1978@yahoo.com">gejun_1978@yahoo.com</a><br>
Date:   Tue Oct 15 21:12:54 2019</p>
</blockquote>
<pre><code>Add spec for all endpoints  

Summary: We are missing the spec for the endpoints. Adding them.  

Test: none  
</code></pre>
<p>diff &ndash;git a/README.md b/README.md<br>
index 983cb1e..cbefdc3 100644<br>
&mdash; a/README.md<br>
+++ b/README.md<br>
@@ -1,4 +1,8 @@</p>
<h1 id="this-project-is-for-demoing-atomic-commit-in-git-2">This project is for demoing atomic commit in git</h1>
<p>-You can visit endpoint getRandom to get a random real number.<br>
-The end endpoint is <code>/getRandom</code>.<br>
+## endpoints<br>
+<br>
+* /getRandom: get a random real number.<br>
+* /timestamp: get the current timestamp.<br>
+* /: get a &ldquo;hello world&rdquo; message.</p>
<h2 id="将提交发送到-phabricator-进行审查">将提交发送到 Phabricator 进行审查</h2>
<blockquote>
<p>arc diff</p>
</blockquote>
<h2 id="查看提交历史-6">查看提交历史</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph feature-c feature-d</p>
</blockquote>
<ul>
<li>97047a3 (HEAD -&gt; feature-d Add spec for all endpoints<br>
| * 2122faa (feature-c) Refactor to use const instead of var<br>
|/</li>
<li>5055c14 (origin/master) Add documentation for getRandom endpoint</li>
</ul>
<p>这时，origin/master 之上有 feature-c 和 feature-d 两个分支，分别有 C1 和 D1 两个提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/f27c92b040a1c1a3ff103edc240f1724.png" alt=""></p>
<p>图 16 多分支提交状态第 2 步</p>
<h3 id="阶段-3推送提交-c1-到远端代码仓共享分支">阶段 3：推送提交 C1 到远端代码仓共享分支</h3>
<p>这时，我收到 Phabricator 的通知，C1 通过了检查，可以推送了！首先，我使用 git checkout 把分支切换回分支 feature-c：</p>
<blockquote>
<p>git checkout feature-c<br>
Switched to branch &lsquo;feature-c&rsquo;<br>
Your branch is ahead of &lsquo;origin/master&rsquo; by 1 commit.<br>
(use &ldquo;git push&rdquo; to publish your local commits)</p>
</blockquote>
<p>然后，运行 git fetch; git rebase origin/master，确保我的分支上有最新的远程共享分支代码：</p>
<blockquote>
<p>git fetch<br>
git rebase origin/master<br>
Current branch feature-c is up to date.</p>
</blockquote>
<p>接下来，运行 git push 推送 C1：</p>
<blockquote>
<p>git push<br>
Enumerating objects: 5, done.<br>
Counting objects: 100% (5/5), done.<br>
Delta compression using up to 8 threads<br>
Compressing objects: 100% (3/3), done.<br>
Writing objects: 100% (3/3), 460 bytes | 460.00 KiB/s, done.<br>
Total 3 (delta 2), reused 0 (delta 0)<br>
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.<br>
To github.com:jungejason/git-atomic-demo.git<br>
5055c14..2122faa  feature-c -&gt; master</p>
</blockquote>
<h2 id="查看提交状态">查看提交状态</h2>
<ul>
<li>97047a3 (feature-d) Add spec for all endpoints<br>
| * 2122faa (HEAD -&gt; feature-c, origin/master, multi-branch-step-1) Refactor to use const instead of var<br>
|/</li>
<li>5055c14 Add documentation for getRandom endpoint<br>
&hellip;</li>
</ul>
<p>这时，origin/master 指向 C1。分支 feature-d 从 origin/master 的父提交上分叉，上面只有 D1 一个提交。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/0efeaf3e72dce07e17961bb1b40fbd6a.png" alt=""></p>
<p>图 17 多分支提交状态第 3 步</p>
<h3 id="阶段-4继续开发-d1">阶段 4：继续开发 D1</h3>
<p>完成 C1 的推送后，我继续开发 D1。首先，用 git checkout 命令切换回分支 feature-d；然后，运行 git fetch 和 git rebase，确保当前代码 D1 是包含了远程代码仓最新的代码，以减少将来合并代码产生冲突的可能性。</p>
<blockquote>
<p>git checkout feature-d<br>
Switched to branch &lsquo;feature-d&rsquo;<br>
Your branch and &lsquo;origin/master&rsquo; have diverged,<br>
and have 1 and 1 different commits each, respectively.<br>
(use &ldquo;git pull&rdquo; to merge the remote branch into yours)<br>
21:38:22 (feature-d) <a href="mailto:jasonge@Juns-MacBook-Pro-2.local">jasonge@Juns-MacBook-Pro-2.local</a>:~/jksj-repo/git-atomic-demo</p>
</blockquote>
<blockquote>
<p>git fetch<br>
git rebase origin/master<br>
First, rewinding head to replay your work on top of it&hellip;<br>
Applying: Add spec for all endpoints</p>
</blockquote>
<h2 id="查看提交状态-1">查看提交状态</h2>
<blockquote>
<p>git log &ndash;oneline &ndash;graph feature-c feature-d</p>
</blockquote>
<ul>
<li>a8f92f5 (HEAD -&gt; feature-d) Add spec for all endpoints</li>
<li>2122faa (origin/master,) Refactor to use const instead of var<br>
&hellip;</li>
</ul>
<p>这时，当前分支为 feature-d，上面有唯一一个提交 D1’，而且 D1’已经变基到了 origin/master 上。</p>
<p>需要注意的是，因为使用的是 git rebase，没有使用 git merge 产生和并提交，所以提交历史是线性的。我在第 7 篇文章中提到过，线性的提交历史对 Facebook 的 CI 自动化意义重大。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/95e9f414ae9d18d6838d9e4d6351d76c.png" alt=""></p>
<p>图 18 多分支提交状态第 4 步</p>
<p>至此，我们完成了在两个分支上同时开发 C 和 D 两个需求，并尽早把完成了的提交推送到远端代码仓中的全过程。</p>
<p>虽然在这个例子中，我简化了这两个需求开发的情况，每个需求只有一个提交并且一次就通过了质量检查，但结合在一个分支上完成所有开发需求的流程，相信你也可以推导出每个需求有多个提交，以及质量检查没有通过时的处理方法了。如果这中间还有什么问题的话，那就直接留言给我吧。</p>
<p>接下来，我与你对比下这两种工作流。</p>
<h2 id="两种工作流的对比">两种工作流的对比</h2>
<p>如果我们要对比这两工作流的话，那就是各有利弊。</p>
<p>单分支开发方式的好处是，不需要切换分支，可以顺手解决一些缺陷修复，但缺点是 rebase 操作多，产生冲突的可能性大。</p>
<p>而多分支方式的好处是，一个分支只对应一个需求，相对比较简单、清晰，rebase 操作较少，产生冲突的可能性小，但缺点是不如单分支开发方式灵活。</p>
<p>无论是采用哪一种工作流，都有几个需要注意的地方：</p>
<ol>
<li>不要同时开发太多的需求，否则分支管理花销太大；</li>
<li>有了可以推送的提交就尽快推送到远端代码仓，从而减少在本地的管理成本，以及推送时产生冲突的可能性；</li>
<li>经常使用 git fetch 和 git rebase，确保自己的代码在本地持续与远程共享分支的代码在做集成，降低推送时冲突的可能性</li>
</ol>
<p>最后，我想说的是，如果你对 Git 不是特别熟悉，我推荐你先尝试第二种工作流。这种情况 rebase 操作较少，相对容易上手一些。</p>
<h2 id="小结">小结</h2>
<p>今天，我与你详细讲述了，在 Facebook 开发人员借助 Git 的强大功能，实现代码提交的原子性的两种工作流。</p>
<p>第一种工作流是，在一个单独的分支上进行多个需求的开发。总结来讲，具体的工作方法是：把每一个需求的提交都拆分为比较小的原子提交，并使用 git rebase -i 的功能，把可以进行质量检查的提交，放到提交链的最底部，也就是最接近 origin/master 的地方，然后发送到代码检查系统进行检查，之后继续在提交链的其他提交处工作。如果提交没有通过检查，就对它进行修改再提交检查；如果检查通过，就马上把它推送到远端代码仓的共享分支去。在等待代码检察时，继续在提交链的其他提交处工作。</p>
<p>第二种工作流是，使用多个分支来开发多个需求，每个分支对应一个需求。与单分支开发流程类似，我们尽快把当前可以进行代码检查的提交，放到离 origin/master 最近的地方；然后在代码审查时，继续开发其他提交。与单分支开发流程不同的是，切换工作任务时，需要切换分支。</p>
<p>这两种工作流，无论哪一种都能大大促进代码提交的原子性，从而同时提高个人及团队的研发效能。</p>
<p>我把今天的案例放到了 GitHub 上的git-atomic-demo代码仓里，并标注出了各个提交状态产生的分支。比如，single-branch-step-14 就是单分支流程中的第 14 个状态，multi-branch-step-4 就是多分支流程中的第 4 个状态。</p>
<h2 id="思考题">思考题</h2>
<ol>
<li>在对提交链的非当前提交，比如 HEAD^，进行修改时，除了使用 git rebase -i，在它暂停的时候进行修改，你还其他办法吗？你觉得这种方法的利弊是什么？</li>
<li>Git 和文字编排系统 LaTex 有一个有趣的共同点，你知道是什么吗？</li>
</ol>
<p>感谢你的收听，欢迎你在评论区给我留言分享你的观点，也欢迎你把这篇文章分享给更多的朋友一起阅读。我们下期再见！</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/6476358e731920fbc927e278bae473aa.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87%E7%A0%B4%E5%B1%80%E4%B9%8B%E9%81%93/">研发效率破局之道</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%8E%B0%E4%BB%A3c&#43;&#43;%E5%AE%9E%E6%88%9830%E8%AE%B2/26__easylogging&#43;&#43;%E5%92%8Cspdlog%E4%B8%A4%E4%B8%AA%E5%A5%BD%E7%94%A8%E7%9A%84%E6%97%A5%E5%BF%97%E5%BA%93/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">26__Easylogging&#43;&#43;和spdlog：两个好用的日志库</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/26__fork_join%E5%8D%95%E6%9C%BA%E7%89%88%E7%9A%84mapreduce/">
            <span class="next-text nav-default">26__Fork_Join：单机版的MapReduce</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
