<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>0908丨案例手把手教你编写最简单的性能脚本 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="08丨案例： 手把手教你编写最简单的性能脚本
通常我们会遇到要手写脚本的时候，就要针对一些接口编写脚本。这时候，我们需要知道接口规范和后台的数据是什么。而有些性能测试工程师写脚本时，并不知道后端的逻辑，只知道实现脚本，事实上，只知道实现脚本是远远不够的。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/0908%E4%B8%A8%E6%A1%88%E4%BE%8B%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E6%80%A7%E8%83%BD%E8%84%9A%E6%9C%AC/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/0908%E4%B8%A8%E6%A1%88%E4%BE%8B%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E6%80%A7%E8%83%BD%E8%84%9A%E6%9C%AC/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="0908丨案例手把手教你编写最简单的性能脚本">
  <meta property="og:description" content="08丨案例： 手把手教你编写最简单的性能脚本
通常我们会遇到要手写脚本的时候，就要针对一些接口编写脚本。这时候，我们需要知道接口规范和后台的数据是什么。而有些性能测试工程师写脚本时，并不知道后端的逻辑，只知道实现脚本，事实上，只知道实现脚本是远远不够的。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="性能测试实战30讲">

  <meta itemprop="name" content="0908丨案例手把手教你编写最简单的性能脚本">
  <meta itemprop="description" content="08丨案例： 手把手教你编写最简单的性能脚本
通常我们会遇到要手写脚本的时候，就要针对一些接口编写脚本。这时候，我们需要知道接口规范和后台的数据是什么。而有些性能测试工程师写脚本时，并不知道后端的逻辑，只知道实现脚本，事实上，只知道实现脚本是远远不够的。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="6253">
  <meta itemprop="keywords" content="性能测试实战30讲">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="0908丨案例手把手教你编写最简单的性能脚本">
  <meta name="twitter:description" content="08丨案例： 手把手教你编写最简单的性能脚本
通常我们会遇到要手写脚本的时候，就要针对一些接口编写脚本。这时候，我们需要知道接口规范和后台的数据是什么。而有些性能测试工程师写脚本时，并不知道后端的逻辑，只知道实现脚本，事实上，只知道实现脚本是远远不够的。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">0908丨案例手把手教你编写最简单的性能脚本</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 6253 字 </span>
          <span class="more-meta"> 预计阅读 13 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>08丨案例： 手把手教你编写最简单的性能脚本</p>
<p>通常我们会遇到要手写脚本的时候，就要针对一些接口编写脚本。这时候，我们需要知道接口规范和后台的数据是什么。而有些性能测试工程师写脚本时，并不知道后端的逻辑，只知道实现脚本，事实上，只知道实现脚本是远远不够的。</p>
<p>在这一篇文章中，我不打算讲复杂的内容，只想针对新手写一步步的操作，描述最简单的脚本编写。如果你已经具有丰富的脚本编写经验，会觉得本文很简单。</p>
<p>我没有打算把 JMeter 的功能点一一罗列出来，作为一个性能测试的专栏，不写一下脚本的实现似乎不像个样子。在脚本实现中，我们最常用的协议就是 HTTP 和 TCP 了吧，所以在今天的内容里，我简单地说一下如何编写 HTTP 和 TCP 脚本，以应测试主题。</p>
<p>我先画个图说明一下。</p>
<p>这样的图做性能的人一定要知道，相信很多人也画的出来。</p>
<p>我们知道 HTTP 是应用层的协议之一，现在很多场景都在用它，并且是用的 HTTP1.1 的版本，对应的是 RFC2616，当然还有补充协议 RFC7231、6265。</p>
<p>HTTP 中只规定了传输的规则，规定了请求、响应、连接、方法、状态定义等。我们写脚本的时候，必须符合这些规则。比如为什么要在脚本中定义个 Header？Header 里为什么要那样写？这些在 RFC 中都说得明明白白了。</p>
<p>还有一点也需要注意，HTTP 是通过 Socket 来使用 TCP 的，Socket 做为套接层 API，它本身不是协议，只规定了 API。</p>
<p>而我们通常在 JMeter 中写 TCP 脚本，就是直接调用 Socket 层的 API。TCP 脚本和 HTTP 脚本最大的区别就是，TCP 脚本中发送和接收的内容完全取决于 Socket server 是怎么处理的，并没有通用的规则。所以脚本中也就只有根据具体的项目来发挥了。</p>
<p>手工编写 HTTP 脚本</p>
<p>服务端代码逻辑说明</p>
<p>我们先自己编写一小段服务端代码的逻辑。现在用 Spring Boot 写一个示例，其实就是分分钟的事情。我们做性能测试的人至少要知道访问的是什么东西。</p>
<p>Controller 关键代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="err">@</span><span class="nx">RestController</span><span class="err">@</span><span class="nx">RequestMapping</span><span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&#34;pa&#34;</span><span class="p">)</span><span class="kr">public</span> <span class="kr">class</span> <span class="nx">PAController</span> <span class="p">{</span>  <span class="err">@</span><span class="nx">Autowired</span>  <span class="kr">private</span> <span class="nx">PAService</span> <span class="nx">paService</span><span class="p">;</span>  <span class="c1">// 查询  @GetMapping(&#34;/query/{id}&#34;)  public ResultVO&lt;User&gt; getById(@PathVariable(&#34;id&#34;) String id) {    User user = paService.getById(id);    return ResultVO.&lt;User&gt;builder().success(user).build();  }}
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Service 关键代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">  <span class="kr">public</span> <span class="nx">User</span> <span class="nx">getById</span><span class="p">(</span><span class="nb">String</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>    <span class="k">return</span> <span class="nx">mapper</span><span class="p">.</span><span class="nx">selectByPrimaryKey</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>用 MyBatis 组件实现对 Mapper 的操作。由于不是基础开发教程，这里只是为了说明逻辑，如果你感兴趣的话，可以自己编写一个接口示例。</p>
<p>逻辑调用关系如下：</p>
<p>数据库中表的信息如下：</p>
<p>我们先看这个接口的访问逻辑：JMeter——SprintBoot 的应用——MySQL。</p>
<p>1. 编写 JMeter 脚本</p>
<p>1.1 创建线程组</p>
<p>首先创建一个线程组，配置如下：</p>
<p>在这个线程组中，有几个关键配置，我来一一说明一下。</p>
<p>Number of Threads(users)：我们都知道这是 JMeter 中的线程数，也可以称之为用户数。但是在第 2 篇文章中，我已经说得非常明确了，这个线程数是产生 TPS 的，而一个线程产生多少 TPS，取决于系统的响应时间有多快。所以我们用 TPS 这个概念来承载系统的负载能力，而不是用这里的线程数。</p>
<p>Ramp-up Period(in seconds)：递增时间，以秒为单位。指的就是上面配置的线程数将在多长时间内会全部递增完。如果我们配置了 100 线程，这里配置为 10 秒，那么就是 100/(10s*1000ms)=1 线程 /10ms；如果我们配置了 10 线程，这里配置为 1 秒，则是 10/1000=1 线程 /10ms。这时我们要注意了哦，在 10 线程启动的这个阶段中，对服务器的压力是一样的。示意图如下：</p>
<p>Loop Count 这个值指的是一个线程中脚本迭代的次数。这里你需要注意，这个值和后面的 Scheduler 有一个判断关系，下面我们会提到。</p>
<p>Delay Thread creation until needed：这个含义从字面看不是特别清楚。这里有一个默认的知识点，那就是 JMeter 所有的线程是一开始就创建完成的，只是递增的时候会按照上面的规则递增。如果选择了这个选项，则不会在一开始创建所有线程，只有在需要时才会创建。这一点和 LoadRunner 中的初始化选项类似。只是不知道你有没有注意过，基本上，我们做性能测试的工程师，很少有选择这个选项的。选与不选之间，区别到底是什么呢？</p>
<p>如果不选择，在启动场景时，JMeter 会用更多的 CPU 来创建线程，它会影响前面的一些请求的响应时间，因为压力机的 CPU 在做其他事情嘛。</p>
<p>如果选择了的话，就会在使用时再创建，CPU 消耗会平均一些，但是这时会有另一个隐患，就是会稍微影响正在跑的线程。这个选项，选择与否，取决于压力机在执行过程中，它能产生多大的影响。如果你的线程数很多，一旦启动，压力机的 CPU 都被消耗在创建线程上了，那就可以考虑选择它，否则，可以不选择。</p>
<p>Scheduler Configuration：这里有一句重要的话，
If Loop Count is not -1 or Forever, duration will be min(Duration, Loop Count * iteration duration)
。举例来说，如果设置了 Loop Count 为 100，而响应时间是 0.1 秒，那么 Loop
Count * iteration duration(这个就是响应时间) = 100 * 0.1 = 10秒
。</p>
<p>即便设置了 Scheduler 的 Duration 为 100 秒，线程仍然会以 10 秒为结束点。</p>
<p>如果没有设置 Scheduler 的 Duration，那么你会看到，在 JMeter 运行到 10 秒时，控制台中会出现如下信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">  <span class="mi">2019</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">26</span> <span class="mi">10</span><span class="o">:</span><span class="mi">39</span><span class="o">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">521</span> <span class="nx">INFO</span> <span class="nx">o</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">j</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="o">:</span> <span class="nx">Thread</span> <span class="nx">finished</span><span class="o">:</span> <span class="nx">Thread</span> <span class="nx">Group</span> <span class="mi">1</span><span class="o">-</span><span class="mi">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>有些人不太理解这一点，经常会设置迭代次数，同时又设置 Scheduler 中的 Duration。而对 TPS 来说，就会产生这样的图：</p>
<p>场景没执行完，结果 TPS 全掉下去了，于是开始查后端系统，其实和后端没有任何关系。</p>
<p>1.2 创建 HTTP Sampler</p>
<p>1.2.1 GET 接口</p>
<p>看上图，我将 Method 选择为 GET。为什么要选择它？往上看我们的接口注解，这是一个 GetMapping，所以这里要选择 GET。</p>
<p>再看 path 中，这里是
/pa/query/0808050c-0ae0-11ea-af5f-00163e124cff
，对应着
“/query/{id}”
。</p>
<p>然后执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">User</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">paService</span><span class="p">.</span><span class="nx">getById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>返回执行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">ResultVO</span><span class="p">.</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="nx">builder</span><span class="p">().</span><span class="nx">success</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">build</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为什么要解释这一段呢？</p>
<p>做开发的人可能会觉得，你这个解释毫无意义呀，代码里已经写得很清楚了。事实上，在我的工作经历中，会发现很多做性能测试脚本的，实际上并不知道后端采用了什么样的技术，实现的是什么样的逻辑。</p>
<p>所以还是希望你可以自己写一些 demo，去了解一些逻辑，然后在排除问题的时候，就非常清楚了。</p>
<p>接着我们执行脚本，就得到了如下结果：</p>
<p>这样一个最简单的 GET 脚本就做好了。</p>
<p>前面我们提到过，URL 中的 ID 是 0808050c-0ae0-11ea-af5f-00163e124cff，这个数据来自于数据库中的第一条。</p>
<p>如果我们随便写一个数据，会得到什么结果呢？</p>
<p>你会看到，结果一样得到了 200 的 code，但是这个结果明显就不对了，明明没有查到，还是返回了成功。</p>
<p>所以说，业务的成功，只能靠业务来判断。这里只是查询成功了，没返回数据也是查询成功了。我将在后面给你说明如何加断言。</p>
<p>1.2.2 POST 接口</p>
<p>下面我将 Method 改为 POST，POST 接口与 GET 接口的区别有这么几处：</p>
<p>要把 Path 改为 /pa/add；</p>
<p>输入 JSON 格式的 Body Data。</p>
<p>执行起来，查看下结果。</p>
<p>你会发现上来就错了，提示如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s2">&#34;status&#34;</span><span class="o">:</span><span class="mi">415</span><span class="p">,</span><span class="s2">&#34;error&#34;</span><span class="o">:</span><span class="s2">&#34;Unsupported Media Type&#34;</span><span class="p">,</span><span class="s2">&#34;message&#34;</span><span class="o">:</span><span class="s2">&#34;Content type &#39;text/plain;charset=UTF-8&#39; not supported&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里你需要注意，无论遇到什么问题，都要针对问题来处理。当看不懂问题信息时，先查资料，想办法看懂。这是处理问题的关键，我发现很多做性能测试的新同学，一旦碰到问题就懵了，晕头转向地瞎尝试。</p>
<p>我经常对我的团队成员说，先看懂问题，再处理问题，别瞎蒙！</p>
<p>上面这个问题其实提示得很清楚：“不支持的媒体类型”。这里就两个信息，一个是 Content type，一个是 charset。它们是 JMeter 中 HTTP Header 里默认自带的。我们要发送的是 JSON 数据，而 JMeter 默认是把它当成 text 发出去的，这就出现了问题。所以我们要加一个 Header，将 Content type 指定为 JSON。</p>
<p>加一个 HTTP Header，如下所示：</p>
<p>如果你不知道加什么样的 Header，建议你用 HTTP 抓包工具抓一个看一看，比如说用 Charles，抓到如下信息：</p>
<p>这时你就会知道头里的 Content-Type 原来是
application/json;charset=UTF-8
。这里的 charset=UTF-8 可以不用写，因为它和默认的一样。</p>
<p>这时再回放，你就会看到如下结果：</p>
<p>到此，一个 POST 脚本就完成了。是不是很简单。</p>
<p>在这里，我需要跟你强调的是，手工编写 HTTP 脚本时，要注意以下几点：</p>
<p>要知道请求的类型，我们选择的类型和后端接口的实现类型要是一致的。</p>
<p>业务的成功要有明确的业务判断（在下面的 TCP 中，我们再加断言来判断）。</p>
<p>判断问题时，请求的逻辑路径要清晰。</p>
<p>编写完 HTTP 脚本时，我们再来看一下如何编写 TCP 脚本。</p>
<p>手工编写 TCP 脚本</p>
<p>服务端代码逻辑说明</p>
<p>我在这里写一个非常简单的服务端接收线程（如果你是开发，不要笑话，我只是为了说明脚本怎么写）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">package</span> <span class="nx">demo</span><span class="p">.</span><span class="nx">socket</span><span class="p">;</span><span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">IOException</span><span class="p">;</span><span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">InputStream</span><span class="p">;</span><span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">OutputStream</span><span class="p">;</span><span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">ServerSocket</span><span class="p">;</span><span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">Socket</span><span class="p">;</span><span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">concurrent</span><span class="p">.</span><span class="nx">ArrayBlockingQueue</span><span class="p">;</span><span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">concurrent</span><span class="p">.</span><span class="nx">ThreadPoolExecutor</span><span class="p">;</span><span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">concurrent</span><span class="p">.</span><span class="nx">TimeUnit</span><span class="p">;</span><span class="kr">public</span> <span class="kr">class</span> <span class="nx">SocketReceiver</span> <span class="p">{</span>  <span class="c1">// 定义初始  public static final int corePoolSize = 5;  // 定义最大线程池  public static final int maximumPoolSize = 5;  // 定义 socket 队列长度  public static final int blockingQueue = 50;  /\*\*   \* 初始化并启动服务   \*/  public void init() {    // 定义线程池    ThreadPoolExecutor executor = new ThreadPoolExecutor(corePoolSize, maximumPoolSize, 0L,        TimeUnit.MILLISECONDS, new ArrayBlockingQueue(blockingQueue));    // 定义 serverSocket    ServerSocket serverSocket = null;    try {      // 启动 serverSocket      serverSocket = new ServerSocket(Constants.PORT);      // 输出服务启动地址      System.out.println(&#34; 服务已启动:&#34; + serverSocket.getLocalSocketAddress().toString());      // 接收信息并传递给线程池      while (true) {        Socket socket = serverSocket.accept();        executor.submit(new Handler(socket));      }    } catch (IOException e) {      e.printStackTrace();    } finally {      if (serverSocket != null) {        try {          serverSocket.close(); // 释放 serverSocket        } catch (IOException e) {          e.printStackTrace();        }      }    }  }  // 处理请求类  class Handler implements Runnable {    private Socket socket;    public Handler(Socket socket) {      this.socket = socket;    }    public void run() {      try {        // 接收客户端的信息        InputStream in = socket.getInputStream();        int count = 0;        while (count == 0) {          count = in.available();        }        byte\[\] b = new byte\[count\];        in.read(b);        String message = new String(b);        System.out.println(&#34; receive request: &#34; + socket.getInetAddress() + &#34; &#34; + message);        // 睡 2 秒模拟思考时间，这里是为了模拟服务器端的业务处理时间        try {          Thread.sleep(2000);        } catch (InterruptedException e) {          e.printStackTrace();        }        // 向客户端发送确认消息        // 定义输出流 outer        OutputStream outer = socket.getOutputStream();        // 将客户端发送的信息加上确认信息 ok        String response = message + &#34; is OK&#34;;        // 将输入信息保存到 b\_out 中        byte\[\] b\_out = response.getBytes();        // 写入输入流        outer.write(b\_out);        // 推送输入流到客户端        outer.flush();      } catch (IOException e) {        e.printStackTrace();      } finally {        // 关闭 socket        try {          socket.close();        } catch (IOException e) {          e.printStackTrace();        }      }    }  }  // 程序入口  public static void main(String\[\] args) {    // 定义服务端    SocketReceiver receiver = new SocketReceiver();    // 启动服务端    receiver.init();  }}
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>编写 JMeter 脚本</p>
<p>首先创建 TCP Sampler。右键点击 Thread Group - Add - Sampler - TCP Sampler 即可创建。</p>
<p>输入配置和要发送的信息。</p>
<p>IP 地址和端口是必须要输入的。对于创建一个 TCP 协议的 JMeter 脚本来说，简单地说，过程就是这样的：创建连接 - 发数据 - 关闭连接。</p>
<p>就这样，这个手工的脚本就完成了。</p>
<p>你可能会问，就这么简单吗？是的，手工编写就是这么简单。</p>
<p>但是（对嘛，但是才是重点），通常我们在创建 TCP 协议的脚本时，都是根据业务接口规范来说的，复杂点其实不在脚本本身上，而是在接口的规则上。</p>
<p>添加断言</p>
<p>我回放了一下脚本，发现如下情况：</p>
<p>都执行对了呀，为什么下面的没有返回信息呢？这种情况下只有第一个请求有返回信息，但是下面也没有报错。这里就需要注意了。</p>
<p>测试工具的成功，并不等于业务的成功。</p>
<p>所以我们必须要做的就是响应断言，也就是返回值的判断。在 JMeter 中，断言有以下这些：</p>
<p>因为今天的文章不是工具的教程，所以我不打算全讲一遍。这里我只用最基础的响应断言。什么是断言呢？</p>
<p>断言指的就是服务器端有一个业务成功的标识，会传递给客户端，客户端判断是否正常接收到了这个标识的过程。</p>
<p>在这里我添加了一个断言，用以判断服务器是否返回了 OK。 你要注意这个“OK”是从哪来的哦，它是从服务端的这一行代码中来的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"> <span class="nb">String</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">message</span> <span class="o">+</span> <span class="s2">&#34; is OK&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>请注意，这个断言的信息，一是可以判断出业务的正确性。我在工作中发现有些人用页面中一些并不必要的文字来判断，这样就不对了，我们应该用有业务含义的判断标识。</p>
<p>如果我们再次回放脚本，你会发现除了第一个请求，后面 9 个请求都错了。</p>
<p>所以，在做脚本时，请你一定要注意，断言是必须要加的。</p>
<p>长短连接的问题</p>
<p>既然有错，肯定是要处理。我们查看一下 JMeter 的控制台错误信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="mi">2019</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">26</span> <span class="mi">09</span><span class="o">:</span><span class="mi">51</span><span class="o">:</span><span class="mi">51</span><span class="p">,</span><span class="mi">587</span> <span class="nx">ERROR</span> <span class="nx">o</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">j</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">TCPSampler</span><span class="o">:</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">SocketException</span><span class="o">:</span> <span class="nx">Broken</span> <span class="nx">pipe</span> <span class="p">(</span><span class="nx">Write</span> <span class="nx">failed</span><span class="p">)</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">SocketOutputStream</span><span class="p">.</span><span class="nx">socketWrite0</span><span class="p">(</span><span class="nx">Native</span> <span class="nx">Method</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">SocketOutputStream</span><span class="p">.</span><span class="nx">socketWrite</span><span class="p">(</span><span class="nx">SocketOutputStream</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">109</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">SocketOutputStream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">SocketOutputStream</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">141</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">tcp</span><span class="p">.</span><span class="nx">sampler</span><span class="p">.</span><span class="nx">TCPClientImpl</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">TCPClientImpl</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">78</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_tcp</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">tcp</span><span class="p">.</span><span class="nx">sampler</span><span class="p">.</span><span class="nx">TCPSampler</span><span class="p">.</span><span class="nx">sample</span><span class="p">(</span><span class="nx">TCPSampler</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">401</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_tcp</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">threads</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">doSampling</span><span class="p">(</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">622</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_core</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">threads</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">executeSamplePackage</span><span class="p">(</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">546</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_core</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">threads</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">processSampler</span><span class="p">(</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">486</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_core</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">threads</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">253</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_core</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Thread</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">Thread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">745</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从字面上来看，就是通道瓦塔（被破坏）了，Broken pipe。这个提示表明客户端上没有这个连接了，而 JMeter 还以为有这个链接，于是接着用这个链接来发，显然是找不到这个通道，于是就报错了。</p>
<p>这是一个典型的压力工具这边的问题。</p>
<p>而服务端，只收到了一条请求。</p>
<p>为什么会报这个错呢？因为我们代码是短链接的，服务端处理完之后，就把这个链接给断掉了。</p>
<p>这里是压力机上的抓包信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// 从这里开始，上面已经看到了有 Fin（结束）包了，后面还在发 Push（发送数据）包。显然是通不了，还被服务端啪啪抽了两次 reset。11:58:07.042915 IP localhost.57677 &gt; 60.205.107.9.m-oap: Flags \[P.\], seq 34:67, ack 41, win 4119, options \[nop,nop,TS val 163718903 ecr 2122793206\], length 3311:58:07.046075 IP localhost.57677 &gt; 60.205.107.9.m-oap: Flags \[FP.\], seq 67:331, ack 41, win 4119, options \[nop,nop,TS val 163718906 ecr 2122793206\], length 26411:58:07.076393 IP 60.205.107.9.m-oap &gt; localhost.57677: Flags \[R\], seq 3986768192, win 0, length 011:58:07.079156 IP 60.205.107.9.m-oap &gt; localhost.57677: Flags \[R\], seq 3986768192, win 0, length 0
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>服务端的抓包信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// 服务端也是没有办法，只能在看到了 Push 包之后，给回了个 Reset 包。11:58:07.047001 IP 124.64.16.240.bones &gt; 7dgroup1.enc-eps-mc-sec: Flags \[P.\], seq 34:67, ack 41, win 4119, options \[nop,nop,TS val 163718903 ecr 2122793206\], length 3311:58:07.047077 IP 7dgroup1.enc-eps-mc-sec &gt; 124.64.16.240.bones: Flags \[R\], seq 3986768192, win 0, length 011:58:07.054757 IP 124.64.16.240.bones &gt; 7dgroup1.enc-eps-mc-sec: Flags \[FP.\], seq 67:331, ack 41, win 4119, options \[nop,nop,TS val 163718906 ecr 2122793206\], length 26411:58:07.054844 IP 7dgroup1.enc-eps-mc-sec &gt; 124.64.16.240.bones: Flags \[R\], seq 3986768192, win 0, length 0
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这是为什么呢？因为在 JMeter 中，默认是复用 TCP 连接的，但是在我们这个示例中，服务端并没有保存这个连接。所以，我们应该在脚本中，把下图中的 Re-use connection 给去掉。</p>
<p>这时再回放脚本，你就会发现 10 次迭代全都对了。如下图所示：</p>
<p>但是，这里还有一个知识点，希望你注意。短连接的时候，必然会产生更多的 TCP 连接的创建和销毁，对性能来说，这会让系统变得缓慢。</p>
<p>所以你可以看到上面 10 条迭代全都对了的同时，响应时间也增加了。</p>
<p>可能会有人问，那这怎么办呢？长短连接的选择取决于业务的需要，如果必须用短链接，那可能就需要更多的 CPU 来支撑；要是长连接，就需要更多的内存来支撑（用以保存 TCP 连接）。</p>
<p>根据业务需要，我们选择一个合适的就好。</p>
<p>TCP 连接超时</p>
<p>这个问题，应该说非常常见，我们这里只做问题的现象说明和解决，不做原理的探讨。原理的部分，我会在监控和分析部分加一说明。</p>
<p>下面这个错误，属于典型的主机连不上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">ConnectException</span><span class="o">:</span> <span class="nx">Operation</span> <span class="nx">timed</span> <span class="nx">out</span> <span class="p">(</span><span class="nx">Connection</span> <span class="nx">timed</span> <span class="nx">out</span><span class="p">)</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">PlainSocketImpl</span><span class="p">.</span><span class="nx">socketConnect</span><span class="p">(</span><span class="nx">Native</span> <span class="nx">Method</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">AbstractPlainSocketImpl</span><span class="p">.</span><span class="nx">doConnect</span><span class="p">(</span><span class="nx">AbstractPlainSocketImpl</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">350</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">AbstractPlainSocketImpl</span><span class="p">.</span><span class="nx">connectToAddress</span><span class="p">(</span><span class="nx">AbstractPlainSocketImpl</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">206</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">AbstractPlainSocketImpl</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">AbstractPlainSocketImpl</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">188</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">SocksSocketImpl</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">SocksSocketImpl</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">392</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">589</span><span class="p">)</span> <span class="o">~</span><span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">tcp</span><span class="p">.</span><span class="nx">sampler</span><span class="p">.</span><span class="nx">TCPSampler</span><span class="p">.</span><span class="nx">getSocket</span><span class="p">(</span><span class="nx">TCPSampler</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">168</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_tcp</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">tcp</span><span class="p">.</span><span class="nx">sampler</span><span class="p">.</span><span class="nx">TCPSampler</span><span class="p">.</span><span class="nx">sample</span><span class="p">(</span><span class="nx">TCPSampler</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">384</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_tcp</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">threads</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">doSampling</span><span class="p">(</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">622</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_core</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">threads</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">executeSamplePackage</span><span class="p">(</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">546</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_core</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">threads</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">processSampler</span><span class="p">(</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">486</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_core</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">org</span><span class="p">.</span><span class="nx">apache</span><span class="p">.</span><span class="nx">jmeter</span><span class="p">.</span><span class="nx">threads</span><span class="p">.</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">JMeterThread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">253</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="nx">ApacheJMeter</span><span class="err">\</span><span class="nx">_core</span><span class="p">.</span><span class="nx">jar</span><span class="o">:</span><span class="mf">5.1</span><span class="p">.</span><span class="mi">1</span> <span class="nx">r1855137</span><span class="err">\</span><span class="p">]</span>  <span class="nx">at</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Thread</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">Thread</span><span class="p">.</span><span class="nx">java</span><span class="o">:</span><span class="mi">745</span><span class="p">)</span> <span class="err">\</span><span class="p">[</span><span class="o">?:</span><span class="mf">1.8</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="nx">_111</span><span class="err">\</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>time out 是个如果你理解了逻辑，就觉得很简单，如果没理解逻辑，就觉得非常复杂的问题。</p>
<p>要想解决这个问题，就要先确定服务端是可以正常连通的。</p>
<p>如果不能正常连通，那么通常都是 IP 不正确、端口不正确、防火墙阻止之类的问题。解决了网络连通性的问题，就可以解决 connection timed out 的问题。</p>
<p>编写 LoadRunner 脚本</p>
<p>针对上面这个示例，如果你要想编写一个 LoadRunner 的示例脚本，也是简单到不行。</p>
<p>首先创建一个空的 winsock 脚本，复制下面代码到 action 里面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// 创建 socket1lrs\_create\_socket(&#34;socket1&#34;, &#34;TCP&#34;, &#34;RemoteHost=60.205.10.9:5567&#34;, LrsLastArg); // 走 socket1, 发送 buf1 中定义的数据lrs\_send (&#34;socket1&#34;, &#34;buf1&#34;, LrsLastArg ); // 走 socket1，接收数据保存在 buf2 中lrs\_receive(&#34;socket1&#34;, &#34;buf2&#34;,  LrsLastArg); // 关掉 socket1lrs\_close\_socket(&#34;socket1&#34;); 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>从上面的信息就可以看到，socket1 这个标识是我们操作的基础。如果你在一个脚本中想处理两个 socket，也是可以的，只要控制好你的标识不会乱就行。</p>
<p>接着再将下面的内容复制到 data.ws 里面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">send</span> <span class="nx">buf1</span> <span class="mi">5</span>    <span class="s2">&#34;12345&#34;</span><span class="nx">recv</span> <span class="nx">buf2</span> <span class="mi">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>你可能会问，这个 recv 怎么不写返回的值是什么？</p>
<p>当你手写 socket 脚本的时候，都还没有运行，你怎么知道返回值是什么呢？所以这里，可以不用写。</p>
<p>而 recv 后面的 10 是指接收 10 个字节。如果多了怎么办？截掉？！不会的，LoadRunner 还是会把所有信息全部接收并保存下来，除非你提前定义了截取字符长度的函数。</p>
<p>最后看下我们回放的结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">Action</span><span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span> <span class="nx">lrs</span><span class="err">\</span><span class="nx">_create</span><span class="err">\</span><span class="nx">_socket</span><span class="p">(</span><span class="nx">socket1</span><span class="p">,</span> <span class="nx">TCP</span><span class="p">,</span> <span class="p">...)</span><span class="nx">Action</span><span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">:</span> <span class="nx">lrs</span><span class="err">\</span><span class="nx">_send</span><span class="p">(</span><span class="nx">socket1</span><span class="p">,</span> <span class="nx">buf1</span><span class="p">)</span><span class="nx">Action</span><span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">:</span> <span class="nx">lrs</span><span class="err">\</span><span class="nx">_receive</span><span class="p">(</span><span class="nx">socket1</span><span class="p">,</span> <span class="nx">buf2</span><span class="p">)</span><span class="nx">Action</span><span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">:</span> <span class="nx">Mismatch</span> <span class="k">in</span> <span class="nx">buffer</span><span class="err">&#39;</span><span class="nx">s</span> <span class="nx">length</span> <span class="p">(</span><span class="nx">expected</span> <span class="mi">10</span> <span class="nx">bytes</span><span class="p">,</span> <span class="mi">11</span> <span class="nx">bytes</span> <span class="nx">actually</span> <span class="nx">received</span><span class="p">,</span> <span class="nx">difference</span> <span class="k">in</span> <span class="mi">1</span> <span class="nx">bytes</span><span class="p">)</span><span class="err">\</span><span class="o">================================</span><span class="nx">EXPECTED</span> <span class="nx">BUFFER</span><span class="o">================================</span><span class="err">\</span><span class="o">===============================================================================</span><span class="err">\</span><span class="o">================================</span><span class="nx">RECEIVED</span> <span class="nx">BUFFER</span><span class="o">================================</span>  <span class="s2">&#34;12345 is OK&#34;</span><span class="err">\</span><span class="o">===============================================================================</span><span class="nx">Action</span><span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">:</span> <span class="nx">callRecv</span><span class="o">:</span><span class="mi">11</span> <span class="nx">bytes</span> <span class="nx">were</span> <span class="nx">receivedAction</span><span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">:</span> <span class="nx">lrs</span><span class="err">\</span><span class="nx">_close</span><span class="err">\</span><span class="nx">_socket</span><span class="p">(</span><span class="nx">socket1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看，脚本正常执行了，只是报了一个 Mismatch，这是因为我们定义了 buf2 是 10 字节，而我们实际上接收了 11 字节，所以这里给出了 Mismatch。</p>
<p>到此，一个 LoadRunner 的手工 TCP 脚本就完成了。后面我们就可以根据需要，增强脚本了，加个参数化、关联、检查点等等。</p>
<p>总结</p>
<p>其实这篇文章只想告诉你一件事情，手工编写脚本，从基础上说，是非常简单的，只是有三点需要特别强调：</p>
<p>涉及到业务规则和逻辑判断之后，编写脚本就复杂了起来。但是了解业务规则是做脚本的前提条件，也是性能测试工程师的第一步。</p>
<p>编写脚本的时候，要知道后端的逻辑。这里的意思不是说，你一开始写脚本的时候，就要去读后端的代码，而是说你在遇到问题的时候，要分析整个链路上每个环节使用到了什么技术，以便快速地分析判断。</p>
<p>写脚本是以最简为最佳，用不着故意复杂。</p>
<p>脚本的细节功能有很多，而现在我们可以看到市场上的书籍也好，文档也好，基本上是在教人如何用工具，很少会从前到后地说明一个数据从哪发到哪，谁来处理这样的逻辑。</p>
<p>希望学习性能测试工具的你，不仅知其然，更知其所以然。</p>
<p>思考题</p>
<p>学习完今天的内容，你不妨思考一下，HTTP 的 GET 和 POST 请求，在后端处理中有什么不同？断言的作用是什么？如何使用断言呢？</p>
<p>欢迎你在评论区写下你的思考，也欢迎把这篇文章分享给你的朋友或者同事，一起交流一下。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/">性能测试实战30讲</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%98/0906embedding%E6%89%80%E6%9C%89%E4%BA%BA%E9%83%BD%E5%9C%A8%E8%B0%88%E7%9A%84embedding%E6%8A%80%E6%9C%AF%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">0906｜Embedding所有人都在谈的Embedding技术到底是什么</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/sql%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/0908%E4%B8%A8%E4%BB%80%E4%B9%88%E6%98%AFsql%E7%9A%84%E8%81%9A%E9%9B%86%E5%87%BD%E6%95%B0%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8%E5%AE%83%E4%BB%AC%E6%B1%87%E6%80%BB%E8%A1%A8%E7%9A%84%E6%95%B0%E6%8D%AE/">
            <span class="next-text nav-default">0908丨什么是SQL的聚集函数如何利用它们汇总表的数据</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
