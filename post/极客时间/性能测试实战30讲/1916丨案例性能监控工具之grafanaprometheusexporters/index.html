<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>1916丨案例性能监控工具之GrafanaPrometheusExporters - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="16丨案例：性能监控工具之Grafana&#43;Prometheus&#43;Exporters
在本模块中，我将把几个常用的监控部分给梳理一下。前面我们提到过，在性能监控图谱中，有操作系统、应用服务器、中间件、队列、缓存、数据库、网络、前端、负载均衡、Web 服务器、存储、代码等很多需要监控的点。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/1916%E4%B8%A8%E6%A1%88%E4%BE%8B%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E4%B9%8Bgrafanaprometheusexporters/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/1916%E4%B8%A8%E6%A1%88%E4%BE%8B%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E4%B9%8Bgrafanaprometheusexporters/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="1916丨案例性能监控工具之GrafanaPrometheusExporters">
  <meta property="og:description" content="16丨案例：性能监控工具之Grafana&#43;Prometheus&#43;Exporters
在本模块中，我将把几个常用的监控部分给梳理一下。前面我们提到过，在性能监控图谱中，有操作系统、应用服务器、中间件、队列、缓存、数据库、网络、前端、负载均衡、Web 服务器、存储、代码等很多需要监控的点。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="性能测试实战30讲">

  <meta itemprop="name" content="1916丨案例性能监控工具之GrafanaPrometheusExporters">
  <meta itemprop="description" content="16丨案例：性能监控工具之Grafana&#43;Prometheus&#43;Exporters
在本模块中，我将把几个常用的监控部分给梳理一下。前面我们提到过，在性能监控图谱中，有操作系统、应用服务器、中间件、队列、缓存、数据库、网络、前端、负载均衡、Web 服务器、存储、代码等很多需要监控的点。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="3964">
  <meta itemprop="keywords" content="性能测试实战30讲">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="1916丨案例性能监控工具之GrafanaPrometheusExporters">
  <meta name="twitter:description" content="16丨案例：性能监控工具之Grafana&#43;Prometheus&#43;Exporters
在本模块中，我将把几个常用的监控部分给梳理一下。前面我们提到过，在性能监控图谱中，有操作系统、应用服务器、中间件、队列、缓存、数据库、网络、前端、负载均衡、Web 服务器、存储、代码等很多需要监控的点。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">1916丨案例性能监控工具之GrafanaPrometheusExporters</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 3964 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>16丨案例：性能监控工具之Grafana+Prometheus+Exporters</p>
<p>在本模块中，我将把几个常用的监控部分给梳理一下。前面我们提到过，在性能监控图谱中，有操作系统、应用服务器、中间件、队列、缓存、数据库、网络、前端、负载均衡、Web 服务器、存储、代码等很多需要监控的点。</p>
<p>显然这些监控点不能在一个专栏中全部覆盖并一一细化，我只能找最常用的几个，做些逻辑思路的说明，同时也把具体的实现描述出来。如果你遇到了其他的组件，也需要一一实现这些监控。</p>
<p>在本篇中，主要想说明白下图的这个监控逻辑。</p>
<p>这应该是现在最流行的一套监控逻辑了吧。</p>
<p>我今天把常见的使用 Grafana、Prometheus、InfluxDB、Exporters 的数据展示方式说一下，如果你刚进入性能测试领域，也能有一个感性的认识。</p>
<p>有测试工具，有监控工具，才能做后续的性能分析和瓶颈定位，所以有必要把这些工具的逻辑跟你摆一摆。</p>
<p>所有做性能的人都应该知道一点，不管数据以什么样的形式展示，最要紧的还是看数据的来源和含义，以便做出正确的判断。</p>
<p>我先说明一下 JMeter 和 node_exporter 到 Grafana 的数据展示逻辑。至于其他的 Exporter，我就不再解释这个逻辑了，只说监控分析的部分。</p>
<p>JMeter+InfluxDB+Grafana 的数据展示逻辑</p>
<p>一般情况下，我们用 JMeter 做压力测试时，都是使用 JMeter 的控制台来查看结果。如下图所示：</p>
<p>或者装个插件来看结果：</p>
<p>或者用 JMeter 来生成 HTML：</p>
<p>这样看都没有问题，我们在前面也强调过，对于压力工具来说，我们最多只关心三条曲线的数据：TPS（T 由测试目标定义）、响应时间、错误率。这里的错误率还只是辅助排查问题的曲线，没有问题时，只看 TPS 和响应时间即可。</p>
<p>不过采取以上三种方式有几个方面的问题。</p>
<p>整理结果时比较浪费时间。</p>
<p>在 GUI 用插件看曲线，做高并发时并不现实。</p>
<p>在场景运行时间比较长的时候，采用生成 HTML 的方式，会出现消耗内存过大的情况，而实际上，在生成的结果图中，有很多生成的图我们并不是那么关注。</p>
<p>生成的结果保存之后再查看比较麻烦，还要一个个去找。</p>
<p>那么如何解决这几个问题呢？</p>
<p>用 JMeter 的 Backend Listener 帮我们实时发送数据到 InfluxDB 或 Graphite 可以解决这样的问题。Graphite Backend Listener 的支持是在 JMeter 2.13 版本，InfluxdDB Backend Listener 的支持是在 JMeter 3.3 的版本，它们都是用异步的方式把数据发送出来，以便查看。</p>
<p>其实有这个 JMeter 发送给 InfluxDB 的数据之后，我们不需要看上面的那些 HTML 数据，也可以直观地看到系统性能的性能趋势。并且这样保存下来的数据，在测试结束后想再次查看也比较方便比对。</p>
<p>JMeter+InfluxDB+Grafana 的结构如下：</p>
<p>在这个结构中，JMeter 发送压力到服务器的同时，统计下 TPS、响应时间、线程数、错误率等信息。默认每 30 秒在控制台输出一次结果（在 jmeter.properties 中有一个参数 #summariser.interval=30 可以控制）。配置了 Backend Listener 之后，将统计出的结果异步发送到 InfluxDB 中。最后在 Grafana 中配置 InfluxDB 数据源和 JMeter 显示模板。</p>
<p>然后就可以实时查看 JMeter 的测试结果了，这里看到的数据和控制台的数据是一样。</p>
<p>但如果这么简单就说完了，这篇文章也就没价值了。下面我们来说一下，数据的传输和展示逻辑。</p>
<p>JMeter 中 Backend Listener 的配置</p>
<p>下面我们就 InfluxDB 的 Backend Listener 做个说明。它的配置比较简单，在脚本中加上即可。</p>
<p>我们先配置好 influxdb Url、application 等信息，application 这个配置可以看成是场景名。</p>
<p>那么 JMeter 如何将数据发给 InfluxDB 呢？请看源码中的关键代码，如下所示：</p>
<p><code>    private void addMetrics(String transaction, SamplerMetric metric) {        // FOR ALL STATUS        addMetric(transaction, metric.getTotal(), metric.getSentBytes(), metric.getReceivedBytes(), TAG\_ALL, metric.getAllMean(), metric.getAllMinTime(),                metric.getAllMaxTime(), allPercentiles.values(), metric::getAllPercentile);        // FOR OK STATUS        addMetric(transaction, metric.getSuccesses(), null, null, TAG\_OK, metric.getOkMean(), metric.getOkMinTime(),                metric.getOkMaxTime(), okPercentiles.values(), metric::getOkPercentile);        // FOR KO STATUS        addMetric(transaction, metric.getFailures(), null, null, TAG\_KO, metric.getKoMean(), metric.getKoMinTime(),                metric.getKoMaxTime(), koPercentiles.values(), metric::getKoPercentile);​​        metric.getErrors().forEach((error, count) -&gt; addErrorMetric(transaction, error.getResponseCode(),                    error.getResponseMessage(), count));    }</code></p>
<p>从这段代码可以看出，站在全局统计的视角来看，这里把 JMeter 运行的统计结果，比如事务的 Total 请求、发送接收字节、平均值、最大值、最小值等，都加到 metric 中，同时也会把成功和失败的事务信息添加到 metric 中去。</p>
<p>在源码中，还有更多的添加 metric 的步骤，你有兴趣的话，也可以看一下 JMeter 源码中的
InfluxdbBackendListenerClient.java
。</p>
<p>保存了 metric 之后，再使用 InfluxdbMetricsSender 发送到 Influxdb 中去。发送关键代码如下：</p>
<p><code>   @Override    public void writeAndSendMetrics() { ........        if (!copyMetrics.isEmpty()) {            try {                if(httpRequest == null) {                    httpRequest = createRequest(url);                }                StringBuilder sb = new StringBuilder(copyMetrics.size()\*35);                for (MetricTuple metric : copyMetrics) {                    // Add TimeStamp in nanosecond from epoch ( default in InfluxDB )                    sb.append(metric.measurement)                        .append(metric.tag)                        .append(&quot; &quot;) //$NON-NLS-1$                        .append(metric.field)                        .append(&quot; &quot;)                        .append(metric.timestamp+&quot;000000&quot;)                         .append(&quot;\\n&quot;); //$NON-NLS-1$                }                StringEntity entity = new StringEntity(sb.toString(), StandardCharsets.UTF\_8);                                httpRequest.setEntity(entity);                lastRequest = httpClient.execute(httpRequest, new FutureCallback&lt;HttpResponse&gt;() {                    @Override                    public void completed(final HttpResponse response) {                        int code = response.getStatusLine().getStatusCode();                        /\*                         \* HTTP response summary 2xx: If your write request received                         \* HTTP 204 No Content, it was a success! 4xx: InfluxDB                         \* could not understand the request. 5xx: The system is                         \* overloaded or significantly impaired.                         \*/                        if (MetricUtils.isSuccessCode(code)) {                            if(log.isDebugEnabled()) {                                log.debug(&quot;Success, number of metrics written: {}&quot;, copyMetrics.size());                            }                         } else {                            log.error(&quot;Error writing metrics to influxDB Url: {}, responseCode: {}, responseBody: {}&quot;, url, code, getBody(response));                        }                    }                    @Override                    public void failed(final Exception ex) {                        log.error(&quot;failed to send data to influxDB server : {}&quot;, ex.getMessage());                    }                    @Override                    public void cancelled() {                        log.warn(&quot;Request to influxDB server was cancelled&quot;);                    }                });                ........            }        }    }</code></p>
<p>通过 writeAndSendMetrics，就将所有保存的 metrix 都发给了 InfluxDB。</p>
<p>InfluxDB 中的存储结构</p>
<p>然后我们再来看下 InfluxDB 中如何存储：</p>
<p><code>\&gt; show databasesname: databasesname\----\_internaljmeter\&gt; use jmeterUsing database jmeter\&gt;\&gt; show MEASUREMENTSname: measurementsname\----eventsjmeter\&gt; select \* from events where application='7ddemo'name: eventstime                application text                title\----                ----------- ----                -----1575255462806000000 7ddemo      Test Cycle1 started ApacheJMeter1575256463820000000 7ddemo      Test Cycle1 ended   ApacheJMeter..............n&gt; select \* from jmeter where application='7ddemo' limit 10name: jmetertime                application avg                count countError endedT hit max maxAT meanAT min minAT pct90.0            pct95.0           pct99.0 rb responseCode responseMessage sb startedT statut transaction\----                ----------- ---                ----- ---------- ------ --- --- ----- ------ --- ----- -------            -------           ------- -- ------------ --------------- -- -------- ------ -----------1575255462821000000 7ddemo                                          0              0     0          0                                                                                     0               internal1575255467818000000 7ddemo      232.82352941176472 17    0                 17  849              122       384.9999999999996  849               849     0                               0           all    all1575255467824000000 7ddemo      232.82352941176472 17                          849              122       384.9999999999996  849               849     0                               0           all    0\_openIndexPage1575255467826000000 7ddemo      232.82352941176472 17                          849              122       384.9999999999996  849               849                                                 ok     0\_openIndexPage1575255467829000000 7ddemo                                          0              1     1          1                                                                                     1               internal1575255472811000000 7ddemo      205.4418604651163  26    0                 26  849              122       252.6              271.4             849     0                               0           all    all1575255472812000000 7ddemo                                          0              1     1          1                                                                                     1               internal1575255472812000000 7ddemo      205.4418604651163  26                          849              122       252.6              271.4             849                                                 ok     0\_openIndexPage1575255472812000000 7ddemo      205.4418604651163  26                          849              122       252.6              271.4             849     0                               0           all    0\_openIndexPage1575255477811000000 7ddemo      198.2142857142857  27    0                 27  849              117       263.79999999999995 292.3500000000001 849     0                               0           all    all</code></p>
<p>这段代码也就是说，在 InfluxDB 中，创建了两个 MEASUREMENTS，分别是 events 和 jmeter。这两个各自存了数据，我们在界面中配置的 testtile 和 eventTags 放在了 events 这个 MEASUREMENTS 中。在模板中这两个值暂时都是不用的。</p>
<p>在 jmeter 这个 MEASUREMENTS 中，我们可以看到 application 和事务的统计信息，这些值和控制台一致。</p>
<p>在 Grafana 中显示的时候，就是从这个表中取出的数据，根据时序做的曲线。</p>
<p>Grafana 中的配置</p>
<p>有了 JMeter 发送到 InfluxDB 中的数据，下面就来配置一下 Grafana 中的展示。首先，要配置一个 InfluxDB 数据源。如下所示：</p>
<p>在这里配置好 URL、Database、User、Password 之后，直接点击保存即可。</p>
<p>然后添加一个 JMeter dashboard，我们常用的 dashboard 是 Grafana 官方 ID 为 5496 的模板。导入进来后，选择好对应的数据源。</p>
<p>然后就看到界面了。</p>
<p>这时还没有数据，我们稍后做个示例，看下 JMeter 中的数据怎么和这个界面的数据对应起来。</p>
<p>我们先看下图中两个重要的数据查询语句吧。</p>
<p>TPS 曲线：</p>
<p><code>SELECT last(&quot;count&quot;) / $send\_interval FROM &quot;$measurement\_name&quot; WHERE (&quot;transaction&quot; =~ /^$transaction$/ AND &quot;statut&quot; = 'ok') AND $timeFilter GROUP BY time($\_\_interval)</code></p>
<p>上面这个就是 Total TPS 了，在这里称为 throughput。关于这个概念，我在第一篇中就已经有了说明，这里再次提醒，概念的使用在团队中要有统一的认识，不要受行业内一些传统信息的误导。</p>
<p>这里取的数据来自 MEASUREMENTS 中成功状态的所有事务。</p>
<p>响应时间曲线：</p>
<p><code>SELECT mean(&quot;pct95.0&quot;) FROM &quot;$measurement\_name&quot; WHERE (&quot;application&quot; =~ /^$application$/) AND $timeFilter GROUP BY &quot;transaction&quot;, time($\_\_interval) fill(null)</code></p>
<p>这里是用 95 pct 内的响应时间画出来的曲线。</p>
<p>整体展示出来的效果如下：</p>
<p>数据比对</p>
<p>首先，我们在 JMeter 中配置一个简单的场景。10 个线程，每个线程迭代 10 次，以及两个 HTTP 请求。</p>
<p>也就是说，这时会产生 10x10x2=200 次请求。我们用 JMeter 跑起来看一下。</p>
<p>看到了吧，这个请求数和我们预想的一样。下面我们看一下 Grafana 中展示出来的结果。</p>
<p>还有针对每个事务的统计情况。</p>
<p>至此，JMeter 到 Grafana 的展示过程就完成了。以后我们就不用再保存 JMeter 的执行结果了，也不用等着 JMeter 输出 HTML 了。</p>
<p>node_exporter+Prometheus+Grafana 的数据展示逻辑</p>
<p>对性能测试来说，在常用的 Grafana+Prometheus+Exporter 的逻辑中，第一步要看的就是操作系统资源了。所以在这一篇中，我们将以 node_exporter 为例来说明一下操作系统抽取数据的逻辑，以便知道监控数据的来源，至于数据的含义，我们将在后续的文章中继续描述。</p>
<p>首先，我们还是要画一个图。</p>
<p>现在 node_exporter 可以支持很多个操作系统了。官方列表如下：</p>
<p>当然不是说只支持这些，你也可以扩展自己的 Exporter。</p>
<p>配置 node_exporter</p>
<p>node_exporter 目录如下：</p>
<p><code>\[root@7dgroup2 node\_exporter-0.18.1.linux-amd64\]# lltotal 16524\-rw-r--r-- 1 3434 3434    11357 Jun  5 00:50 LICENSE\-rwxr-xr-x 1 3434 3434 16878582 Jun  5 00:41 node\_exporter\-rw-r--r-- 1 3434 3434      463 Jun  5 00:50 NOTICE</code></p>
<p>启动：</p>
<p><code>\[root@7dgroup2 node\_exporter-0.18.1.linux-amd64\]#./node\_exporter --web.listen-address=:9200 &amp;</code></p>
<p>是不是很简洁？如果想看更多的功能 ，可以查看下它的帮助。</p>
<p>配置 Prometheus</p>
<p>先下载 Prometheus：</p>
<p><code>\[root@7dgroup2 data\]# wget -c https://github.com/prometheus/prometheus/releases/download/v2.14.0/prometheus-2.14.0.linux-amd64.tar.gz..........100%\[=============================================================================================&gt;\] 58,625,125   465KB/s   in 6m 4s2019-11-29 15:40:16 (157 KB/s) - ‘prometheus-2.14.0.linux-amd64.tar.gz’ saved \[58625125/58625125\]\[root@7dgroup2 data\]</code></p>
<p>解压之后，我们可以看到目录结构如下：</p>
<p><code>\[root@7dgroup2 prometheus-2.11.1.linux-amd64\]# lltotal 120288drwxr-xr-x. 2 3434 3434     4096 Jul 10 23:26 console\_librariesdrwxr-xr-x. 2 3434 3434     4096 Jul 10 23:26 consolesdrwxr-xr-x. 3 root root     4096 Nov 30 12:55 data\-rw-r--r--. 1 3434 3434    11357 Jul 10 23:26 LICENSE\-rw-r--r--. 1 root root       35 Aug  7 23:19 node.yml\-rw-r--r--. 1 3434 3434     2770 Jul 10 23:26 NOTICE\-rwxr-xr-x. 1 3434 3434 76328852 Jul 10 21:53 prometheus\-rw-r--r--  1 3434 3434     1864 Sep 21 09:36 prometheus.yml\-rwxr-xr-x. 1 3434 3434 46672881 Jul 10 21:54 promtool\[root@7dgroup2 prometheus-2.11.1.linux-amd64\]#</code></p>
<p>在
prometheus.yml
中添加如下配置，以取数据：</p>
<p><code>  - job\_name: 's1'    static\_configs:    - targets: \['172.17.211.143:9200'\]</code></p>
<p>启动：</p>
<p><code>\[root@7dgroup2 data\]# ./prometheus --config.file=prometheus.yml &amp;</code></p>
<p>这样就行了吗？当然不是。根据上面的流程图，我们还需要配置 Grafana。</p>
<p>配置 Grafana</p>
<p>首先配置一个数据源，非常简单。如下所示：</p>
<p>再配置一个 node_exporter 的模板，比如我这里选择了官方模板（ID：11074），展示如下：</p>
<p>数据逻辑说明</p>
<p>说明完上面的过程之后，对我们做性能测试和分析的人来说，最重要的，就是要知道数据的来源和含义了。</p>
<p>拿上面图中的 CPU 使用率来说吧（因为 CPU 使用率是非常重要的一个计数器，所以我们今天先拿它来开刀）。</p>
<p>我们先点一下 title 上的 edit，看一下它的 query 语句。</p>
<p><code>avg(irate(node\_cpu\_seconds\_total{instance=~&quot;$node&quot;,mode=&quot;system&quot;}\[30m\])) by (instance)avg(irate(node\_cpu\_seconds\_total{instance=~&quot;$node&quot;,mode=&quot;user&quot;}\[30m\])) by (instance)avg(irate(node\_cpu\_seconds\_total{instance=~&quot;$node&quot;,mode=&quot;iowait&quot;}\[30m\])) by (instance)1 - avg(irate(node\_cpu\_seconds\_total{instance=~&quot;$node&quot;,mode=&quot;idle&quot;}\[30m\])) by (instance)</code></p>
<p>这些都是从 Prometheus 中取出来的数据，查询语句读了 Prometheus 中
node_cpu_seconds_total
的不同的模块数据。</p>
<p>下面我们来看一下，
node_exporter
暴露出来的计数器。</p>
<p>这些值和 top 一样，都来自于
/proc/
目录。下面这张图是 top 数据，我们可以比对一下。</p>
<p>到此，我们就了解到了操作系统中监控数据的取值逻辑了，也就是从操作系统本身的计数器中取出值来，然后传给 Prometheus，再由 Grafana 中的 query 语句查出相应的数据，最后由 Grafana 展示在界面上。</p>
<p>总结</p>
<p>为什么要解释数据的逻辑呢？</p>
<p>因为最近在工作中遇到一些情况，有人觉得有了 Prometheus+Grafana+Exportor 这样的组合工具之后，基本上都不再用手工执行什么命令了。但我们要了解的是，对于监控平台来说，它取的所有的数据必然是被监控者可以提供的数据，像 node_exporter 这样小巧的监控收集器，它可以获取的监控数据，并不是整个系统全部的性能数据，只是取到了常见的计数器而已。</p>
<p>这些计数器不管是用命令查看，还是用这样炫酷的工具查看，它的值本身都不会变。所以不管是在监控平台上看到的数据，还是在命令行中看到的数据，我们最重要的是要知道含义以及这些值的变化对性能测试和分析的下一步骤的影响。</p>
<p>后面我们将着重来解释这些细节。</p>
<p>问题</p>
<p>最后我问两个问题吧，，第一个问题是，JMeter 如何把数据推送到 Grafana 中呢？另外，同样是监控操作系统的计数器，监控平台中的数据和监控命令中的数据有什么区别？</p>
<p>欢迎你在评论区写下你的思考，也欢迎把这篇文章分享给你的朋友或者同事，一起交流一下。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/">性能测试实战30讲</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/python%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8A%9E%E5%85%AC%E5%AE%9E%E6%88%98%E8%AF%BE/1914vba%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95excel%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E7%9A%84%E6%89%B9%E9%87%8F%E6%89%93%E5%8D%B0/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">1914｜VBA脚本编程如何扩展Excel实现文件的批量打印</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/sql%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/1918%E4%B8%A8sqlalchemy%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8pythonorm%E6%A1%86%E6%9E%B6%E6%9D%A5%E6%93%8D%E4%BD%9Cmysql/">
            <span class="next-text nav-default">1918丨SQLAlchemy如何使用PythonORM框架来操作MySQL</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
