<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>03丨套接字和地址：像电话和电话号码一样理解它们 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="在网络编程中，我们经常会提到 socket 这个词，它的中文翻译为套接字，有的时候也叫做套接口。
socket 这个英文单词的原意是“插口”“插槽”，在网络编程中，它的寓意是可以通过插口接入的方式，快速完成网络连接和数据收发。你可以把它想象成现实世界的电源插口，或者是早期上网需要的网络插槽，所以 socket 也可以看做是对物理世界的直接映射。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/03%E4%B8%A8%E5%A5%97%E6%8E%A5%E5%AD%97%E5%92%8C%E5%9C%B0%E5%9D%80%E5%83%8F%E7%94%B5%E8%AF%9D%E5%92%8C%E7%94%B5%E8%AF%9D%E5%8F%B7%E7%A0%81%E4%B8%80%E6%A0%B7%E7%90%86%E8%A7%A3%E5%AE%83%E4%BB%AC/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/03%E4%B8%A8%E5%A5%97%E6%8E%A5%E5%AD%97%E5%92%8C%E5%9C%B0%E5%9D%80%E5%83%8F%E7%94%B5%E8%AF%9D%E5%92%8C%E7%94%B5%E8%AF%9D%E5%8F%B7%E7%A0%81%E4%B8%80%E6%A0%B7%E7%90%86%E8%A7%A3%E5%AE%83%E4%BB%AC/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="03丨套接字和地址：像电话和电话号码一样理解它们">
  <meta property="og:description" content="在网络编程中，我们经常会提到 socket 这个词，它的中文翻译为套接字，有的时候也叫做套接口。
socket 这个英文单词的原意是“插口”“插槽”，在网络编程中，它的寓意是可以通过插口接入的方式，快速完成网络连接和数据收发。你可以把它想象成现实世界的电源插口，或者是早期上网需要的网络插槽，所以 socket 也可以看做是对物理世界的直接映射。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="网络编程实战">

  <meta itemprop="name" content="03丨套接字和地址：像电话和电话号码一样理解它们">
  <meta itemprop="description" content="在网络编程中，我们经常会提到 socket 这个词，它的中文翻译为套接字，有的时候也叫做套接口。
socket 这个英文单词的原意是“插口”“插槽”，在网络编程中，它的寓意是可以通过插口接入的方式，快速完成网络连接和数据收发。你可以把它想象成现实世界的电源插口，或者是早期上网需要的网络插槽，所以 socket 也可以看做是对物理世界的直接映射。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="4012">
  <meta itemprop="keywords" content="网络编程实战">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="03丨套接字和地址：像电话和电话号码一样理解它们">
  <meta name="twitter:description" content="在网络编程中，我们经常会提到 socket 这个词，它的中文翻译为套接字，有的时候也叫做套接口。
socket 这个英文单词的原意是“插口”“插槽”，在网络编程中，它的寓意是可以通过插口接入的方式，快速完成网络连接和数据收发。你可以把它想象成现实世界的电源插口，或者是早期上网需要的网络插槽，所以 socket 也可以看做是对物理世界的直接映射。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">03丨套接字和地址：像电话和电话号码一样理解它们</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 4012 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#socket-到底是什么">socket 到底是什么？</a>
          <ul>
            <li><a href="#更好地理解-socket一个更直观的解释">更好地理解 socket：一个更直观的解释</a></li>
            <li><a href="#socket-的发展历史">socket 的发展历史</a></li>
          </ul>
        </li>
        <li><a href="#套接字地址格式">套接字地址格式</a>
          <ul>
            <li><a href="#通用套接字地址格式">通用套接字地址格式</a></li>
            <li><a href="#ipv4-套接字格式地址">IPv4 套接字格式地址</a></li>
            <li><a href="#ipv6-套接字地址格式">IPv6 套接字地址格式</a></li>
            <li><a href="#几种套接字地址格式比较">几种套接字地址格式比较</a></li>
          </ul>
        </li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#思考题">思考题</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>在网络编程中，我们经常会提到 socket 这个词，它的中文翻译为套接字，有的时候也叫做套接口。</p>
<p>socket 这个英文单词的原意是“插口”“插槽”，在网络编程中，它的寓意是可以通过插口接入的方式，快速完成网络连接和数据收发。你可以把它想象成现实世界的电源插口，或者是早期上网需要的网络插槽，所以 socket 也可以看做是对物理世界的直接映射。</p>
<p>其实计算机程序设计是一门和英文有着紧密联系的学科，很多专有名词使用英文原词比翻译成中文更容易让大家接受。为了方便，在专栏里我们一般会直接使用英文，如果需要翻译就一律用“套接字”这个翻译。</p>
<h2 id="socket-到底是什么">socket 到底是什么？</h2>
<p>在网络编程中，到底应该怎么理解 socket 呢？我在这里先呈上这么一张图，你可以先看看。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/03df911e671f84b9beb1463ded36b940.png" alt=""><br>
这张图表达的其实是网络编程中，客户端和服务器工作的核心逻辑。</p>
<p>我们先从右侧的服务器端开始看，因为在客户端发起连接请求之前，服务器端必须初始化好。右侧的图显示的是服务器端初始化的过程，首先初始化 socket，之后服务器端需要执行 bind 函数，将自己的服务能力绑定在一个众所周知的地址和端口上，紧接着，服务器端执行 listen 操作，将原先的 socket 转化为服务端的 socket，服务端最后阻塞在 accept 上等待客户端请求的到来。</p>
<p>此时，服务器端已经准备就绪。客户端需要先初始化 socket，再执行 connect 向服务器端的地址和端口发起连接请求，这里的地址和端口必须是客户端预先知晓的。这个过程，就是著名的<strong>TCP 三次握手</strong>（Three-way Handshake）。下一篇文章，我会详细讲到 TCP 三次握手的原理。</p>
<p>一旦三次握手完成，客户端和服务器端建立连接，就进入了数据传输过程。</p>
<p>具体来说，客户端进程向操作系统内核发起 write 字节流写操作，内核协议栈将字节流通过网络设备传输到服务器端，服务器端从内核得到信息，将字节流从内核读入到进程中，并开始业务逻辑的处理，完成之后，服务器端再将得到的结果以同样的方式写给客户端。可以看到，<strong>一旦连接建立，数据的传输就不再是单向的，而是双向的，这也是 TCP 的一个显著特性</strong>。</p>
<p>当客户端完成和服务器端的交互后，比如执行一次 Telnet 操作，或者一次 HTTP 请求，需要和服务器端断开连接时，就会执行 close 函数，操作系统内核此时会通过原先的连接链路向服务器端发送一个 FIN 包，服务器收到之后执行被动关闭，这时候整个链路处于半关闭状态，此后，服务器端也会执行 close 函数，整个链路才会真正关闭。半关闭的状态下，发起 close 请求的一方在没有收到对方 FIN 包之前都认为连接是正常的；而在全关闭的状态下，双方都感知连接已经关闭。</p>
<p>请你牢牢记住文章开头的那幅图，它是贯穿整个专栏的核心图之一。</p>
<p>讲这幅图的真正用意在于引入 socket 的概念，请注意，以上所有的操作，都是通过 socket 来完成的。无论是客户端的 connect，还是服务端的 accept，或者 read/write 操作等，<strong>socket 是我们用来建立连接，传输数据的唯一途径</strong>。</p>
<h3 id="更好地理解-socket一个更直观的解释">更好地理解 socket：一个更直观的解释</h3>
<p>你可以把整个 TCP 的网络交互和数据传输想象成打电话，顺着这个思路想象，socket 就好像是我们手里的电话机，connect 就好比拿着电话机拨号，而服务器端的 bind 就好比是去电信公司开户，将电话号码和我们家里的电话机绑定，这样别人就可以用这个号码找到你，listen 就好似人们在家里听到了响铃，accept 就好比是被叫的一方拿起电话开始应答。至此，三次握手就完成了，连接建立完毕。</p>
<p>接下来，拨打电话的人开始说话：“你好。”这时就进入了 write，接收电话的人听到的过程可以想象成 read（听到并读出数据），并且开始应答，双方就进入了 read/write 的数据传输过程。</p>
<p>最后，拨打电话的人完成了此次交流，挂上电话，对应的操作可以理解为 close，接听电话的人知道对方已挂机，也挂上电话，也是一次 close。</p>
<p>在整个电话交流过程中，电话是我们可以和外面通信的设备，对应到网络编程的世界里，socket 也是我们可以和外界进行网络通信的途径。</p>
<h3 id="socket-的发展历史">socket 的发展历史</h3>
<p>通过上面的讲解和这个打电话的类比，你现在清楚 socket 到底是什么了吧？那 socket 最开始是怎么被提出来的呢？接下来就很有必要一起来简单追溯一下它的历史了。</p>
<p>socket 是加州大学伯克利分校的研究人员在 20 世纪 80 年代早期提出的，所以也被叫做伯克利套接字。伯克利的研究者们设想用 socket 的概念，屏蔽掉底层协议栈的差别。第一版实现 socket 的就是 TCP/IP 协议，最早是在 BSD 4.2 Unix 内核上实现了 socket。很快大家就发现这么一个概念带来了网络编程的便利，于是有更多人也接触到了 socket 的概念。Linux 作为 Unix 系统的一个开源实现，很早就从头开发实现了 TCP/IP 协议，伴随着 socket 的成功，Windows 也引入了 socket 的概念。于是在今天的世界里，socket 成为网络互联互通的标准。</p>
<h2 id="套接字地址格式">套接字地址格式</h2>
<p>在使用套接字时，首先要解决通信双方寻址的问题。我们需要套接字的地址建立连接，就像打电话时首先需要查找电话簿，找到你想要联系的那个人，你才可以建立连接，开始交流。接下来，我们重点讨论套接字的地址格式。</p>
<h3 id="通用套接字地址格式">通用套接字地址格式</h3>
<p>下面先看一下套接字的<strong>通用</strong>地址结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/* POSIX.1g 规范规定了地址族为 2 字节的值.  */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">typedef unsigned short int sa_family_t;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/* 描述通用套接字地址  */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">struct sockaddr{
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    sa_family_t sa_family;  /* 地址族.  16-bit*/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    char sa_data[14];   /* 具体的地址值 112-bit */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  }; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个结构体里，第一个字段是地址族，它表示使用什么样的方式对地址进行解释和保存，好比电话簿里的手机格式，或者是固话格式，这两种格式的长度和含义都是不同的。地址族在 glibc 里的定义非常多，常用的有以下几种：</p>
<ul>
<li>AF_LOCAL：表示的是本地地址，对应的是 Unix 套接字，这种情况一般用于本地 socket 通信，很多情况下也可以写成 AF_UNIX、AF_FILE；</li>
<li>AF_INET：因特网使用的 IPv4 地址；</li>
<li>AF_INET6：因特网使用的 IPv6 地址。</li>
</ul>
<p>这里的 AF_ 表示的含义是 Address Family，但是很多情况下，我们也会看到以 PF_ 表示的宏，比如 PF_INET、PF_INET6 等，实际上 PF_ 的意思是 Protocol Family，也就是协议族的意思。我们用 AF_xxx 这样的值来初始化 socket 地址，用 PF_xxx 这样的值来初始化 socket。我们在 &lt;sys/socket.h&gt; 头文件中可以清晰地看到，这两个值本身就是一一对应的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/* 各种地址族的宏定义  */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_UNSPEC PF_UNSPEC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_LOCAL  PF_LOCAL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_UNIX   PF_UNIX
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_FILE   PF_FILE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_INET   PF_INET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_AX25   PF_AX25
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_IPX    PF_IPX
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_APPLETALK  PF_APPLETALK
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_NETROM PF_NETROM
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_BRIDGE PF_BRIDGE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_ATMPVC PF_ATMPVC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_X25    PF_X25
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define AF_INET6  PF_INET6
</span></span></code></pre></td></tr></table>
</div>
</div><p>sockaddr 是一个通用的地址结构，通用的意思是适用于多种地址族。为什么定义这么一个通用地址结构呢，这个放在后面讲。</p>
<h3 id="ipv4-套接字格式地址">IPv4 套接字格式地址</h3>
<p>接下来，看一下常用的 IPv4 地址族的结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/* IPV4 套接字地址，32bit 值.  */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">typedef uint32_t in_addr_t;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">struct in_addr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    in_addr_t s_addr;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  };
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  /* 描述 IPV4 的套接字地址格式  */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">struct sockaddr_in
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    sa_family_t sin_family; /* 16-bit */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    in_port_t sin_port;     /* 端口口  16-bit*/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    struct in_addr sin_addr;    /* Internet address. 32-bit */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      /* 这里仅仅用作占位符，不做实际用处  */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    unsigned char sin_zero[8];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  };
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们对这个结构体稍作解读，首先可以发现和 sockaddr 一样，都有一个 16-bit 的 sin_family 字段，对于 IPv4 来说这个值就是 AF_INET。</p>
<p>接下来是端口号，我们可以看到端口号最多是 16-bit，也就是说最大支持 2 的 16 次方，这个数字是 65536，所以我们应该知道支持寻址的端口号最多就是 65535。关于端口，我在前面的章节也提到过，这里重点阐述一下保留端口。所谓保留端口就是大家约定俗成的，已经被对应服务广为使用的端口，比如 ftp 的 21 端口，ssh 的 22 端口，http 的 80 端口等。一般而言，大于 5000 的端口可以作为我们自己应用程序的端口使用。</p>
<p>下面是 glibc 定义的保留端口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Standard</span> <span class="n">well</span><span class="o">-</span><span class="n">known</span> <span class="n">ports</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">enum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_ECHO</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>    <span class="o">/*</span> <span class="n">Echo</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_DISCARD</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>   <span class="o">/*</span> <span class="n">Discard</span> <span class="n">transmissions</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_SYSTAT</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>   <span class="o">/*</span> <span class="n">System</span> <span class="n">status</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_DAYTIME</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>  <span class="o">/*</span> <span class="n">Time</span> <span class="n">of</span> <span class="n">day</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_NETSTAT</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>  <span class="o">/*</span> <span class="n">Network</span> <span class="n">status</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_FTP</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>    <span class="o">/*</span> <span class="ne">File</span> <span class="n">Transfer</span> <span class="n">Protocol</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_TELNET</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span>   <span class="o">/*</span> <span class="n">Telnet</span> <span class="n">protocol</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_SMTP</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>   <span class="o">/*</span> <span class="n">Simple</span> <span class="n">Mail</span> <span class="n">Transfer</span> <span class="n">Protocol</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_TIMESERVER</span> <span class="o">=</span> <span class="mi">37</span><span class="p">,</span> <span class="o">/*</span> <span class="n">Timeserver</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_NAMESERVER</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="o">/*</span> <span class="n">Domain</span> <span class="n">Name</span> <span class="n">Service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_WHOIS</span> <span class="o">=</span> <span class="mi">43</span><span class="p">,</span>    <span class="o">/*</span> <span class="n">Internet</span> <span class="n">Whois</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_MTP</span> <span class="o">=</span> <span class="mi">57</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IPPORT_TFTP</span> <span class="o">=</span> <span class="mi">69</span><span class="p">,</span>   <span class="o">/*</span> <span class="n">Trivial</span> <span class="ne">File</span> <span class="n">Transfer</span> <span class="n">Protocol</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_RJE</span> <span class="o">=</span> <span class="mi">77</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_FINGER</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span>   <span class="o">/*</span> <span class="n">Finger</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_TTYLINK</span> <span class="o">=</span> <span class="mi">87</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_SUPDUP</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span>   <span class="o">/*</span> <span class="n">SUPDUP</span> <span class="n">protocol</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">IPPORT_EXECSERVER</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>  <span class="o">/*</span> <span class="n">execd</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_LOGINSERVER</span> <span class="o">=</span> <span class="mi">513</span><span class="p">,</span> <span class="o">/*</span> <span class="n">rlogind</span> <span class="n">service</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_CMDSERVER</span> <span class="o">=</span> <span class="mi">514</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_EFSSERVER</span> <span class="o">=</span> <span class="mi">520</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">/*</span> <span class="n">UDP</span> <span class="n">ports</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_BIFFUDP</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_WHOSERVER</span> <span class="o">=</span> <span class="mi">513</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_ROUTESERVER</span> <span class="o">=</span> <span class="mi">520</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">/*</span> <span class="n">Ports</span> <span class="n">less</span> <span class="n">than</span> <span class="n">this</span> <span class="n">value</span> <span class="n">are</span> <span class="n">reserved</span> <span class="k">for</span> <span class="n">privileged</span> <span class="n">processes</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_RESERVED</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">/*</span> <span class="n">Ports</span> <span class="n">greater</span> <span class="n">this</span> <span class="n">value</span> <span class="n">are</span> <span class="n">reserved</span> <span class="k">for</span> <span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">privileged</span><span class="p">)</span> <span class="n">servers</span><span class="o">.</span>  <span class="o">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPPORT_USERRESERVED</span> <span class="o">=</span> <span class="mi">5000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>实际的 IPv4 地址是一个 32-bit 的字段，可以想象最多支持的地址数就是 2 的 32 次方，大约是 42 亿，应该说这个数字在设计之初还是非常巨大的，无奈互联网蓬勃发展，全球接入的设备越来越多，这个数字渐渐显得不太够用了，于是大家所熟知的 IPv6 就隆重登场了。</p>
<h3 id="ipv6-套接字地址格式">IPv6 套接字地址格式</h3>
<p>我们再看看 IPv6 的地址结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">struct sockaddr_in6
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    sa_family_t sin6_family; /* 16-bit */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    in_port_t sin6_port;  /* 传输端口号 # 16-bit */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    uint32_t sin6_flowinfo; /* IPv6 流控信息 32-bit*/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    struct in6_addr sin6_addr;  /* IPv6 地址 128-bit */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    uint32_t sin6_scope_id; /* IPv6 域 ID 32-bit */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  };
</span></span></code></pre></td></tr></table>
</div>
</div><p>整个结构体长度是 28 个字节，其中流控信息和域 IP 先不用管，这两个字段，一个在 glibc 的官网上根本没出现，另一个是当前未使用的字段。这里的地址族显然应该是 AF_INET6，端口同 IPv4 地址一样，关键的地址从 32 位升级到 128 位，这个数字就大到恐怖了，完全解决了寻址数字不够的问题。</p>
<p>请注意，以上无论 IPv4 还是 IPv6 的地址格式都是因特网套接字的格式，还有一种本地套接字格式，用来做为本地进程间的通信，也就是前面提到的 AF_LOCAL。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">struct sockaddr_un {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    unsigned short sun_family; /* 固定为 AF_LOCAL */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    char sun_path[108];   /* 路径名 */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">};
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="几种套接字地址格式比较">几种套接字地址格式比较</h3>
<p>这几种地址的比较见下图，IPv4 和 IPv6 套接字地址结构的长度是固定的，而本地地址结构的长度是可变的。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/ff91d129b4dfb418a981d12f2aa39aca.png" alt=""></p>
<h2 id="总结">总结</h2>
<p>这一讲我们重点讲述了什么是套接字，以及对应的套接字地址格式。套接字作为网络编程的基础，概念异常重要。套接字的设计为我们打开了网络编程的大门，实际上，正是因为 BSD 套接字如此成功，各大 Unix 厂商（包括开源的 Linux）以及 Windows 平台才会很快照搬了过来。在下一讲中，我们将开始创建并使用套接字，建立连接，进一步开始我们的网络编程之旅。</p>
<h2 id="思考题">思考题</h2>
<p>最后给你留两道思考题吧，你可以想一想 IPv4、IPv6、本地套接字格式以及通用地址套接字，它们有什么共性呢？如果你是 BSD 套接字的设计者，你为什么要这样设计呢？</p>
<p>第二道题是，为什么本地套接字格式不需要端口号，而 IPv4 和 IPv6 套接字格式却需要端口号呢？</p>
<p>我在评论区期待你的思考与见解，如果你觉得这篇文章对你有所帮助，欢迎点击“请朋友读”，把这篇文章分享给你朋友或同事。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/5a282807b2a1ff091b7f803e8cef3429.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">网络编程实战</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%81%8C%E5%9C%BA%E6%B1%82%E7%94%9F%E6%94%BB%E7%95%A5/03%E4%B8%A8%E6%B2%9F%E9%80%9A%E7%A8%8B%E5%BA%8F%E5%91%98%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BA%94%E8%AF%A5%E7%88%B1%E4%B8%8A%E4%BA%A4%E6%B5%81/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">03丨沟通：程序员为什么应该爱上交流？</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/kubernetes%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/03%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%8E%A9%E8%BD%ACkubernete%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">
            <span class="next-text nav-default">03集群搭建：手把手教你玩转Kubernete集群搭建</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
