<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>34_Amazon热销榜Beam_Pipeline实战 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是蔡元楠。
今天我要与你分享的主题是“Amazon 热销榜 Beam Pipeline 实战”。
两个月前，亚马逊（Amazon）宣布将关闭中国国内电商业务的消息你一定还记忆犹新。虽然亚马逊遗憾离场，但它依然是目前全球市值最高的电商公司。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/34_amazon%E7%83%AD%E9%94%80%E6%A6%9Cbeam_pipeline%E5%AE%9E%E6%88%98/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/34_amazon%E7%83%AD%E9%94%80%E6%A6%9Cbeam_pipeline%E5%AE%9E%E6%88%98/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="34_Amazon热销榜Beam_Pipeline实战">
  <meta property="og:description" content="你好，我是蔡元楠。
今天我要与你分享的主题是“Amazon 热销榜 Beam Pipeline 实战”。
两个月前，亚马逊（Amazon）宣布将关闭中国国内电商业务的消息你一定还记忆犹新。虽然亚马逊遗憾离场，但它依然是目前全球市值最高的电商公司。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="大规模数据处理实战">

  <meta itemprop="name" content="34_Amazon热销榜Beam_Pipeline实战">
  <meta itemprop="description" content="你好，我是蔡元楠。
今天我要与你分享的主题是“Amazon 热销榜 Beam Pipeline 实战”。
两个月前，亚马逊（Amazon）宣布将关闭中国国内电商业务的消息你一定还记忆犹新。虽然亚马逊遗憾离场，但它依然是目前全球市值最高的电商公司。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="4175">
  <meta itemprop="keywords" content="大规模数据处理实战">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="34_Amazon热销榜Beam_Pipeline实战">
  <meta name="twitter:description" content="你好，我是蔡元楠。
今天我要与你分享的主题是“Amazon 热销榜 Beam Pipeline 实战”。
两个月前，亚马逊（Amazon）宣布将关闭中国国内电商业务的消息你一定还记忆犹新。虽然亚马逊遗憾离场，但它依然是目前全球市值最高的电商公司。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">34_Amazon热销榜Beam_Pipeline实战</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 4175 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#1-怎样用批处理计算基础的热销商品列表热销商品的存储和-serving-设计">1. 怎样用批处理计算基础的热销商品列表、热销商品的存储和 serving 设计？</a></li>
            <li><a href="#2-怎样设计每小时更新的热销榜单">2. 怎样设计每小时更新的热销榜单？</a></li>
            <li><a href="#3-怎样设计商品去重处理流水线和怎样根据商品在售状态过滤热销商品">3. 怎样设计商品去重处理流水线和怎样根据商品在售状态过滤热销商品？</a></li>
            <li><a href="#4-怎样按不同的商品门类生成榜单">4. 怎样按不同的商品门类生成榜单？</a></li>
          </ul>
        </li>
        <li><a href="#小结">小结</a></li>
        <li><a href="#思考题">思考题</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是蔡元楠。</p>
<p>今天我要与你分享的主题是“Amazon 热销榜 Beam Pipeline 实战”。</p>
<p>两个月前，亚马逊（Amazon）宣布将关闭中国国内电商业务的消息你一定还记忆犹新。虽然亚马逊遗憾离场，但它依然是目前全球市值最高的电商公司。</p>
<p>作为美国最大的一家网络电子商务公司，亚马逊的总部位于华盛顿州的西雅图。类似于 BAT 在国内的地位，亚马逊也是北美互联网 FAANG 五大巨头之一，其他四个分别是 Facebook、Apple、Netflix 和 Google。</p>
<p>亚马逊的热销商品系统就如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/825c55e507ac87c5c28c4dbaf7dbe6c7.png" alt=""></p>
<p>当我搜索“攀岩鞋”时，搜索结果的第三个被打上了“热销商品”的标签，这样能帮助消费者快速做出购买决策。</p>
<p>当我点击这个“Best Seller”的标签时，我可以浏览“攀岩鞋”这个商品分类中浏览销量最高的前 100 个商品。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/9eb42b5b6d00cd0bf506d78e2084765f.png" alt=""></p>
<p>这些贴心的功能都是由热销商品系统实现的。</p>
<p>这一讲我们就来看看在这样的热销商品系统中，怎样应用之前所学的 Beam 数据处理技术吧。今天，我们主要会解决一个热销商品系统数据处理架构中的这几个问题：</p>
<ol>
<li>怎样用批处理计算基础的热销商品列表、热销商品的存储和 serving 设计？</li>
<li>怎样设计每小时更新的热销榜单？</li>
<li>怎样设计商品去重处理流水线和怎样根据商品在售状态过滤热销商品？</li>
<li>怎样按不同的商品门类生成榜单？</li>
</ol>
<h3 id="1-怎样用批处理计算基础的热销商品列表热销商品的存储和-serving-设计">1. 怎样用批处理计算基础的热销商品列表、热销商品的存储和 serving 设计？</h3>
<p>我们先来看最简单的问题设置，怎样用批处理计算基础的热销商品列表。</p>
<p>假设你的电商网站销售着 10 亿件商品，并且已经跟踪了网站的销售记录：商品 id 和购买时间 {product_id, timestamp}，整个交易记录是 1000 亿行数据，TB 级。举个例子，假设我们的数据是这样的：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/22c333d45d5900bb2b5f72a978e1be5a.png" alt=""></p>
<p>我们可以把热销榜按 product_id 排名为：1，2，3。</p>
<p>你现在有没有觉得这个问题似曾相识呢？的确，我们在<a href="./91125.md">第 3 讲“大规模数据初体验”</a>中用这个例子引出了数据处理框架设计的基本需求。</p>
<p>这一讲中，我们会从这个基本问题设置开始，逐步深入探索。</p>
<p>在第 3 讲中，我们把我们的数据处理流程分成了两个步骤，分别是：</p>
<ol>
<li>统计每个商品的销量</li>
<li>找出销量前 K</li>
</ol>
<p>我们先来看第一个步骤的统计商品销量应该如何在 Beam 中实现。我们在第 3 讲中是画了这样的计算集群的示意图：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/5c253a7232f8ace445eab87488e02f49.png" alt=""></p>
<p>如果你暂时没有思路的话，我们不妨试试换一个角度来思考这个问题。</p>
<p>统计商品的销量，换句话说，其实就是计算同样的商品 id 在我们的销售记录数据库中出现了多少次。这有没有让你联想到什么呢？没错，就是我们在<a href="./105324.md">第 31 讲</a>中讲到的 WordCount 例子。WordCount 是统计同样的单词出现的次数，而商品销量就是统计同样的商品 id 出现的次数。</p>
<p>所以，我们完全可以用 WordCount 中的部分代码解决商品销量统计的这部分数据处理逻辑。</p>
<p>在 WordCount 中，我们用 words.apply(Count.perElement()) 把一个分词后的 PCollection 转换成了“单词为 key，count 为 value”的一个 key/value 组合。</p>
<p>在这里呢，我们同样使用 salesRecords.apply(Count.perElement()) 把一个商品 id 的 PCollection 转换成“key 为商品 id，value 为 count”的 key/value 组合。</p>
<p>Java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// WordCount 的统计词频步骤
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">wordCount = words.apply(Count.perElement())
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> // 我们这里的统计销量步骤
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">salesCount = salesRecords.apply(Count.perElement())
</span></span></code></pre></td></tr></table>
</div>
</div><p>解决了统计每个商品的销量步骤，我们再来看看怎样统计销量前 K 的商品。在第 3 讲中，我们是画了一个计算集群来解决这个问题。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/822a5120b920003bc720bf4879437d12.png" alt=""></p>
<p>但是 Beam 提供了很好的 API 供我们使用。我们可以使用 Top() 这个 Transform。</p>
<p>Top 接受的第一个参数就是我们这里的 K，也就是我们最终要输出的前几个元素。我们需要实现的是一个 Java Comparator interface。</p>
<p>Java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PCollection&lt;KV&lt;String, Long&gt;&gt; topK =
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      salesCount.apply(Top.of(K, new Comparator&lt;KV&lt;String, Long&gt;&gt;() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          @Override
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          public int compare(KV&lt;String, Long&gt; a, KV&lt;String, Long&gt; b) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            return b.getValue.compareTo(a.getValue());
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }));
</span></span></code></pre></td></tr></table>
</div>
</div><p>到这里，销量前 K 的产品就已经被计算出来了。</p>
<p>和所有数据处理流水线一样，我们需要的是一个完整的系统。那么你就不能仅仅满足于计算出结果，必须要考虑你的数据处理结果将怎样被使用。在本文开头的截图中，你能看到，热销商品都被打上了“Best Seller”的标签，点击“Best Seller”标签我们还能看到完整的热销榜单。</p>
<p>那么你可以考虑两种 serving 的方案。</p>
<p>一种是把热销商品的结果存储在一个单独的数据库中。但是在 serving 时候，你需要把商品搜索结果和热销商品结果进行交叉查询。如果搜索结果存在于热销商品数据库中，你就在返回的搜索结果元素中把它标注成“Best Seller”。</p>
<p>另一个可能不太灵活，就是把热销商品的结果写回原来的商品数据库中。如果是热销商品，你就在“是热销商品”这一列做标记。这种方案的缺点是每次更新热销结果后，都要去原来的数据库进行大量更新，不仅要把新成为热销的商品进行标记，还要将落选商品的标记去除。</p>
<p>两种 serving 方案的选择影响了你对于数据处理输出的业务需求。相应的，你可以把输出的前 K 销量产品使用 Pipeline output 输出到一个单独数据库，也可以统一更新所有数据库中的商品。</p>
<h3 id="2-怎样设计每小时更新的热销榜单">2. 怎样设计每小时更新的热销榜单？</h3>
<p>在设计完基础的热销商品处理系统后，我们注意到在 Amazon 的热销榜上有一行小字“Updated hourly”，也就是“每小时更新”。的确，热销商品往往是有时效性的。去年热销的 iPhone X 今年就变成了 iPhone XS。Amazon 选择了以小时为单位更新热销榜单确实是合理的产品设计。</p>
<p>那么怎样用 Beam 实现这种定时更新的数据处理系统呢？</p>
<p>可能你在看到“时间”这个关键词的时候，就马上联想到了第 32 讲介绍的 Beam Window。确实，用基于 Window 的流处理模式是一个值得考虑的方案。我在这里故意把问题设置得比较模糊。其实是因为这需要取决于具体的业务需求，实际上你也可以选择批处理或者流处理的方式。</p>
<p>我们先从简单的批处理模式开始。</p>
<p>在处理工程问题时，我们都是先看最简单的方案能否支撑起来业务需求，避免为了体现工程难度而故意将系统复杂化。采用批处理的方式的话，我们可以每隔一个小时运行一遍上一个小标题中的基础版热销商品系统，也就是部署成 cron job 的模式。</p>
<p>但你要注意，如果我们不修改代码的话，每一次运行都会计算目前为止所有销售的商品。如果这不是你的业务需求，你可以在批处理的数据输入步骤中，根据你的销售记录表的时间戳来筛选想要计算的时间段。比如，你可以设置成每一次运行都只计算从运行时间前 6 个月到该运行时间为止。</p>
<p>其实，批处理的模式已经能解决我们目前为止的大部分业务需求。但有时候我们不得不去使用流处理。比如，如果存储销售记录的团队和你属于不同的部门，你没有权限去直接读取他们的数据库，他们部门只对外分享一个 Pub/Sub 的消息队列。这时候就是流处理应用的绝佳场景。</p>
<p>不知道你还记不记得第 33 讲中我提到过，在 Streaming 版本的 WordCount 中监听一个 Kafka 消息队列的例子。同样的，这时候你可以订阅来自这个部门的销售消息。</p>
<p>Java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pipeline
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    .apply(KafkaIO.&lt;String, Long&gt;read()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       .withBootstrapServers(&#34;broker_1:9092,broker_2:9092&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       .withTopic(&#34;sales_record&#34;)  // use withTopics(List&lt;String&gt;) to read from multiple topics.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       .withKeyDeserializer(StringDeserializer.class)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       .withValueDeserializer(StringDeserializer.class)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       .withLogAppendTime()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    )
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后你可以为你的输入 PCollection 添加窗口，和 WordCount 一样。不过这时候你很有可能需要滑动窗口，因为你的窗口是每小时移动一次。</p>
<p>Java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PCollection&lt;String&gt; windowedProductIds = input
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  .apply(Window.&lt;String&gt;into(
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    SlidingWindows.of(Duration.standardMonths(options.getWindowSize()))));
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-怎样设计商品去重处理流水线和怎样根据商品在售状态过滤热销商品">3. 怎样设计商品去重处理流水线和怎样根据商品在售状态过滤热销商品？</h3>
<p>通过前面的内容，我们已经设计出了能够每小时更新的热销榜单。但不知道你有没有注意到，其实我们之前的问题设置是过于简化了，忽略了很多现实而重要的问题，比如：</p>
<ul>
<li>怎样处理退货的商品？</li>
<li>怎样处理店家因为收到差评故意把商品下架换个马甲重新上架？</li>
<li>怎样处理那些虽然曾经热销但是现在已经不再出售的商品？</li>
</ul>
<p>这些问题都需要使用第 28 讲中介绍的 Pipeline 的基本设计模式：过滤模式。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/f0ff96b3d3b3665e3280bf26f9bd639e.png" alt=""></p>
<p>我们这个案例中所需要的过滤条件是：</p>
<ul>
<li>把退货的商品销量减去</li>
<li>把重复的商品销量进行叠加</li>
<li>将在售商品过滤出来</li>
</ul>
<p>一起来想想这些过滤条件应该怎么实现吧。</p>
<p>对于退货商品，我们可以把所有退货的记录挑出来进行统计。同样对于每一个商品 id，如果我们把出售的计数减去退货的计数就可以得到成功销售的计数。</p>
<p>而事实上，实际交易系统对于商品状态的跟踪会详细得多，每一个订单最终落在退货状态还是成功销售状态都可以在交易数据库中查询得到。我们可以把这个封装在 isSuccessfulSale() 方法中。</p>
<p>重复的商品在一个成熟的交易系统中一般会有另外一个去重的数据处理流水线。它能根据商品描述、商品图片等推测重复的商品。我们假设在我们系统中已经有了 product_unique_id 这样一个记录，那么我们只要把之前进行统计的 product_id 替换成统计 product_unique_id 就行了。</p>
<p>过滤在售的商品可能有多种实现方式，取决于你的小组有没有权限读取所需的数据库。</p>
<p>假如你可以读取一个商品状态的数据库列，那你可以直接根据 [商品状态 = 在售] 这样的判断条件进行过滤。假如你不能读取商品状态，那你可能需要查询在售的商品中是否有你的这个商品 id 来进行判断。但在这一讲中，我们先忽略实现细节，把这个过滤逻辑封装在 isInStock() 方法中。</p>
<p>最终我们的过滤处理步骤会是类似下面这样的。只有同时满足 isSuccessfulSale() 和 isInStock() 的 product_unique_id，才会被我们后续的销量统计步骤所计算。</p>
<p>Java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PCollection&lt;Product&gt; productCollection = ...;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> PCollection&lt;Product&gt; qualifiedProductCollection = productCollection
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  .apply(“uniqueProductTransform”, Distinct.withRepresentativeValueFn(
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      new SerializableFunction&lt;Product, Long&gt;() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        @Override
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        public Long apply(Product input) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          return input.productUniqueId();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }).withRepresentativeType(TypeDescriptor.of(Long.class))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    .apply(&#34;filterProductTransform&#34;, ParDo.of(new DoFn&lt;Product, Product&gt;(){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    @ProcessElement
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public void processElement(ProcessContext c) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      if (isSuccessfulSale(c.element()) &amp;&amp; isInStockc.element())) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        c.output(c.element());
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  }));
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-怎样按不同的商品门类生成榜单">4. 怎样按不同的商品门类生成榜单？</h3>
<p>我们还注意到亚马逊的热销榜是按照不同的商品种类的。也就说每一个商品分类都有自己的榜单。这是很合理的业务设计，因为你不可能会去把飞机的销量和手机的销量相比，手机可能人手一个，飞机无法人手一个。</p>
<p>这时候我们在第 28 讲所学的分离模式设计就能大显身手了。分离模式把一个 PCollection 按照类别分离成了几个小的子 PCollection。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/0656c5fda71cc94a2da8f93d5747801b.png" alt=""></p>
<p>在这个案例里，我们也需要对商品进行分离。</p>
<p>与经典的分离模式不同，我们这里每一个商品可能都属于多个类别。比如一双鞋子，它可能既归类为“户外”，也归类为“潮鞋”。还记得分离模式在 Beam 中怎么实现吗？没错就是使用 output tag。我们先要为每一种分类定义 tag，比如刚才说的 outdoorTag 和 fashionTag。再把相应的商品输出进对应的 tag 中。示例如下：</p>
<p>Java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 首先定义每一个 output 的 tag
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">final TupleTag&lt;Product&gt; outdoorTag = new TupleTag&lt;Product&gt;(){};
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">final TupleTag&lt;Product&gt; fashionTag = new TupleTag&lt;Product&gt;(){};
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> PCollection&lt;Product&gt; salesCollection = ...;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> PCollectionTuple mixedCollection =
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    userCollection.apply(ParDo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        .of(new DoFn&lt;Product, Product&gt;() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          @ProcessElement
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          public void processElement(ProcessContext c) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            if (isOutdoorProduct(c.element())) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              c.output(c.element());
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            } else if (isFashionProduct(c.element())) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              c.output(fashionTag, c.element());
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        })
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        .withOutputTags(outdoorTag, TupleTagList.of(fashionTag)));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> // 分离出不同的商品分类
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mixedCollection.get(outdoorTag).apply(...);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> mixedCollection.get(fashionTag).apply(...);
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="小结">小结</h2>
<p>这一讲我们从基础商品排行榜系统出发，利用到了之前学的数据处理设计模式和 Beam 编程方法。</p>
<p>同时，探索了以批处理计算为基础的热销商品列表。我们设计了每小时更新的热销榜单、商品去重处理流水线，根据商品在售状态过滤出热销商品，并按不同的商品门类生成榜单。</p>
<h2 id="思考题">思考题</h2>
<p>一个商品排名系统中还有太多需要解决的工程问题，你觉得哪些也可以利用大规模数据处理技术设计解决？</p>
<p>欢迎你把答案写在留言区，与我和其他同学一起讨论。如果你觉得有所收获，也欢迎把文章分享给你的朋友。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/a0f5b0b51dbfc98740637837dc0ae117.png" alt="unpreview"></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%AE%9E%E6%88%98/">大规模数据处理实战</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6%E5%A4%A7%E6%95%B0%E6%8D%AE/34_a_b%E6%B5%8B%E8%AF%95%E4%B8%8E%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">34_A_B测试与灰度发布必知必会</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6%E5%BE%AE%E6%9C%8D%E5%8A%A1/34_istioservice_mesh%E7%9A%84%E4%BB%A3%E8%A1%A8%E4%BA%A7%E5%93%81/">
            <span class="next-text nav-default">34_Istio：Service_Mesh的代表产品</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
