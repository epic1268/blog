<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>30__Java虚拟机的监控及诊断工具（命令行篇） - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="今天，我们来一起了解一下 JDK 中用于监控及诊断工具。本篇中我将使用刚刚发布的 Java 11 版本的工具进行示范。
jps 你可能用过ps命令，打印所有正在运行的进程的相关信息。JDK 中的jps命令（帮助文档）沿用了同样的概念：它将打印所有正在运行的 Java 进程的相关信息。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/30__java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%AF%87/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/30__java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%AF%87/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="30__Java虚拟机的监控及诊断工具（命令行篇）">
  <meta property="og:description" content="今天，我们来一起了解一下 JDK 中用于监控及诊断工具。本篇中我将使用刚刚发布的 Java 11 版本的工具进行示范。
jps 你可能用过ps命令，打印所有正在运行的进程的相关信息。JDK 中的jps命令（帮助文档）沿用了同样的概念：它将打印所有正在运行的 Java 进程的相关信息。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="深入拆解Java虚拟机">

  <meta itemprop="name" content="30__Java虚拟机的监控及诊断工具（命令行篇）">
  <meta itemprop="description" content="今天，我们来一起了解一下 JDK 中用于监控及诊断工具。本篇中我将使用刚刚发布的 Java 11 版本的工具进行示范。
jps 你可能用过ps命令，打印所有正在运行的进程的相关信息。JDK 中的jps命令（帮助文档）沿用了同样的概念：它将打印所有正在运行的 Java 进程的相关信息。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="4724">
  <meta itemprop="keywords" content="深入拆解Java虚拟机">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="30__Java虚拟机的监控及诊断工具（命令行篇）">
  <meta name="twitter:description" content="今天，我们来一起了解一下 JDK 中用于监控及诊断工具。本篇中我将使用刚刚发布的 Java 11 版本的工具进行示范。
jps 你可能用过ps命令，打印所有正在运行的进程的相关信息。JDK 中的jps命令（帮助文档）沿用了同样的概念：它将打印所有正在运行的 Java 进程的相关信息。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">30__Java虚拟机的监控及诊断工具（命令行篇）</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 4724 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#jps">jps</a></li>
        <li><a href="#jstat">jstat</a></li>
        <li><a href="#jmap">jmap</a></li>
        <li><a href="#jinfo">jinfo</a></li>
        <li><a href="#jstack">jstack</a></li>
        <li><a href="#jcmd">jcmd</a></li>
        <li><a href="#总结与实践">总结与实践</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>今天，我们来一起了解一下 JDK 中用于监控及诊断工具。本篇中我将使用刚刚发布的 Java 11 版本的工具进行示范。</p>
<h2 id="jps">jps</h2>
<p>你可能用过<code>ps</code>命令，打印所有正在运行的进程的相关信息。JDK 中的<code>jps</code>命令（<a href="./jps.md">帮助文档</a>）沿用了同样的概念：它将打印所有正在运行的 Java 进程的相关信息。</p>
<p>在默认情况下，<code>jps</code>的输出信息包括 Java 进程的进程 ID 以及主类名。我们还可以通过追加参数，来打印额外的信息。例如，<code>-l</code>将打印模块名以及包名；<code>-v</code>将打印传递给 Java 虚拟机的参数（如<code>-XX:+UnlockExperimentalVMOptions -XX:+UseZGC</code>）；<code>-m</code>将打印传递给主类的参数。</p>
<p>具体的示例如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">jps</span> <span class="o">-</span><span class="n">mlv</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">18331</span> <span class="n">org</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">Foo</span> <span class="n">Hello</span> <span class="ne">World</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">18332</span> <span class="n">jdk</span><span class="o">.</span><span class="n">jcmd</span><span class="o">/</span><span class="n">sun</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">jps</span><span class="o">.</span><span class="n">Jps</span> <span class="o">-</span><span class="n">mlv</span> <span class="o">-</span><span class="n">Dapplication</span><span class="o">.</span><span class="n">home</span><span class="o">=/</span><span class="n">Library</span><span class="o">/</span><span class="n">Java</span><span class="o">/</span><span class="n">JavaVirtualMachines</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mf">11.j</span><span class="n">dk</span><span class="o">/</span><span class="n">Contents</span><span class="o">/</span><span class="n">Home</span> <span class="o">-</span><span class="n">Xms8m</span> <span class="o">-</span><span class="n">Djdk</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">main</span><span class="o">=</span><span class="n">jdk</span><span class="o">.</span><span class="n">jcmd</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意的是，如果某 Java 进程关闭了默认开启的<code>UsePerfData</code>参数（即使用参数<code>-XX:-UsePerfData</code>），那么<code>jps</code>命令（以及下面介绍的<code>jstat</code>）将无法探知该 Java 进程。</p>
<p>当获得 Java 进程的进程 ID 之后，我们便可以调用接下来介绍的各项监控及诊断工具了。</p>
<h2 id="jstat">jstat</h2>
<p><code>jstat</code>命令（<a href="./jstat.md">帮助文档</a>）可用来打印目标 Java 进程的性能数据。它包括多条子命令，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ jstat -options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-class
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-compiler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gccapacity
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gccause
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gcmetacapacity
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gcnew
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gcnewcapacity
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gcold
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gcoldcapacity
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-gcutil
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-printcompilation
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这些子命令中，<code>-class</code>将打印类加载相关的数据，<code>-compiler</code>和<code>-printcompilation</code>将打印即时编译相关的数据。剩下的都是以<code>-gc</code>为前缀的子命令，它们将打印垃圾回收相关的数据。</p>
<p>默认情况下，<code>jstat</code>只会打印一次性能数据。我们可以将它配置为每隔一段时间打印一次，直至目标 Java 进程终止，或者达到我们所配置的最大打印次数。具体示例如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Usage: jstat -outputOptions [-t] [-hlines] VMID [interval [count]]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ jstat -gc 22126 1s 4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">17472,0 17472,0  0,0    0,0   139904,0 47146,4   349568,0   21321,0   30020,0 28001,8 4864,0 4673,4     22    0,080   3      0,270   0      0,000    0,350
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">17472,0 17472,0 420,6   0,0   139904,0 11178,4   349568,0   21321,0   30020,0 28090,1 4864,0 4674,2     28    0,084   3      0,270   0      0,000    0,354
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">17472,0 17472,0  0,0   403,9  139904,0 139538,4  349568,0   21323,4   30020,0 28137,2 4864,0 4674,2     34    0,088   4      0,359   0      0,000    0,446
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">17472,0 17472,0  0,0    0,0   139904,0   0,0     349568,0   21326,1   30020,0 28093,6 4864,0 4673,4     38    0,091   5      0,445   0      0,000    0,536
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>当监控本地环境的 Java 进程时，VMID 可以简单理解为 PID。如果需要监控远程环境的 Java 进程，你可以参考 jstat 的帮助文档。</p>
</blockquote>
<p>在上面这个示例中，22126 进程是一个使用了 CMS 垃圾回收器的 Java 进程。我们利用<code>jstat</code>的<code>-gc</code>子命令，来打印该进程垃圾回收相关的数据。命令最后的<code>1s 4</code>表示每隔 1 秒打印一次，共打印 4 次。</p>
<p>在<code>-gc</code>子命令的输出中，前四列分别为两个 Survivor 区的容量（Capacity）和已使用量（Utility）。我们可以看到，这两个 Survivor 区的容量相等，而且始终有一个 Survivor 区的内存使用量为 0。</p>
<p>当使用默认的 G1 GC 时，输出结果则有另一些特征：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ jstat -gc 22208 1s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0,0   16384,0  0,0   16384,0 210944,0 192512,0  133120,0    5332,5   28848,0 26886,4 4864,0 4620,5     19    0,067   1      0,016   2      0,002    0,084
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0,0   16384,0  0,0   16384,0 210944,0 83968,0   133120,0    5749,9   29104,0 27132,8 4864,0 4621,0     21    0,078   1      0,016   2      0,002    0,095
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0,0    0,0    0,0    0,0   71680,0  18432,0   45056,0    20285,1   29872,0 27952,4 4864,0 4671,6     23    0,089   2      0,063   2      0,002    0,153
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0,0   2048,0  0,0   2048,0 69632,0  28672,0   45056,0    18608,1   30128,0 28030,4 4864,0 4672,4     32    0,093   2      0,063   2      0,002    0,158
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上面这个示例中，<code>jstat</code>每隔 1s 便会打印垃圾回收的信息，并且不断重复下去。</p>
<p>你可能已经留意到，<code>S0C</code>和<code>S0U</code>始终为 0，而且另一个 Survivor 区的容量（S1C）可能会下降至 0。</p>
<p>这是因为，当使用 G1 GC 时，Java 虚拟机不再设置 Eden 区、Survivor 区，老年代区的内存边界，而是将堆划分为若干个等长内存区域。</p>
<p>每个内存区域都可以作为 Eden 区、Survivor 区以及老年代区中的任一种，并且可以在不同区域类型之间来回切换。（<a href="./tutorials-1876574.md">参考链接</a>）</p>
<p>换句话说，逻辑上我们只有一个 Survivor 区。当需要迁移 Survivor 区中的数据时（即 Copying GC），我们只需另外申请一个或多个内存区域，作为新的 Survivor 区。</p>
<p>因此，Java 虚拟机决定在使用 G1 GC 时，将所有 Survivor 内存区域的总容量以及已使用量存放至 S1C 和 S1U 中，而 S0C 和 S0U 则被设置为 0。</p>
<p>当发生垃圾回收时，Java 虚拟机可能出现 Survivor 内存区域内的对象<strong>全</strong>被回收或晋升的现象。</p>
<p>在这种情况下，Java 虚拟机会将这块内存区域回收，并标记为可分配的状态。这样子做的结果是，堆中可能完全没有 Survivor 内存区域，因而相应的 S1C 和 S1U 将会是 0。</p>
<p><code>jstat</code>还有一个非常有用的参数<code>-t</code>，它将在每行数据之前打印目标 Java 进程的启动时间。例如，在下面这个示例中，第一列代表该 Java 进程已经启动了 10.7 秒。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ jstat -gc -t 22407
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Timestamp        S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           10,7  0,0    0,0    0,0    0,0   55296,0  45056,0   34816,0    20267,8   30128,0 27975,3 4864,0 4671,6     33    0,086   3      0,111   2      0,001    0,198
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以比较 Java 进程的启动时间以及总 GC 时间（GCT 列），或者两次测量的间隔时间以及总 GC 时间的增量，来得出 GC 时间占运行时间的比例。</p>
<p>如果该比例超过 20%，则说明目前堆的压力较大；如果该比例超过 90%，则说明堆里几乎没有可用空间，随时都可能抛出 OOM 异常。</p>
<p><code>jstat</code>还可以用来判断是否出现内存泄漏。在长时间运行的 Java 程序中，我们可以运行<code>jstat</code>命令连续获取多行性能数据，并取这几行数据中 OU 列（即已占用的老年代内存）的最小值。</p>
<p>然后，我们每隔一段较长的时间重复一次上述操作，来获得多组 OU 最小值。如果这些值呈上涨趋势，则说明该 Java 程序的老年代内存已使用量在不断上涨，这意味着无法回收的对象在不断增加，因此很有可能存在内存泄漏。</p>
<blockquote>
<p>上面没有涉及的列（或者其他子命令的输出），你可以查阅帮助文档了解具体含义。至于文档中漏掉的 CGC 和 CGCT，它们分别代表并发 GC Stop-The-World 的次数和时间。</p>
</blockquote>
<h2 id="jmap">jmap</h2>
<p>在这种情况下，我们便可以请<code>jmap</code>命令（<a href="./jmap.md">帮助文档</a>）出马，分析 Java 虚拟机堆中的对象。</p>
<p><code>jmap</code>同样包括多条子命令。</p>
<ol>
<li><code>-clstats</code>，该子命令将打印被加载类的信息。</li>
<li><code>-finalizerinfo</code>，该子命令将打印所有待 finalize 的对象。</li>
<li><code>-histo</code>，该子命令将统计各个类的实例数目以及占用内存，并按照内存使用量从多至少的顺序排列。此外，<code>-histo:live</code>只统计堆中的存活对象。</li>
<li><code>-dump</code>，该子命令将导出 Java 虚拟机堆的快照。同样，<code>-dump:live</code>只保存堆中的存活对象。</li>
</ol>
<p>我们通常会利用<code>jmap -dump:live,format=b,file=filename.bin</code>命令，将堆中所有存活对象导出至一个文件之中。</p>
<p>这里<code>format=b</code>将使<code>jmap</code>导出与<a href="./tooldescr008.md">hprof</a>（在 Java 9 中已被移除）、<code>-XX:+HeapDumpAfterFullGC</code>、<code>-XX:+HeapDumpOnOutOfMemoryError</code>格式一致的文件。这种格式的文件可以被其他 GUI 工具查看，具体我会在下一篇中进行演示。</p>
<p>下面我贴了一段<code>-histo</code>子命令的输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ jmap -histo 22574
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> num     #instances         #bytes  class name (module)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-------------------------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   1:        500004       20000160  org.python.core.PyComplex
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   2:        570866       18267712  org.python.core.PyFloat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   3:        360295       18027024  [B (java.base@11)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   4:        339394       11429680  [Lorg.python.core.PyObject;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   5:        308637       11194264  [Ljava.lang.Object; (java.base@11)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   6:        301378        9291664  [I (java.base@11)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   7:        225103        9004120  java.math.BigInteger (java.base@11)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   8:        507362        8117792  org.python.core.PySequence$1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   9:        285009        6840216  org.python.core.PyLong
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  10:        282908        6789792  java.lang.String (java.base@11)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2281:             1             16  traceback$py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2282:             1             16  unicodedata$py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Total       5151277      167944400
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于<code>jmap</code>将访问堆中的所有对象，为了保证在此过程中不被应用线程干扰，<code>jmap</code>需要借助安全点机制，让所有线程停留在不改变堆中数据的状态。</p>
<p>也就是说，由<code>jmap</code>导出的堆快照必定是安全点位置的。这可能导致基于该堆快照的分析结果存在偏差。举个例子，假设在编译生成的机器码中，某些对象的生命周期在两个安全点之间，那么<code>:live</code>选项将无法探知到这些对象。</p>
<p>另外，如果某个线程长时间无法跑到安全点，<code>jmap</code>将一直等下去。上一小节的<code>jstat</code>则不同。这是因为垃圾回收器会主动将<code>jstat</code>所需要的摘要数据保存至固定位置之中，而<code>jstat</code>只需直接读取即可。</p>
<p>关于这种长时间等待的情况，你可以通过下面这段程序来复现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 暂停时间较长，约为二三十秒，可酌情调整。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// CTRL+C 的 SIGINT 信号无法停止，需要 SIGKILL。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static double sum = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> public static void main(String[] args) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  for (int i = 0; i &lt; 0x77777777; i++) { // counted loop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    sum += Math.log(i); // Math.log is an intrinsic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>jmap</code>（以及接下来的<code>jinfo</code>、<code>jstack</code>和<code>jcmd</code>）依赖于 Java 虚拟机的<a href="./package-summary.md">Attach API</a>，因此只能监控本地 Java 进程。</p>
<p>一旦开启 Java 虚拟机参数<code>DisableAttachMechanism</code>（即使用参数<code>-XX:+DisableAttachMechanism</code>），基于 Attach API 的命令将无法执行。反过来说，如果你不想被其他进程监控，那么你需要开启该参数。</p>
<h2 id="jinfo">jinfo</h2>
<p><code>jinfo</code>命令（<a href="./jinfo.md">帮助文档</a>）可用来查看目标 Java 进程的参数，如传递给 Java 虚拟机的<code>-X</code>（即输出中的 jvm_args）、<code>-XX</code>参数（即输出中的 VM Flags），以及可在 Java 层面通过<code>System.getProperty</code>获取的<code>-D</code>参数（即输出中的 System Properties）。</p>
<p>具体的示例如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">jinfo</span> <span class="mi">31185</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Java</span> <span class="n">System</span> <span class="n">Properties</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">gopherProxySet</span><span class="o">=</span><span class="bp">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">awt</span><span class="o">.</span><span class="n">toolkit</span><span class="o">=</span><span class="n">sun</span><span class="o">.</span><span class="n">lwawt</span><span class="o">.</span><span class="n">macosx</span><span class="o">.</span><span class="n">LWCToolkit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">java</span><span class="o">.</span><span class="n">specification</span><span class="o">.</span><span class="n">version</span><span class="o">=</span><span class="mi">11</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sun</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">isalist</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sun</span><span class="o">.</span><span class="n">jnu</span><span class="o">.</span><span class="n">encoding</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">VM</span> <span class="n">Flags</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">CICompilerCount</span><span class="o">=</span><span class="mi">4</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">ConcGCThreads</span><span class="o">=</span><span class="mi">3</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">G1ConcRefinementThreads</span><span class="o">=</span><span class="mi">10</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">G1HeapRegionSize</span><span class="o">=</span><span class="mi">2097152</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">GCDrainStackTargetSize</span><span class="o">=</span><span class="mi">64</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">InitialHeapSize</span><span class="o">=</span><span class="mi">536870912</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">MarkStackSize</span><span class="o">=</span><span class="mi">4194304</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">MaxHeapSize</span><span class="o">=</span><span class="mi">8589934592</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">MaxNewSize</span><span class="o">=</span><span class="mi">5152702464</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">MinHeapDeltaBytes</span><span class="o">=</span><span class="mi">2097152</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">NonNMethodCodeHeapSize</span><span class="o">=</span><span class="mi">5835340</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">NonProfiledCodeHeapSize</span><span class="o">=</span><span class="mi">122911450</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">ProfiledCodeHeapSize</span><span class="o">=</span><span class="mi">122911450</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="n">ReservedCodeCacheSize</span><span class="o">=</span><span class="mi">251658240</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="o">+</span><span class="n">SegmentedCodeCache</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="o">+</span><span class="n">UseCompressedClassPointers</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="o">+</span><span class="n">UseCompressedOops</span> <span class="o">-</span><span class="n">XX</span><span class="p">:</span><span class="o">+</span><span class="n">UseG1GC</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">VM</span> <span class="n">Arguments</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">jvm_args</span><span class="p">:</span> <span class="o">-</span><span class="n">Xlog</span><span class="p">:</span><span class="n">gc</span> <span class="o">-</span><span class="n">Xmx1024m</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">java_command</span><span class="p">:</span> <span class="n">org</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">Foo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">java_class_path</span> <span class="p">(</span><span class="n">initial</span><span class="p">):</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Launcher</span> <span class="n">Type</span><span class="p">:</span> <span class="n">SUN_STANDARD</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>jinfo</code>还可以用来修改目标 Java 进程的“manageable”虚拟机参数。</p>
<p>举个例子，我们可以使用<code>jinfo -flag +HeapDumpAfterFullGC &lt;PID&gt;</code>命令，开启<code>&lt;PID&gt;</code>所指定的 Java 进程的<code>HeapDumpAfterFullGC</code>参数。</p>
<p>你可以通过下述命令查看其他 &ldquo;manageable&rdquo; 虚拟机参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ java -XX:+PrintFlagsFinal -version | grep manageable   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     intx CMSAbortablePrecleanWaitMillis           = 100                                    {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     intx CMSTriggerInterval                       = -1                                     {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     intx CMSWaitDuration                          = 2000                                   {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     bool HeapDumpAfterFullGC                      = false                                  {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     bool HeapDumpBeforeFullGC                     = false                                  {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     bool HeapDumpOnOutOfMemoryError               = false                                  {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ccstr HeapDumpPath                             =                                        {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    uintx MaxHeapFreeRatio                         = 70                                     {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    uintx MinHeapFreeRatio                         = 40                                     {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     bool PrintClassHistogram                      = false                                  {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     bool PrintConcurrentLocks                     = false                                  {manageable} {default}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">java version &#34;11&#34; 2018-09-25
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Java(TM) SE Runtime Environment 18.9 (build 11+28)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11+28, mixed mode)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="jstack">jstack</h2>
<p><code>jstack</code>命令（<a href="./jstack.md">帮助文档</a>）可以用来打印目标 Java 进程中各个线程的栈轨迹，以及这些线程所持有的锁。</p>
<p><code>jstack</code>的其中一个应用场景便是死锁检测。这里我用<code>jstack</code>获取一个已经死锁了的 Java 程序的栈信息。具体输出如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ jstack 31634
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &#34;Thread-0&#34; #12 prio=5 os_prio=31 cpu=1.32ms elapsed=34.24s tid=0x00007fb08601c800 nid=0x5d03 waiting for monitor entry  [0x000070000bc7e000]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   java.lang.Thread.State: BLOCKED (on object monitor)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at DeadLock.foo(DeadLock.java:18)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> - waiting to lock &lt;0x000000061ff904c0&gt; (a java.lang.Object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> - locked &lt;0x000000061ff904b0&gt; (a java.lang.Object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at DeadLock$$Lambda$1/0x0000000800060840.run(Unknown Source)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at java.lang.Thread.run(java.base@11/Thread.java:834)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &#34;Thread-1&#34; #13 prio=5 os_prio=31 cpu=1.43ms elapsed=34.24s tid=0x00007fb08601f800 nid=0x5f03 waiting for monitor entry  [0x000070000bd81000]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   java.lang.Thread.State: BLOCKED (on object monitor)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at DeadLock.bar(DeadLock.java:33)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> - waiting to lock &lt;0x000000061ff904b0&gt; (a java.lang.Object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> - locked &lt;0x000000061ff904c0&gt; (a java.lang.Object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at DeadLock$$Lambda$2/0x0000000800063040.run(Unknown Source)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at java.lang.Thread.run(java.base@11/Thread.java:834)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> JNI global refs: 6, weak refs: 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Found one Java-level deadlock:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">=============================
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#34;Thread-0&#34;:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  waiting to lock monitor 0x00007fb083015900 (object 0x000000061ff904c0, a java.lang.Object),
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  which is held by &#34;Thread-1&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#34;Thread-1&#34;:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  waiting to lock monitor 0x00007fb083015800 (object 0x000000061ff904b0, a java.lang.Object),
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  which is held by &#34;Thread-0&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Java stack information for the threads listed above:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">===================================================
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#34;Thread-0&#34;:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at DeadLock.foo(DeadLock.java:18)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> - waiting to lock &lt;0x000000061ff904c0&gt; (a java.lang.Object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> - locked &lt;0x000000061ff904b0&gt; (a java.lang.Object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at DeadLock$$Lambda$1/0x0000000800060840.run(Unknown Source)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at java.lang.Thread.run(java.base@11/Thread.java:834)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#34;Thread-1&#34;:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at DeadLock.bar(DeadLock.java:33)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> - waiting to lock &lt;0x000000061ff904b0&gt; (a java.lang.Object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> - locked &lt;0x000000061ff904c0&gt; (a java.lang.Object)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at DeadLock$$Lambda$2/0x0000000800063040.run(Unknown Source)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> at java.lang.Thread.run(java.base@11/Thread.java:834)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Found 1 deadlock.
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到，<code>jstack</code>不仅会打印线程的栈轨迹、线程状态（BLOCKED）、持有的锁（locked …）以及正在请求的锁（waiting to lock …），而且还会分析出具体的死锁。</p>
<h2 id="jcmd">jcmd</h2>
<p>你还可以直接使用<code>jcmd</code>命令（<a href="./jcmd.md">帮助文档</a>），来替代前面除了<code>jstat</code>之外的所有命令。具体的替换规则你可以参考下表。</p>
<p>至于<code>jstat</code>的功能，虽然<code>jcmd</code>复制了<code>jstat</code>的部分代码，并支持通过<code>PerfCounter.print</code>子命令来打印所有的 Performance Counter，但是它没有保留<code>jstat</code>的输出格式，也没有重复打印的功能。因此，感兴趣的同学可以自行整理。</p>
<p>另外，我们将在下一篇中介绍<code>jcmd</code>中 Java Flight Recorder 相关的子命令。</p>
<h2 id="总结与实践">总结与实践</h2>
<p>今天我介绍了 JDK 中用于监控及诊断的命令行工具。我们再来回顾一下。</p>
<ol>
<li><code>jps</code>将打印所有正在运行的 Java 进程。</li>
<li><code>jstat</code>允许用户查看目标 Java 进程的类加载、即时编译以及垃圾回收相关的信息。它常用于检测垃圾回收问题以及内存泄漏问题。</li>
<li><code>jmap</code>允许用户统计目标 Java 进程的堆中存放的 Java 对象，并将它们导出成二进制文件。</li>
<li><code>jinfo</code>将打印目标 Java 进程的配置参数，并能够改动其中 manageabe 的参数。</li>
<li><code>jstack</code>将打印目标 Java 进程中各个线程的栈轨迹、线程状态、锁状况等信息。它还将自动检测死锁。</li>
<li><code>jcmd</code>则是一把瑞士军刀，可以用来实现前面除了<code>jstat</code>之外所有命令的功能。</li>
</ol>
<hr>
<p>今天的实践环节，你可以探索<code>jcmd</code>中的下述功能，看看有没有适合你项目的监控项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Compiler</span><span class="o">.</span><span class="n">CodeHeap_Analytics</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Compiler</span><span class="o">.</span><span class="n">codecache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Compiler</span><span class="o">.</span><span class="n">codelist</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Compiler</span><span class="o">.</span><span class="n">directives_add</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Compiler</span><span class="o">.</span><span class="n">directives_clear</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Compiler</span><span class="o">.</span><span class="n">directives_print</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Compiler</span><span class="o">.</span><span class="n">directives_remove</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Compiler</span><span class="o">.</span><span class="n">queue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GC</span><span class="o">.</span><span class="n">class_histogram</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GC</span><span class="o">.</span><span class="n">class_stats</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GC</span><span class="o">.</span><span class="n">finalizer_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GC</span><span class="o">.</span><span class="n">heap_dump</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GC</span><span class="o">.</span><span class="n">heap_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GC</span><span class="o">.</span><span class="n">run</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GC</span><span class="o">.</span><span class="n">run_finalization</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">class_hierarchy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">classloader_stats</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">classloaders</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">command_line</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">dynlibs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">flags</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">log</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">metaspace</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">native_memory</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">print_touched_methods</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">set_flag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">stringtable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">symboltable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">system_properties</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">systemdictionary</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">unlock_commercial_features</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">uptime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VM</span><span class="o">.</span><span class="n">version</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/a500044f1e4938fb43719f802cba82d8.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA/">深入拆解Java虚拟机</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E9%87%8D%E5%AD%A6%E5%89%8D%E7%AB%AF/30__javascript%E8%AF%AD%E6%B3%95%E4%BA%8C%E4%BD%A0%E7%9F%A5%E9%81%93%E5%93%AA%E4%BA%9Bjavascript%E8%AF%AD%E5%8F%A5/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">30__JavaScript语法（二）：你知道哪些JavaScript语句？</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%85%A8%E6%A0%88%E5%B7%A5%E7%A8%8B%E5%B8%88%E4%BF%AE%E7%82%BC%E6%8C%87%E5%8D%97/30__ops%E4%B8%89%E9%83%A8%E6%9B%B2%E4%B9%8B%E4%B8%89%E6%B5%8B%E8%AF%95%E5%92%8C%E5%8F%91%E5%B8%83/">
            <span class="next-text nav-default">30__Ops三部曲之三：测试和发布</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
