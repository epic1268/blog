<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>16__商品加入购物车：SQL优化和压力工具中的参数分析 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是高楼。
今天这节课，我用商品加入购物车接口，来给你讲一讲 SQL 优化和压力工具中的参数分析。
对于 SQL 的优化，很多人一看到数据库资源使用率高，就猜测是 SQL 有问题。这个方向看起来没错，但是，具体是哪个 SQL 有问题，以及有什么样的问题，往往回答不出来。因此，这节课我会教你怎么根据资源使用率高，快速定位到有问题的 SQL，并做出相应的调整。此外，你还将看到，当压力工具的参数使用不合理时，我们应该如何处理由此产生的数据库锁的问题。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/16__%E5%95%86%E5%93%81%E5%8A%A0%E5%85%A5%E8%B4%AD%E7%89%A9%E8%BD%A6sql%E4%BC%98%E5%8C%96%E5%92%8C%E5%8E%8B%E5%8A%9B%E5%B7%A5%E5%85%B7%E4%B8%AD%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/16__%E5%95%86%E5%93%81%E5%8A%A0%E5%85%A5%E8%B4%AD%E7%89%A9%E8%BD%A6sql%E4%BC%98%E5%8C%96%E5%92%8C%E5%8E%8B%E5%8A%9B%E5%B7%A5%E5%85%B7%E4%B8%AD%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="16__商品加入购物车：SQL优化和压力工具中的参数分析">
  <meta property="og:description" content="你好，我是高楼。
今天这节课，我用商品加入购物车接口，来给你讲一讲 SQL 优化和压力工具中的参数分析。
对于 SQL 的优化，很多人一看到数据库资源使用率高，就猜测是 SQL 有问题。这个方向看起来没错，但是，具体是哪个 SQL 有问题，以及有什么样的问题，往往回答不出来。因此，这节课我会教你怎么根据资源使用率高，快速定位到有问题的 SQL，并做出相应的调整。此外，你还将看到，当压力工具的参数使用不合理时，我们应该如何处理由此产生的数据库锁的问题。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="高楼的性能工程实战课">

  <meta itemprop="name" content="16__商品加入购物车：SQL优化和压力工具中的参数分析">
  <meta itemprop="description" content="你好，我是高楼。
今天这节课，我用商品加入购物车接口，来给你讲一讲 SQL 优化和压力工具中的参数分析。
对于 SQL 的优化，很多人一看到数据库资源使用率高，就猜测是 SQL 有问题。这个方向看起来没错，但是，具体是哪个 SQL 有问题，以及有什么样的问题，往往回答不出来。因此，这节课我会教你怎么根据资源使用率高，快速定位到有问题的 SQL，并做出相应的调整。此外，你还将看到，当压力工具的参数使用不合理时，我们应该如何处理由此产生的数据库锁的问题。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="4744">
  <meta itemprop="keywords" content="高楼的性能工程实战课">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="16__商品加入购物车：SQL优化和压力工具中的参数分析">
  <meta name="twitter:description" content="你好，我是高楼。
今天这节课，我用商品加入购物车接口，来给你讲一讲 SQL 优化和压力工具中的参数分析。
对于 SQL 的优化，很多人一看到数据库资源使用率高，就猜测是 SQL 有问题。这个方向看起来没错，但是，具体是哪个 SQL 有问题，以及有什么样的问题，往往回答不出来。因此，这节课我会教你怎么根据资源使用率高，快速定位到有问题的 SQL，并做出相应的调整。此外，你还将看到，当压力工具的参数使用不合理时，我们应该如何处理由此产生的数据库锁的问题。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">16__商品加入购物车：SQL优化和压力工具中的参数分析</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 4744 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#压力数据">压力数据</a></li>
        <li><a href="#看架构图">看架构图</a></li>
        <li><a href="#分析的第一阶段">分析的第一阶段</a>
          <ul>
            <li><a href="#拆分响应时间">拆分响应时间</a></li>
            <li><a href="#全局分析">全局分析</a></li>
            <li><a href="#定向分析">定向分析</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#72s-user-time-70ms-system-time-3678m-rss-10605m-vsz">7.2s user time, 70ms system time, 36.78M rss, 106.05M vsz</a></li>
    <li><a href="#current-date-wed-dec-30-233014-2020">Current date: Wed Dec 30 23:30:14 2020</a></li>
    <li><a href="#hostname-7dgroup1">Hostname: 7dgroup1</a></li>
    <li><a href="#files-slow-querylog">Files: slow-query.log</a></li>
    <li><a href="#overall-3660k-total-7-unique-8906-qps-1717x-concurrency-_________">Overall: 36.60k total, 7 unique, 89.06 QPS, 17.17x concurrency _________</a></li>
    <li><a href="#time-range-2020-12-30t152200-to-2020-12-30t152851">Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51</a></li>
    <li><a href="#attribute----------total-----min-----max-----avg-----95--stddev--median">Attribute          total     min     max     avg     95%  stddev  median</a></li>
    <li><a href="#-----------">============     ======= ======= ======= ======= ======= ======= =======</a></li>
    <li><a href="#exec-time----------7055s----20ms------1s---193ms---501ms---160ms---128ms">Exec time          7055s    20ms      1s   193ms   501ms   160ms   128ms</a></li>
    <li><a href="#lock-time-------------7s-------0----39ms---194us---247us---696us---125us">Lock time             7s       0    39ms   194us   247us   696us   125us</a></li>
    <li><a href="#rows-sent---------3545k-------0-------1----099----099----009----099">Rows sent         35.45k       0       1    0.99    0.99    0.09    0.99</a></li>
    <li><a href="#rows-examine-------233g-------0-11276k--6671k-11233k--4650k-11233k">Rows examine       2.33G       0 112.76k  66.71k 112.33k  46.50k 112.33k</a></li>
    <li><a href="#query-size--------1426m-------6----1016--40853--59207--19517--20240">Query size        14.26M       6    1016  408.53  592.07  195.17  202.40</a></li>
    <li><a href="#profile">Profile</a></li>
    <li><a href="#rank-query-id----------------------response-time---calls-rcall-vm---it">Rank Query ID                      Response time   Calls R/Call V/M   It</a></li>
    <li><a href="#------">==== ============================= =============== ===== ====== ===== ==</a></li>
    <li><a href="#1-0xb8bdb35ad896842fac41202b-57443322-814-18420-03119--007-select-pms_sku_stock">1 0xB8BDB35AD896842FAC41202B&hellip; 5744.3322 81.4% 18420 0.3119  0.07 SELECT pms_sku_stock</a></li>
    <li><a href="#2-0xc71984b4087f304be41ac8f8-13091841-186-18138-00722--003-select-oms_cart_item">2 0xC71984B4087F304BE41AC8F8&hellip; 1309.1841 18.6% 18138 0.0722  0.03 SELECT oms_cart_item</a></li>
    <li><a href="#misc-0xmisc---------------------------14979--00----46-00326---00-5-items">MISC 0xMISC                           1.4979  0.0%    46 0.0326   0.0 &lt;5 ITEMS&gt;</a></li>
    <li><a href="#query-1-4482-qps-1398x-concurrency-id-0xb8bdb35ad896842fac41202bb9c908e8-at-byte-6504041">Query 1: 44.82 QPS, 13.98x concurrency, ID 0xB8BDB35AD896842FAC41202BB9C908E8 at byte 6504041</a></li>
    <li><a href="#this-item-is-included-in-the-report-because-it-matches---limit">This item is included in the report because it matches &ndash;limit.</a></li>
    <li><a href="#scores-vm--007">Scores: V/M = 0.07</a></li>
    <li><a href="#time-range-2020-12-30t152200-to-2020-12-30t152851-1">Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51</a></li>
    <li><a href="#attribute----pct---total-----min-----max-----avg-----95--stddev--median">Attribute    pct   total     min     max     avg     95%  stddev  median</a></li>
    <li><a href="#--------">============ === ======= ======= ======= ======= ======= ======= =======</a></li>
    <li><a href="#count---------50---18420">Count         50   18420</a></li>
    <li><a href="#exec-time-----81---5744s----76ms------1s---312ms---580ms---148ms---279ms">Exec time     81   5744s    76ms      1s   312ms   580ms   148ms   279ms</a></li>
    <li><a href="#lock-time-----47------3s----70us----37ms---184us---224us---673us---119us">Lock time     47      3s    70us    37ms   184us   224us   673us   119us</a></li>
    <li><a href="#rows-sent-----50--1799k-------1-------1-------1-------1-------0-------1">Rows sent     50  17.99k       1       1       1       1       0       1</a></li>
    <li><a href="#rows-examine--85---198g-11276k-11276k-11276k-11276k-------0-11276k">Rows examine  85   1.98G 112.76k 112.76k 112.76k 112.76k       0 112.76k</a></li>
    <li><a href="#query-size----26---372m-----212-----212-----212-----212-------0-----212">Query size    26   3.72M     212     212     212     212       0     212</a></li>
    <li><a href="#string">String:</a></li>
    <li><a href="#hosts--------10100554">Hosts        10.100.5.54</a></li>
    <li><a href="#users--------reader">Users        reader</a></li>
    <li><a href="#query_time-distribution">Query_time distribution</a></li>
    <li><a href="#1us">1us</a></li>
    <li><a href="#10us">10us</a></li>
    <li><a href="#100us">100us</a></li>
    <li><a href="#1ms">1ms</a></li>
    <li><a href="#10ms">10ms </a></li>
    <li><a href="#100ms">100ms </a></li>
    <li><a href="#1s">1s </a></li>
    <li><a href="#10s">10s+</a></li>
    <li><a href="#tables">Tables</a></li>
    <li><a href="#show-table-status-like-pms_sku_stockg">SHOW TABLE STATUS LIKE &lsquo;pms_sku_stock&rsquo;\G</a></li>
    <li><a href="#show-create-table-pms_sku_stockg">SHOW CREATE TABLE <code>pms_sku_stock</code>\G</a></li>
    <li><a href="#explain-50100-partitions">EXPLAIN /<em>!50100 PARTITIONS</em>/</a></li>
    <li><a href="#query-2-4413-qps-319x-concurrency-id-0xc71984b4087f304be41ac8f82a88b245-at-byte-20901845">Query 2: 44.13 QPS, 3.19x concurrency, ID 0xC71984B4087F304BE41AC8F82A88B245 at byte 20901845</a></li>
    <li><a href="#this-item-is-included-in-the-report-because-it-matches---limit-1">This item is included in the report because it matches &ndash;limit.</a></li>
    <li><a href="#scores-vm--003">Scores: V/M = 0.03</a></li>
    <li><a href="#time-range-2020-12-30t152200-to-2020-12-30t152851-2">Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51</a></li>
    <li><a href="#attribute----pct---total-----min-----max-----avg-----95--stddev--median-1">Attribute    pct   total     min     max     avg     95%  stddev  median</a></li>
    <li><a href="#---------1">============ === ======= ======= ======= ======= ======= ======= =======</a></li>
    <li><a href="#count---------49---18138">Count         49   18138</a></li>
    <li><a href="#exec-time-----18---1309s----20ms---419ms----72ms---148ms----43ms----59ms">Exec time     18   1309s    20ms   419ms    72ms   148ms    43ms    59ms</a></li>
    <li><a href="#lock-time-----52------4s----76us----39ms---205us---260us---719us---138us">Lock time     52      4s    76us    39ms   205us   260us   719us   138us</a></li>
    <li><a href="#rows-sent-----49--1745k-------0-------1----099----099----012----099">Rows sent     49  17.45k       0       1    0.99    0.99    0.12    0.99</a></li>
    <li><a href="#rows-examine--14-35631m--1996k--2022k--2012k--1940k-------0--1940k">Rows examine  14 356.31M  19.96k  20.22k  20.12k  19.40k       0  19.40k</a></li>
    <li><a href="#query-size----73--1051m-----604-----610--60781--59207-------0--59207">Query size    73  10.51M     604     610  607.81  592.07       0  592.07</a></li>
    <li><a href="#string-1">String:</a></li>
    <li><a href="#hosts--------10100554-1">Hosts        10.100.5.54</a></li>
    <li><a href="#users--------reader-1">Users        reader</a></li>
    <li><a href="#query_time-distribution-1">Query_time distribution</a></li>
    <li><a href="#1us-1">1us</a></li>
    <li><a href="#10us-1">10us</a></li>
    <li><a href="#100us-1">100us</a></li>
    <li><a href="#1ms-1">1ms</a></li>
    <li><a href="#10ms-1">10ms </a></li>
    <li><a href="#100ms-1">100ms </a></li>
    <li><a href="#1s-1">1s</a></li>
    <li><a href="#10s-1">10s+</a></li>
    <li><a href="#tables-1">Tables</a></li>
    <li><a href="#show-table-status-like-oms_cart_itemg">SHOW TABLE STATUS LIKE &lsquo;oms_cart_item&rsquo;\G</a></li>
    <li><a href="#show-create-table-oms_cart_itemg">SHOW CREATE TABLE <code>oms_cart_item</code>\G</a></li>
    <li><a href="#explain-50100-partitions-1">EXPLAIN /<em>!50100 PARTITIONS</em>/</a>
      <ul>
        <li>
          <ul>
            <li><a href="#优化效果">优化效果</a></li>
          </ul>
        </li>
        <li><a href="#分析的第二阶段">分析的第二阶段</a>
          <ul>
            <li><a href="#压力数据-1">压力数据</a></li>
            <li><a href="#拆分响应时间-1">拆分响应时间</a></li>
            <li><a href="#全局分析-1">全局分析</a></li>
            <li><a href="#error-updating-database--cause-commysqlcjjdbcexceptionsmysqltransactionrollbackexception-deadlock-found-when-trying-to-get-lock-try-restarting-transaction">Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</a></li>
            <li><a href="#the-error-may-involve-comdunshanmallmapperomscartitemmapperupdatebyprimarykey-inline">The error may involve com.dunshan.mall.mapper.OmsCartItemMapper.updateByPrimaryKey-Inline</a></li>
            <li><a href="#the-error-occurred-while-setting-parameters">The error occurred while setting parameters</a></li>
            <li><a href="#sql-update-oms_cart_item-----set-product_id---------product_sku_id---------member_id---------quantity---------price---------product_pic---------product_name---------product_sub_title---------product_sku_code---------member_nickname---------create_date---------modify_date---------delete_status---------product_category_id---------product_brand---------product_sn---------product_attr-------where-id--">SQL: update oms_cart_item     set product_id = ?,       product_sku_id = ?,       member_id = ?,       quantity = ?,       price = ?,       product_pic = ?,       product_name = ?,       product_sub_title = ?,       product_sku_code = ?,       member_nickname = ?,       create_date = ?,       modify_date = ?,       delete_status = ?,       product_category_id = ?,       product_brand = ?,       product_sn = ?,       product_attr = ?     where id = ?</a></li>
            <li><a href="#cause-commysqlcjjdbcexceptionsmysqltransactionrollbackexception-deadlock-found-when-trying-to-get-lock-try-restarting-transaction">Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</a></li>
            <li><a href="#定向分析-1">定向分析</a></li>
            <li><a href="#优化效果-1">优化效果</a></li>
          </ul>
        </li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#课后作业">课后作业</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是高楼。</p>
<p>今天这节课，我用商品加入购物车接口，来给你讲一讲 SQL 优化和压力工具中的参数分析。</p>
<p>对于 SQL 的优化，很多人一看到数据库资源使用率高，就猜测是 SQL 有问题。这个方向看起来没错，但是，具体是哪个 SQL 有问题，以及有什么样的问题，往往回答不出来。因此，这节课我会教你怎么根据资源使用率高，快速定位到有问题的 SQL，并做出相应的调整。此外，你还将看到，当压力工具的参数使用不合理时，我们应该如何处理由此产生的数据库锁的问题。</p>
<p>现在，我们就开始这节课的分析。</p>
<h2 id="压力数据">压力数据</h2>
<p>对于商品加入购物车这个接口，我们第一次运行的性能场景结果如下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/b55b4c451b2ffe3ff3c2faad2cdf6ca4.png" alt=""></p>
<p>看着有一种想哭的感觉，有没有？从这张图来看，问题不止一个。我用自己在有限的职业生涯中吸收的天地之灵气，打开天眼一看，感觉这里有两个问题：</p>
<ol>
<li>TPS 即使在峰值的时候，也不够高，才 50 左右；</li>
<li>TPS 在峰值的时候，有大量的错误产生。</li>
</ol>
<p>那哪个问题更重要呢？有人可能说，明显应该处理错误呀，有错误看着不眼晕吗？如果你是有强迫症的人，那没办法，可以先处理错误。</p>
<p>不过，在我看来，先处理 TPS 不高的问题也是可以的。因为虽然有错误产生，但并不是全错呀，只有 5% 的错，你着个啥急。</p>
<p>可是，不管怎么着，我们都要走性能分析决策树的思路。</p>
<h2 id="看架构图">看架构图</h2>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/caa967e8e0fb565898c2358550b4ff22.png" alt=""></p>
<p>这个接口的逻辑清晰明了：压力工具 - Gateway - Cart - Member。</p>
<p>我打算先分析 TPS 不高、响应时间变长的问题，这个问题可以在压力曲线图的前半段中看出来。所以，接下来，我们的分析就从拆分响应时间开始。</p>
<p>如果你想在这样的场景中先处理错误，那就从查日志开始。其实，这些错误是容易处理的，因为它们给出了非常明确的方向指示。</p>
<h2 id="分析的第一阶段">分析的第一阶段</h2>
<h3 id="拆分响应时间">拆分响应时间</h3>
<p>这次我们截小图。</p>
<ol>
<li>User - Gateway：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/13ca47495cc4a6832486f52bde79f8cd.png" alt=""></p>
<ol>
<li>Gateway - Cart：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/49b5682df00b1b39904d096989c7398b.png" alt=""></p>
<ol>
<li>Cart - Member：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/d8a4f12df115ae04fae227faf84a8e42.png" alt=""></p>
<ol>
<li>Cart - MySQL：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/47ed056a0c361873e9f09e7c9cbe9342.png" alt=""></p>
<ol>
<li>Member - MySQL：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/047b2e76bea1b45bad44ed8fe6a080cd.png" alt=""></p>
<p>从响应时间上来看，我们需要先收拾 MySQL，并且是和 Cart 服务相关的 SQL，因为 Cart - MySQL 之间的响应时间有点长。</p>
<h3 id="全局分析">全局分析</h3>
<p>按照我们的惯例，还是得来看一下全局监控。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/bc2f156878253e18b0e2713742015a68.png" alt=""></p>
<p>既然 worker-1 上的 CPU 使用率很高，那我们就去看看 worker-1 上运行着什么服务。</p>
<p>你也许会问，网络的下载带宽也飘红了啊，已经达到 100Mb 以上了。这就涉及到怎么理解计数器的问题了。这里的网络虽然飘红了，但也只有 100 多 Mb，它飘红只是因为 Grafana DashBoard 的阈值设置问题。如果你不想让它飘红，也可以把阈值设置得高一点。并且对于网络来说，100 多 Mb，真的不算大。</p>
<p>我们来看一下 worker-1 上有什么。</p>
<p>[root@k8s-master-2 ~]# kubectl get pods -o wide|grep k8s-worker-1<br>
elasticsearch-data-1                        1/1     Running   1          11d     10.100.230.57    k8s-worker-1   <none>           <none><br>
elasticsearch-master-0                      1/1     Running   0          3d11h   10.100.230.60    k8s-worker-1   <none>           <none><br>
mysql-min-d564fc4df-vs7d6                   1/1     Running   0          22h     10.100.230.1     k8s-worker-1   <none>           <none><br>
[root@k8s-master-2 ~]#</p>
<p>你看，这个 worker-1 上不止有 MySQL，还有 ES data，这是一个吃网络的大户。不过，现在问题并没有指向它。</p>
<p>我们在前面看到的是 MySQL 的响应时间长，所以我们再到 worker-1 上，接着看全局监控的数据。</p>
<p>[root@k8s-worker-1 ~]# top<br>
top - 23:08:21 up 3 days, 11:30,  5 users,  load average: 29.90, 28.54, 23.00<br>
Tasks: 309 total,   1 running, 307 sleeping,   0 stopped,   1 zombie<br>
%Cpu0  : 94.1 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  2.9 si,  2.9 st<br>
%Cpu1  : 94.1 us,  2.9 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  2.9 si,  0.0 st<br>
%Cpu2  : 90.9 us,  3.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  6.1 st<br>
%Cpu3  : 89.7 us,  3.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  3.4 si,  3.4 st<br>
%Cpu4  : 87.9 us,  6.1 sy,  0.0 ni,  3.0 id,  0.0 wa,  0.0 hi,  0.0 si,  3.0 st<br>
%Cpu5  : 87.9 us,  9.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  3.0 st<br>
KiB Mem : 16265992 total,  1176564 free,  8436112 used,  6653316 buff/cache<br>
KiB Swap:        0 total,        0 free,        0 used.  7422832 avail Mem</p>
<p>PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                     <br>
21344 27        20   0 8222204 628452  12892 S 331.4  3.9 141:36.72 /opt/rh/rh-mysql57/root/usr/libexec/mysqld &ndash;defaults-file=/etc/my.cnf      <br>
5128 techstar  20   0 5917564   1.4g  21576 S 114.3  8.8 233:09.48 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache+<br>
5127 techstar  20   0   14.1g   3.5g  25756 S  40.0 22.8   1647:28 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache+<br>
1091 root      20   0 1145528 108228  29420 S  25.7  0.7 263:51.49 /usr/bin/dockerd -H fd:// &ndash;containerd=/run/containerd/containerd.sock      <br>
1078 root      20   0 2504364 106288  38808 S  14.3  0.7 429:13.57 /usr/bin/kubelet &ndash;bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.co+<br>
17108 root      20   0  164472   2656   1712 R  14.3  0.0   0:00.66 top</p>
<p>从上面的数据中，我们也能看到 MySQL 的进程消耗的 CPU 比较多，这说明我们现在走的证据链是正确的。既然走到了数据库，那我们主要看什么呢？当然是看 MySQL 的全局监控了。所以，我打印了 MySQL Report，过滤掉一些没问题的数据之后得到如下结果（不然内容就太长了）：</p>
<p>__ Questions ___________________________________________________________<br>
Total         637.05k     8.0/s<br>
DMS         293.57k     3.7/s  %Total:  46.08<br>
Com_        235.02k     2.9/s           36.89<br>
&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..<br>
Slow 20 ms    119.50k     1.5/s           18.76  %DMS:  40.70  Log:<br>
DMS           293.57k     3.7/s           46.08<br>
SELECT      224.80k     2.8/s           35.29         76.57<br>
UPDATE       51.86k     0.6/s            8.14         17.66<br>
INSERT       16.92k     0.2/s            2.66          5.76<br>
REPLACE           0       0/s            0.00          0.00<br>
DELETE            0       0/s            0.00          0.00<br>
&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..</p>
<p>__ SELECT and Sort _____________________________________________________<br>
Scan          137.84k     1.7/s %SELECT:  61.32<br>
&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..</p>
<p>从上面的数据我们可以看到，在 Total 的部分中，DMS（Data Manipulation Statements，数据维护语句）占比 46.08%。而在 DMS 中，SELECT 占比 76.57%。所以，我们要把后续分析的重点放在 SELECT 语句上。</p>
<p>通过 Slow 这一行，看到慢日志也已经出现，因为我把慢日志阈值设置的比较低，只有 20ms，所以，你能看到每秒产生了 1.5 个慢日志。我之所以把慢日志阈值设的比较低，主要是想把稍微慢一点的 SQL 都记录下来。不过，在你的应用中，要根据实际的情况来，不要设置过大，也不要过小，不然都是泪。</p>
<h3 id="定向分析">定向分析</h3>
<p>下面就是看慢日志喽。请你记住，在看 MySQL 慢日志之前，最好先把日志清一遍，让这个日志只记录压力场景执行时间段内的慢 SQL，不然受影响的数据会很多。</p>
<p>[root@7dgroup1 gaolou]# pt-query-digest slow-query.log</p>
<h1 id="72s-user-time-70ms-system-time-3678m-rss-10605m-vsz">7.2s user time, 70ms system time, 36.78M rss, 106.05M vsz</h1>
<h1 id="current-date-wed-dec-30-233014-2020">Current date: Wed Dec 30 23:30:14 2020</h1>
<h1 id="hostname-7dgroup1">Hostname: 7dgroup1</h1>
<h1 id="files-slow-querylog">Files: slow-query.log</h1>
<h1 id="overall-3660k-total-7-unique-8906-qps-1717x-concurrency-_________">Overall: 36.60k total, 7 unique, 89.06 QPS, 17.17x concurrency _________</h1>
<h1 id="time-range-2020-12-30t152200-to-2020-12-30t152851">Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51</h1>
<h1 id="attribute----------total-----min-----max-----avg-----95--stddev--median">Attribute          total     min     max     avg     95%  stddev  median</h1>
<h1 id="-----------">============     ======= ======= ======= ======= ======= ======= =======</h1>
<h1 id="exec-time----------7055s----20ms------1s---193ms---501ms---160ms---128ms">Exec time          7055s    20ms      1s   193ms   501ms   160ms   128ms</h1>
<h1 id="lock-time-------------7s-------0----39ms---194us---247us---696us---125us">Lock time             7s       0    39ms   194us   247us   696us   125us</h1>
<h1 id="rows-sent---------3545k-------0-------1----099----099----009----099">Rows sent         35.45k       0       1    0.99    0.99    0.09    0.99</h1>
<h1 id="rows-examine-------233g-------0-11276k--6671k-11233k--4650k-11233k">Rows examine       2.33G       0 112.76k  66.71k 112.33k  46.50k 112.33k</h1>
<h1 id="query-size--------1426m-------6----1016--40853--59207--19517--20240">Query size        14.26M       6    1016  408.53  592.07  195.17  202.40</h1>
<h1 id="profile">Profile</h1>
<h1 id="rank-query-id----------------------response-time---calls-rcall-vm---it">Rank Query ID                      Response time   Calls R/Call V/M   It</h1>
<h1 id="------">==== ============================= =============== ===== ====== ===== ==</h1>
<h1 id="1-0xb8bdb35ad896842fac41202b-57443322-814-18420-03119--007-select-pms_sku_stock">1 0xB8BDB35AD896842FAC41202B&hellip; 5744.3322 81.4% 18420 0.3119  0.07 SELECT pms_sku_stock</h1>
<h1 id="2-0xc71984b4087f304be41ac8f8-13091841-186-18138-00722--003-select-oms_cart_item">2 0xC71984B4087F304BE41AC8F8&hellip; 1309.1841 18.6% 18138 0.0722  0.03 SELECT oms_cart_item</h1>
<h1 id="misc-0xmisc---------------------------14979--00----46-00326---00-5-items">MISC 0xMISC                           1.4979  0.0%    46 0.0326   0.0 &lt;5 ITEMS&gt;</h1>
<h1 id="query-1-4482-qps-1398x-concurrency-id-0xb8bdb35ad896842fac41202bb9c908e8-at-byte-6504041">Query 1: 44.82 QPS, 13.98x concurrency, ID 0xB8BDB35AD896842FAC41202BB9C908E8 at byte 6504041</h1>
<h1 id="this-item-is-included-in-the-report-because-it-matches---limit">This item is included in the report because it matches &ndash;limit.</h1>
<h1 id="scores-vm--007">Scores: V/M = 0.07</h1>
<h1 id="time-range-2020-12-30t152200-to-2020-12-30t152851-1">Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51</h1>
<h1 id="attribute----pct---total-----min-----max-----avg-----95--stddev--median">Attribute    pct   total     min     max     avg     95%  stddev  median</h1>
<h1 id="--------">============ === ======= ======= ======= ======= ======= ======= =======</h1>
<h1 id="count---------50---18420">Count         50   18420</h1>
<h1 id="exec-time-----81---5744s----76ms------1s---312ms---580ms---148ms---279ms">Exec time     81   5744s    76ms      1s   312ms   580ms   148ms   279ms</h1>
<h1 id="lock-time-----47------3s----70us----37ms---184us---224us---673us---119us">Lock time     47      3s    70us    37ms   184us   224us   673us   119us</h1>
<h1 id="rows-sent-----50--1799k-------1-------1-------1-------1-------0-------1">Rows sent     50  17.99k       1       1       1       1       0       1</h1>
<h1 id="rows-examine--85---198g-11276k-11276k-11276k-11276k-------0-11276k">Rows examine  85   1.98G 112.76k 112.76k 112.76k 112.76k       0 112.76k</h1>
<h1 id="query-size----26---372m-----212-----212-----212-----212-------0-----212">Query size    26   3.72M     212     212     212     212       0     212</h1>
<h1 id="string">String:</h1>
<h1 id="hosts--------10100554">Hosts        10.100.5.54</h1>
<h1 id="users--------reader">Users        reader</h1>
<h1 id="query_time-distribution">Query_time distribution</h1>
<h1 id="1us">1us</h1>
<h1 id="10us">10us</h1>
<h1 id="100us">100us</h1>
<h1 id="1ms">1ms</h1>
<h1 id="10ms">10ms </h1>
<h1 id="100ms">100ms </h1>
<h1 id="1s">1s </h1>
<h1 id="10s">10s+</h1>
<h1 id="tables">Tables</h1>
<h1 id="show-table-status-like-pms_sku_stockg">SHOW TABLE STATUS LIKE &lsquo;pms_sku_stock&rsquo;\G</h1>
<h1 id="show-create-table-pms_sku_stockg">SHOW CREATE TABLE <code>pms_sku_stock</code>\G</h1>
<h1 id="explain-50100-partitions">EXPLAIN /<em>!50100 PARTITIONS</em>/</h1>
<p>select</p>
<pre><code>id, product_id, sku_code, price, stock, low_stock, pic, sale, promotion_price, lock_stock,  
sp_data  

from pms_sku_stock  


 WHERE (  sku_code = '202008270027906' )\G  
</code></pre>
<h1 id="query-2-4413-qps-319x-concurrency-id-0xc71984b4087f304be41ac8f82a88b245-at-byte-20901845">Query 2: 44.13 QPS, 3.19x concurrency, ID 0xC71984B4087F304BE41AC8F82A88B245 at byte 20901845</h1>
<h1 id="this-item-is-included-in-the-report-because-it-matches---limit-1">This item is included in the report because it matches &ndash;limit.</h1>
<h1 id="scores-vm--003">Scores: V/M = 0.03</h1>
<h1 id="time-range-2020-12-30t152200-to-2020-12-30t152851-2">Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51</h1>
<h1 id="attribute----pct---total-----min-----max-----avg-----95--stddev--median-1">Attribute    pct   total     min     max     avg     95%  stddev  median</h1>
<h1 id="---------1">============ === ======= ======= ======= ======= ======= ======= =======</h1>
<h1 id="count---------49---18138">Count         49   18138</h1>
<h1 id="exec-time-----18---1309s----20ms---419ms----72ms---148ms----43ms----59ms">Exec time     18   1309s    20ms   419ms    72ms   148ms    43ms    59ms</h1>
<h1 id="lock-time-----52------4s----76us----39ms---205us---260us---719us---138us">Lock time     52      4s    76us    39ms   205us   260us   719us   138us</h1>
<h1 id="rows-sent-----49--1745k-------0-------1----099----099----012----099">Rows sent     49  17.45k       0       1    0.99    0.99    0.12    0.99</h1>
<h1 id="rows-examine--14-35631m--1996k--2022k--2012k--1940k-------0--1940k">Rows examine  14 356.31M  19.96k  20.22k  20.12k  19.40k       0  19.40k</h1>
<h1 id="query-size----73--1051m-----604-----610--60781--59207-------0--59207">Query size    73  10.51M     604     610  607.81  592.07       0  592.07</h1>
<h1 id="string-1">String:</h1>
<h1 id="hosts--------10100554-1">Hosts        10.100.5.54</h1>
<h1 id="users--------reader-1">Users        reader</h1>
<h1 id="query_time-distribution-1">Query_time distribution</h1>
<h1 id="1us-1">1us</h1>
<h1 id="10us-1">10us</h1>
<h1 id="100us-1">100us</h1>
<h1 id="1ms-1">1ms</h1>
<h1 id="10ms-1">10ms </h1>
<h1 id="100ms-1">100ms </h1>
<h1 id="1s-1">1s</h1>
<h1 id="10s-1">10s+</h1>
<h1 id="tables-1">Tables</h1>
<h1 id="show-table-status-like-oms_cart_itemg">SHOW TABLE STATUS LIKE &lsquo;oms_cart_item&rsquo;\G</h1>
<h1 id="show-create-table-oms_cart_itemg">SHOW CREATE TABLE <code>oms_cart_item</code>\G</h1>
<h1 id="explain-50100-partitions-1">EXPLAIN /<em>!50100 PARTITIONS</em>/</h1>
<p>select</p>
<pre><code>id, product_id, product_sku_id, member_id, quantity, price, product_pic, product_name,  
product_sub_title, product_sku_code, member_nickname, create_date, modify_date, delete_status,  
product_category_id, product_brand, product_sn, product_attr  
from oms_cart_item  
 WHERE (  member_id = 381920  
                   and product_id = 317  
              and delete_status = 0  
              and product_sku_id = 317 )\G
</code></pre>
<p>从上面的数据来看，我们的优化方向比较简单明了：占用总时间最长的两个 SQL 需要收拾，其中，一个占用了总时间的 81.4%，另一个占用了 18.6%。</p>
<p>我们先来看最慢的那个 SQL：</p>
<p>select<br>
id, product_id, sku_code, price, stock, low_stock, pic, sale, promotion_price, lock_stock,<br>
sp_data<br>
from pms_sku_stock<br>
WHERE (  sku_code = &lsquo;202008270027906&rsquo; )\G</p>
<p>要想知道一个语句哪里慢，就得来看一下执行计划：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/418ad19206f1270859811631bc1c8ad3.png" alt=""></p>
<p>在执行计划中，type 这一列的参数值为 ALL，说明这个 SQL 没有用到索引。你想想，一个有 where 条件的语句，又没有用到索引，那它上方的索引到底合不合理呢？我们不妨检查一下这个索引：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/e9fc028ef27925b834e983297cd1a7e4.png" alt=""></p>
<p>通过检查索引，我们看到只有一个 ID 列，也就是一个主键索引，并没有 where 条件中的 sku_code 列。所以，我们先给 sku_code 加一个索引来实现精准查询，这样就不用扫描整表的数据了：</p>
<p>ALTER TABLE pms_sku_stock ADD INDEX sku_code_index (sku_code);</p>
<p>修改之后，我们再来看一下此时的执行计划：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/cc8852c247b1bf856c1e1c7c4509805d.png" alt=""></p>
<p>现在，type 列的参数值变为了 ref，说明 where 条件确实走了索引了。那我们再把场景执行起来，看看效果：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/5b4ced04aa9da47cec48915885fe328c.png" alt=""></p>
<p>从结果来看，TPS 从 50 增加到了 150 以上。响应时间也从 750ms 左右降到 250ms 以下。效果显著。</p>
<p>收拾完了第一个 SQL 后，我们再来收拾另一个 SQL。同样地，我们先看它的执行计划：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/fee2bc84afdf145c904d512d632de7d6.png" alt=""></p>
<p>type 列的参数值为 ALL，表明 where 条件没有使用索引。但是，第二个语句用了好几个 where 条件，所以，我们直接加一个组合索引，让 where 条件可以走到索引这里：</p>
<p>ALTER TABLE oms_cart_item ADD INDEX mix_index (member_id,product_id,product_sku_id);</p>
<p>加了组合索引后，这个 SQL 的执行计划如下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/bd7da7cc0de55e7dc7c1ada9d4c6aebb.png" alt=""></p>
<p>还是一样，我们再次把场景跑起来，看看优化了这两个最慢的 SQL 之后，效果如何。</p>
<h3 id="优化效果">优化效果</h3>
<p>优化效果如下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/3eec8fab2e22c0a04a8479ebc3994365.png" alt=""></p>
<p>优化前后的对比图如下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/e8acf5053061a270600005549a5cffdb.png" alt=""></p>
<p>建议你在写报告的时候，画这种对比图，用它来说明优化效果是非常直接明显的。</p>
<h2 id="分析的第二阶段">分析的第二阶段</h2>
<p>现在我们就要来分析错误了，反正也忽悠不过去。</p>
<h3 id="压力数据-1">压力数据</h3>
<p>下面是对应的错误图，我把图截多一点，可以看到趋势如下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/0c729a4d14a637ce6117ee67cb5010fe.png" alt=""></p>
<p>你看，<strong>TPS 中有对的，也有错的，并且 TPS 越高的时候，错误率也越高</strong>。这一点很重要，希望你能记住。</p>
<p>紧接着，我们来拆分响应时间。</p>
<h3 id="拆分响应时间-1">拆分响应时间</h3>
<p>先设置 skywalking 的时间段：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/7be3dbf94253747e9adb96b3a2fb792e.png" alt=""></p>
<p>请你注意，在看性能计数器的时候，每一个工具上的时间窗口一定要对应上。</p>
<ol>
<li>User - Gateway：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/dd04d793f7fa989bfce9769d72f9e032.png" alt=""></p>
<ol>
<li>Gateway - Cart：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/b18c1e363aa0943bf2f00b5ed6576dc4.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/95a3fd326f4fa4567425ed23c1aae822.png" alt=""></p>
<ol>
<li>Cart - Member：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/d257d0182ebcb30dcd40cfb935cddf9d.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/5969a3f501b38fd8baf9383ddce907e1.png" alt=""></p>
<ol>
<li>Cart - MySQL：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/446f86a44a3bbacd19615f715fa3d431.png" alt=""></p>
<ol>
<li>Member - MySQL：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/b1c3b3794db0e24b846a29c4f6663f90.png" alt=""></p>
<p>罗列了一堆信息之后……并没有什么发现。</p>
<p>你可能会奇怪，为什么说没有发现呢，Cart 上的响应时间不是比较长吗？这里你就要注意了，我们现在分析的问题是错误，而不是响应时间，所以时间长就长呗。<strong>在分析的过程中，你一定要时刻记得自己查的是什么问题，不要走到半路就走岔了，那样会陷入混乱的状态。</strong></p>
<h3 id="全局分析-1">全局分析</h3>
<p>通常情况下，我们的全局分析都是从资源开始的对吧，也就是从性能分析决策树中一层层查下去。对应我们第 4 节课讲的内容，你可以把所有的第一层计数器查一遍。</p>
<p>而在我们的这个问题的分析中，其实不用那么麻烦，因为在前面看到压力数据的时候，已经看到了大量的报错了，要想分析错误，肯定得先知道错误在哪，所以，这里我们直接查日志相关的内容就可以。查到日志的时候，我们看到下面这些错误信息：</p>
<p>2020-12-30 23:44:06.754 ERROR 1 &mdash; [io-8086-exec-41] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.dao.DeadlockLoserDataAccessException:</p>
<h3 id="error-updating-database--cause-commysqlcjjdbcexceptionsmysqltransactionrollbackexception-deadlock-found-when-trying-to-get-lock-try-restarting-transaction">Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</h3>
<h3 id="the-error-may-involve-comdunshanmallmapperomscartitemmapperupdatebyprimarykey-inline">The error may involve com.dunshan.mall.mapper.OmsCartItemMapper.updateByPrimaryKey-Inline</h3>
<h3 id="the-error-occurred-while-setting-parameters">The error occurred while setting parameters</h3>
<h3 id="sql-update-oms_cart_item-----set-product_id---------product_sku_id---------member_id---------quantity---------price---------product_pic---------product_name---------product_sub_title---------product_sku_code---------member_nickname---------create_date---------modify_date---------delete_status---------product_category_id---------product_brand---------product_sn---------product_attr-------where-id--">SQL: update oms_cart_item     set product_id = ?,       product_sku_id = ?,       member_id = ?,       quantity = ?,       price = ?,       product_pic = ?,       product_name = ?,       product_sub_title = ?,       product_sku_code = ?,       member_nickname = ?,       create_date = ?,       modify_date = ?,       delete_status = ?,       product_category_id = ?,       product_brand = ?,       product_sn = ?,       product_attr = ?     where id = ?</h3>
<h3 id="cause-commysqlcjjdbcexceptionsmysqltransactionrollbackexception-deadlock-found-when-trying-to-get-lock-try-restarting-transaction">Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</h3>
<p>; Deadlock found when trying to get lock; try restarting transaction; nested exception is com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction] with root cause<br>
&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..</p>
<p>这个错误已经给了我们明确的指向：死锁。可是为什么会死锁呢？</p>
<p>在性能分析中，你要记得，死锁其实是相对容易分析的内容。<strong>有争用才有锁，而死锁，就是</strong> <strong>说锁被</strong> <strong>争得死死的。</strong></p>
<p>下面我们开始定向分析为什么会产生锁。</p>
<h3 id="定向分析-1">定向分析</h3>
<p>首先，我们找到商品加入购物车业务对应的代码：</p>
<p>/**<br>
* 增加购物车<br>
* @param productSkuCode 库存商品编号<br>
* @param quantity 商品数量<br>
* @return<br>
*/<br>
@Override<br>
public int addCart(String productSkuCode, Integer quantity) {<br>
&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..<br>
OmsCartItem existCartItem = getCartItem(cartItem);<br>
if (existCartItem == null) {<br>
cartItem.setCreateDate(new Date());<br>
count = cartItemMapper.insert(cartItem);<br>
} else {<br>
cartItem.setModifyDate(new Date());<br>
existCartItem.setQuantity(existCartItem.getQuantity() + cartItem.getQuantity());<br>
count = cartItemMapper.updateByPrimaryKey(existCartItem);<br>
}</p>
<pre><code>    return count;  
}
</code></pre>
<p>引用这段代码的事务如下：</p>
<p>@Transactional<br>
int addCart(String productSkuCode, Integer quantity);</p>
<p>根据上面的关系，对于商品加入购物车来说，什么能引起死锁呢？你看，在代码中有一个 update，它对应的也就是前面日志中的 update 语句。所以，要是发生死锁的话，那指定就是 ID 冲突了，而这个 ID 对应的就是会员 ID。也就是说，有多个线程同时想更新同一个会员的购物车，这怎么能行！</p>
<p>既然是会员 ID 冲突了，那是谁给的会员信息呢？想都不用想，这个会员信息肯定是从脚本中传过来的呀，所以我们要查查脚本。</p>
<p>对应的脚本如下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/ea004b59e4d8d59219da4894f6b0b816.png" alt=""></p>
<p>你看，这里有一个 productSkuCode 参数，共用了 1000 行数据量。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/f78a947ae0cb7a02941ea06bce3b16b9.png" alt=""></p>
<p>上面的图对应的 JMeter 脚本是这样的：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/6dbd7e66ce552a240c031c5f29950497.png" alt=""></p>
<p>我们来看 JMeter 脚本中的这三个参数：</p>
<p>quotedData: false<br>
recycle: true<br>
stopThread: false</p>
<p>这意味着，我们所有的线程都在共用这 1000 条数据，并且在不断循环。这会导致数据使用重复，也就是说，如果有两个以上的线程用到了相同的用户数据，就会更新同一个购物车，于是产生冲突报错。</p>
<p>我们现在把上面三个参数改一下：</p>
<p>quotedData: true<br>
recycle: false<br>
stopThread: true</p>
<p>这样就保证了每个线程可以分到不同的数据。</p>
<p>可是，另一个问题来了：我们做这样处理的话，1000 条数据是不够用的，怎么办呢？那我们就只有把用户数据加大，等生成更多的 Token 之后，我们再来执行场景。</p>
<p>通过一晚上的造数，时间来到了第二天。</p>
<h3 id="优化效果-1">优化效果</h3>
<p>于是，我们得到了如下结果：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/52a2d9f069fd0459d6fa9e79d962950c.png" alt=""></p>
<p>从数据上来看，报错没有了，这是一个合理的结果。</p>
<h2 id="总结">总结</h2>
<p>现在，我们总结一下这节课。</p>
<p>“哎，哎，你先别总结呀，问题都没解决完，你看这不是还有 TPS 掉下来的情况吗？”</p>
<p>“年轻人，别捉急，饭都得一口一口吃，问题自然要一个一个解决了。这个问题，我会放在后面的课程中解决。”</p>
<p>在这节课中，我们从 TPS 不高开始，一直分析到了具体的 SQL，看似是两个简单的索引就搞定的事情，逻辑也并不复杂，但是，这个分析思路非常重要。</p>
<p>对于第二个问题，我们从错误数据查到了日志中出现的死锁信息，这一点大部分人应该都可以做得到。只不过，能立即想到参数冲突的，就是有经验的人了。</p>
<p>此外，这里还有一个重点就是，<strong>参数化数据一定要符合真实场景</strong>！高老师已经反复强调很多遍了，希望你能记得住。</p>
<h2 id="课后作业">课后作业</h2>
<p>最后，我给你留两道题，请你思考一下：</p>
<ol>
<li>除了用本节课中的手段，你还有什么方法可以快速定位到 SQL 语句慢的问题？</li>
<li>你能画出在第二阶段分析中的逻辑吗？</li>
</ol>
<p>记得在留言区和我讨论、交流你的想法，每一次思考都会让你更进一步。</p>
<p>如果你读完这篇文章有所收获，也欢迎你分享给你的朋友，共同学习进步。我们下一讲再见！</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/">高楼的性能工程实战课</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%B7%9F%E6%9C%88%E5%BD%B1%E5%AD%A6%E5%8F%AF%E8%A7%86%E5%8C%96/16__%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%99%AA%E5%A3%B0%E7%94%9F%E6%88%90%E5%A4%8D%E6%9D%82%E7%9A%84%E7%BA%B9%E7%90%86/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">16__如何使用噪声生成复杂的纹理？</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF%E9%9D%A2%E8%AF%9538%E8%AE%B2/16__%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%9F%BA%E7%A1%80%E4%B8%8D%E4%BC%9A%E7%81%B5%E6%B4%BB%E5%BA%94%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%BD%A0%E5%B0%B1%E6%B2%A1%E6%9C%89%E6%8E%8C%E6%8F%A1%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/">
            <span class="next-text nav-default">16__设计模式基础：不会灵活应用设计模式，你就没有掌握面向对象编程</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
