<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>31__辅助界面元素的架构设计 - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="你好，我是七牛云许式伟。
我们第二章“桌面软件开发”今天开始进入尾声。前面我们主要围绕一个完整的桌面应用程序，从单机到 B/S 结构，我们的系统架构应该如何考虑。并且，我们通过五讲的“画图”程序实战，来验证我们的架构设计思路。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/31__%E8%BE%85%E5%8A%A9%E7%95%8C%E9%9D%A2%E5%85%83%E7%B4%A0%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/31__%E8%BE%85%E5%8A%A9%E7%95%8C%E9%9D%A2%E5%85%83%E7%B4%A0%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="31__辅助界面元素的架构设计">
  <meta property="og:description" content="你好，我是七牛云许式伟。
我们第二章“桌面软件开发”今天开始进入尾声。前面我们主要围绕一个完整的桌面应用程序，从单机到 B/S 结构，我们的系统架构应该如何考虑。并且，我们通过五讲的“画图”程序实战，来验证我们的架构设计思路。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="许式伟的架构课">

  <meta itemprop="name" content="31__辅助界面元素的架构设计">
  <meta itemprop="description" content="你好，我是七牛云许式伟。
我们第二章“桌面软件开发”今天开始进入尾声。前面我们主要围绕一个完整的桌面应用程序，从单机到 B/S 结构，我们的系统架构应该如何考虑。并且，我们通过五讲的“画图”程序实战，来验证我们的架构设计思路。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="4675">
  <meta itemprop="keywords" content="许式伟的架构课">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="31__辅助界面元素的架构设计">
  <meta name="twitter:description" content="你好，我是七牛云许式伟。
我们第二章“桌面软件开发”今天开始进入尾声。前面我们主要围绕一个完整的桌面应用程序，从单机到 B/S 结构，我们的系统架构应该如何考虑。并且，我们通过五讲的“画图”程序实战，来验证我们的架构设计思路。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">31__辅助界面元素的架构设计</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 4675 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#辅助界面元素的框架">辅助界面元素的框架</a></li>
        <li><a href="#jquery-颜色选择器">jQuery 颜色选择器</a></li>
        <li><a href="#辅助界面元素的架构设计">辅助界面元素的架构设计</a></li>
        <li><a href="#结语">结语</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>你好，我是七牛云许式伟。</p>
<p>我们第二章“桌面软件开发”今天开始进入尾声。前面我们主要围绕一个完整的桌面应用程序，从单机到 B/S 结构，我们的系统架构应该如何考虑。并且，我们通过五讲的“画图”程序实战，来验证我们的架构设计思路。</p>
<p>这个实战有点复杂。对于编码量不多的初学者，理解起来还是有点复杂性的。为了减轻理解的难度，我们从原计划的上下两讲，扩大到了五讲。尽管如此，理解上的难度仍然还是有的，后面我们做总结时，会给出一个不基于 MVC 架构的实现代码。</p>
<p>今天我们不谈桌面应用的架构，而是来谈谈辅助界面元素的架构设计。</p>
<p>辅助界面元素非常常见，它其实就是通用控件，或者我们自定义的控件。例如在我们画图程序中使用了线型选择控件（<a href="./menu.js.md#L105">menu.js#L105</a>），如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;select id=&#34;lineWidth&#34; onchange=&#34;onIntPropChanged(&#39;lineWidth&#39;)&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;1&#34;&gt;1&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;3&#34;&gt;3&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;5&#34;&gt;5&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;7&#34;&gt;7&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;9&#34;&gt;9&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;11&#34;&gt;11&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/select&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>还有颜色选择控件（<a href="./menu.js.md#L115">menu.js#L115</a>），如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;select id=&#34;lineColor&#34; onchange=&#34;onPropChanged(&#39;lineColor&#39;)&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;black&#34;&gt;black&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;red&#34;&gt;red&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;blue&#34;&gt;blue&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;green&#34;&gt;green&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;yellow&#34;&gt;yellow&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;gray&#34;&gt;gray&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/select&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &lt;select id=&#34;fillColor&#34; onchange=&#34;onPropChanged(&#39;fillColor&#39;)&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;white&#34;&gt;white&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;null&#34;&gt;transparent&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;black&#34;&gt;black&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;red&#34;&gt;red&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;blue&#34;&gt;blue&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;green&#34;&gt;green&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;yellow&#34;&gt;yellow&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;option value=&#34;gray&#34;&gt;gray&lt;/option&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/select&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们统一用通用的 select 控件实现了一个线型选择器、两个颜色选择器的实例。虽然这种方式实现的颜色选择器不够美观，但是它们的确可以正常工作。</p>
<p>不过，产品经理很快就提出反对意见，说我们需要更加用户友好的界面。赶紧换一个更加可视化的颜色选择器吧？比如像下图这样的：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/b94925646eed47d4c5ee2d52c1717c36.png" alt=""></p>
<h2 id="辅助界面元素的框架">辅助界面元素的框架</h2>
<p>怎么做到？</p>
<p>我们不妨把上面基础版本的线型选择器、颜色选择器叫做 BaseLineWidthPicker、BaseColorPicker，我们总结它们在画图程序中的使用接口如下：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/ec8023953a797a26fbf973be92911f5c.png" alt=""></p>
<p>我们解释一下这个表格中的各项内容。</p>
<p>id 是控件的 id，通过它可以获取到辅助界面元素的顶层结点。</p>
<p>value 是界面元素的值，其实也就是辅助界面元素的 Model 层的数据。从 MVC 架构角度来说，Model 层的数据一般是一棵 DOM 树。但是对很多辅助界面元素来说，它的 DOM 树比较简单，只是一个数值。比如线型选择器是一个 number，颜色选择器是一个 Color 值。</p>
<p>palette 是颜色选择器的调色板，用来指示颜色选择器可以选择哪些颜色。</p>
<p>blur() 方法是主动让一个界面元素失去焦点。</p>
<p>onchange 事件是在该界面元素的值（value）通过用户界面交互进行改变时发送的事件。需要注意的是，这个事件只在用户交互时发送。直接调用 element.value = xxx 这样的方式来修改界面元素的值是不会触发 onchange 事件的。</p>
<p>为了便于修改辅助界面元素，我们计划引入统一的辅助界面元素的框架。</p>
<p>这个框架长什么样？</p>
<p>首先，每个界面元素使用的时候，统一以 <code>&lt;div type=&quot;xxx&quot;&gt;</code>来表示。比如上面的一个线型选择器、两个颜色选择器的实例可以这样来表示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;div type=&#34;BaseLineWidthPicker&#34; id=&#34;lineWidth&#34; onchange=&#34;onIntPropChanged(&#39;lineWidth&#39;)&#34;&gt;&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &lt;div type=&#34;BaseColorPicker&#34; id=&#34;lineColor&#34; onchange=&#34;onPropChanged(&#39;lineColor&#39;)&#34; palette=&#34;black,red,blue,green,yellow,gray&#34;&gt;&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &lt;div type=&#34;BaseColorPicker&#34; id=&#34;fillColor&#34; onchange=&#34;onPropChanged(&#39;fillColor&#39;)&#34; palette=&#34;white,null(transparent),black,red,blue,green,yellow,gray&#34;&gt;&lt;/div&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么它是怎么被替换成前面的界面元素的？</p>
<p>我们引入一个全局的 qcontrols: QControls 实例，所有我们定义的控件都向它注册（register）自己。注册的代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="n">QControls</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">register</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">control</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，注册的逻辑基本上没做什么，只是建立了类型（type）和控件的构建函数（control）的关联。有了这个关联表，我们就可以在适当的时候，把所有的 <code>&lt;div type=&quot;xxx&quot;&gt;</code>的 div 替换为实际的控件。替换过程如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class QControls {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  init() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    let divs = document.getElementsByTagName(&#34;div&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    let n = divs.length
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    for (let i = n-1; i &gt;= 0; i--) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      let div = divs[i]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      let type = div.getAttribute(&#34;type&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      if (type != null) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        let control = this.data[type]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if (control) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          control(div)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码逻辑很简单，遍历文档中所有的 div，如果带 type 属性，就去查这个 type 有没有注册过，注册过就用注册时指定的构建函数去构建控件实例。</p>
<p>完整的辅助界面元素框架代码如下：</p>
<ul>
<li><a href="./base.js.md">controls/base.js</a></li>
</ul>
<p>具体构建控件的代码是怎么样的？源代码请参考这两个文件：</p>
<ul>
<li><a href="./BaseLineWidthPicker.js.md">controls/BaseLineWidthPicker.js</a></li>
<li><a href="./BaseColorPicker.js.md">controls/BaseColorPicker.js</a></li>
</ul>
<p>我们拿 BaseColorPicker 作为例子看下吧：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">function BaseColorPicker(div) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let id = div.id
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let onchange = div.onchange
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let palette = div.getAttribute(&#34;palette&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let colors = palette.split(&#34;,&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let options = []
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  for (let i in colors) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    let color = colors[i]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    let n = color.length
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (color.charAt(n-1) == &#34;)&#34;) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      let offset = color.indexOf(&#34;(&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      options.push(`&lt;option value=&#34;` + color.substring(0, offset) + `&#34;&gt;` + color.substring(offset+1, n-1) + `&lt;/option&gt;`)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } else {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      options.push(`&lt;option value=&#34;` + color + `&#34;&gt;` + color + `&lt;/option&gt;`)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  div.outerHTML = `&lt;select id=&#34;` + id + `&#34;&gt;` + options.join(&#34;&#34;) + `&lt;/select&gt;`
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let elem = document.getElementById(id)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  if (onchange) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    elem.onchange = onchange
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> qcontrols.register(&#34;BaseColorPicker&#34;, BaseColorPicker)
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，构建函数的代码大体分为如下三步。</p>
<p>第一步，从占位的 div 元素中读入所有的输入参数。这里是 id, onchange, palette。</p>
<p>第二步，把占位的 div 元素替换为实际的界面。也就是 div.outerHTML = <code>xxx</code> 这段代码。</p>
<p>第三步，如果用户对 onchange 事件感兴趣，把 onchange 响应函数安装到实际界面的 onchange 事件中。</p>
<h2 id="jquery-颜色选择器">jQuery 颜色选择器</h2>
<p>接下来我们就开始考虑替换颜色选择器的实现了。新版本的颜色选择器，我们不妨命名为 ColorPicker。这个新版本的使用姿势必须和 BaseColorPicker 一样，也就是：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/61f90b6ec743f874dd898caad916f84d.png" alt=""></p>
<p>从使用的角度来说，我们只需要把之前的 BaseColorPicker 换成 ColorPicker。如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;div type=&#34;BaseLineWidthPicker&#34; id=&#34;lineWidth&#34; onchange=&#34;onIntPropChanged(&#39;lineWidth&#39;)&#34;&gt;&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &lt;div type=&#34;ColorPicker&#34; id=&#34;lineColor&#34; onchange=&#34;onPropChanged(&#39;lineColor&#39;)&#34; palette=&#34;black,red,blue,green,yellow,gray&#34;&gt;&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &lt;div type=&#34;ColorPicker&#34; id=&#34;fillColor&#34; onchange=&#34;onPropChanged(&#39;fillColor&#39;)&#34; palette=&#34;white,null(transparent),black,red,blue,green,yellow,gray&#34;&gt;&lt;/div&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么实现方面呢？</p>
<p>我们决定基于 jQuery 社区的 <a href="./spectrum.md">spectrum</a> 颜色选择器。</p>
<p>我们的画图程序的主体并没有引用任何现成的框架代码。jQuery 是第一个被引入的。</p>
<p>对待 jQuery，我们可以有两种态度。一种是认为 jQuery 设计非常优良，我们很喜欢，决定将其作为团队的编程用的基础框架。</p>
<p>在这种态度下，我们允许 jQuery 风格的代码蔓延得到处都是，典型表现就是满屏皆是 $ 符号。</p>
<p>当然这种选择的风险是不低的。有一天我们不想再基于 jQuery 开发了，这意味着大量的模块需要进行调整，尤其是那些活跃的项目。</p>
<p>另一种态度是，认为 jQuery 并不是我们的主体框架，只是因为我们有些模块用了社区的成果，比如 <a href="./spectrum.md">spectrum</a> 颜色选择器，它是基于 jQuery 实现的。这意味着我们要用 <a href="./spectrum.md">spectrum</a>，就需要引入 jQuery。</p>
<p>这种团队下，我们会尽可能限制 jQuery 的使用范围，尽量不要让它的代码蔓延，而只是限制在颜色选择器等少量场景中。</p>
<p>我们这一讲假设我们的态度是后者。我们有自己的基础开发框架（虽然我们其实基本上接近裸写 JavaScript 的状态），所以不会大面积使用 jQuery。</p>
<p>这样我们需要包装 jQuery 组件。代码如下（参阅 <a href="./ColorPicker.js.md">controls/ColorPicker.js</a>）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">function ColorPicker(div) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let id = div.id
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let onchange = div.onchange
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let palette = div.getAttribute(&#34;palette&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let colors = palette.split(&#34;,&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let value = colors[0]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  div.outerHTML = `&lt;input type=&#34;button&#34; id=&#34;` + id + `&#34; value=&#34;` + value + `&#34;&gt;`
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let elem = $(&#34;#&#34; + id)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  elem.spectrum({
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    showInitial: true,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    showInput: true,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    showButtons: true,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    preferredFormat: &#34;hex6&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  })
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  if (onchange) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    elem.change(onchange)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Object.defineProperty(document.getElementById(id), &#34;value&#34;, {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    get() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      return value
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    set(x) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      if (this.busy) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      value = x
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      this.busy = true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      elem.spectrum(&#34;set&#34;, value)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      this.busy = false
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  })
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> qcontrols.register(&#34;ColorPicker&#34;, ColorPicker)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里大部分代码比较常规，只有 Object.defineProperty 这一段看起来比较古怪一些。这段代码是在改写 document.getElementById(id) 这个界面元素的 value 属性的读写（get/set）函数。</p>
<p>为什么需要改写？</p>
<p>因为我们希望感知到使用者对 value 的改写。正常我们可能认为接管 onchange 就可以了，但是实际上 element.value = xxx 这样的属性改写是不会触发 onchange 事件的。所以我们只能从改写 value 属性的 set 函数来做。</p>
<p>set 函数收到 value 被改写后，会调用 elem.spectrum(“set”, value) 来改变 spectrum 颜色控件的当前值。</p>
<p>但这里又有个细节问题：elem.spectrum(“set”, value) 内部又会调用 element.value = value 来修改 document.getElementById(id) 这个界面元素的 value 属性，这样就出现了死循环。怎么办？我们通过引入一个 busy 标志来解决：如果当前已经处于 value 属性的 set 函数，就直接返回。</p>
<h2 id="辅助界面元素的架构设计">辅助界面元素的架构设计</h2>
<p>到目前为止，我们实现了三个符合我们定义的控件规范的辅助界面元素。如下：</p>
<ul>
<li><a href="./BaseLineWidthPicker.js.md">controls/BaseLineWidthPicker.js</a></li>
<li><a href="./BaseColorPicker.js.md">controls/BaseColorPicker.js</a></li>
<li><a href="./ColorPicker.js.md">controls/ColorPicker.js</a></li>
</ul>
<p>观察这些辅助界面元素的代码，你会发现它们都没有基于 MVC 架构。</p>
<p>是因为辅助界面元素不适合用 MVC 架构来编写么？</p>
<p>当然不是。</p>
<p>更本质的原因是因为它们规模太小了。这些界面元素的特点是 DOM 都是一个 value，并不是一棵树，这样 Model 层就没什么代码了。同样的逻辑，View 层、Control 层代码量都过于短小，就没必要有那么清楚的模块划分。View 负责界面呈现，Control 负责事件响应，只是在心里有谱就好了。</p>
<p>但并不是所有辅助界面元素都这么简单。</p>
<p>举一个简单的例子。让我们给自己设定一个新目标：把我们前面实战的“画图”程序，改造成一个标准的辅助界面元素，这可行么？</p>
<p>答案当然是肯定的。</p>
<p>但是这意味着我们有一些假设需要修正。这些假设通常都和唯一性有关。</p>
<p>比如，全局有唯一的 View 对象实例 qview: QPaintView。如果我们是辅助界面元素，意味着我们可能在同一个界面出现多个实例。在多实例的情况下，View 对象显然就应该有多个。</p>
<p>再比如，我们画图程序的辅助界面元素（参见 <a href="./menu.js.md">accel/menu.js</a>）都是单例，具体表现为这些界面元素的 id 都是固定的。</p>
<p>当然，辅助界面元素的改造方案有多种可能性。一种方案是将辅助界面元素也改造为多例，使得每个 QPaint 实例都有自己的辅助界面元素。</p>
<p>另一种方案是继续保持单例，这意味着多个 QPaint 实例会有一个当前实例的概念。辅助界面元素根据场景，可以是操作全部实例，也可以是操作当前实例。</p>
<p>我们选择继续保持单例。这意味着 qview: QPaintView 这个全局变量可以继续存在，但是和之前的含义有了很大不同。之前 qview 代表的是单例，现在 qview 代表的是当前实例。</p>
<p>有了当前实例当然就有切换。这样就需要增加焦点相关的事件响应。</p>
<p>在画图程序中，很多 Controller 都是 View 实例相关的。比如：PathCreator、ShapeSelector 等。在 View 存在多例的情况下，这些 Controller 之前的 registerController 动作就需要重新考虑。</p>
<p>为了支持多例，我们引入了 onViewAdded、onCurrentViewChanged 事件。当一个新的 View 实例被创建时，会发送 onViewAdded 事件。Controller 可以响应该事件去完成 registerController 动作。如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">onViewAdded(function(view) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  view.registerController(&#34;PathCreator&#34;, function() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return new QPathCreator(view, false)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  })
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">})
</span></span></code></pre></td></tr></table>
</div>
</div><p>原先，当前图形样式是放在 View 中的，通过 qview.style 可以访问到。这会导致多个 View 实例的当前图形样式不一样，但是我们辅助界面元素又是单例的，这就非常让人混淆。最后我们决定把 qview.style 挪到全局，改名叫 defaultStyle（参阅 <a href="./menu.js.md#L42">accel/menu.js#L42</a>）。</p>
<p>做完这些改造，我们的画图程序就有了成为一个标准控件的基础。具体代码如下（参阅 <a href="./PaintView.js.md">PaintView.js</a>）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">function newPaintView(drawingID) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let view = new QPaintView(drawingID)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  fireViewAdded(view)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  return view
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> function initPaintView(drawingID) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let view = newPaintView(drawingID)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  setCurrentView(view)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> function PaintView(div) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let id = div.id
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let width = div.getAttribute(&#34;width&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  let height = div.getAttribute(&#34;height&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  div.outerHTML = `&lt;canvas id=&#34;` + id + `&#34; width=&#34;` + width + `&#34; height=&#34;` + height + `&#34;&gt; 你的浏览器不支持 Canvas！&lt;/canvas&gt;`
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  initPaintView(id)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> qcontrols.register(&#34;PaintView&#34;, PaintView)
</span></span></code></pre></td></tr></table>
</div>
</div><p>有了这个 PaintView 控件，我们就可以到处引用它了。我们做了一个 PaintView 控件的 DEMO 程序，它效果看起来是这样的（代码参阅 <a href="./PaintDemo.md">PaintDemo.htm</a>）：</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/54123ed20f60a37b3c2e25b0251ec56b.png" alt=""></p>
<p>从这个截图看，细心的你可能会留意到，还有一个问题是没有被修改的，那就是 URL 地址。我们的 QPaintView 在 load 文档后会修改 URL，这作为应用程序并没有问题。但是如果是一个控件，整个界面有好多个 PaintView，URL 中应该显示哪个文档的 ID？</p>
<p>显然谁都不合适。如果非要显示，可能要在 PaintView 实例附近放一个辅助界面元素来显示它。</p>
<p>怎么修改？</p>
<p>这个问题暂且留给大家。</p>
<h2 id="结语">结语</h2>
<p>今天探讨了辅助界面元素，或者叫控件的架构设计。从大的实现逻辑来说，它和应用程序不应该有本质的不同。但控件总是要考虑支持多实例，这会带来一些细节上的差异。</p>
<p>支持多实例听起来是一项简单的工作，但是从我的观察看，对很多工程师来说实际上并不简单。不少初级工程师写代码往往容易全局变量满天飞，模块之间相互传递信息不假思索地基于全局变量来完成。这些不良习惯会导致代码极难控件化。</p>
<p>当然我们不见得什么桌面应用程序都要考虑把它控件化。但是我们花一些精力去思考控件化的话，会有助于你对架构设计中的一些决策提供帮助。</p>
<p>当然更重要的，其实是让你有机会形成更好的架构设计规范。</p>
<p>这一讲我们作出的修改如下：</p>
<ul>
<li><a href="https://github.com/qiniu/qpaint/compare/v30...v31">https://github.com/qiniu/qpaint/compare/v30...v31</a></li>
</ul>
<p>这是最新版本的源代码：</p>
<ul>
<li><a href="https://github.com/qiniu/qpaint/tree/v31">https://github.com/qiniu/qpaint/tree/v31</a></li>
</ul>
<p>如果你对今天的内容有什么思考与解读，欢迎给我留言，我们一起讨论。下一讲我们会谈谈架构设计的第二步：如何做好系统架构。</p>
<p>如果你觉得有所收获，也欢迎把文章分享给你的朋友。感谢你的收听，我们下期再见。</p>
<p><img src="https://raw.githubusercontent.com/epic1268/images/master/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/66b9828c3d4de21b8f7a14213cf3c4e7.png" alt=""></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE/">许式伟的架构课</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90/31__%E5%88%86%E5%B8%83%E5%BC%8F%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B9%8B%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E7%9F%A5%E9%94%99%E8%83%BD%E6%94%B9%E5%96%84%E8%8E%AB%E5%A4%A7%E7%84%89/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">31__分布式高可用之故障恢复：知错能改，善莫大焉</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%9C%B1%E8%B5%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E7%AE%A1%E7%90%86%E8%AF%BE/31__%E5%B7%A5%E7%A8%8B%E5%B8%88%E4%BA%A7%E5%93%81%E7%BB%8F%E7%90%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%B8%88%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E8%B5%B7%E5%B7%A5%E4%BD%9C%E7%9A%84/">
            <span class="next-text nav-default">31__工程师、产品经理、数据工程师是如何一起工作的？</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
