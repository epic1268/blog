<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>14日志采集：如何在Kubernete中做日志收集与管理？ - Docs</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="说到日志，你应该不陌生。日志中不仅记录了代码运行的实时轨迹，往往还包含着一些关键的数据、错误信息，等等。日志方便我们进行分析统计及监控告警，尤其是在后期问题排查的时候，我们通过日志可以很方便地定位问题、现场复现及问题修复。日志也是做可观测性（Observability）必不可少的一部分。
" /><meta name="keywords" content="技术文档, docs, 极客时间" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/kubernetes%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/14%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%A6%82%E4%BD%95%E5%9C%A8kubernete%E4%B8%AD%E5%81%9A%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E4%B8%8E%E7%AE%A1%E7%90%86/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://politcloud.org/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/kubernetes%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/14%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%A6%82%E4%BD%95%E5%9C%A8kubernete%E4%B8%AD%E5%81%9A%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E4%B8%8E%E7%AE%A1%E7%90%86/">
  <meta property="og:site_name" content="Docs">
  <meta property="og:title" content="14日志采集：如何在Kubernete中做日志收集与管理？">
  <meta property="og:description" content="说到日志，你应该不陌生。日志中不仅记录了代码运行的实时轨迹，往往还包含着一些关键的数据、错误信息，等等。日志方便我们进行分析统计及监控告警，尤其是在后期问题排查的时候，我们通过日志可以很方便地定位问题、现场复现及问题修复。日志也是做可观测性（Observability）必不可少的一部分。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-10T00:00:00+00:00">
    <meta property="article:tag" content="Kubernetes原理剖析与实战应用">

  <meta itemprop="name" content="14日志采集：如何在Kubernete中做日志收集与管理？">
  <meta itemprop="description" content="说到日志，你应该不陌生。日志中不仅记录了代码运行的实时轨迹，往往还包含着一些关键的数据、错误信息，等等。日志方便我们进行分析统计及监控告警，尤其是在后期问题排查的时候，我们通过日志可以很方便地定位问题、现场复现及问题修复。日志也是做可观测性（Observability）必不可少的一部分。">
  <meta itemprop="datePublished" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-10T00:00:00+00:00">
  <meta itemprop="wordCount" content="3934">
  <meta itemprop="keywords" content="Kubernetes原理剖析与实战应用">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="14日志采集：如何在Kubernete中做日志收集与管理？">
  <meta name="twitter:description" content="说到日志，你应该不陌生。日志中不仅记录了代码运行的实时轨迹，往往还包含着一些关键的数据、错误信息，等等。日志方便我们进行分析统计及监控告警，尤其是在后期问题排查的时候，我们通过日志可以很方便地定位问题、现场复现及问题修复。日志也是做可观测性（Observability）必不可少的一部分。">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Docs</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Docs</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">14日志采集：如何在Kubernete中做日志收集与管理？</h1>

      <div class="post-meta">
        <span class="post-time"> 10100-01-10 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/"> 极客时间 </a>
            </div>
          <span class="more-meta"> 约 3934 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>说到日志，你应该不陌生。日志中不仅记录了代码运行的实时轨迹，往往还包含着一些关键的数据、错误信息，等等。日志方便我们进行分析统计及监控告警，尤其是在后期问题排查的时候，我们通过日志可以很方便地定位问题、现场复现及问题修复。日志也是做可观测性（Observability）必不可少的一部分。</p>
<p>因此在使用 Kubernetes 的过程中，对应的日志收集也是我们不得不考虑的问题。我们需要日志去了解集群内部的运行状况。</p>
<p>我们先来看看 Kubernetes 的日志收集和以往的日志收集有什么差别，以及为什么我们需要为 Kubernetes 的日志收集单独设计方案。</p>
<p>Kubernetes 中的日志收集 VS 传统日志收集</p>
<p>对于传统的应用来说，它们大都都是直接运行在宿主机上的，会将日志直接写入本地的文件中或者由 systemd-journald 直接管理。在做日志收集的时候，只需要访问这些日志所在的目录即可。此类日志系统解决方案非常多，也相对比较成熟，在这里就不再过多说明。我们重点来看看 Kubernetes 的日志系统建设问题。</p>
<p>在 Kubernetes 中，日志采集相比传统虚拟机、物理机方式要复杂很多。</p>
<p>首先，日志的形式非常多样化。日志需求主要集中在如下三个部分：</p>
<p>系统各组件的日志，比如 Kubernetes 自身各大组件的日志（包括 kubelet、kube-proxy 等），容器运行时的日志（比如 Docker）；</p>
<p>以容器化方式运行的应用程序自身的日志，比如 Nginx、Tomcat 的运行日志；</p>
<p>Kubernetes 内部各种 Event（事件），比如通过
kubebctl create
创建一个 Pod 后，可以通过
kubectl describe pod pod-xxx
命令查看到的这个 Pod 的 Event 信息。</p>
<p>其次，集群环境时刻在动态变化。我们都知道 Pod “用完即焚”，Pod 销毁后日志也会一同被删除。但是这个时候我们仍然希望可以看到具体的日志，用于查看和分析业务的运行情况，以及帮助我们发现出容器异常的原因。</p>
<p>同时新的 Pod 可能随时会“飘”到别的节点上重新“生长”出来，我们无法提前预知具体是哪个节点。而且 Kubernetes 的节点也会存在宕机等异常情况。所以说，Kubernetes 的日志系统在设计的时候，必须得独立于节点和 Pod 的生命周期，且保证日志数据可以实时采集到服务端，即完全独立于 Kubernetes 系统，使用自己的后端存储和查询工具。</p>
<p>再次，日志规模会越来越大。很多人在 Kubernetes 中喜欢使用 hostpath 来保存 Pod 的日志，并且不做日志轮转（可以配置 Docker 的
log-opts
来设置容器的日志轮转 ），这很容易将宿主机的磁盘“打爆”。这里你是不是觉得如果做了轮转，磁盘打爆的问题就可以完美解决了？</p>
<p>其实虽有所缓解，并不会让你安全无忧。虽说日志轮转可以有效减少日志的文件大小，但是你会丢失掉不少日志，后续想要分析和排查问题时就无从下手了。想想看如果容器内的应用出现异常并疯狂报错，这个时候又有大量的并发请求，那么日志就会急剧增多。</p>
<p>配置了日志轮转，会让你丢失很多重要的上下文信息。如果没有配置日志轮转，这些日志很快就会将磁盘打爆。还有可能引发该节点的 Kubelet 异常，导致该节点上的 Pod 被驱逐。我们在一些生产实践中，就遇到过这种情况。同时当 Pod 被删除后，这些 hostpath 的文件并不会被及时删除，会继续占用很多磁盘空间。此外，随着业务逐渐增长，在这个节点上运行过的 Pod 也会变多，这就会残留大量的日志文件。</p>
<p>此外，日志非常分散且种类多变。单纯查找一个应用的日志，就需要查看其关联的分散在各个节点上的各个 Pod 的日志。在出现紧急情况需要排查的时候，这种方式极其低效，会严重影响到问题修复和服务恢复。如果这个应用还通过 Ingress 对外暴露服务，并使用了 Service Mesh 等，那么此时做日志收集就更复杂了。</p>
<p>随着在 Kubernetes 上落地越来越多的微服务，各个服务之间的依赖也越来越多。这个时候各个维度的日志关联也是一个非常困难的问题。那么，下面我们就来看看如何对 Kubernetes 做日志收集。</p>
<p>几种常见的 Kubernetes 日志收集架构</p>
<p>Kubernetes 集群本身其实并没有提供日志收集的解决方案，但依赖 Kubernetes 自身提供的各项能力，可以帮助我们解决日志收集的诉求。根据上面提到的三大基本日志需求，一般来说我们有如下有三种方案来做日志收集：</p>
<p>直接在应用程序中将日志信息推送到采集后端；</p>
<p>在节点上运行一个 Agent 来采集节点级别的日志；</p>
<p>在应用的 Pod 内使用一个 Sidecar 容器来收集应用日志。</p>
<p>我们来分别看看这三种方式。</p>
<p>先来看直接在应用程序中将日志信息推送到采集后端，即Pod 内的应用直接将日志写到后端的日志中心。</p>
<p>（https://github.com/kubernetes/website/blob/master/static/images/docs/user-guide/logging/logging-from-application.png）</p>
<p>通常有两种做法，一个就是应用程序通过对应的日志 SDK 进行接入，不过这种做法一般不推荐，和应用本身耦合太严重，也不方便后续对接其他的日志系统。</p>
<p>还有一种做法就是通过容器运行时提供的 Logging Driver 来实现。以最常用的 Docker 为例，目前已经支持了十多种 Logging Driver。比如你可以配置为
fluentd
，这个时候 Docker 就会将容器的标准输出日志（stdout、stderr）直接写到
fluentd
中。你也可以设置成
awslogs
，这样就会直接将日志写到 Amazon CloudWatch Logs 中。但是在和 Kubernetes 一起使用的时候，使用较多的是
json-file
，这也是 Docker 默认的 Logging Driver。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ docker info |grep &#39;Logging Driver&#39;
</span></span><span class="line"><span class="cl">Logging Driver: json-file
</span></span></code></pre></td></tr></table>
</div>
</div><p>你经常使用的
kubectl logs
就是基于
json-flle
这种 Logging Driver 来实现的，目前 Kubernetes 也只支持
json-flle
这一种 Logging Driver。</p>
<p>所以在 Kubernetes 的这套体系中，直接将日志写到后端日志采集系统中去，并不是特别好的做法。</p>
<p>我们来看第二种方法，在节点上运行一个 Agent 来采集节点级别的日志。如下图所示，我们可以在每一个 Kubernetes Node 上都部署一个 Agent，该 Agent 负责对该节点上运行的所有容器进行日志收集，并推送到后端的日志存储系统里。这个 Agent 通常需要可以访问到宿主机上的指定目录，比如
/var/lib/docker/containers/
。</p>
<p>（https://github.com/kubernetes/website/blob/master/static/images/docs/user-guide/logging/logging-with-node-agent.png）</p>
<p>由于这样的 Agent 需要在每个 Node 上都运行，因此我们都是通过 上节课讲到的
DaemonSet
的方式来部署的。对于 Kubernetes 集群来说，这种使用节点级的
DaemonSet
日志代理是最常用，也是最被推荐的方式，不仅可以节约资源，而且对于应用来说也是无侵入的。</p>
<p>但是这种方式也有个缺点，就是只适应于容器内应用日志是标准输出的场景，即应用把日志输出到
stdout
和
stderr
。</p>
<p>最后来看通过 Sidecar 来收集容器日志。 在 Pod 里面，容器的输出日志可以是
stdout
、
stderr
和日志文件。那么基于这三种形式，我们可以借助于 Sidecar 容器</p>
<p>将基于文件的日志来帮助我们。</p>
<p>通过Sidecar 容器读取日志文件，并定向到自己的标准输出。如下图所示，这里
streaming container
就是一个 Sidecar 容器，可以将
app-container
的日志文件重新定向到自己的标准输出。同时还可以归并多个日志文件。而且这里也可以使用多个 Sidecar 容器，你可以参考这个例子。</p>
<p>Sidecar容器运行一个日志代理，配置该日志代理以便从应用容器收集日志。这种方式就解决了我们上面方案一的问题，将日志处理部分和应用程序本身进行了解耦，可以方便切换到其他的日志系统中。可以参考这个使用 fluentd 的例子。</p>
<p>（https://github.com/kubernetes/website/blob/master/static/images/docs/user-guide/logging/logging-with-sidecar-agent.png）</p>
<p>可以看到,通过 Sidecar 的方式来收集日志，会增加额外的开销。在集群规模较小的情况下可以忽略不计,但是对于大规模集群来说，这些开销还是不可忽略的。</p>
<p>那么，上面的这几套方案，在实际使用的时候，又该如何选择呢？社区又有什么推荐方案呢？</p>
<p>基于 Fluentd + ElasticSearch 的日志收集方案</p>
<p>Kubernetes 社区官方推荐的方案是使用 Fluentd+ElasticSearch+Kibana 进行日志的收集和管理，通过Fluentd将日志导入到Elasticsearch中，用户可以通过Kibana来查看到所有的日志。</p>
<p>(<a href="https://docs.fluentd.org/container-deployment/kubernetes">https://docs.fluentd.org/container-deployment/kubernetes</a>)</p>
<p>关于 ElasticSearch 和 Kibana 如何部署，在此就不过多地介绍了，你可以通过添加 helm 的 repo即
helm repo add elastic <a href="https://helm.elastic.co">https://helm.elastic.co</a>
，然后通过 helm来快速地自行部署，相关的 Chart 见https://github.com/elastic/helm-charts。</p>
<p>现在我们就来看看这套方案的几个技术点。</p>
<p>Fluentd 提供了强大的日志统一接入能力，同时内置了插件，可以对接 ElasticSearch。这里 Fluentd 主要有如下四个配置：</p>
<p>fluent.conf
这个文件主要是用来设置一些地址，比如 ElasticSearch 的地址等；.</p>
<p>kubernetes.conf
这个文件记录了与 Kubernetes 相关的配置，比如 Kubernetes 各组件的日志配置、容器的日志收集规则，等等；</p>
<p>prometheus.conf
这个文件定义了 Prometheus 的地址，方便 Fluentd 暴露自己的统计指标；</p>
<p>systemd.conf
这个文件可以配置 Fluentd 通过 systemd-journal 来收集哪些服务的日志，比如 Docker 的日志、Kubelet 的日志等。</p>
<p>上面的这些配置，都默认内置到了 fluent/fluentd-kubernetes-daemonset的镜像中，你可以使用官方的默认配置。如果你想要定制化更改一些，可以参照这份默认示例配置。</p>
<p>如下的 YAML 是一段 fluentd 的 DaemonSet 定义，源自这里：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
</span></span><span class="line"><span class="cl"><span class="n">kind</span><span class="p">:</span> <span class="n">DaemonSet</span>
</span></span><span class="line"><span class="cl"><span class="n">metadata</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span>
</span></span><span class="line"><span class="cl">  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</span></span><span class="line"><span class="cl">  <span class="n">labels</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">logging</span>
</span></span><span class="line"><span class="cl">    <span class="n">version</span><span class="p">:</span> <span class="n">v1</span>
</span></span><span class="line"><span class="cl"><span class="n">spec</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">selector</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">matchLabels</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">logging</span>
</span></span><span class="line"><span class="cl">      <span class="n">version</span><span class="p">:</span> <span class="n">v1</span>
</span></span><span class="line"><span class="cl">  <span class="n">template</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">metadata</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">labels</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">logging</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span><span class="p">:</span> <span class="n">v1</span>
</span></span><span class="line"><span class="cl">    <span class="n">spec</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">tolerations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">key</span><span class="p">:</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span>
</span></span><span class="line"><span class="cl">        <span class="n">effect</span><span class="p">:</span> <span class="n">NoSchedule</span>
</span></span><span class="line"><span class="cl">      <span class="n">containers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span>
</span></span><span class="line"><span class="cl">        <span class="n">image</span><span class="p">:</span> <span class="n">fluent</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">daemonset</span><span class="p">:</span><span class="n">v1</span><span class="o">-</span><span class="n">debian</span><span class="o">-</span><span class="n">elasticsearch</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span>  <span class="n">FLUENT_ELASTICSEARCH_HOST</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;elasticsearch-logging&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span>  <span class="n">FLUENT_ELASTICSEARCH_PORT</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;9200&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">FLUENT_ELASTICSEARCH_SCHEME</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;http&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># Option to configure elasticsearch plugin with self signed certs</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># ================================================================</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">FLUENT_ELASTICSEARCH_SSL_VERIFY</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># Option to configure elasticsearch plugin with tls</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># ================================================================</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">FLUENT_ELASTICSEARCH_SSL_VERSION</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;TLSv1_2&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># X-Pack Authentication</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># =====================</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">FLUENT_ELASTICSEARCH_USER</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;elastic&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">FLUENT_ELASTICSEARCH_PASSWORD</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;changeme&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># Logz.io Authentication</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># ======================</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">LOGZIO_TOKEN</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;ThisIsASuperLongToken&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">LOGZIO_LOGTYPE</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span><span class="p">:</span> <span class="s2">&#34;kubernetes&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">resources</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">limits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">memory</span><span class="p">:</span> <span class="mi">200</span><span class="n">Mi</span>
</span></span><span class="line"><span class="cl">          <span class="n">requests</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cpu</span><span class="p">:</span> <span class="mi">100</span><span class="n">m</span>
</span></span><span class="line"><span class="cl">            <span class="n">memory</span><span class="p">:</span> <span class="mi">200</span><span class="n">Mi</span>
</span></span><span class="line"><span class="cl">        <span class="n">volumeMounts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">varlog</span>
</span></span><span class="line"><span class="cl">          <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span>
</span></span><span class="line"><span class="cl">        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">varlibdockercontainers</span>
</span></span><span class="line"><span class="cl">          <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">containers</span>
</span></span><span class="line"><span class="cl">          <span class="n">readOnly</span><span class="p">:</span> <span class="bp">true</span>
</span></span><span class="line"><span class="cl">      <span class="n">terminationGracePeriodSeconds</span><span class="p">:</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl">      <span class="n">volumes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">varlog</span>
</span></span><span class="line"><span class="cl">        <span class="n">hostPath</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">varlibdockercontainers</span>
</span></span><span class="line"><span class="cl">        <span class="n">hostPath</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">containers</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>写在最后</p>
<p>在实际采集日志的时候，你可以根据自己的场景和集群规模选择适用的方案。或者也可以将上面的这几种方案进行合理地组合。</p>
<p>到这里这节课就结束了，如果你对本节课有什么想法或者疑问，欢迎你在留言区留言，我们一起讨论。</p>
<p>-&ndash; ### 精选评论 ##### **0530： &gt; 一般程序的业务日志都不是标准输出流的……都是自定义的file的日志，还是使用每个node挂一个agent最常用，可以结合ELK使用哈</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        10100-01-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/">Kubernetes原理剖析与实战应用</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E8%A7%A3%E8%AF%BB%E4%BD%A0%E8%BA%AB%E8%BE%B9%E7%9A%84%E7%BB%8F%E6%B5%8E%E5%AD%A6/14%E4%B9%B0%E4%BD%8F%E5%AE%85%E4%B8%8D%E5%BE%97%E4%B8%8D%E8%80%83%E8%99%91%E7%9A%84%E5%9B%A0%E7%B4%A0/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">14买住宅不得不考虑的因素</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90mybatis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/14%E6%8E%A2%E7%A9%B6mybati%E7%BB%93%E6%9E%9C%E9%9B%86%E6%98%A0%E5%B0%84%E6%9C%BA%E5%88%B6%E8%83%8C%E5%90%8E%E7%9A%84%E7%A7%98%E5%AF%86%E4%B8%8A/">
            <span class="next-text nav-default">14探究MyBati结果集映射机制背后的秘密（上）</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2024 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FVZ07KBD4X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FVZ07KBD4X');
        }
      </script>






</body>
</html>
